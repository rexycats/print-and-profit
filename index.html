<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Print & Profit â€“ 3D Print Tycoon v12.0</title>
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Print%20%26%20Profit&quot;,&quot;short_name&quot;:&quot;P%26P&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;%230d0f14&quot;,&quot;theme_color&quot;:&quot;%2300e5ff&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%230d0f14'/%3E%3Ctext y='.9em' font-size='90'%3EðŸ–¨ï¸%3C/text%3E%3C/svg%3E&quot;,&quot;sizes&quot;:&quot;any&quot;,&quot;type&quot;:&quot;image/svg+xml&quot;}]}">
<style>
/* ============================================================
   PRINT & PROFIT v7.0
   Nieuw: TPU + Resin filament Â· Leverancierssysteem Â· VIP klanten
   Meer upgrades Â· Filamentvoorraad Â· Marktcrises Â· UI verbetering
   Klantenpanel Â· Leveranciersschommelingen Â· Challenge mode
   ============================================================ */
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Barlow+Condensed:wght@300;500;700;900&display=swap');

:root {
  --bg:         #0d0f14;
  --bg2:        #13161e;
  --bg3:        #1a1e2a;
  --panel:      #161b26;
  --border:     #2a3045;
  --accent:     #00e5ff;
  --accent2:    #ff6b35;
  --accent3:    #7fff6e;
  --warn:       #ffcc00;
  --danger:     #ff3d5a;
  --pro:        #a78bfa;
  --pro-dark:   #7c3aed;
  --pro-glow:   rgba(167,139,250,0.25);
  --text:       #d4dae8;
  --text-dim:   #5a6480;
  --text-bright:#ffffff;
  --pla:        #4fc3f7;
  --petg:       #ce93d8;
  --pa6:        #ffab40;
  --radius:     6px;
  --mono:       'Space Mono', monospace;
  --display:    'Barlow Condensed', sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--mono);
  font-size: 12px;
  min-height: 100vh;
  overflow-x: hidden;
  background-image:
    radial-gradient(ellipse 80% 40% at 50% -10%, rgba(0,229,255,0.06) 0%, transparent 70%),
    repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px),
    repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px);
}

/* â”€â”€ TOP BAR â”€â”€ */
#topbar {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px; height: 56px;
  background: var(--panel); border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 100; gap: 12px; flex-wrap: wrap;
}
.logo {
  font-family: var(--display); font-weight: 900; font-size: 22px;
  letter-spacing: 2px; color: var(--accent); text-transform: uppercase;
  white-space: nowrap; text-shadow: 0 0 20px rgba(0,229,255,0.4);
}
.logo span { color: var(--accent2); }
.stat-pill {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 20px; padding: 5px 14px;
  font-family: var(--display); font-weight: 700; font-size: 16px;
}
.stat-pill .label { color: var(--text-dim); font-size: 10px; font-weight: 300; letter-spacing: 1px; text-transform: uppercase; }
#money-val { color: var(--accent3); }
#rep-val   { color: var(--warn); }
#level-val { color: var(--accent); }
.topbar-right { display: flex; gap: 8px; align-items: center; }

/* PRO BUTTON */
.btn-pro {
  background: linear-gradient(135deg, var(--pro-dark), var(--pro));
  color: white;
  border: none; border-radius: var(--radius);
  padding: 7px 14px; cursor: pointer;
  font-family: var(--mono); font-size: 11px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase;
  box-shadow: 0 0 20px var(--pro-glow);
  transition: all 0.2s;
}
.btn-pro:hover { box-shadow: 0 0 30px rgba(167,139,250,0.5); transform: translateY(-1px); }
.btn-pro.owned { background: linear-gradient(135deg,#2d1b69,#4c1d95); color: var(--pro); cursor: default; }

/* SOUND TOGGLE */
.sound-btn {
  width: 34px; height: 34px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; transition: all 0.15s;
}
.sound-btn:hover { border-color: var(--accent); }
.sound-btn.muted { opacity: 0.4; }

/* â”€â”€ MAIN LAYOUT â”€â”€ */
#main {
  display: grid; grid-template-columns: 290px 1fr 290px;
  gap: 12px; padding: 12px;
  max-width: 1340px; margin: 0 auto;
  min-height: calc(100vh - 56px);
}

/* â”€â”€ PANELS â”€â”€ */
.panel { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; display: flex; flex-direction: column; }
.panel-header {
  padding: 10px 14px; border-bottom: 1px solid var(--border);
  font-family: var(--display); font-weight: 700; font-size: 14px;
  letter-spacing: 2px; text-transform: uppercase; color: var(--text-dim);
  display: flex; align-items: center; gap: 8px;
}
.panel-header .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 8px var(--accent); }
.panel-body { padding: 12px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

/* â”€â”€ TABS â”€â”€ */
.tab-row { display: flex; gap: 4px; padding: 8px 12px 0; }
.tab {
  padding: 5px 12px; border-radius: 4px 4px 0 0; cursor: pointer;
  font-family: var(--display); font-size: 12px; font-weight: 700;
  letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim);
  border: 1px solid transparent; border-bottom: none; transition: all 0.15s;
}
.tab.active { color: var(--text-bright); background: var(--bg3); border-color: var(--border); }
.tab-content { display: none; flex-direction: column; gap: 10px; }
.tab-content.active { display: flex; }

/* â”€â”€ PANEL TABS (left panel) â”€â”€ */
.ptab-row { display: flex; border-bottom: 1px solid var(--border); }
.ptab {
  flex: 1; padding: 8px 0; text-align: center; cursor: pointer;
  font-family: var(--display); font-weight: 700; font-size: 12px;
  letter-spacing: 1px; text-transform: uppercase; color: var(--text-dim);
  border-bottom: 2px solid transparent; transition: all 0.15s;
}
.ptab.active { color: var(--accent); border-bottom-color: var(--accent); }
.ptab .badge {
  display: inline-block; background: var(--danger); color: white;
  border-radius: 50%; width: 15px; height: 15px; line-height: 15px;
  text-align: center; font-size: 9px; margin-left: 4px; vertical-align: middle;
}
.ptab .cbadge {
  display: inline-block; background: var(--warn); color: var(--bg);
  border-radius: 50%; width: 15px; height: 15px; line-height: 15px;
  text-align: center; font-size: 9px; margin-left: 4px; vertical-align: middle;
}
.ptab-body { display: none; flex: 1; overflow-y: auto; padding: 10px; flex-direction: column; gap: 8px; }
.ptab-body.active { display: flex; }

/* â”€â”€ PRINTER CARDS â”€â”€ */
.printer-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 12px; position: relative;
  transition: border-color 0.3s;
}
.printer-card.active { border-color: var(--accent); }
.printer-card.error  { border-color: var(--danger); }
.printer-name {
  font-family: var(--display); font-weight: 700; font-size: 15px; letter-spacing: 1px;
  margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;
}
.printer-status {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; letter-spacing: 1px; text-transform: uppercase;
  padding: 2px 8px; border-radius: 10px;
}
.status-idle     { background: rgba(90,100,128,0.2); color: var(--text-dim); }
.status-printing { background: rgba(0,229,255,0.1);  color: var(--accent); }
.status-error    { background: rgba(255,61,90,0.15); color: var(--danger); }

.progress-wrap { margin: 8px 0 4px; }
.progress-label { display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--text-dim); font-size: 10px; }
.progress-bar { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; }
.progress-fill {
  height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2));
  border-radius: 3px; transition: width 0.5s linear; position: relative;
}
.progress-fill::after {
  content: ''; position: absolute; right: 0; top: 0; width: 4px; height: 100%;
  background: white; opacity: 0.7; border-radius: 2px; box-shadow: 0 0 6px white;
}

.printer-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px; }
.pstat { background: var(--bg); border-radius: 4px; padding: 6px 8px; }
.pstat-label { color: var(--text-dim); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; }
.pstat-value { font-family: var(--display); font-weight: 700; font-size: 15px; color: var(--text-bright); }
.health-bar { height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; margin-top: 6px; }
.health-fill { height: 100%; border-radius: 2px; transition: width 0.5s, background 0.5s; }

/* â”€â”€ ORDER CARDS â”€â”€ */
.order-card {
  background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 12px; cursor: pointer; transition: border-color 0.2s, transform 0.15s;
  position: relative; overflow: hidden;
}
.order-card:hover { border-color: var(--accent); transform: translateY(-1px); }
.order-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; }
.order-pla::before   { background: var(--pla); }
.order-petg::before  { background: var(--petg); }
.order-pa6::before   { background: var(--pa6); }
.order-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
.order-name   { font-family: var(--display); font-weight: 700; font-size: 13px; letter-spacing: 0.5px; }
.order-reward { font-family: var(--display); font-weight: 900; font-size: 18px; color: var(--accent3); }
.order-meta   { display: flex; gap: 8px; flex-wrap: wrap; }
.tag { font-size: 9px; letter-spacing: 1px; text-transform: uppercase; padding: 2px 6px; border-radius: 3px; }
.tag-pla   { background: rgba(79,195,247,0.15);  color: var(--pla);  }
.tag-petg  { background: rgba(206,147,216,0.15); color: var(--petg); }
.tag-pa6   { background: rgba(255,171,64,0.15);  color: var(--pa6);  }
.tag-time  { background: rgba(255,204,0,0.1);    color: var(--warn); }
.tag-diff  { background: rgba(255,61,90,0.1);    color: var(--danger); }
.order-timer      { height: 2px; background: var(--bg); margin-top: 8px; border-radius: 1px; overflow: hidden; }
.order-timer-fill { height: 100%; background: var(--warn); border-radius: 1px; transition: width 1s linear; }
.no-orders { text-align: center; color: var(--text-dim); padding: 30px 0; font-size: 11px; line-height: 1.8; }

/* â”€â”€ CONTRACT CARDS â”€â”€ */
.contract-card {
  background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 12px; position: relative; overflow: hidden;
  transition: border-color 0.2s;
}
.contract-card.daily  { border-color: rgba(255,204,0,0.4); }
.contract-card.active-c { border-color: var(--accent3); }
.contract-card::before {
  content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--warn);
}
.contract-card.regular::before { background: var(--accent2); }
.contract-card.completed-c { opacity: 0.5; pointer-events: none; }
.contract-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
.contract-name { font-family: var(--display); font-weight: 700; font-size: 13px; }
.contract-reward { font-family: var(--display); font-weight: 900; font-size: 18px; color: var(--warn); }
.contract-daily-badge {
  font-size: 9px; letter-spacing: 1px; text-transform: uppercase;
  padding: 2px 6px; border-radius: 3px;
  background: rgba(255,204,0,0.15); color: var(--warn);
  margin-left: 6px;
}
.contract-req { margin: 6px 0; }
.contract-req-item {
  display: flex; align-items: center; gap: 8px; font-size: 10px; margin-bottom: 4px;
}
.contract-req-bar { flex: 1; height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; }
.contract-req-fill { height: 100%; border-radius: 2px; transition: width 0.5s; background: var(--accent3); }
.contract-req-label { color: var(--text-dim); white-space: nowrap; }
.contract-actions { display: flex; gap: 6px; margin-top: 8px; }
.contract-timer { font-size: 10px; color: var(--warn); margin-top: 4px; }

/* â”€â”€ CENTER â”€â”€ */
#center-panel { display: flex; flex-direction: column; gap: 12px; }
.job-display { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; flex: 1; display: flex; flex-direction: column; gap: 12px; }
.job-title { font-family: var(--display); font-weight: 900; font-size: 28px; letter-spacing: 2px; text-transform: uppercase; color: var(--text-bright); }
.job-subtitle { color: var(--text-dim); font-size: 11px; letter-spacing: 1px; }

/* printer visual */
.printer-visual {
  position: relative; height: 160px; background: var(--bg3); border-radius: var(--radius);
  overflow: hidden; display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--border);
}
.print-head {
  position: absolute; top: 30px; width: 40px; height: 8px;
  background: var(--accent); border-radius: 2px;
  box-shadow: 0 0 12px var(--accent), 0 0 4px white;
  transition: left 0.5s ease-in-out;
}
.print-layer {
  position: absolute; bottom: 30px; left: 20px; right: 20px; height: 0;
  background: linear-gradient(0deg, var(--accent2), var(--accent));
  border-radius: 2px; transition: height 0.5s linear; opacity: 0.7;
}
.scan-line { position: absolute; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--accent), transparent); opacity: 0; }
.printing .scan-line { opacity: 1; animation: scan 2s linear infinite; }
@keyframes scan { 0% { top: 20px; } 100% { top: 140px; } }
.nozzle-dot {
  position: absolute; top: 38px; width: 6px; height: 6px;
  background: var(--accent2); border-radius: 50%;
  box-shadow: 0 0 8px var(--accent2);
}

/* job stats */
.job-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 8px; }
.jstat { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; text-align: center; }
.jstat-label { color: var(--text-dim); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
.jstat-value { font-family: var(--display); font-weight: 700; font-size: 20px; color: var(--text-bright); }

/* big progress */
.big-progress-bar { height: 24px; background: var(--bg); border-radius: 12px; overflow: hidden; position: relative; border: 1px solid var(--border); }
.big-progress-fill { height: 100%; background: linear-gradient(90deg,#00b4d8,var(--accent),#00e5ff); background-size: 200%; animation: shimmer 1.5s linear infinite; border-radius: 12px; transition: width 0.5s linear; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.big-progress-text { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: var(--display); font-weight: 700; font-size: 13px; letter-spacing: 1px; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }

/* filament + quality */
.filament-row, .quality-row { display: flex; gap: 6px; }
.filament-btn {
  flex: 1; padding: 8px 6px; border: 1px solid var(--border); background: var(--bg3);
  border-radius: var(--radius); cursor: pointer; text-align: center; transition: all 0.15s;
}
.filament-btn:hover { border-color: var(--accent); }
.filament-btn.selected-pla  { border-color: var(--pla);  background: rgba(79,195,247,0.1);  }
.filament-btn.selected-petg { border-color: var(--petg); background: rgba(206,147,216,0.1); }
.filament-btn.selected-pa6  { border-color: var(--pa6);  background: rgba(255,171,64,0.1);  }
.filament-btn.locked-fil { opacity: 0.3; cursor: not-allowed; }
.fil-name { font-family: var(--display); font-weight: 700; font-size: 13px; }
.fil-pla { color: var(--pla); } .fil-petg { color: var(--petg); } .fil-pa6 { color: var(--pa6); }
.fil-cf   { color: #9ca3af; } .fil-glow { color: #ccff00; }
.fil-stat { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.quality-btn { flex: 1; padding: 8px 6px; border: 1px solid var(--border); background: var(--bg3); border-radius: var(--radius); cursor: pointer; text-align: center; transition: all 0.15s; font-family: var(--mono); font-size: 10px; }
.quality-btn:hover { border-color: var(--accent2); }
.quality-btn.selected { border-color: var(--accent2); background: rgba(255,107,53,0.1); color: var(--accent2); }
.quality-label { font-family: var(--display); font-weight: 700; font-size: 12px; }

/* printer tabs (center) */
.printer-tabs { display: flex; gap: 6px; }
.printer-tab { flex: 1; padding: 7px 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; font-family: var(--display); font-weight: 700; font-size: 12px; letter-spacing: 1px; text-align: center; transition: all 0.15s; color: var(--text-dim); }
.printer-tab:hover { border-color: var(--accent); color: var(--text); }
.printer-tab.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,0.08); }
.printer-tab.active-printing { border-color: var(--accent3); color: var(--accent3); background: rgba(127,255,110,0.06); }
.tab-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
.tab-dot.printing { background: var(--accent3); box-shadow: 0 0 6px var(--accent3); animation: blink 1s infinite; }
.tab-dot.idle { background: var(--text-dim); }
.tab-dot.error { background: var(--danger); }
@keyframes blink { 0%,100%{opacity:1;}50%{opacity:0.3;} }

.mode-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; padding: 3px 8px; border-radius: 3px; display: inline-block; margin-bottom: 6px; }
.mode-configure { background: rgba(255,107,53,0.15); color: var(--accent2); }
.mode-monitor   { background: rgba(0,229,255,0.1);   color: var(--accent); }

/* â”€â”€ SHOP â”€â”€ */
.upgrade-card { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; display: flex; flex-direction: column; gap: 6px; transition: border-color 0.2s; }
.upgrade-card.affordable  { border-color: rgba(0,229,255,0.3); }
.upgrade-card.owned       { border-color: var(--accent3); opacity: 0.7; }
.upgrade-card.locked-upg  { opacity: 0.4; }
.upgrade-card.pro-locked  { border-color: rgba(167,139,250,0.4); opacity: 0.9; }
.upgrade-header { display: flex; justify-content: space-between; align-items: flex-start; }
.upgrade-name   { font-family: var(--display); font-weight: 700; font-size: 14px; letter-spacing: 0.5px; }
.upgrade-cost   { font-family: var(--display); font-weight: 900; font-size: 17px; color: var(--accent3); }
.upgrade-desc   { color: var(--text-dim); font-size: 10px; line-height: 1.5; }
.upgrade-effect { color: var(--accent); font-size: 10px; }
.pro-badge {
  display: inline-block; background: linear-gradient(135deg,var(--pro-dark),var(--pro));
  color: white; font-size: 9px; font-weight: 700; letter-spacing: 1px;
  padding: 2px 7px; border-radius: 10px; text-transform: uppercase;
  box-shadow: 0 0 10px var(--pro-glow);
}

/* biz level */
.biz-level { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; text-align: center; }
.biz-level-name { font-family: var(--display); font-weight: 900; font-size: 20px; color: var(--accent); letter-spacing: 2px; }
.biz-level-sub  { color: var(--text-dim); font-size: 10px; margin-top: 4px; margin-bottom: 8px; }
.biz-xp-bar  { height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
.biz-xp-fill { height: 100%; background: linear-gradient(90deg,var(--accent2),var(--warn)); border-radius: 4px; transition: width 0.5s; }

/* â”€â”€ GRAPH / STATS â”€â”€ */
.graph-container { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; }
.graph-label { font-family: var(--display); font-weight: 700; font-size: 13px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 10px; }
#income-canvas { display: block; width: 100%; border-radius: 4px; }
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.stat-box { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; }
.stat-box-label { color: var(--text-dim); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; }
.stat-box-value { font-family: var(--display); font-weight: 700; font-size: 22px; color: var(--text-bright); }
.stat-box-sub   { font-size: 9px; color: var(--text-dim); margin-top: 2px; }

/* â”€â”€ LOG â”€â”€ */
.log-entry { font-size: 10px; padding: 4px 0; border-bottom: 1px solid rgba(42,48,69,0.5); display: flex; gap: 8px; animation: fadeIn 0.3s ease; }
.log-time   { color: var(--text-dim); white-space: nowrap; }
.log-msg.success{ color: var(--accent3); } .log-msg.error { color: var(--danger); }
.log-msg.warn   { color: var(--warn);    } .log-msg.info  { color: var(--accent); }
.log-msg.money  { color: var(--accent3); } .log-msg.contract { color: var(--warn); }
@keyframes fadeIn { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:translateY(0); } }

/* â”€â”€ POPUPS / MODALS â”€â”€ */
#popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
#popup-overlay.visible { display: flex; }
.popup { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 24px; max-width: 380px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.6); animation: popIn 0.25s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes popIn { from{transform:scale(0.8);opacity:0;}to{transform:scale(1);opacity:1;} }
.popup-title { font-family: var(--display); font-weight: 900; font-size: 22px; margin-bottom: 8px; letter-spacing: 1px; }
.popup-body  { color: var(--text-dim); line-height: 1.6; margin-bottom: 16px; font-size: 11px; }
.popup-actions { display: flex; gap: 8px; justify-content: flex-end; }

/* PRO MODAL */
.pro-modal { border-color: var(--pro); }
.pro-modal .popup-title { color: var(--pro); }
.pro-features { list-style: none; margin: 10px 0; }
.pro-features li { padding: 5px 0; font-size: 11px; color: var(--text); }
.pro-features li::before { content: 'âš¡ '; color: var(--pro); }
.pro-price { font-family: var(--display); font-weight: 900; font-size: 32px; color: var(--pro); text-align: center; margin: 12px 0 4px; }
.pro-price-sub { text-align: center; color: var(--text-dim); font-size: 10px; letter-spacing: 1px; }

/* â”€â”€ ACHIEVEMENT TOAST â”€â”€ */
.achievement-toast {
  position: fixed; bottom: 20px; right: 20px;
  background: var(--panel); border: 1px solid var(--accent3); border-radius: var(--radius);
  padding: 12px 16px; z-index: 300; box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 20px rgba(127,255,110,0.2);
  animation: toastIn 0.4s cubic-bezier(0.34,1.56,0.64,1); max-width: 280px;
}
@keyframes toastIn { from{transform:translateX(100px);opacity:0;}to{transform:translateX(0);opacity:1;} }
.achievement-toast .ach-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent3); margin-bottom: 4px; }
.achievement-toast .ach-name  { font-family: var(--display); font-weight: 700; font-size: 15px; color: var(--text-bright); }
.achievement-toast .ach-desc  { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

/* CONTRACT TOAST */
.contract-toast {
  position: fixed; bottom: 20px; left: 20px;
  background: var(--panel); border: 1px solid var(--warn); border-radius: var(--radius);
  padding: 12px 16px; z-index: 300; box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 20px rgba(255,204,0,0.2);
  animation: toastInLeft 0.4s cubic-bezier(0.34,1.56,0.64,1); max-width: 280px;
}
@keyframes toastInLeft { from{transform:translateX(-100px);opacity:0;}to{transform:translateX(0);opacity:1;} }

/* â”€â”€ BUTTONS â”€â”€ */
.btn { padding: 8px 14px; border: none; border-radius: var(--radius); cursor: pointer; font-family: var(--mono); font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; transition: all 0.15s; }
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--accent); color: var(--bg); box-shadow: 0 0 16px rgba(0,229,255,0.3); }
.btn-primary:hover { background: #33ecff; box-shadow: 0 0 24px rgba(0,229,255,0.5); }
.btn-primary:disabled { background: var(--bg3); color: var(--text-dim); cursor: not-allowed; box-shadow: none; }
.btn-danger { background: var(--danger); color: white; }
.btn-warn   { background: var(--warn);   color: var(--bg); }
.btn-ghost  { background: var(--bg3); color: var(--text-dim); border: 1px solid var(--border); }
.btn-ghost:hover { color: var(--text); border-color: var(--text-dim); }
.btn-sm   { padding: 5px 10px; font-size: 10px; }
.btn-full { width: 100%; text-align: center; }

/* â”€â”€ FAILURE ANIMATION â”€â”€ */
#fail-flash { position: fixed; inset: 0; background: rgba(255,30,60,0); pointer-events: none; z-index: 500; }
#fail-flash.flashing { animation: failFlashAnim 0.7s ease-out forwards; }
@keyframes failFlashAnim { 0%{background:rgba(255,30,60,0);}10%{background:rgba(255,30,60,0.35);}30%{background:rgba(255,30,60,0.22);}60%{background:rgba(255,30,60,0.10);}100%{background:rgba(255,30,60,0);} }
@keyframes printerShake { 0%{transform:translateX(0);}15%{transform:translateX(-7px) rotate(-1.5deg);}30%{transform:translateX(7px) rotate(1.5deg);}45%{transform:translateX(-5px) rotate(-1deg);}60%{transform:translateX(5px) rotate(1deg);}75%{transform:translateX(-3px);}90%{transform:translateX(3px);}100%{transform:translateX(0);} }
.printer-card.shaking { animation: printerShake 0.5s ease-out; }
.spaghetti-overlay { position: absolute; inset: 0; background: rgba(13,15,20,0.88); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; border-radius: var(--radius); animation: fadeIn 0.3s ease; }
.spaghetti-text { font-family: var(--display); font-weight: 900; font-size: 22px; color: var(--danger); letter-spacing: 3px; text-shadow: 0 0 20px rgba(255,61,90,0.8); margin-top: 8px; }
.spaghetti-sub  { font-size: 10px; color: var(--text-dim); margin-top: 4px; letter-spacing: 1px; }
@keyframes successPulse { 0%{box-shadow:inset 0 0 0 0 rgba(127,255,110,0);}30%{box-shadow:inset 0 0 0 3px rgba(127,255,110,0.6);}100%{box-shadow:inset 0 0 0 0 rgba(127,255,110,0);} }
.printer-visual.success-pulse { animation: successPulse 0.8s ease-out; }

/* â”€â”€ MISC â”€â”€ */
.idle-ticker { position: fixed; pointer-events: none; font-family: var(--display); font-weight: 900; font-size: 18px; color: var(--accent3); text-shadow: 0 0 10px var(--accent3); z-index: 400; animation: tickerFloat 1.2s ease-out forwards; }
@keyframes tickerFloat { 0%{opacity:1;transform:translateY(0);}100%{opacity:0;transform:translateY(-50px);} }
@keyframes glow-pulse { 0%{box-shadow:0 0 0 0 rgba(127,255,110,0.6);}70%{box-shadow:0 0 0 12px rgba(127,255,110,0);}100%{box-shadow:0 0 0 0 rgba(127,255,110,0);} }
.money-gained { animation: glow-pulse 0.6s ease-out; }
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* active-effect banners */
.effect-banner { display: flex; gap: 6px; flex-wrap: wrap; }
.effect-tag { font-size: 9px; letter-spacing: 1px; padding: 3px 8px; border-radius: 3px; animation: fadeIn 0.3s; }
.effect-bulk  { background: rgba(127,255,110,0.12); color: var(--accent3); border: 1px solid rgba(127,255,110,0.2); }
.effect-disc  { background: rgba(0,229,255,0.1);   color: var(--accent);  border: 1px solid rgba(0,229,255,0.2); }
.effect-warn  { background: rgba(255,61,90,0.1);   color: var(--danger);  border: 1px solid rgba(255,61,90,0.2); }

@media (max-width: 1100px) { #main { grid-template-columns: 260px 1fr 260px; } }
@media (max-width: 900px)  { #main { grid-template-columns: 1fr; } }

/* â”€â”€ MARKET TICKER â”€â”€ */
.market-bar {
  display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
  padding: 4px 16px; background: rgba(13,15,20,0.8);
  border-bottom: 1px solid var(--border); font-size: 10px;
}
.market-pill {
  display: flex; align-items: center; gap: 5px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 12px; padding: 2px 10px;
  font-family: var(--display); font-weight: 700; font-size: 12px;
  transition: all 0.5s;
}
.market-pill .m-label { color: var(--text-dim); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; font-family: var(--mono); }
.market-up   { color: var(--accent3); }
.market-down { color: var(--danger); }
.market-flat { color: var(--text); }
.market-arrow { font-size: 10px; }
#market-label { color: var(--text-dim); font-size: 9px; letter-spacing: 1px; text-transform: uppercase; }

/* â”€â”€ TUTORIAL OVERLAY â”€â”€ */
#tutorial-overlay {
  position: fixed; inset: 0; z-index: 999; pointer-events: none;
}
.tut-spotlight {
  position: absolute; background: rgba(0,229,255,0.08);
  border: 2px solid var(--accent); border-radius: 8px;
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.55), 0 0 30px rgba(0,229,255,0.3);
  pointer-events: none;
  transition: all 0.4s cubic-bezier(0.34,1.2,0.64,1);
  animation: tutPulse 1.5s ease-in-out infinite;
}
@keyframes tutPulse { 0%,100%{box-shadow:0 0 0 9999px rgba(0,0,0,0.55),0 0 20px rgba(0,229,255,0.2);} 50%{box-shadow:0 0 0 9999px rgba(0,0,0,0.55),0 0 40px rgba(0,229,255,0.5);} }
.tut-tooltip {
  position: absolute; background: var(--panel); border: 1px solid var(--accent);
  border-radius: 10px; padding: 14px 18px; max-width: 260px; pointer-events: all;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6);
  animation: popIn 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
.tut-tooltip::before {
  content: ''; position: absolute; width: 10px; height: 10px;
  background: var(--accent); border-radius: 2px;
  top: -6px; left: 20px; transform: rotate(45deg);
}
.tut-step { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); margin-bottom: 6px; }
.tut-title { font-family: var(--display); font-weight: 900; font-size: 18px; color: var(--text-bright); margin-bottom: 6px; }
.tut-body { font-size: 11px; color: var(--text-dim); line-height: 1.6; margin-bottom: 12px; }
.tut-actions { display: flex; justify-content: space-between; align-items: center; }
.tut-skip { font-size: 10px; color: var(--text-dim); cursor: pointer; border: none; background: none; font-family: var(--mono); }
.tut-skip:hover { color: var(--text); }

/* â”€â”€ KEYBOARD HINTS â”€â”€ */
.kbd {
  display: inline-block; background: var(--bg3); border: 1px solid var(--border);
  border-radius: 4px; padding: 1px 6px; font-family: var(--mono);
  font-size: 9px; color: var(--text-dim); vertical-align: middle;
}
#kbd-hint {
  position: fixed; bottom: 16px; right: 16px; z-index: 100;
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 8px; padding: 10px 14px;
  font-size: 10px; color: var(--text-dim);
  opacity: 0; transition: opacity 0.3s;
  pointer-events: none;
}
#kbd-hint.visible { opacity: 1; }
.kbd-row { display: flex; gap: 8px; align-items: center; margin-bottom: 4px; }

/* â”€â”€ AUTO-SAVE INDICATOR â”€â”€ */
#save-indicator {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 9px; letter-spacing: 1px; color: var(--text-dim);
  opacity: 0; transition: opacity 0.4s;
  padding: 4px 8px; background: var(--bg3); border-radius: 4px;
  border: 1px solid var(--border);
}
#save-indicator.visible { opacity: 1; }
#save-indicator.saving { color: var(--accent3); border-color: rgba(127,255,110,0.3); }

/* â”€â”€ SETTINGS TAB â”€â”€ */
.settings-section { display: flex; flex-direction: column; gap: 10px; }
.settings-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 10px 12px; background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius);
}
.settings-label { font-family: var(--display); font-weight: 700; font-size: 13px; }
.settings-sub { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.settings-danger-zone {
  background: rgba(255,61,90,0.06); border: 1px solid rgba(255,61,90,0.25);
  border-radius: var(--radius); padding: 12px;
}
.settings-danger-title { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--danger); margin-bottom: 8px; }

/* â”€â”€ MARKET BONUS BADGE on order card â”€â”€ */
.market-bonus { font-size: 9px; padding: 1px 5px; border-radius: 3px; background: rgba(127,255,110,0.15); color: var(--accent3); font-family: var(--mono); margin-left: 4px; }
.market-malus { background: rgba(255,61,90,0.12); color: var(--danger); }

/* â”€â”€ STREAK COUNTER â”€â”€ */
.streak-pill {
  display: flex; align-items: center; gap: 6px;
  background: linear-gradient(135deg, rgba(255,204,0,0.12), rgba(255,107,53,0.08));
  border: 1px solid rgba(255,204,0,0.3);
  border-radius: 20px; padding: 5px 14px;
  font-family: var(--display); font-weight: 700; font-size: 16px;
}
.streak-pill .label { color: var(--text-dim); font-size: 10px; font-weight: 300; letter-spacing: 1px; text-transform: uppercase; }
#streak-val { color: var(--warn); }

/* â”€â”€ NIGHT MODE indicator â”€â”€ */
.night-badge {
  font-size: 9px; padding: 2px 8px; border-radius: 10px;
  background: rgba(167,139,250,0.15); color: var(--pro);
  border: 1px solid rgba(167,139,250,0.3); letter-spacing: 1px;
  text-transform: uppercase; display: none;
}
.night-badge.active { display: inline-block; }

/* â”€â”€ PRINTER SKINS â”€â”€ */
.skin-midnight .print-head { background: var(--pro) !important; box-shadow: 0 0 12px var(--pro) !important; }
.skin-midnight .print-layer { background: linear-gradient(0deg, var(--pro-dark), var(--pro)) !important; }
.skin-midnight #printer-visual { border-color: rgba(167,139,250,0.4) !important; background: #0f0a1f !important; }
.skin-lava .print-head { background: var(--danger) !important; box-shadow: 0 0 12px var(--danger) !important; }
.skin-lava .print-layer { background: linear-gradient(0deg, #8b0000, var(--danger)) !important; }
.skin-lava #printer-visual { border-color: rgba(255,61,90,0.4) !important; background: #1a0808 !important; }
.skin-forest .print-head { background: var(--accent3) !important; box-shadow: 0 0 12px var(--accent3) !important; }
.skin-forest .print-layer { background: linear-gradient(0deg, #1a4020, var(--accent3)) !important; }
.skin-forest #printer-visual { border-color: rgba(127,255,110,0.4) !important; background: #080f08 !important; }
.skin-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; border: 2px solid rgba(255,255,255,0.15); cursor: pointer; transition: transform 0.15s; }
.skin-dot:hover { transform: scale(1.3); }
.skin-dot.active-skin { outline: 2px solid white; outline-offset: 2px; }
.skin-selector { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
.skin-label { font-size: 9px; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; }

/* â”€â”€ BREAKDOWN MINI-GAME â”€â”€ */
#minigame-overlay {
  position: fixed; inset: 0; z-index: 600;
  background: rgba(0,0,0,0.88); backdrop-filter: blur(8px);
  display: none; align-items: center; justify-content: center;
}
#minigame-overlay.active { display: flex; }
.minigame-box {
  background: var(--panel); border: 2px solid var(--danger);
  border-radius: 12px; padding: 28px 32px; max-width: 420px; width: 90%;
  box-shadow: 0 0 60px rgba(255,61,90,0.3);
  animation: popIn 0.3s cubic-bezier(0.34,1.56,0.64,1); text-align: center;
}
.mg-title { font-family: var(--display); font-weight: 900; font-size: 26px; color: var(--danger); letter-spacing: 2px; margin-bottom: 6px; }
.mg-sub { color: var(--text-dim); font-size: 11px; margin-bottom: 20px; line-height: 1.6; }
.mg-sequence { display: flex; gap: 8px; justify-content: center; margin-bottom: 18px; min-height: 40px; align-items: center; flex-wrap: wrap; }
.mg-key { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 2px solid var(--border); background: var(--bg3); }
.mg-buttons { display: flex; gap: 14px; justify-content: center; margin-bottom: 18px; }
.mg-btn { width: 68px; height: 68px; border-radius: 14px; border: 2px solid var(--border); cursor: pointer; font-size: 26px; transition: all 0.1s; display: flex; align-items: center; justify-content: center; background: var(--bg3); }
.mg-btn:active, .mg-btn.pressed { transform: scale(0.88); filter: brightness(1.5); }
.mg-timer-bar { height: 6px; background: var(--bg3); border-radius: 3px; overflow: hidden; margin-bottom: 14px; border: 1px solid var(--border); }
.mg-timer-fill { height: 100%; background: linear-gradient(90deg, var(--accent3), var(--warn), var(--danger)); border-radius: 3px; transition: width 0.1s linear; }
.mg-progress { font-size: 10px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 6px; }
.mg-feedback { font-family: var(--display); font-weight: 900; font-size: 16px; min-height: 22px; margin-bottom: 4px; }

/* â”€â”€ CUSTOMER QUOTE TOAST â”€â”€ */
.quote-toast {
  position: fixed; top: 76px; left: 50%; transform: translateX(-50%);
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 10px; padding: 10px 20px; z-index: 350;
  max-width: 360px; width: 90%; pointer-events: none;
  animation: quoteSlide 0.4s cubic-bezier(0.34,1.4,0.64,1) forwards;
}
@keyframes quoteSlide { from{opacity:0;transform:translateX(-50%) translateY(-16px);}to{opacity:1;transform:translateX(-50%) translateY(0);} }
.quote-toast .q-name { font-family: var(--display); font-weight: 700; font-size: 12px; color: var(--accent); margin-bottom: 4px; letter-spacing: 1px; }
.quote-toast .q-text { font-size: 11px; color: var(--text-dim); font-style: italic; line-height: 1.5; }

/* â”€â”€ URGENT ORDER PULSE â”€â”€ */
@keyframes urgentPulse {
  0%,100% { border-color: var(--danger); box-shadow: 0 0 0 0 rgba(255,61,90,0.5), inset 0 0 0 0 rgba(255,61,90,0); }
  50%     { border-color: #ff7090;       box-shadow: 0 0 8px 2px rgba(255,61,90,0.2), inset 0 0 8px rgba(255,61,90,0.05); }
}
.order-card.urgent-card { animation: urgentPulse 1s ease-in-out infinite; }

/* â”€â”€ LEADERBOARD â”€â”€ */
#tab-leaderboard { overflow-y: auto; }
.lb-row { display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 6px; }
.lb-rank { font-family: var(--display); font-weight: 900; font-size: 20px; color: var(--text-dim); width: 30px; text-align: center; }
.lb-rank.gold   { color: #ffd700; text-shadow: 0 0 8px rgba(255,215,0,0.5); }
.lb-rank.silver { color: #c0c0c0; }
.lb-rank.bronze { color: #cd7f32; }
.lb-name  { flex: 1; }
.lb-name-main { font-family: var(--display); font-weight: 700; font-size: 14px; color: var(--text-bright); }
.lb-name-sub  { font-size: 9px; color: var(--text-dim); margin-top: 1px; }
.lb-score { text-align: right; }
.lb-score-val { font-family: var(--display); font-weight: 900; font-size: 16px; color: var(--accent3); }
.lb-score-sub { font-size: 9px; color: var(--text-dim); }
.lb-you   { border-color: var(--accent); background: rgba(0,229,255,0.06); }
.lb-empty { text-align: center; color: var(--text-dim); padding: 24px 0; font-size: 11px; line-height: 1.8; }

/* â”€â”€ LOYALTY BADGE â”€â”€ */
.loyalty-badge { font-size: 9px; padding: 1px 6px; border-radius: 3px; background: rgba(255,204,0,0.15); color: var(--warn); margin-left: 4px; vertical-align: middle; }

/* â”€â”€ PIE CHART â”€â”€ */
#pie-canvas { display: block; margin: 0 auto; }
.pie-legend { display: flex; gap: 14px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
.pie-legend-item { display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--text-dim); }
.pie-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }

/* â”€â”€ NOTIFICATION BELL â”€â”€ */
.notif-btn { width: 34px; height: 34px; background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 15px; transition: all 0.15s; position: relative; }
.notif-btn:hover { border-color: var(--accent); }
.notif-dot { position: absolute; top: 4px; right: 4px; width: 6px; height: 6px; border-radius: 50%; background: var(--danger); display: none; }
.notif-btn.has-notif .notif-dot { display: block; animation: blink 1s infinite; }

/* â”€â”€ COMBO SYSTEM â”€â”€ */
#combo-display {
  position: fixed; top: 70px; right: 20px; z-index: 400;
  font-family: var(--display); font-weight: 900;
  pointer-events: none; text-align: right;
}
.combo-number {
  font-size: 48px; line-height: 1;
  background: linear-gradient(135deg, var(--warn), var(--accent2));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  filter: drop-shadow(0 0 12px rgba(255,204,0,0.6));
  animation: comboPop 0.3s cubic-bezier(0.34,1.8,0.64,1);
}
@keyframes comboPop { 0%{transform:scale(0.6);}100%{transform:scale(1);} }
.combo-label { font-size: 11px; color: var(--warn); letter-spacing: 3px; text-transform: uppercase; margin-top: -4px; }
.combo-mult  { font-size: 14px; color: var(--accent3); letter-spacing: 1px; }
.combo-bar-wrap { width: 80px; height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-left: auto; margin-top: 4px; overflow: hidden; }
.combo-bar-fill { height: 100%; background: linear-gradient(90deg,var(--warn),var(--accent2)); border-radius: 2px; transition: width 0.1s linear; }

/* â”€â”€ DAILY GOALS â”€â”€ */
.goal-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 10px 12px;
  display: flex; align-items: center; gap: 10px;
}
.goal-card.goal-done { border-color: var(--accent3); opacity: 0.7; }
.goal-icon { font-size: 20px; flex-shrink: 0; }
.goal-info { flex: 1; min-width: 0; }
.goal-name { font-family: var(--display); font-weight: 700; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.goal-desc { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.goal-progress { margin-top: 5px; }
.goal-prog-bar { height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; }
.goal-prog-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--accent), var(--accent3)); transition: width 0.4s; }
.goal-prog-text { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.goal-reward { font-family: var(--display); font-weight: 900; font-size: 15px; color: var(--warn); flex-shrink: 0; }
.goal-done-check { font-size: 18px; flex-shrink: 0; }

/* â”€â”€ SPEEDRUN MODE â”€â”€ */
#speedrun-bar {
  display: none; align-items: center; justify-content: space-between;
  padding: 6px 16px; background: rgba(255,61,90,0.12);
  border-bottom: 1px solid rgba(255,61,90,0.3); gap: 12px;
}
#speedrun-bar.active { display: flex; }
.sr-timer { font-family: var(--display); font-weight: 900; font-size: 22px; color: var(--danger); letter-spacing: 2px; }
.sr-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--danger); }
.sr-score { font-family: var(--display); font-weight: 700; font-size: 15px; color: var(--warn); }
.sr-end-btn { font-family: var(--mono); font-size: 10px; padding: 4px 10px; border: 1px solid var(--danger); background: transparent; color: var(--danger); border-radius: var(--radius); cursor: pointer; }
.sr-end-btn:hover { background: rgba(255,61,90,0.15); }

/* â”€â”€ ACHIEVEMENT PROGRESS â”€â”€ */
.achiev-card {
  padding: 10px 12px; background: var(--bg3);
  border: 1px solid var(--border); border-radius: var(--radius);
  margin-bottom: 8px; transition: border-color 0.2s;
}
.achiev-card.unlocked { border-color: var(--accent3); }
.achiev-card.locked   { opacity: 0.5; }
.achiev-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
.achiev-icon  { font-size: 18px; }
.achiev-title { font-family: var(--display); font-weight: 700; font-size: 14px; }
.achiev-desc  { font-size: 10px; color: var(--text-dim); margin-bottom: 4px; }
.achiev-prog-bar { height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; }
.achiev-prog-fill { height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--accent2), var(--warn)); }
.achiev-prog-text { font-size: 9px; color: var(--text-dim); margin-top: 3px; text-align: right; }

/* â”€â”€ SEASON BANNER â”€â”€ */
#season-banner {
  display: none; align-items: center; gap: 10px;
  padding: 6px 16px; border-bottom: 1px solid var(--border);
  font-size: 11px; animation: fadeIn 0.5s;
}
#season-banner.active { display: flex; }
.season-icon { font-size: 18px; }
.season-text { flex: 1; }
.season-name { font-family: var(--display); font-weight: 700; font-size: 14px; }
.season-effect { color: var(--text-dim); font-size: 10px; }

/* â”€â”€ SMART TIP â”€â”€ */
#smart-tip {
  position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%);
  background: var(--panel); border: 1px solid var(--accent);
  border-radius: 10px; padding: 10px 18px; z-index: 300;
  max-width: 380px; width: 90%; pointer-events: none; display: none;
  animation: tipSlide 0.4s cubic-bezier(0.34,1.4,0.64,1) forwards;
}
@keyframes tipSlide { from{opacity:0;transform:translateX(-50%) translateY(12px);}to{opacity:1;transform:translateX(-50%) translateY(0);} }
#smart-tip.visible { display: block; }
.tip-label { font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--accent); margin-bottom: 4px; }
.tip-text  { font-size: 11px; color: var(--text); line-height: 1.5; }

/* â”€â”€ PRINTER RENAME â”€â”€ */
.printer-name-btn { background: none; border: none; cursor: pointer; font-size: 10px; color: var(--text-dim); padding: 0 4px; transition: color 0.15s; }
.printer-name-btn:hover { color: var(--accent); }
.printer-name-input { background: var(--bg); border: 1px solid var(--accent); border-radius: 4px; color: var(--text-bright); font-family: var(--display); font-weight: 700; font-size: 14px; padding: 2px 6px; width: 120px; }

/* â”€â”€ DYNAMIC BACKGROUND â”€â”€ */
body.level-5  { background-image: radial-gradient(ellipse 80% 40% at 50% -10%, rgba(0,229,255,0.09) 0%, transparent 70%), repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px), repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px); }
body.level-6  { background-image: radial-gradient(ellipse 80% 40% at 50% -10%, rgba(167,139,250,0.1) 0%, transparent 70%), repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px), repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px); }
body.level-7  { background-image: radial-gradient(ellipse 80% 40% at 50% -10%, rgba(255,107,53,0.1) 0%, transparent 70%), repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px), repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px); }
body.level-8  { background-image: radial-gradient(ellipse 100% 60% at 50% -10%, rgba(127,255,110,0.12) 0%, rgba(255,204,0,0.04) 50%, transparent 70%), repeating-linear-gradient(0deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px), repeating-linear-gradient(90deg, transparent, transparent 39px, rgba(42,48,69,0.3) 39px, rgba(42,48,69,0.3) 40px); }

/* â”€â”€ PRESTIGE SYSTEM â”€â”€ */
.prestige-btn {
  background: linear-gradient(135deg,#7c2d12,#ea580c,#fbbf24);
  border: none; border-radius: var(--radius); color: white;
  font-family: var(--mono); font-weight: 700; font-size: 11px;
  letter-spacing: 1px; text-transform: uppercase; padding: 8px 16px;
  cursor: pointer; width: 100%; margin-top: 8px;
  box-shadow: 0 0 20px rgba(234,88,12,0.4); transition: all 0.2s;
}
.prestige-btn:hover { box-shadow: 0 0 32px rgba(234,88,12,0.6); transform: translateY(-1px); }
.prestige-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
.prestige-badge {
  display: inline-flex; align-items: center; gap: 4px;
  background: linear-gradient(135deg,rgba(124,45,18,0.3),rgba(251,191,36,0.15));
  border: 1px solid rgba(251,191,36,0.4); border-radius: 12px;
  padding: 3px 10px; font-size: 10px; color: #fbbf24;
  font-family: var(--display); font-weight: 700;
}
#prestige-pill { display: none; }
#prestige-pill.active { display: flex; }

/* â”€â”€ PRINTER SPECIALIZATION â”€â”€ */
.spec-btn { flex: 1; padding: 6px 4px; border: 1px solid var(--border); background: var(--bg3); border-radius: var(--radius); cursor: pointer; font-size: 9px; letter-spacing: 0.5px; text-transform: uppercase; color: var(--text-dim); transition: all 0.15s; text-align: center; font-family: var(--mono); }
.spec-btn:hover { border-color: var(--accent); color: var(--text); }
.spec-btn.active-spec { font-weight: 700; }
.spec-speed   { border-color: var(--accent3) !important; color: var(--accent3) !important; background: rgba(127,255,110,0.08) !important; }
.spec-quality { border-color: var(--pro) !important;    color: var(--pro) !important;    background: rgba(167,139,250,0.08) !important; }
.spec-economy { border-color: var(--warn) !important;   color: var(--warn) !important;   background: rgba(255,204,0,0.08) !important; }
.spec-tag { font-size: 8px; padding: 1px 5px; border-radius: 3px; margin-left: 4px; vertical-align: middle; }
.spec-tag-speed   { background: rgba(127,255,110,0.15); color: var(--accent3); }
.spec-tag-quality { background: rgba(167,139,250,0.15); color: var(--pro); }
.spec-tag-economy { background: rgba(255,204,0,0.15);  color: var(--warn); }

/* â”€â”€ ACHIEVEMENT PROGRESS CARDS â”€â”€ */
.achiev-card { padding:10px 12px; background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:8px; transition:border-color 0.2s; }
.achiev-card.unlocked { border-color:var(--accent3); }
.achiev-card.locked   { opacity:0.5; }
.achiev-header { display:flex; align-items:center; gap:8px; margin-bottom:4px; }
.achiev-icon  { font-size:18px; }
.achiev-title-text { font-family:var(--display); font-weight:700; font-size:13px; flex:1; }
.achiev-desc  { font-size:10px; color:var(--text-dim); margin-bottom:5px; line-height:1.4; }
.achiev-prog-bar  { height:4px; background:var(--bg); border-radius:2px; overflow:hidden; }
.achiev-prog-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--accent2),var(--warn)); }
.achiev-prog-text { font-size:9px; color:var(--text-dim); margin-top:2px; text-align:right; }

/* â”€â”€ RENAME INPUT â”€â”€ */
.printer-name-editable { cursor: pointer; border-bottom: 1px dashed var(--text-dim); transition: border-color 0.15s; }
.printer-name-editable:hover { border-color: var(--accent); color: var(--accent); }

/* â”€â”€ MOBILE RESPONSIVE â”€â”€ */
@media (max-width: 768px) {
  #main { grid-template-columns: 1fr !important; padding: 8px; gap: 8px; }
  #topbar { height: auto; padding: 8px 12px; gap: 8px; flex-wrap: wrap; }
  .logo { font-size: 17px; }
  .market-bar { padding: 4px 10px; gap: 4px; overflow-x: auto; white-space: nowrap; flex-wrap: nowrap; }
  #main > div:nth-child(1) { order: 2; }
  #center-panel { order: 1; }
  #main > div:nth-child(3) { order: 3; }
  .job-title { font-size: 20px; }
  .printer-visual { height: 110px; }
  .panel-body { padding: 8px; }
  .topbar-right { gap: 4px; }
  .btn-sm { padding: 4px 8px; font-size: 9px; }
  .stat-pill { padding: 4px 10px; font-size: 13px; }
  .streak-pill { padding: 4px 10px; font-size: 13px; }
}

/* â”€â”€ NIEUWS-TICKER â”€â”€ */
#news-ticker {
  background: rgba(0,229,255,0.04); border-bottom: 1px solid var(--border);
  padding: 5px 0; overflow: hidden; white-space: nowrap;
  font-size: 10px; color: var(--text-dim); position: relative;
}
.ticker-inner { display: inline-block; animation: tickerScroll 50s linear infinite; padding-left: 100%; }
@keyframes tickerScroll { 0%{transform:translateX(0);}100%{transform:translateX(-100%);} }
.ticker-item { display: inline-block; margin-right: 80px; }
.ticker-item span { color: var(--accent); }

/* â”€â”€ PRINT WACHTRIJ â”€â”€ */
.queue-slot { display:flex; align-items:center; gap:8px; padding:6px 10px; background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:4px; transition:all 0.2s; }
.queue-slot.filled { border-color:rgba(0,229,255,0.3); }
.queue-slot-num { font-family:var(--display); font-weight:900; font-size:16px; color:var(--text-dim); width:20px; }
.queue-slot-name { flex:1; font-size:11px; }
.queue-slot-fil { font-size:9px; padding:1px 6px; border-radius:3px; }
.queue-slot-remove { background:none; border:none; cursor:pointer; color:var(--text-dim); font-size:14px; padding:0 4px; }
.queue-slot-remove:hover { color:var(--danger); }

/* â”€â”€ MEDEWERKERS â”€â”€ */
.employee-card { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius); padding:10px 12px; margin-bottom:8px; }
.employee-card.hired { border-color:rgba(0,229,255,0.3); }
.employee-header { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
.employee-avatar { font-size:22px; }
.employee-name { font-family:var(--display); font-weight:700; font-size:14px; flex:1; }
.employee-wage { font-size:10px; color:var(--text-dim); }
.employee-desc { font-size:10px; color:var(--text-dim); line-height:1.5; margin-bottom:6px; }
.employee-status { font-size:9px; letter-spacing:1px; text-transform:uppercase; }
.employee-status.working { color:var(--accent3); }
.employee-status.idle    { color:var(--text-dim); }

/* â”€â”€ LOOTBOX / PRINT TOKENS â”€â”€ */
.token-pill { display:flex; align-items:center; gap:6px; background:var(--bg3); border:1px solid rgba(251,191,36,0.3); border-radius:20px; padding:4px 12px; font-family:var(--display); font-weight:700; font-size:15px; color:#fbbf24; }
.lootbox-card { background:linear-gradient(135deg,rgba(124,45,18,0.2),rgba(251,191,36,0.08)); border:1px solid rgba(251,191,36,0.3); border-radius:var(--radius); padding:14px; text-align:center; margin-bottom:8px; }
.lootbox-icon { font-size:36px; margin-bottom:6px; }
.lootbox-name { font-family:var(--display); font-weight:900; font-size:18px; color:#fbbf24; }
.lootbox-cost { font-size:11px; color:var(--text-dim); margin:4px 0 10px; }

/* â”€â”€ PRODUCTIEKETENS â”€â”€ */
.chain-card { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius); padding:10px 12px; margin-bottom:8px; }
.chain-header { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
.chain-name { font-family:var(--display); font-weight:700; font-size:14px; flex:1; }
.chain-steps { display:flex; align-items:center; gap:6px; flex-wrap:wrap; margin-bottom:6px; }
.chain-step { display:flex; align-items:center; gap:4px; font-size:10px; }
.chain-arrow { color:var(--text-dim); }
.chain-progress { height:4px; background:var(--bg); border-radius:2px; overflow:hidden; margin-bottom:4px; }
.chain-prog-fill { height:100%; background:linear-gradient(90deg,var(--pla),var(--petg),var(--pa6)); border-radius:2px; transition:width 0.5s; }
.chain-reward { font-family:var(--display); font-weight:900; font-size:14px; color:var(--accent3); }

/* â”€â”€ v9: RIVAL COMPETITOR â”€â”€ */
.rival-banner {
  display: none; align-items: center; justify-content: space-between;
  padding: 6px 16px; background: rgba(255,61,90,0.08);
  border-bottom: 1px solid rgba(255,61,90,0.25); gap: 12px; font-size: 11px;
}
.rival-banner.active { display: flex; }
.rival-name { font-family: var(--display); font-weight: 900; font-size: 14px; color: var(--danger); }
.rival-score { font-family: var(--display); font-weight: 700; color: var(--warn); }
.rival-steal { animation: rivalSteal 0.4s ease; }
@keyframes rivalSteal { 0%{background:rgba(255,61,90,0.3);}100%{background:transparent;} }

/* â”€â”€ v9: LOAN SYSTEM â”€â”€ */
.loan-card {
  background: linear-gradient(135deg,rgba(255,61,90,0.08),rgba(255,204,0,0.04));
  border: 1px solid rgba(255,61,90,0.3); border-radius: var(--radius); padding: 12px; margin-bottom:8px;
}
.loan-interest { color: var(--danger); font-size: 10px; }
.loan-due { font-family: var(--display); font-weight: 700; color: var(--warn); font-size: 16px; }

/* â”€â”€ v9: DEMAND SURGE â”€â”€ */
.surge-banner {
  display: none; align-items: center; gap: 12px; padding: 8px 16px;
  background: linear-gradient(90deg,rgba(127,255,110,0.08),rgba(0,229,255,0.06));
  border-bottom: 1px solid rgba(127,255,110,0.3); font-size: 11px;
}
.surge-banner.active { display: flex; }
.surge-name { font-family: var(--display); font-weight: 900; font-size: 15px; color: var(--accent3); }
.surge-progress { flex: 1; }
.surge-bar { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin-top: 3px; }
.surge-fill { height: 100%; background: linear-gradient(90deg, var(--accent3), var(--accent)); border-radius: 3px; transition: width 0.5s; }
.surge-reward { font-family: var(--display); font-weight: 900; color: var(--warn); font-size: 14px; }
.surge-timer { color: var(--danger); font-size: 10px; }

/* â”€â”€ v9: CLOG MINIGAME â”€â”€ */
#clog-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75);
  z-index: 9100; align-items: center; justify-content: center; backdrop-filter: blur(4px);
}
#clog-overlay.active { display: flex; }
.clog-box {
  background: var(--panel); border: 2px solid var(--danger); border-radius: 10px;
  padding: 24px; width: 320px; text-align: center;
  box-shadow: 0 0 40px rgba(255,61,90,0.4);
}
.clog-title { font-family: var(--display); font-weight: 900; font-size: 22px; color: var(--danger); letter-spacing: 2px; margin-bottom: 6px; }
.clog-desc  { font-size: 10px; color: var(--text-dim); margin-bottom: 16px; line-height: 1.5; }
.clog-mash  { display: flex; justify-content: center; gap: 12px; margin: 14px 0; }
.clog-mash-btn {
  width: 70px; height: 70px; border-radius: 50%; border: 3px solid var(--danger);
  background: rgba(255,61,90,0.1); cursor: pointer; font-size: 28px;
  transition: all 0.1s; box-shadow: 0 0 16px rgba(255,61,90,0.3);
}
.clog-mash-btn:active { transform: scale(0.88); background: rgba(255,61,90,0.3); }
.clog-timer-bar { height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; margin: 8px 0; }
.clog-timer-fill { height: 100%; background: var(--danger); border-radius: 3px; transition: width 0.1s linear; }
.clog-progress-text { font-family: var(--display); font-weight: 700; font-size: 18px; color: var(--text-bright); margin: 8px 0; }

/* â”€â”€ v9: POWER OUTAGE â”€â”€ */
.outage-flash { position: fixed; inset: 0; background: black; z-index: 9050; pointer-events: none; opacity: 0; animation: outageFlash 1.5s ease forwards; }
@keyframes outageFlash { 0%{opacity:0;}10%{opacity:0.95;}40%{opacity:0.7;}70%{opacity:0.3;}100%{opacity:0;} }

/* â”€â”€ v9: SABOTAGE â”€â”€ */
.sabotage-toast {
  position: fixed; top: 70px; right: 16px; z-index: 9999;
  background: linear-gradient(135deg,rgba(255,61,90,0.2),rgba(124,45,18,0.15));
  border: 1px solid var(--danger); border-radius: 8px; padding: 10px 16px;
  max-width: 260px; animation: slideInRight 0.4s ease;
}
@keyframes slideInRight { from{transform:translateX(40px);opacity:0;}to{transform:translateX(0);opacity:1;} }

/* â”€â”€ v10: TAX SYSTEM â”€â”€ */
.tax-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.7);
  z-index: 9200; display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(4px);
}
.tax-overlay.active { display: flex; }
.tax-box {
  background: var(--panel); border: 2px solid var(--warn);
  border-radius: 12px; padding: 28px; width: 340px; text-align: center;
  box-shadow: 0 0 60px rgba(255,204,0,0.3);
  animation: taxDrop 0.5s cubic-bezier(0.34,1.4,0.64,1);
}
@keyframes taxDrop { from{transform:translateY(-40px) scale(0.8);opacity:0;} to{transform:none;opacity:1;} }
.tax-title { font-family: var(--display); font-weight: 900; font-size: 26px; color: var(--warn); letter-spacing: 2px; }
.tax-amount { font-family: var(--display); font-weight: 900; font-size: 48px; color: var(--danger); margin: 12px 0; line-height:1; }
.tax-sub { font-size: 10px; color: var(--text-dim); line-height: 1.6; margin-bottom: 16px; }
.tax-breakdown { background: var(--bg3); border-radius: var(--radius); padding: 10px; margin: 10px 0; text-align: left; }
.tax-row { display: flex; justify-content: space-between; font-size: 10px; padding: 3px 0; border-bottom: 1px solid var(--border); }
.tax-row:last-child { border-bottom: none; font-weight: 700; color: var(--warn); }

/* â”€â”€ v10: CLIENT COMPLAINT â”€â”€ */
.complaint-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.65);
  z-index: 9150; display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(3px);
}
.complaint-overlay.active { display: flex; }
.complaint-box {
  background: var(--panel); border: 2px solid var(--danger);
  border-radius: 12px; padding: 24px; width: 320px; text-align: center;
  box-shadow: 0 0 40px rgba(255,61,90,0.35);
  animation: complaintShake 0.5s ease;
}
@keyframes complaintShake {
  0%,100%{transform:translateX(0);}
  15%{transform:translateX(-8px);}
  30%{transform:translateX(8px);}
  45%{transform:translateX(-6px);}
  60%{transform:translateX(6px);}
  75%{transform:translateX(-3px);}
  90%{transform:translateX(3px);}
}
.complaint-face { font-size: 48px; margin-bottom: 8px; }
.complaint-title { font-family: var(--display); font-weight: 900; font-size: 20px; color: var(--danger); }
.complaint-msg { font-size: 11px; color: var(--text); margin: 8px 0 14px; line-height: 1.6; font-style: italic; }
.complaint-choices { display: flex; gap: 8px; }
.complaint-choices .btn { flex: 1; }

/* â”€â”€ v10: LEGACY PERKS â”€â”€ */
.perk-card {
  background: linear-gradient(135deg, rgba(167,139,250,0.08), rgba(124,45,18,0.06));
  border: 1px solid rgba(167,139,250,0.3); border-radius: var(--radius);
  padding: 14px; cursor: pointer; transition: all 0.2s; margin-bottom: 8px;
  position: relative; overflow: hidden;
}
.perk-card::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(167,139,250,0.0), rgba(167,139,250,0.12));
  opacity: 0; transition: opacity 0.2s;
}
.perk-card:hover::before { opacity: 1; }
.perk-card.perk-owned { border-color: var(--accent3); opacity: 0.65; cursor: default; }
.perk-card.perk-owned::after { content: 'âœ“ ACTIVE'; position: absolute; top: 8px; right: 10px; font-size: 9px; color: var(--accent3); letter-spacing: 1px; font-weight: 700; }
.perk-icon { font-size: 28px; margin-bottom: 6px; }
.perk-name { font-family: var(--display); font-weight: 900; font-size: 16px; color: var(--pro); }
.perk-desc { font-size: 10px; color: var(--text-dim); margin-top: 4px; line-height: 1.5; }
.perk-effect { font-size: 10px; color: var(--accent3); margin-top: 6px; font-weight: 700; }

/* â”€â”€ v10: FRANCHISE â”€â”€ */
.franchise-card {
  background: linear-gradient(135deg, rgba(255,107,53,0.08), rgba(255,204,0,0.05));
  border: 1px solid rgba(255,107,53,0.35); border-radius: var(--radius); padding: 14px; margin-bottom: 8px;
}
.franchise-name { font-family: var(--display); font-weight: 900; font-size: 16px; color: var(--accent2); }
.franchise-income { font-family: var(--display); font-weight: 700; font-size: 22px; color: var(--accent3); }
.franchise-bar { height: 5px; background: var(--bg); border-radius: 3px; overflow: hidden; margin: 6px 0; }
.franchise-fill { height: 100%; background: linear-gradient(90deg, var(--accent2), var(--warn)); border-radius: 3px; transition: width 0.5s; }

/* â”€â”€ v10: RECYCLING â”€â”€ */
.recycle-pill {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(127,255,110,0.08); border: 1px solid rgba(127,255,110,0.25);
  border-radius: 20px; padding: 4px 12px;
  font-family: var(--display); font-weight: 700; font-size: 14px; color: var(--accent3);
}

/* â”€â”€ v10: HALL OF FAME â”€â”€ */
.hof-entry {
  background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 12px 14px; margin-bottom: 8px;
  display: flex; align-items: center; gap: 12px;
}
.hof-rank { font-family: var(--display); font-weight: 900; font-size: 28px; color: var(--text-dim); width: 36px; flex-shrink: 0; }
.hof-rank.gold   { color: #ffd700; }
.hof-rank.silver { color: #c0c0c0; }
.hof-rank.bronze { color: #cd7f32; }
.hof-info { flex: 1; }
.hof-run-name { font-family: var(--display); font-weight: 700; font-size: 14px; }
.hof-run-sub  { font-size: 9px; color: var(--text-dim); margin-top: 2px; }
.hof-score { font-family: var(--display); font-weight: 900; font-size: 20px; color: var(--accent3); }
.hof-perks { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
.hof-perk-tag { font-size: 8px; padding: 1px 5px; border-radius: 3px; background: rgba(167,139,250,0.15); color: var(--pro); }

/* â”€â”€ v10: CLIENT TIERS â”€â”€ */
.client-tier-badge {
  display: inline-block; padding: 2px 7px; border-radius: 10px; font-size: 9px;
  font-family: var(--display); font-weight: 700; letter-spacing: 1px; vertical-align: middle;
}
.tier-bronze   { background: rgba(205,127,50,0.2);  color: #cd7f32; border: 1px solid rgba(205,127,50,0.4); }
.tier-silver   { background: rgba(192,192,192,0.15); color: #c0c0c0; border: 1px solid rgba(192,192,192,0.35); }
.tier-gold     { background: rgba(255,215,0,0.15);   color: #ffd700; border: 1px solid rgba(255,215,0,0.4); }
.tier-platinum { background: rgba(0,229,255,0.1);    color: var(--accent); border: 1px solid rgba(0,229,255,0.35); }

/* â”€â”€ v10: MORALE â”€â”€ */
.morale-bar-wrap { margin-top: 5px; }
.morale-bar { height: 3px; background: var(--bg); border-radius: 2px; overflow: hidden; }
.morale-fill { height: 100%; border-radius: 2px; transition: width 0.5s, background 0.5s; }

/* â”€â”€ v10: SUBSCRIPTION ORDER â”€â”€ */
.order-card.order-subscription { border-left: 3px solid #00e5ff !important; }
.tag-subscription { background: rgba(0,229,255,0.12); color: var(--accent); }

/* â”€â”€ v10: ANIMATED MONEY â”€â”€ */
@keyframes moneyPop { 0%{transform:scale(1);}30%{transform:scale(1.18);}100%{transform:scale(1);} }
.money-pop { animation: moneyPop 0.25s ease; }

/* â”€â”€ v10: INSURANCE â”€â”€ */
.insurance-card {
  background: linear-gradient(135deg, rgba(0,229,255,0.06), rgba(127,255,110,0.04));
  border: 1px solid rgba(0,229,255,0.25); border-radius: var(--radius); padding: 12px; margin-bottom: 8px;
}
.insurance-active { border-color: var(--accent3) !important; }

/* â”€â”€ v10: SCRAP COUNTER â”€â”€ */
.scrap-pill {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(255,107,53,0.08); border: 1px solid rgba(255,107,53,0.25);
  border-radius: 20px; padding: 4px 12px;
  font-family: var(--display); font-weight: 700; font-size: 14px; color: var(--accent2);
}

/* â”€â”€ v10: PRESTIGE PERK SELECT OVERLAY â”€â”€ */
.perk-select-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.8);
  z-index: 9300; display: none; align-items: center; justify-content: center;
  backdrop-filter: blur(6px);
}
.perk-select-overlay.active { display: flex; }
.perk-select-box {
  background: var(--panel); border: 2px solid var(--pro);
  border-radius: 14px; padding: 28px; width: min(500px, 95vw);
  box-shadow: 0 0 80px rgba(167,139,250,0.4);
  animation: taxDrop 0.4s cubic-bezier(0.34,1.4,0.64,1);
}
.perk-select-title { font-family: var(--display); font-weight: 900; font-size: 24px; color: var(--pro); text-align: center; margin-bottom: 6px; }
.perk-select-sub { font-size: 10px; color: var(--text-dim); text-align: center; margin-bottom: 18px; }
.perk-select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
@media(max-width:500px){ .perk-select-grid { grid-template-columns: 1fr; } }
.perk-choice {
  background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 14px; cursor: pointer; transition: all 0.18s; text-align: center;
}
.perk-choice:hover { border-color: var(--pro); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(167,139,250,0.2); }
.perk-choice-icon { font-size: 30px; margin-bottom: 6px; }
.perk-choice-name { font-family: var(--display); font-weight: 900; font-size: 14px; color: var(--pro); }
.perk-choice-desc { font-size: 9px; color: var(--text-dim); margin-top: 4px; line-height: 1.5; }


@keyframes confettiDrop { 0%{transform:translateY(-20px) rotate(0deg);opacity:1;} 100%{transform:translateY(110vh) rotate(540deg);opacity:0;} }
.confetti-piece { position:fixed; top:-20px; pointer-events:none; z-index:9999; border-radius:2px; animation:confettiDrop linear forwards; }

/* â”€â”€ LEVEL-UP FLASH â”€â”€ */
@keyframes lvlFlash { 0%,100%{opacity:0;} 10%,60%{opacity:1;} }
.levelup-flash { position:fixed; inset:0; z-index:8000; pointer-events:none; display:flex; align-items:center; justify-content:center; animation:lvlFlash 2.5s ease forwards; }
.levelup-text { font-family:var(--display); font-weight:900; font-size:56px; color:var(--warn); text-shadow:0 0 40px rgba(255,204,0,0.9); letter-spacing:4px; text-align:center; line-height:1.2; }

/* â”€â”€ SMOOTH HOVER â”€â”€ */
.order-card { transition:transform 0.15s, box-shadow 0.15s; }
.order-card:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,0.35); }
.upgrade-card { transition:transform 0.12s, border-color 0.2s; }
.upgrade-card:hover:not(.owned-card) { transform:translateY(-1px); }

/* â”€â”€ PRINTER TEMP â”€â”€ */
.temp-bar-wrap { margin-top:5px; }
.temp-bar-label { font-size:9px; color:var(--text-dim); display:flex; justify-content:space-between; margin-bottom:2px; }
.temp-bar { height:4px; background:var(--bg); border-radius:2px; overflow:hidden; }
.temp-fill { height:100%; border-radius:2px; transition:width 0.8s, background 0.8s; }

/* â”€â”€ EINDSPEL â”€â”€ */
.printgod-banner { background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(234,88,12,0.06)); border:1px solid rgba(251,191,36,0.4); border-radius:var(--radius); padding:14px; text-align:center; margin:8px 0; }
.printgod-title { font-family:var(--display); font-weight:900; font-size:20px; color:#fbbf24; letter-spacing:2px; }
.printgod-desc { font-size:10px; color:var(--text-dim); line-height:1.6; margin-top:4px; }

/* â”€â”€ v7: LEVERANCIERS â”€â”€ */
.supplier-card {
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 12px; margin-bottom: 8px;
  transition: border-color 0.2s;
}
.supplier-card.preferred { border-color: rgba(0,229,255,0.4); }
.supplier-card.trusted   { border-color: rgba(127,255,110,0.4); }
.supplier-card.crisis    { border-color: rgba(255,61,90,0.5); animation: supplierCrisis 1s ease-in-out infinite; }
@keyframes supplierCrisis { 0%,100%{border-color:rgba(255,61,90,0.3);} 50%{border-color:rgba(255,61,90,0.9);} }
.supplier-header { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.supplier-avatar { font-size:24px; }
.supplier-name { font-family:var(--display); font-weight:700; font-size:15px; flex:1; }
.supplier-relation { font-size:9px; letter-spacing:1px; text-transform:uppercase; padding:2px 8px; border-radius:10px; }
.supplier-rel-neutral  { background:rgba(90,100,128,0.2); color:var(--text-dim); }
.supplier-rel-preferred{ background:rgba(0,229,255,0.1); color:var(--accent); }
.supplier-rel-trusted  { background:rgba(127,255,110,0.1); color:var(--accent3); }
.supplier-prices { display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:8px; }
.supplier-price-item { background:var(--bg); border-radius:4px; padding:6px 8px; }
.supplier-price-label { font-size:9px; color:var(--text-dim); margin-bottom:2px; }
.supplier-price-val { font-family:var(--display); font-weight:700; font-size:14px; }
.supplier-price-trend { font-size:9px; margin-left:4px; }
.trend-up   { color:var(--danger); }
.trend-down { color:var(--accent3); }
.supplier-stock-label { font-size:9px; color:var(--text-dim); margin-bottom:4px; letter-spacing:1px; text-transform:uppercase; }
.supplier-stock-row { display:flex; align-items:center; gap:8px; margin-bottom:6px; }
.supplier-stock-name { font-size:10px; min-width:50px; }
.stock-bar { flex:1; height:5px; background:var(--bg); border-radius:3px; overflow:hidden; }
.stock-fill { height:100%; border-radius:3px; transition:width 0.4s; }
.stock-low  { background: var(--danger); }
.stock-mid  { background: var(--warn); }
.stock-high { background: var(--accent3); }
.supplier-order-row { display:flex; gap:6px; margin-top:8px; }
.supplier-order-qty { width:50px; background:var(--bg); border:1px solid var(--border); border-radius:4px; color:var(--text); font-family:var(--mono); padding:4px 6px; font-size:11px; }

/* â”€â”€ v7: FILAMENT VOORRAAD INDICATOR â”€â”€ */
.stock-pill {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; padding: 2px 8px; border-radius: 10px;
  border: 1px solid var(--border); background: var(--bg3);
}
.stock-pill.low  { border-color:rgba(255,61,90,0.5); color:var(--danger); }
.stock-pill.mid  { border-color:rgba(255,204,0,0.4); color:var(--warn); }
.stock-pill.high { border-color:rgba(127,255,110,0.3); color:var(--accent3); }
#stock-bar {
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  padding:4px 16px; background:rgba(13,15,20,0.9);
  border-bottom: 1px solid var(--border); font-size:10px;
}
.stock-label { color:var(--text-dim); font-size:9px; letter-spacing:1px; text-transform:uppercase; }

/* â”€â”€ v7: VIP KLANTEN â”€â”€ */
.vip-badge {
  display:inline-flex; align-items:center; gap:3px;
  font-size:9px; padding:2px 7px; border-radius:10px;
  background:linear-gradient(135deg,rgba(251,191,36,0.2),rgba(234,88,12,0.1));
  border:1px solid rgba(251,191,36,0.4); color:#fbbf24;
  font-family:var(--display); font-weight:700; letter-spacing:1px;
  text-transform:uppercase;
}
.customer-panel {
  background:var(--bg3); border:1px solid var(--border);
  border-radius:var(--radius); padding:10px 12px; margin-bottom:8px;
}
.customer-row {
  display:flex; align-items:center; gap:8px; padding:6px 0;
  border-bottom:1px solid rgba(42,48,69,0.4);
}
.customer-row:last-child { border-bottom:none; }
.customer-name-main { font-family:var(--display); font-weight:700; font-size:13px; flex:1; }
.customer-satisfaction { display:flex; gap:2px; }
.sat-star { color:var(--warn); font-size:11px; }
.sat-star.empty { color:var(--border); }
.customer-jobs-count { font-size:10px; color:var(--text-dim); white-space:nowrap; }
.vip-bonus-label { font-size:9px; color:var(--accent3); margin-left:4px; }

/* â”€â”€ v7: MARKTCRISIS â”€â”€ */
.crisis-banner {
  display:none; align-items:center; gap:10px;
  padding:8px 16px; border-bottom:2px solid var(--danger);
  background:rgba(255,61,90,0.08); animation:fadeIn 0.3s;
}
.crisis-banner.active { display:flex; }
.crisis-icon { font-size:20px; animation: blink 0.8s infinite; }
.crisis-text { flex:1; }
.crisis-name { font-family:var(--display); font-weight:900; font-size:15px; color:var(--danger); }
.crisis-desc { font-size:10px; color:var(--text-dim); }
.crisis-timer { font-family:var(--display); font-weight:700; font-size:14px; color:var(--danger); }

/* â”€â”€ v7: CHALLENGE MODE â”€â”€ */
.challenge-card {
  background:linear-gradient(135deg,rgba(167,139,250,0.08),rgba(124,58,237,0.04));
  border:1px solid rgba(167,139,250,0.3);
  border-radius:var(--radius); padding:12px; margin-bottom:8px;
}
.challenge-card.active-challenge { border-color:var(--pro); background:rgba(167,139,250,0.1); }
.challenge-name { font-family:var(--display); font-weight:700; font-size:14px; color:var(--pro); }
.challenge-desc { font-size:10px; color:var(--text-dim); margin:4px 0; line-height:1.5; }
.challenge-reward { font-family:var(--display); font-weight:900; font-size:16px; color:var(--warn); }
.challenge-prog-bar { height:4px; background:var(--bg); border-radius:2px; overflow:hidden; margin-top:6px; }
.challenge-prog-fill { height:100%; background:linear-gradient(90deg,var(--pro-dark),var(--pro)); border-radius:2px; transition:width 0.4s; }
.challenge-timer { font-size:9px; color:var(--pro); margin-top:4px; }

/* â”€â”€ v7: FILAMENT UPGRADE VISUAL â”€â”€ */
.fil-tpu  { color: #ff9f43; }
.fil-resin { color: #ee5a24; }
.tag-tpu   { background:rgba(255,159,67,0.15); color:#ff9f43; }
.tag-resin { background:rgba(238,90,36,0.12);  color:#ee5a24; }
.tag-cf    { background:rgba(74,74,74,0.3);    color:#9ca3af; }
.tag-glow  { background:rgba(204,255,0,0.12);  color:#ccff00; }
.order-tpu::before   { background: #ff9f43; }
.order-resin::before { background: #ee5a24; }
.filament-btn.selected-tpu   { border-color:#ff9f43; background:rgba(255,159,67,0.1); }
.filament-btn.selected-resin { border-color:#ee5a24; background:rgba(238,90,36,0.08); }

/* â”€â”€ v7: UPGRADE CATEGORY HEADERS â”€â”€ */
.upgrade-category {
  font-family:var(--display); font-weight:700; font-size:11px;
  letter-spacing:2px; text-transform:uppercase;
  color:var(--text-dim); padding:8px 4px 4px;
  border-bottom:1px solid var(--border); margin-bottom:6px; margin-top:10px;
}

/* â”€â”€ v7: BETERE TOPBAR STATS â”€â”€ */
.stat-pill.danger  { border-color:rgba(255,61,90,0.4); }
.stat-pill.success { border-color:rgba(127,255,110,0.3); }

/* â”€â”€ v7: NOTIFICATION CENTER â”€â”€ */
.notif-center {
  position:fixed; top:60px; right:16px; z-index:500;
  background:var(--panel); border:1px solid var(--border);
  border-radius:10px; width:280px;
  box-shadow:0 12px 40px rgba(0,0,0,0.5);
  display:none; animation:popIn 0.25s cubic-bezier(0.34,1.56,0.64,1);
  max-height:400px; overflow-y:auto;
}
.notif-center.open { display:block; }
.notif-center-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 14px; border-bottom:1px solid var(--border);
  font-family:var(--display); font-weight:700; font-size:13px;
}
.notif-item {
  padding:10px 14px; border-bottom:1px solid rgba(42,48,69,0.4);
  font-size:10px; line-height:1.5;
}
.notif-item:last-child { border-bottom:none; }
.notif-item-title { font-family:var(--display); font-weight:700; font-size:12px; color:var(--text-bright); }
.notif-item-time { font-size:9px; color:var(--text-dim); float:right; }
.notif-clear { padding:8px 14px; text-align:center; color:var(--text-dim); font-size:10px; cursor:pointer; }
.notif-clear:hover { color:var(--danger); }

/* â”€â”€ v7: SMOOTHERE PROGRESS BARS â”€â”€ */
.big-progress-fill {
  transition: width 0.3s linear !important;
}

/* â”€â”€ v8: RESEARCH TREE â”€â”€ */
.research-tree { display:flex; flex-direction:column; gap:8px; }
.research-tier { margin-bottom:4px; }
.research-tier-label { font-size:9px; letter-spacing:2px; text-transform:uppercase; color:var(--text-dim); padding:4px 0; border-bottom:1px solid var(--border); margin-bottom:6px; }
.research-row { display:flex; gap:6px; flex-wrap:wrap; }
.research-node {
  flex:1; min-width:110px; background:var(--bg3); border:1px solid var(--border);
  border-radius:var(--radius); padding:10px; cursor:pointer;
  transition:all 0.2s; position:relative; overflow:hidden;
}
.research-node::before { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; background:var(--border); }
.research-node.researched::before { background:var(--accent3); }
.research-node.researching::before { background:var(--accent); animation:researchPulse 1s ease-in-out infinite; }
.research-node.available { border-color:rgba(0,229,255,0.35); }
.research-node.researched { border-color:var(--accent3); opacity:0.75; }
.research-node.locked-node { opacity:0.3; cursor:not-allowed; }
.research-node:hover:not(.locked-node):not(.researched) { border-color:var(--accent); transform:translateY(-1px); }
.research-icon { font-size:20px; margin-bottom:4px; }
.research-name { font-family:var(--display); font-weight:700; font-size:12px; color:var(--text-bright); }
.research-desc { font-size:9px; color:var(--text-dim); margin-top:3px; line-height:1.4; }
.research-cost { font-size:10px; color:var(--warn); margin-top:4px; font-family:var(--display); font-weight:700; }
.research-time { font-size:9px; color:var(--text-dim); }
.research-progress { height:3px; background:var(--bg); border-radius:2px; margin-top:6px; overflow:hidden; }
.research-prog-fill { height:100%; background:var(--accent); border-radius:2px; transition:width 0.5s; }
@keyframes researchPulse { 0%,100%{opacity:1;}50%{opacity:0.4;} }
.active-research-banner {
  background:rgba(0,229,255,0.06); border:1px solid rgba(0,229,255,0.2);
  border-radius:var(--radius); padding:10px 12px; display:flex; gap:10px; align-items:center;
  margin-bottom:8px;
}
.arb-icon { font-size:22px; }
.arb-name { font-family:var(--display); font-weight:700; font-size:13px; }
.arb-sub { font-size:9px; color:var(--text-dim); }
.arb-bar { flex:1; height:5px; background:var(--bg); border-radius:3px; overflow:hidden; margin-top:4px; }
.arb-fill { height:100%; background:linear-gradient(90deg,var(--accent2),var(--accent)); border-radius:3px; transition:width 0.5s; }

/* â”€â”€ v8: SPECIAL ORDER TYPES â”€â”€ */
.order-card.order-vip { border-left:3px solid #ffd700 !important; }
.order-card.order-rush { border-left:3px solid var(--danger) !important; }
.order-card.order-bulk { border-left:3px solid var(--accent3) !important; }
.order-card.order-mystery { border-left:3px solid var(--pro) !important; }
.tag-vip   { background:rgba(255,215,0,0.15); color:#ffd700; }
.tag-rush  { background:rgba(255,61,90,0.15);  color:var(--danger); }
.tag-bulk  { background:rgba(127,255,110,0.15);color:var(--accent3); }
.tag-mystery { background:rgba(167,139,250,0.15);color:var(--pro); }
.special-order-glow-vip { box-shadow:0 0 12px rgba(255,215,0,0.25); }
.special-order-glow-rush { animation:urgentPulse 0.8s ease-in-out infinite; }

/* â”€â”€ v8: MILESTONE SYSTEM â”€â”€ */
.milestone-banner {
  position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(0.8);
  background:var(--panel); border:2px solid var(--warn);
  border-radius:16px; padding:28px 36px; z-index:9000;
  box-shadow:0 0 80px rgba(255,204,0,0.4);
  text-align:center; max-width:400px; width:90%;
  animation:milestonePop 0.5s cubic-bezier(0.34,1.56,0.64,1) forwards;
}
@keyframes milestonePop { 0%{transform:translate(-50%,-50%) scale(0.5);opacity:0;} 100%{transform:translate(-50%,-50%) scale(1);opacity:1;} }
.milestone-icon { font-size:52px; margin-bottom:8px; }
.milestone-title { font-family:var(--display); font-weight:900; font-size:26px; color:var(--warn); letter-spacing:2px; }
.milestone-desc { color:var(--text-dim); font-size:12px; margin:8px 0; line-height:1.6; }
.milestone-reward { font-family:var(--display); font-weight:900; font-size:32px; color:var(--accent3); margin:12px 0 4px; }
.milestone-reward-sub { font-size:10px; color:var(--text-dim); letter-spacing:1px; text-transform:uppercase; }
#milestone-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:8999; display:none; backdrop-filter:blur(3px); }

/* â”€â”€ v8: EQUIPMENT EVENTS â”€â”€ */
.equip-event-card {
  background:rgba(255,61,90,0.06); border:1px solid rgba(255,61,90,0.3);
  border-radius:var(--radius); padding:12px; margin-bottom:8px;
  animation:fadeIn 0.3s ease;
}
.equip-event-title { font-family:var(--display); font-weight:900; font-size:14px; color:var(--danger); }
.equip-event-desc { font-size:10px; color:var(--text-dim); margin:4px 0 8px; line-height:1.5; }

/* â”€â”€ v8: DASHBOARD TAB â”€â”€ */
.dashboard-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px; }
.dash-card { background:var(--bg3); border:1px solid var(--border); border-radius:var(--radius); padding:10px 12px; }
.dash-card-label { font-size:9px; color:var(--text-dim); letter-spacing:1px; text-transform:uppercase; margin-bottom:4px; }
.dash-card-value { font-family:var(--display); font-weight:900; font-size:22px; color:var(--text-bright); }
.dash-card-trend { font-size:10px; margin-top:2px; }
.dash-trend-up { color:var(--accent3); }
.dash-trend-down { color:var(--danger); }
.dash-efficiency-bar { height:6px; background:var(--bg); border-radius:3px; overflow:hidden; margin-top:6px; }
.dash-eff-fill { height:100%; border-radius:3px; background:linear-gradient(90deg,var(--danger),var(--warn),var(--accent3)); }
.kpi-row { display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
.kpi-pill { flex:1; min-width:70px; background:var(--bg3); border:1px solid var(--border); border-radius:20px; padding:6px 12px; text-align:center; }
.kpi-val { font-family:var(--display); font-weight:900; font-size:16px; color:var(--accent); }
.kpi-lbl { font-size:8px; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; }

/* â”€â”€ v8: REPUTATION TIERS â”€â”€ */
.rep-tier-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:10px; font-size:9px; font-family:var(--display); font-weight:700; letter-spacing:1px; text-transform:uppercase; }
.rep-tier-0 { background:rgba(90,100,128,0.2); color:var(--text-dim); }
.rep-tier-1 { background:rgba(0,229,255,0.12); color:var(--accent); border:1px solid rgba(0,229,255,0.25); }
.rep-tier-2 { background:rgba(255,204,0,0.12); color:var(--warn); border:1px solid rgba(255,204,0,0.25); }
.rep-tier-3 { background:rgba(127,255,110,0.12); color:var(--accent3); border:1px solid rgba(127,255,110,0.25); }
.rep-tier-4 { background:linear-gradient(135deg,rgba(255,215,0,0.15),rgba(255,107,53,0.1)); color:#ffd700; border:1px solid rgba(255,215,0,0.35); }

/* â”€â”€ v8: ORDER DIFFICULTY STARS â”€â”€ */
.difficulty-stars { display:inline-flex; gap:1px; margin-left:4px; vertical-align:middle; }
.diff-star { font-size:8px; }
.diff-star.filled { color:var(--warn); }
.diff-star.empty  { color:var(--border); }

/* â”€â”€ v8: MARKET TREND SPARKLINE â”€â”€ */
.sparkline-wrap { margin-top:6px; }
.sparkline-svg { display:block; }

/* â”€â”€ v8: LATE GAME UPGRADE GLOW â”€â”€ */
.upgrade-card.tier3 { border-color:rgba(255,107,53,0.4); }
.upgrade-card.tier3 .upgrade-name { color:var(--accent2); }
.upgrade-card.tier4 { border-color:rgba(167,139,250,0.5); background:linear-gradient(135deg,rgba(167,139,250,0.04),transparent); }
.upgrade-card.tier4 .upgrade-name { color:var(--pro); }

/* â”€â”€ v8: RUSH ORDER COUNTDOWN â”€â”€ */
@keyframes rushFlash { 0%,100%{background:rgba(255,61,90,0.04);}50%{background:rgba(255,61,90,0.12);} }
.order-card.order-rush { animation:rushFlash 0.6s ease-in-out infinite; }
.order-card.order-flash { border:2px solid #ffd700 !important; animation:rushFlash 0.4s ease-in-out infinite; background:rgba(255,215,0,0.07) !important; }
.flash-countdown { font-family:var(--display); font-weight:900; font-size:13px; color:#ffd700; text-shadow:0 0 8px rgba(255,215,0,0.6); }

/* â”€â”€ v8: PRINTER HEAT GLOW â”€â”€ */
.printer-card.overheating { box-shadow:0 0 16px rgba(255,107,53,0.4); border-color:var(--accent2) !important; }

/* â”€â”€ v8: NOTIFICATION FEED â”€â”€ */
.notif-feed-item { display:flex; gap:8px; align-items:flex-start; padding:8px 0; border-bottom:1px solid rgba(42,48,69,0.4); }
.notif-feed-item:last-child { border-bottom:none; }
.notif-feed-icon { font-size:16px; flex-shrink:0; margin-top:1px; }
.notif-feed-body { flex:1; }
.notif-feed-title { font-size:11px; font-family:var(--display); font-weight:700; color:var(--text-bright); }
.notif-feed-sub { font-size:9px; color:var(--text-dim); margin-top:1px; }
.notif-feed-time { font-size:9px; color:var(--text-dim); white-space:nowrap; flex-shrink:0; }

/* â”€â”€ v8: BOUNTY BOARD â”€â”€ */
.bounty-card {
  background:linear-gradient(135deg,rgba(255,215,0,0.06),rgba(255,107,53,0.03));
  border:1px solid rgba(255,215,0,0.3); border-radius:var(--radius);
  padding:12px; margin-bottom:8px; position:relative; overflow:hidden;
}
.bounty-card::before { content:'BOUNTY'; position:absolute; top:6px; right:8px; font-size:8px; letter-spacing:2px; color:rgba(255,215,0,0.4); font-family:var(--display); font-weight:900; }
.bounty-name { font-family:var(--display); font-weight:900; font-size:15px; color:#ffd700; margin-bottom:4px; }
.bounty-req { font-size:10px; color:var(--text-dim); line-height:1.6; }
.bounty-reward { font-family:var(--display); font-weight:900; font-size:20px; color:var(--accent3); }
.bounty-expires { font-size:9px; color:var(--danger); margin-top:4px; }
.bounty-claimed { opacity:0.4; pointer-events:none; }

/* â”€â”€ v8: LIVE EFFICIENCY METER â”€â”€ */
#efficiency-display {
  position:fixed; bottom:16px; left:16px; z-index:100;
  background:var(--panel); border:1px solid var(--border);
  border-radius:8px; padding:8px 14px; display:none;
  font-size:10px; color:var(--text-dim);
  transition:opacity 0.3s;
}
#efficiency-display.active { display:block; }
.eff-label { font-size:8px; letter-spacing:2px; text-transform:uppercase; margin-bottom:3px; }
.eff-value { font-family:var(--display); font-weight:900; font-size:20px; color:var(--accent3); }
.eff-sub { font-size:9px; color:var(--text-dim); }

/* â”€â”€ v7: FILAMENT STOCK WARNING â”€â”€ */
@keyframes stockWarn { 0%,100%{opacity:1;} 50%{opacity:0.5;} }
.stock-critical { animation:stockWarn 1s infinite; }

/* â”€â”€ v7: SUPPLIER CRISIS TOAST â”€â”€ */
.crisis-toast {
  position:fixed; top:76px; right:20px;
  background:var(--panel); border:2px solid var(--danger);
  border-radius:var(--radius); padding:12px 16px; z-index:400;
  max-width:280px; box-shadow:0 8px 32px rgba(255,61,90,0.3);
  animation:toastIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
}


</style>
</head>
<body>

<div id="fail-flash"></div>

<!-- TOP BAR -->
<div id="topbar">
  <div class="logo">Print <span>&</span> Profit <span style="font-size:11px;color:var(--text-dim);letter-spacing:1px;font-weight:300">v10.0</span></div>
  <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
    <div class="stat-pill"><span class="label">Cash</span><span class="value" id="money-val">â‚¬0.00</span></div>
    <div class="stat-pill"><span class="label">Rep</span><span class="value" id="rep-val">â˜… 0</span></div>
    <div class="stat-pill"><span class="label">Lvl</span><span class="value" id="level-val">1</span></div>
    <div class="stat-pill" id="passive-pill" style="display:none"><span class="label">Passive/h</span><span class="value" id="passive-val" style="color:var(--accent3)">â‚¬0</span></div>
    <div class="streak-pill" id="streak-pill" style="display:none"><span class="label">ðŸ”¥ Streak</span><span id="streak-val">0</span></div>
    <span class="night-badge" id="night-badge">ðŸŒ™ Night Shift</span>
    <div class="prestige-badge" id="prestige-pill">ðŸ”¥ <span id="prestige-val">P1</span></div>
    <div class="token-pill" id="token-pill" style="display:none;">ðŸŽ² <span id="token-val">0</span></div>
    <div class="stat-pill" id="debt-pill" style="display:none;border-color:rgba(255,61,90,0.4)"><span class="label">ðŸ’³ Debt</span><span class="value" id="debt-val" style="color:var(--danger)">â‚¬0</span></div>
    <div class="scrap-pill" id="scrap-pill" style="display:none">â™»ï¸ <span id="scrap-val">0</span> scrap</div>
  </div>
  <div class="topbar-right">
    <div id="save-indicator">ðŸ’¾ Saved</div>
    <div class="notif-btn" id="notif-btn" onclick="Notifications.toggle()" title="Browser notifications">ðŸ””<div class="notif-dot"></div></div>
    <div class="sound-btn" id="sound-btn" onclick="Sound.toggle()" title="Toggle sound">ðŸ”Š</div>
    <button class="btn-pro" id="pro-btn" onclick="Game.showProModal()">âš¡ Go Pro</button>
    <button class="btn btn-primary btn-sm" onclick="Game.saveGame(true)">ðŸ’¾ Save</button>
    <button class="btn btn-ghost btn-sm" onclick="Game.resetGame()">â†º Reset</button>
  </div>
</div>

<!-- NIEUWS TICKER -->
<div id="news-ticker">
  <div class="ticker-inner" id="ticker-inner">
    <span class="ticker-item">ðŸ“ˆ <span>Marktupdate:</span> PLA stabiel op Ã—1.0</span>
    <span class="ticker-item">ðŸ­ <span>Tip:</span> Hogere kwaliteit = meer reputatie</span>
    <span class="ticker-item">ðŸŽ¯ <span>Dagelijks doel:</span> Check je doelen tab!</span>
    <span class="ticker-item">ðŸ”¥ <span>Combo:</span> Druk snel achter elkaar voor bonussen</span>
    <span class="ticker-item">ðŸ’¡ <span>Pro-tip:</span> PA6 filament heeft de hoogste winstmarge</span>
    <span class="ticker-item">ðŸ§¾ <span>v10 Tip:</span> Pay your VAT bills â€” or lose reputation!</span>
    <span class="ticker-item">ðŸ¥‡ <span>v10 New:</span> Reach Platinum client tier for +35% job rewards</span>
    <span class="ticker-item">ðŸ­ <span>v10 New:</span> Unlock Franchise Mode after 2 Prestiges â€” passive income!</span>
    <span class="ticker-item">â­ <span>v10 New:</span> Every prestige earns a permanent Legacy Perk</span>
    <span class="ticker-item">â™»ï¸ <span>v10 New:</span> Buy the Recycler upgrade to turn failed prints into scrap</span>
    <span class="ticker-item">ðŸ˜´ <span>v10 New:</span> Staff morale drops over time â€” buy Team Lunch to restore</span>
    <span class="ticker-item">ðŸ›¡ <span>v10 New:</span> Business Insurance covers catastrophic failures for â‚¬50/cycle</span>
    <span class="ticker-item">ðŸ“‹ <span>v10 New:</span> Subscription clients send automatic repeat orders</span>
  </div>
</div>

<!-- SEASON BANNER -->
<div id="season-banner">
  <div class="season-icon" id="season-icon">ðŸŽ„</div>
  <div class="season-text">
    <div class="season-name" id="season-name">Holiday Rush</div>
    <div class="season-effect" id="season-effect">Figurines & decorations +40% reward Â· Extra urgent orders</div>
  </div>
  <span style="font-size:9px;color:var(--text-dim)">Seasonal event</span>
</div>

<!-- MARKTCRISIS BANNER -->
<div id="crisis-banner" class="crisis-banner">
  <div class="crisis-icon" id="crisis-icon">âš ï¸</div>
  <div class="crisis-text">
    <div class="crisis-name" id="crisis-name">Filament Shortage!</div>
    <div class="crisis-desc" id="crisis-desc">PLA stock depleted globally â€” prices spiked</div>
  </div>
  <div class="crisis-timer" id="crisis-timer">2:30</div>
</div>

<!-- FILAMENT STOCK BAR -->
<div id="stock-bar">
  <span class="stock-label">ðŸ“¦ Voorraad</span>
  <div class="stock-pill" id="stock-pla"><span>PLA</span><span id="sval-pla">100</span></div>
  <div class="stock-pill" id="stock-petg"><span>PETG</span><span id="sval-petg">80</span></div>
  <div class="stock-pill" id="stock-pa6"><span>PA6</span><span id="sval-pa6">50</span></div>
  <div class="stock-pill" id="stock-tpu"><span>TPU</span><span id="sval-tpu">â€”</span></div>
  <div class="stock-pill" id="stock-resin"><span>Resin</span><span id="sval-resin">â€”</span></div>
  <div class="stock-pill" id="stock-cf"><span>CF</span><span id="sval-cf">â€”</span></div>
  <div class="stock-pill" id="stock-glow"><span>GLOW</span><span id="sval-glow">â€”</span></div>
  <span style="font-size:9px;color:var(--text-dim);margin-left:auto">Bestel bij leveranciers â†’</span>
</div>

<!-- RIVAL BANNER -->
<div id="rival-banner" class="rival-banner">
  <div>
    <div class="rival-name">ðŸ¤– PrintBot stole an order!</div>
    <div style="font-size:9px;color:var(--text-dim)" id="rival-msg">Accept orders faster to beat the competition.</div>
  </div>
  <div style="text-align:right">
    <div style="font-size:9px;color:var(--text-dim)">Rival Jobs</div>
    <div class="rival-score">PrintBot: <span id="rival-score">0</span> | You: <span id="rival-player-score">0</span></div>
  </div>
</div>

<!-- DEMAND SURGE BANNER -->
<div id="surge-banner" class="surge-banner">
  <div>
    <div class="surge-name" id="surge-name">ðŸ”¥ DEMAND SURGE</div>
    <div class="surge-timer" id="surge-timer">â³ 2:00 remaining</div>
  </div>
  <div class="surge-progress">
    <div style="font-size:9px;color:var(--text-dim)">Progress: <span id="surge-progress-text">0/5</span></div>
    <div class="surge-bar"><div class="surge-fill" id="surge-fill" style="width:0%"></div></div>
  </div>
  <div class="surge-reward" id="surge-reward">â‚¬250 Bonus</div>
</div>

<!-- TRENDING PRODUCTS BANNER -->
<div id="trend-banner" style="display:none;background:linear-gradient(90deg,rgba(255,204,0,0.12),rgba(255,140,0,0.08));border:1px solid rgba(255,204,0,0.4);border-radius:var(--radius);padding:8px 14px;margin:0 8px 6px;align-items:center;justify-content:space-between;gap:8px;">
  <div>
    <div style="font-family:var(--display);font-weight:900;font-size:13px;color:var(--warn)" id="trend-name">ðŸ”¥ TRENDING</div>
    <div style="font-size:9px;color:var(--text-dim)" id="trend-timer">â³ 180s remaining</div>
  </div>
  <div style="font-size:10px;color:var(--text-dim)">Matching orders verdienen multiplier!</div>
</div>

<!-- SPEEDRUN BAR -->
<div id="speedrun-bar">
  <div>
    <div class="sr-label">âš¡ SPEEDRUN MODE</div>
    <div class="sr-timer" id="sr-timer">10:00</div>
  </div>
  <div style="text-align:center">
    <div class="sr-label">Verdiend</div>
    <div class="sr-score" id="sr-score">â‚¬0</div>
  </div>
  <div style="text-align:center">
    <div class="sr-label">Jobs</div>
    <div class="sr-score" id="sr-jobs">0</div>
  </div>
  <button class="sr-end-btn" onclick="Speedrun.end(true)">Stoppen</button>
</div>

<!-- COMBO DISPLAY -->
<div id="combo-display" style="display:none;">
  <div class="combo-number" id="combo-number">2Ã—</div>
  <div class="combo-label">COMBO!</div>
  <div class="combo-mult" id="combo-mult">+10% bonus</div>
  <div class="combo-bar-wrap"><div class="combo-bar-fill" id="combo-bar" style="width:100%"></div></div>
</div>

<!-- SMART TIP -->
<div id="smart-tip">
  <div class="tip-label">ðŸ’¡ Tip</div>
  <div class="tip-text" id="tip-text"></div>
</div>
<div class="market-bar">
  <span id="market-label">ðŸ“ˆ Market</span>
  <div class="market-pill" id="market-pla"><span class="m-label">PLA</span><span id="mval-pla" class="market-flat">Ã—1.00</span><span class="market-arrow" id="marr-pla">â†’</span></div>
  <div class="market-pill" id="market-petg"><span class="m-label">PETG</span><span id="mval-petg" class="market-flat">Ã—1.00</span><span class="market-arrow" id="marr-petg">â†’</span></div>
  <div class="market-pill" id="market-pa6"><span class="m-label">PA6</span><span id="mval-pa6" class="market-flat">Ã—1.00</span><span class="market-arrow" id="marr-pa6">â†’</span></div>
  <span style="color:var(--text-dim);font-size:9px;margin-left:8px;">Updates every 2 min Â· affects order rewards</span>
</div>

<!-- KEYBOARD HINT -->
<div id="kbd-hint">
  <div class="kbd-row"><kbd class="kbd">Space</kbd> Start print</div>
  <div class="kbd-row"><kbd class="kbd">1</kbd><kbd class="kbd">2</kbd><kbd class="kbd">3</kbd> Select printer</div>
  <div class="kbd-row"><kbd class="kbd">Q</kbd><kbd class="kbd">W</kbd><kbd class="kbd">E</kbd> Filament PLA/PETG/PA6</div>
  <div class="kbd-row"><kbd class="kbd">R</kbd> Repair active printer</div>
  <div class="kbd-row"><kbd class="kbd">?</kbd> Toggle this hint</div>
</div>

<!-- TUTORIAL OVERLAY -->
<div id="tutorial-overlay" style="display:none;"></div>

<!-- BREAKDOWN MINI-GAME -->
<div id="minigame-overlay">
  <div class="minigame-box">
    <div class="mg-title">ðŸ”§ PRINTER BREAKDOWN</div>
    <div class="mg-sub" id="mg-sub">Your printer is malfunctioning! Match the calibration sequence to repair it for free â€” or close to skip (costs money).</div>
    <div class="mg-progress" id="mg-progress">Step 0 / 0</div>
    <div class="mg-sequence" id="mg-sequence"></div>
    <div class="mg-timer-bar"><div class="mg-timer-fill" id="mg-timer-fill" style="width:100%"></div></div>
    <div class="mg-feedback" id="mg-feedback"></div>
    <div class="mg-buttons">
      <div class="mg-btn" onclick="MiniGame.press('ðŸ”´')" style="border-color:var(--danger)">ðŸ”´</div>
      <div class="mg-btn" onclick="MiniGame.press('ðŸ”µ')" style="border-color:var(--accent)">ðŸ”µ</div>
      <div class="mg-btn" onclick="MiniGame.press('ðŸŸ¢')" style="border-color:var(--accent3)">ðŸŸ¢</div>
      <div class="mg-btn" onclick="MiniGame.press('ðŸŸ¡')" style="border-color:var(--warn)">ðŸŸ¡</div>
    </div>
    <button class="btn btn-ghost btn-sm" onclick="MiniGame.skip()">Skip (pay repair cost)</button>
  </div>
</div>

<!-- MAIN -->
<div id="main">

  <!-- LEFT COLUMN -->
  <div style="display:flex;flex-direction:column;gap:12px;">

    <!-- PRINTERS -->
    <div class="panel">
      <div class="panel-header"><div class="dot"></div> Printers</div>
      <div class="panel-body" id="printers-panel"></div>
    </div>

    <!-- ORDERS + CONTRACTS (tabbed) -->
    <div class="panel" style="flex:1;overflow:hidden;">
      <div class="ptab-row">
        <div class="ptab active" id="ptab-orders" onclick="switchPTab('orders')">Orders <span id="order-badge" class="badge" style="display:none">0</span></div>
        <div class="ptab" id="ptab-contracts" onclick="switchPTab('contracts')">Contracts <span id="contract-badge" class="cbadge" style="display:none">0</span></div>
        <div class="ptab" id="ptab-queue" onclick="switchPTab('queue')">ðŸ“‹ Wachtrij</div>
      </div>
      <div class="ptab-body active" id="ptab-body-orders">
        <div class="no-orders" id="no-orders-msg">Waiting for ordersâ€¦<br><span style="font-size:9px">New orders arrive every 15â€“30s</span></div>
      </div>
      <div class="ptab-body" id="ptab-body-contracts">
        <div id="no-contracts-msg" class="no-orders">No active contracts.<br><span style="font-size:9px">Contracts refresh automatically</span></div>
      </div>
      <div class="ptab-body" id="ptab-body-queue">
        <div style="font-size:10px;color:var(--text-dim);margin-bottom:8px;line-height:1.6;">
          Voeg orders toe aan de wachtrij â€” ze worden automatisch gestart zodra een printer vrijkomt.
        </div>
        <div id="queue-slots"></div>
        <div style="margin-top:8px;font-size:10px;color:var(--text-dim);text-align:center;" id="queue-hint">
          Klik op een order en dan "âž• Wachtrij" om toe te voegen.
        </div>
      </div>
    </div>

  </div>

  <!-- CENTER COLUMN -->
  <div id="center-panel">

    <!-- ACTIVE JOB -->
    <div class="panel" style="flex:2;">
      <div class="panel-header"><div class="dot" style="background:var(--accent3);box-shadow:0 0 8px var(--accent3);"></div> Print Station</div>
      <div class="panel-body" id="active-job-panel">

        <div id="job-empty" style="text-align:center;padding:20px 0;color:var(--text-dim);">
          <div style="font-size:40px;margin-bottom:12px;opacity:0.3;">ðŸ–¨ï¸</div>
          <div style="font-family:var(--display);font-size:18px;font-weight:700;margin-bottom:8px;">No Active Job</div>
          <div style="font-size:11px;line-height:1.8;">Select an order to start printing.<br>Contracts auto-track your progress.</div>
        </div>

        <div id="job-content" style="display:none;flex-direction:column;gap:10px;">
          <div class="printer-tabs" id="center-printer-tabs"></div>
          <div>
            <div class="job-title" id="job-title">Job Name</div>
            <div class="job-subtitle" id="job-subtitle">â€¦</div>
          </div>
          <div class="printer-visual" id="printer-visual">
            <div class="scan-line"></div>
            <div class="print-head" id="print-head" style="left:20px;"></div>
            <div class="nozzle-dot" id="nozzle-dot" style="display:none;left:44px;"></div>
            <div class="print-layer" id="print-layer"></div>
            <div style="position:absolute;opacity:0.12;font-size:80px;">ðŸ–¨ï¸</div>
          </div>
          <div class="job-stats">
            <div class="jstat"><div class="jstat-label">Filament</div><div class="jstat-value" id="jstat-filament">â€”</div></div>
            <div class="jstat"><div class="jstat-label">Quality</div><div class="jstat-value" id="jstat-quality">â€”</div></div>
            <div class="jstat"><div class="jstat-label">Time Left</div><div class="jstat-value" id="jstat-time">â€”</div></div>
            <div class="jstat"><div class="jstat-label">Profit</div><div class="jstat-value" id="jstat-profit" style="color:var(--accent3)">â€”</div></div>
          </div>
          <div>
            <div class="big-progress-bar">
              <div class="big-progress-fill" id="big-prog-fill" style="width:0%"></div>
              <div class="big-progress-text" id="big-prog-text">Ready</div>
            </div>
          </div>
          <!-- active effects banner -->
          <div class="effect-banner" id="effect-banner"></div>
          <div>
            <div style="color:var(--text-dim);font-size:9px;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Filament</div>
            <div class="filament-row" id="filament-row"></div>
          </div>
          <div>
            <div style="color:var(--text-dim);font-size:9px;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Quality</div>
            <div class="quality-row" id="quality-row"></div>
          </div>
          <button class="btn btn-primary btn-full" id="start-job-btn" onclick="Game.startJob()">â–¶ START PRINT</button>
          <button class="btn btn-full btn-danger btn-sm" id="cancel-job-btn" style="display:none;" onclick="Game.cancelJob()">âœ• Cancel Job</button>
        </div>
      </div>
    </div>

    <!-- LOG -->
    <div class="panel">
      <div class="panel-header"><div class="dot" style="background:var(--text-dim);box-shadow:none;"></div> Event Log</div>
      <div class="panel-body" id="log-panel" style="max-height:150px;gap:0;"></div>
    </div>

  </div>

  <!-- RIGHT COLUMN: SHOP + STATS + ACHIEVEMENTS + SETTINGS -->
  <div style="display:flex;flex-direction:column;gap:12px;">
    <div class="panel" style="flex:1;">
      <div class="tab-row">
        <div class="tab active" onclick="switchTab('shop')">Shop</div>
        <div class="tab" onclick="switchTab('stats')">Stats</div>
        <div class="tab" onclick="switchTab('achiev')">Badges</div>
        <div class="tab" onclick="switchTab('doelen')">ðŸŽ¯</div>
        <div class="tab" onclick="switchTab('personeel')">ðŸ‘¥</div>
        <div class="tab" onclick="switchTab('ketens')">ðŸ”—</div>
        <div class="tab" onclick="switchTab('suppliers')">ðŸ­</div>
        <div class="tab" onclick="switchTab('klanten')">â­</div>
        <div class="tab" onclick="switchTab('challenges')">ðŸ†</div>
        <div class="tab" onclick="switchTab('research')">âš—ï¸</div>
        <div class="tab" onclick="switchTab('bounties')">ðŸŽ¯</div>
        <div class="tab" onclick="switchTab('dashboard')">ðŸ“ˆ</div>
        <div class="tab" onclick="switchTab('equipment')">ðŸ”§</div>
        <div class="tab" onclick="switchTab('leaderboard')">ðŸ“Š</div>
        <div class="tab" onclick="switchTab('loans')">ðŸ’³</div>
        <div class="tab" onclick="switchTab('franchise')">ðŸ­</div>
        <div class="tab" onclick="switchTab('legacy')">â­</div>
        <div class="tab" onclick="switchTab('hof')">ðŸ†</div>
        <div class="tab" onclick="switchTab('voorraad')">ðŸ“¦</div>
        <div class="tab" onclick="switchTab('settings')">âš™</div>
      </div>
      <div class="panel-body">
        <div class="tab-content active" id="tab-shop">
          <div class="biz-level">
            <div class="biz-level-name" id="biz-level-name">GARAGE TINKERER</div>
            <div class="biz-level-sub" id="biz-level-sub">Level 1 Â· 0 / 100 XP</div>
            <div class="biz-xp-bar"><div class="biz-xp-fill" id="biz-xp-fill" style="width:0%"></div></div>
          </div>
          <div id="shop-upgrades"></div>
        </div>
        <div class="tab-content" id="tab-stats">
          <div class="graph-container">
            <div class="graph-label">ðŸ“ˆ Income History</div>
            <canvas id="income-canvas" height="120"></canvas>
          </div>
          <div class="graph-container" style="margin-top:0">
            <div class="graph-label">ðŸ¥§ Filament Mix</div>
            <canvas id="pie-canvas" width="120" height="120"></canvas>
            <div class="pie-legend" id="pie-legend"></div>
          </div>
          <div class="stat-grid" id="stats-panel"></div>
        </div>
        <div class="tab-content" id="tab-achiev">
          <div id="achiev-list"></div>
        </div>
        <div class="tab-content" id="tab-doelen">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            Dagelijkse uitdagingen â€” worden gereset om middernacht.<br>
            <span id="goals-reset-timer" style="color:var(--warn)"></span>
          </div>
          <div id="daily-goals-list"></div>
          <div style="margin-top:8px;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);text-align:center;">
            <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;">Vandaag verzameld</div>
            <div style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--warn)" id="goals-earned">â‚¬0</div>
          </div>
        </div>
        <div class="tab-content" id="tab-leaderboard">
          <div id="leaderboard-list"></div>
        </div>
        <div class="tab-content" id="tab-suppliers">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            Koop filament bij leveranciers. Prijzen fluctueren â€” koop goedkoop in! Bouw relaties op voor kortingen.
          </div>
          <div id="supplier-list"></div>
        </div>
        <div class="tab-content" id="tab-klanten">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            VIP klanten geven tot <strong style="color:var(--warn)">+40% loyaliteitsbonus</strong>. Houd ze tevreden!
          </div>
          <div id="customer-panel"></div>
          <div id="crm-panel" style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)"></div>
        </div>
        <div class="tab-content" id="tab-challenges">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            Wekelijkse uitdagingen voor grote beloningen en exclusieve badges.
          </div>
          <div id="challenge-list"></div>
        </div>
        <div class="tab-content" id="tab-personeel">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            Huur medewerkers om je drukkerij te automatiseren. Loon wordt per minuut betaald.
          </div>
          <div id="employee-list"></div>
        </div>
        <div class="tab-content" id="tab-ketens">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            Productieketens combineren meerdere filamenttypes voor een megabeloning. Voltooi alle stappen!
          </div>
          <div id="chain-list"></div>
          <div style="margin-top:8px;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);">
            <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;margin-bottom:4px;">ðŸŽ² Print Tokens</div>
            <div style="font-family:var(--display);font-weight:900;font-size:18px;color:#fbbf24" id="token-display">0 Tokens</div>
            <div style="font-size:9px;color:var(--text-dim);margin-top:2px;">Verdien tokens door ketens te voltooien</div>
            <button class="btn btn-sm" style="margin-top:8px;width:100%;background:linear-gradient(135deg,rgba(124,45,18,0.3),rgba(251,191,36,0.1));border:1px solid rgba(251,191,36,0.3);color:#fbbf24;" onclick="LootBox.open()">ðŸŽ² Open Lootbox (10 tokens)</button>
          </div>
        </div>
        <div class="tab-content" id="tab-franchise">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            ðŸ­ <strong style="color:var(--accent2)">Franchise Branches</strong> auto-earn passive income. Unlock after Prestige 2.
          </div>
          <div id="franchise-panel"></div>
        </div>
        <div class="tab-content" id="tab-legacy">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            â­ <strong style="color:var(--pro)">Legacy Perks</strong> are permanent bonuses chosen at each prestige. They survive all resets forever.
          </div>
          <div id="legacy-panel"></div>
        </div>
        <div class="tab-content" id="tab-hof">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            ðŸ† <strong style="color:var(--warn)">Hall of Fame</strong> â€” your best runs of all time, across all prestiges.
          </div>
          <div id="hof-panel"></div>
        </div>
        <div class="tab-content" id="tab-loans">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            ðŸ’³ <strong style="color:var(--warn)">Business Loans</strong> give you instant cash â€” but you pay back with interest. Don't let debt spiral!
          </div>
          <div id="loan-panel"></div>
          <div style="margin-top:8px;padding:10px;background:var(--bg3);border:1px solid rgba(255,61,90,0.3);border-radius:var(--radius)" id="loan-debt-panel" style="display:none">
            <div style="font-size:9px;color:var(--danger);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px">âš  Current Debt</div>
            <div style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--danger)" id="loan-debt-display">â‚¬0.00</div>
            <div style="font-size:9px;color:var(--text-dim);margin:4px 0">Interest accrues every 60 seconds</div>
            <button class="btn btn-danger btn-sm btn-full" style="margin-top:6px" onclick="Loans.repayAll()">ðŸ’³ Repay All Debt</button>
          </div>
          <!-- v10: Recycling section inside loans tab -->
          <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:12px">
            <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">â™»ï¸ Recycling</div>
            <div id="recycle-panel"></div>
          </div>
          <!-- v10: Subscriptions section -->
          <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:12px">
            <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">ðŸ“‹ Subscription Clients</div>
            <div id="subscription-panel"></div>
          </div>
          <!-- v10: Morale section -->
          <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:12px" id="morale-section">
            <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">ðŸ˜Š Staff Morale</div>
            <div id="morale-panel"></div>
            <button class="btn btn-primary btn-sm btn-full" style="margin-top:6px" onclick="Morale.buyLunch()">ðŸ• Team Lunch â€” â‚¬80 (restore all morale)</button>
          </div>
        </div>
        <div class="tab-content" id="tab-voorraad">
          <div id="inventory-panel"></div>
        </div>
        <div class="tab-content" id="tab-settings">
          <div class="settings-section">
            <div class="settings-row">
              <div>
                <div class="settings-label">ðŸ”Š Sound</div>
                <div class="settings-sub">Synthesized audio feedback</div>
              </div>
              <button class="btn btn-ghost btn-sm" onclick="Sound.toggle()">Toggle</button>
            </div>
            <div class="settings-row">
              <div>
                <div class="settings-label">ðŸŽ¨ Printer Skin</div>
                <div class="settings-sub">Visual theme for the print station</div>
                <div class="skin-selector">
                  <span class="skin-label">Theme:</span>
                  <span class="skin-dot active-skin" style="background:#00e5ff" onclick="Skins.set('default')" title="Default" id="skin-default"></span>
                  <span class="skin-dot" style="background:#a78bfa" onclick="Skins.set('midnight')" title="Midnight" id="skin-midnight"></span>
                  <span class="skin-dot" style="background:#ff3d5a" onclick="Skins.set('lava')" title="Lava" id="skin-lava"></span>
                  <span class="skin-dot" style="background:#7fff6e" onclick="Skins.set('forest')" title="Forest" id="skin-forest"></span>
                </div>
              </div>
            </div>
            <div class="settings-row">
              <div>
                <div class="settings-label">ðŸ”” Notifications</div>
                <div class="settings-sub">Alert when print finishes</div>
              </div>
              <button class="btn btn-ghost btn-sm" onclick="Notifications.toggle()">Enable</button>
            </div>
            <div class="settings-row">
              <div>
                <div class="settings-label">ðŸ“– Tutorial</div>
                <div class="settings-sub">Restart the onboarding</div>
              </div>
              <button class="btn btn-ghost btn-sm" onclick="Tutorial.start()">Restart</button>
            </div>
            <div class="settings-row" style="flex-direction:column;align-items:flex-start;gap:8px;">
              <div class="settings-label">ðŸ’¾ Save / Export</div>
              <div style="display:flex;gap:6px;flex-wrap:wrap;width:100%">
                <button class="btn btn-ghost btn-sm" onclick="Game.saveGame(true)" style="flex:1">Manual Save</button>
                <button class="btn btn-ghost btn-sm" onclick="Game.exportSave()" style="flex:1">ðŸ“¤ Export JSON</button>
              </div>
              <label class="btn btn-ghost btn-sm" style="flex:1;cursor:pointer;text-align:center;width:100%">
                ðŸ“¥ Import Save <input type="file" accept=".json" style="display:none" onchange="Game.importSave(event)">
              </label>
            </div>
            <div class="settings-danger-zone">
              <div class="settings-danger-title">âš  Danger Zone</div>
              <button class="btn btn-danger btn-sm btn-full" onclick="Game.resetGame()">â†º Reset All Progress</button>
            </div>
            <div id="prestige-section" style="margin-top:8px;"></div>
          </div>
        </div>
        <!-- v8: RESEARCH TAB -->
        <div class="tab-content" id="tab-research">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            âš—ï¸ Invest in <strong style="color:var(--accent)">Research</strong> to unlock powerful upgrades and permanent bonuses. Only one research project at a time.
          </div>
          <div id="research-panel"></div>
        </div>
        <!-- v8: BOUNTIES TAB -->
        <div class="tab-content" id="tab-bounties">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            ðŸŽ¯ <strong style="color:#ffd700">Bounties</strong> are special high-reward challenges. Complete them for bonus cash and reputation. Refreshes every 10 minutes.
          </div>
          <div id="bounty-panel"></div>
        </div>
        <!-- v8: DASHBOARD TAB -->
        <div class="tab-content" id="tab-dashboard">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            ðŸ“ˆ Your business at a glance â€” KPIs, efficiency, milestones and records.
          </div>
          <div id="dashboard-panel"></div>
        </div>
        <!-- v8: EQUIPMENT EVENTS TAB -->
        <div class="tab-content" id="tab-equipment">
          <div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
            ðŸ”§ <strong style="color:var(--danger)">Equipment Events</strong> require your attention. Fix issues quickly to keep production running smoothly.
          </div>
          <div id="equip-events-panel"></div>
          <div style="margin-top:12px;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);">
            <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Milestones</div>
            <div id="milestone-progress-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- v8: MILESTONE OVERLAY -->
<div id="milestone-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:8999;backdrop-filter:blur(3px)">
  <div id="milestone-banner" class="milestone-banner" style="display:none"></div>
</div>

<!-- v10: TAX OVERLAY -->
<div class="tax-overlay" id="tax-overlay">
  <div class="tax-box">
    <div style="font-size:36px;margin-bottom:6px">ðŸ§¾</div>
    <div class="tax-title">VAT BILL!</div>
    <div class="tax-amount" id="tax-amount">â‚¬0.00</div>
    <div class="tax-sub">The government wants its cut.<br>Buy an <strong style="color:var(--warn)">Accountant</strong> to reduce VAT by 40%.</div>
    <div class="tax-breakdown" id="tax-breakdown"></div>
    <button class="btn btn-primary btn-full" style="margin-top:4px" onclick="TaxSystem.pay()">ðŸ’³ Pay Tax Bill</button>
    <div style="font-size:9px;color:var(--danger);margin-top:6px" id="tax-warning"></div>
  </div>
</div>

<!-- v10: COMPLAINT OVERLAY -->
<div class="complaint-overlay" id="complaint-overlay">
  <div class="complaint-box">
    <div class="complaint-face" id="complaint-face">ðŸ˜¤</div>
    <div class="complaint-title">CLIENT COMPLAINT!</div>
    <div style="font-size:10px;color:var(--text-dim);margin-top:4px" id="complaint-client">TechHobbyist99</div>
    <div class="complaint-msg" id="complaint-msg">"I paid good money for this and it came out like spaghetti!"</div>
    <div class="complaint-choices">
      <button class="btn btn-danger btn-sm" onclick="Complaints.refund()">ðŸ’¸ Refund (âˆ’â‚¬<span id="complaint-refund">25</span>)</button>
      <button class="btn btn-ghost btn-sm" onclick="Complaints.ignore()">ðŸ™„ Ignore (âˆ’<span id="complaint-rep">10</span> Rep)</button>
    </div>
  </div>
</div>

<!-- v10: PRESTIGE PERK SELECT -->
<div class="perk-select-overlay" id="perk-select-overlay">
  <div class="perk-select-box">
    <div class="perk-select-title">â­ LEGACY PERK</div>
    <div class="perk-select-sub">Choose one permanent bonus that survives all future prestiges.</div>
    <div class="perk-select-grid" id="perk-select-grid"></div>
  </div>
</div>

<!-- v9: CLOG MINI-GAME -->
<div id="clog-overlay">
  <div class="clog-box">
    <div class="clog-title">ðŸ”´ NOZZLE CLOG!</div>
    <div class="clog-desc">Your nozzle clogged mid-print! Rapidly click the button to clear it before the job fails!<br><span style="color:var(--danger);font-size:10px">Printer: <span id="clog-printer-name">Printer #1</span></span></div>
    <div class="clog-progress-text"><span id="clog-clicks">0</span> / <span id="clog-target">20</span> presses</div>
    <div class="clog-timer-bar"><div class="clog-timer-fill" id="clog-timer-fill" style="width:100%"></div></div>
    <div class="clog-mash">
      <button class="clog-mash-btn" onclick="ClogMinigame.press()" id="clog-btn">ðŸ”§</button>
    </div>
    <div style="font-size:10px;color:var(--text-dim);margin-top:4px" id="clog-feedback">Mash the button to clear the clog!</div>
    <button class="btn btn-ghost btn-sm" style="margin-top:10px;width:100%" onclick="ClogMinigame.skip()">Skip (Job will fail)</button>
  </div>
</div>

<!-- POPUP -->
<div id="popup-overlay">
  <div class="popup" id="popup-box">
    <div class="popup-title" id="popup-title">Event!</div>
    <div class="popup-body"  id="popup-body">Something happened.</div>
    <div class="popup-actions">
      <button class="btn btn-ghost btn-sm" id="popup-cancel" onclick="closePopup()" style="display:none;">Cancel</button>
      <button class="btn btn-primary"      id="popup-ok"     onclick="closePopup()">OK</button>
    </div>
  </div>
</div>

<script>
/* ============================================================
   PRINT & PROFIT â€“ v3.0
   New in v3.0: Printer skins, customer loyalty system, breakdown
   mini-game, filament pie chart, browser notifications, customer
   quotes, local leaderboard, mobile responsive, urgent pulse, PWA.
   ============================================================ */

// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const APP_VERSION = 12;

// â”€â”€ UTILITY HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/** Round to 2 decimal places (â‚¬ values) */
const r2 = (v) => Math.round((Number(v) || 0) * 100) / 100;
/** Round to 0 decimal places */
const r0 = (v) => Math.round(Number(v) || 0);
/** getElementById shorthand */
const el  = id => document.getElementById(id);
const $el = el; // alias for use inside functions that shadow `el`
/** Clamp a value between min and max */
const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
/** Get CSS filament class from filament key */
const filClass = f => ({ 'PA6':'pa6', 'PA6-GF':'pa6', 'TPU':'tpu', 'RESIN':'resin', 'PETG':'petg', 'PLA':'pla' }[f] ?? f.toLowerCase());
/** Format â‚¬ with 2 decimals */
const fmtEur = v => `â‚¬${r2(v).toFixed(2)}`;
/** Format time in m:ss */
const fmtTime = s => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;


const CONFIG = {
  TICK_MS:            500,
  ORDER_MIN_SEC:      15,
  ORDER_MAX_SEC:      35,
  MAX_ORDERS:         5,
  ORDER_EXPIRE_S:     90,
  STARTING_MONEY:     50,
  REP_PER_SUCCESS:    2,
  REP_PER_FAILURE:    -3,
  REP_PER_EXPIRED:    -1,
  MAX_REP:            200,
  REPAIR_COST_PER_HP: 0.5,
  CONTRACT_REFRESH_S: 600,   // contracts refresh every 10 min
  DAILY_REFRESH_S:    86400, // daily contract every 24h (real time)
  INCOME_HISTORY_MAX: 40,    // data points in graph

  PRINTER_MODELS: {
    BASIC: { name:'Ender Clone',          speedMult:1.0, failAdd:0.00,  cost:0,    desc:'Standaard. Goedkoop en redelijk.' },
    SPEED: { name:'CoreXY Speedster',     speedMult:0.5, failAdd:0.18,  cost:1500, desc:'Extreem snel (50% tijd), maar faalt veel vaker.' },
    TANK:  { name:'Industrial Workhorse', speedMult:1.5, failAdd:-0.15, cost:2500, desc:'Traag (150% tijd), maar faalt vrijwel nooit.' },
    DELTA: { name:'Delta Titan',          speedMult:0.7, failAdd:-0.05, cost:0,    desc:'Grote delta printer. Snel Ã©n betrouwbaar. Exclusief voor Titan #5.' },
  },

  TRENDING_PRODUCTS: [
    { trigger:'Fidget',        item:'Fidget',        mult:2.5, desc:'Fidgets zijn viraal gegaan op TikTok! Marges Ã—2.5' },
    { trigger:'Mask',          item:'Mask',          mult:3.0, desc:'Comic Con weekend! Cosplay props schieten in prijs omhoog.' },
    { trigger:'Fan Shroud',    item:'Fan Shroud',    mult:2.0, desc:'Hittegolf! Iedereen wil ventilator-onderdelen.' },
    { trigger:'Bracket',       item:'Bracket',       mult:1.8, desc:'School seizoen! Houders en brackets zijn hot.' },
    { trigger:'Figurine',      item:'Figurine',      mult:2.8, desc:'Kickstarter-campagne explosiefgroei! Figurines gewild.' },
    { trigger:'Phone Stand',   item:'Phone Stand',   mult:2.2, desc:'Viral desk-setup trend op sociale media!' },
    { trigger:'Gear',          item:'Gear',          mult:2.4, desc:'Robotica-competitie! Tandwielen en onderdelen in trek.' },
    { trigger:'Trophy',        item:'Trophy Ornament',mult:2.6,desc:'Award-seizoen! TrofeeÃ«n en ornamenten zijn hot.' },
    { trigger:'Miniature',     item:'Miniature',     mult:3.2, desc:'Tabletop gaming boom! Miniaturen in enorme vraag.' },
    { trigger:'Phone Bumper',  item:'Phone Bumper',  mult:1.9, desc:'Nieuw flagship-telefoon uitgebracht! Hoesjes gewild.' },
    { trigger:'Drone',         item:'Drone Frame',   mult:2.7, desc:'Drone racing seizoen gestart! Frames gewild.' },
    { trigger:'Vase',          item:'Vase',          mult:2.0, desc:'Home decor trend â€” vazen en potten zijn viraal.' },
  ],

  FILAMENTS: {
    PLA:   { name:'PLA',                  costPerJob:2,  failBase:0.05, profitMult:1.0, repBonus:1.0, color:'var(--pla)',   desc:'Cheap & reliable',                    unlockRep:0,   stockUse:3  },
    PETG:  { name:'PETG',                 costPerJob:5,  failBase:0.12, profitMult:1.5, repBonus:1.3, color:'var(--petg)',  desc:'Strong & flexible',                   unlockRep:20,  stockUse:4  },
    PA6:   { name:'PA6-GF',               costPerJob:12, failBase:0.25, profitMult:2.5, repBonus:2.0, color:'var(--pa6)',   desc:'Engineering grade',                   unlockRep:60,  stockUse:5  },
    TPU:   { name:'TPU',                  costPerJob:8,  failBase:0.18, profitMult:2.0, repBonus:1.6, color:'#ff9f43',      desc:'Flexible & durable',                  unlockRep:40,  stockUse:4, special:'flex' },
    RESIN: { name:'Resin',                costPerJob:15, failBase:0.30, profitMult:3.5, repBonus:2.5, color:'#ee5a24',      desc:'Ultra-detail SLA prints',             unlockRep:80,  stockUse:6, special:'detail', requiresUpgrade:'resin_printer' },
    CF:    { name:'Carbon Fiber (PA-CF)', costPerJob:25, failBase:0.35, profitMult:5.0, repBonus:3.0, color:'#4a4a4a',      desc:'Extreme marges, maar vernielt nozzles (35% faalkans)', unlockRep:120, stockUse:5, special:'abrasive' },
    GLOW:  { name:'Glow-in-the-Dark',     costPerJob:10, failBase:0.15, profitMult:2.5, repBonus:1.5, color:'#ccff00',      desc:'Perfect voor speelgoed-klanten en nachttarieven',      unlockRep:50,  stockUse:3  },
  },

  QUALITY: {
    DRAFT:  { name:'Draft',  timeMult:0.6,  failAdd:0.05,  profitMult:0.8,  repMult:0.8  },
    NORMAL: { name:'Normal', timeMult:1.0,  failAdd:0.00,  profitMult:1.0,  repMult:1.0  },
    FINE:   { name:'Fine',   timeMult:1.6,  failAdd:-0.04, profitMult:1.3,  repMult:1.2  },
    ULTRA:  { name:'Ultra',  timeMult:2.5,  failAdd:-0.06, profitMult:1.7,  repMult:1.5  },
  },

  UPGRADES: [
    // â”€â”€ BETROUWBAARHEID â”€â”€
    { id:'bed_leveling',   name:'Auto Bed Leveling',   desc:'ABL probe eliminates first-layer failures.',        effect:'âˆ’8% fail chance',          cost:80,   unlockLevel:1, category:'reliability', premium:false, apply:(s)=>{ s.failBonus -= 0.08; } },
    { id:'hardened_nozzle',name:'Hardened Nozzle',      desc:'Wear-resistant â€” reduces abrasive filament clogs.', effect:'âˆ’10% fail (PETG/PA6)',       cost:150,  unlockLevel:2, category:'reliability', premium:false, apply:(s)=>{ s.abrasiveBonus -= 0.10; } },
    { id:'enclosure',      name:'Printer Enclosure',    desc:'Enclosed volume reduces warping dramatically.',      effect:'âˆ’12% fail globally',        cost:350,  unlockLevel:3, category:'reliability', premium:false, apply:(s)=>{ s.failBonus -= 0.12; } },
    { id:'dryer',          name:'Filament Dryer',       desc:'Dry filament = fewer PA6-GF and PETG failures.',    effect:'âˆ’15% fail (hygroscopic)',    cost:280,  unlockLevel:3, category:'reliability', premium:false, apply:(s)=>{ s.dryerBonus -= 0.15; } },
    { id:'ups_system',     name:'UPS Battery System',  desc:'Uninterruptible power supply. Prevents all power outages from disrupting prints.',  effect:'Immune to power outages', cost:1200, unlockLevel:4, category:'reliability', premium:false, apply:(s)=>{ /* flag is checked by PowerOutage module */ } },
    { id:'accountant',     name:'Accountant',          desc:'Part-time accountant files your taxes optimally. VAT reduced from 15% to 9%.',       effect:'VAT cut to 9%',           cost:2000, unlockLevel:4, category:'profit',      premium:false, apply:(s)=>{ s.hasAccountant=true; s.taxRate=0.09; } },
    { id:'insurance',      name:'Business Insurance',  desc:'Monthly premium of â‚¬50. Covers catastrophic equipment failures and power outages.',   effect:'Failures covered by insurance', cost:500, unlockLevel:3, category:'reliability', premium:false, apply:(s)=>{ s.hasInsurance=true; } },
    { id:'recycler',       name:'Filament Recycler',   desc:'Turns failed print scrap into usable filament. Collect scrap, convert to stock.',     effect:'Convert scrapâ†’filament',  cost:900,  unlockLevel:3, category:'reliability', premium:false, apply:(s)=>{ /* checked by Recycling module */ } },
    { id:'subscription_sys',name:'Subscription System',desc:'Enables recurring print subscriptions. Some clients auto-send weekly orders.',        effect:'Unlock subscription clients', cost:3500, unlockLevel:5, category:'profit', premium:false, apply:(s)=>{ Subscriptions.unlock(); } },
    // â”€â”€ SNELHEID â”€â”€
    { id:'faster_extruder',name:'Volcano Extruder',     desc:'High-flow hotend prints 30% faster.',               effect:'âˆ’30% print time',           cost:200,  unlockLevel:2, category:'speed',       premium:false, apply:(s)=>{ s.speedMult *= 0.70; } },
    { id:'cloud_slicer',   name:'Cloud Slicer',         desc:'AI-optimised slicing cuts print time significantly.',effect:'-20% print time (all)',      cost:4000, unlockLevel:6, category:'speed',       premium:false, apply:(s)=>{ s.speedMult *= 0.80; } },
    { id:'direct_drive',   name:'Direct Drive',         desc:'Better filament control â€” faster retraction & flex filaments.',effect:'-15% time, TPU unlock',   cost:500,  unlockLevel:3, category:'speed',       premium:false, apply:(s)=>{ s.speedMult *= 0.85; s.tpuUnlocked = true; } },
    { id:'klipper',        name:'Klipper Firmware',     desc:'Input shaping eliminates ringing â€” up to 40% speed gain.',  effect:'-25% print time, -5% fail',cost:2500,unlockLevel:5, category:'speed',       premium:false, apply:(s)=>{ s.speedMult *= 0.75; s.failBonus -= 0.05; } },
    // â”€â”€ WINST â”€â”€
    { id:'ams',            name:'AMS Multi-Material',   desc:'Automated Material System. Opens premium orders.',  effect:'+25% all rewards',          cost:500,  unlockLevel:3, category:'profit',      premium:false, apply:(s)=>{ s.rewardMult += 0.25; } },
    { id:'passive_income', name:'Online Store',         desc:'Print-on-demand store generates passive income.',   effect:'+â‚¬10/min passive',          cost:800,  unlockLevel:4, category:'profit',      premium:false, apply:(s)=>{ s.passivePerMin += 10; } },
    { id:'auto_package',   name:'Automated Packaging',  desc:'Robotic packaging arm. Every job earns +1 rep.',   effect:'+1 Rep per completed job',   cost:2200, unlockLevel:5, category:'profit',      premium:false, apply:(s)=>{ s.packagingBonus = true; } },
    { id:'etsy_store',     name:'Etsy Empire',          desc:'Full e-commerce store. Massive passive income.',   effect:'+â‚¬40/min passive',           cost:8000, unlockLevel:7, category:'profit',      premium:false, apply:(s)=>{ s.passivePerMin += 40; } },
    { id:'bulk_deals',     name:'Bulk Deal Contracts',  desc:'Negotiate bulk pricing â€” filament costs âˆ’20% permanently.', effect:'âˆ’20% filament costs',  cost:1800, unlockLevel:4, category:'profit',      premium:false, apply:(s)=>{ s.bulkDealActive = true; } },
    // â”€â”€ UITBREIDING â”€â”€
    { id:'printer2',       name:'2nd Printer',          desc:'Run two jobs simultaneously. True idle income.',     effect:'Second printer slot',       cost:1200, unlockLevel:4, category:'expansion',   premium:false, apply:(s)=>{ s.printerCount = 2; } },
    { id:'printer3',       name:'3rd Printer',          desc:'Scale up to three simultaneous print jobs.',        effect:'Third printer slot',         cost:3500, unlockLevel:5, category:'expansion',   premium:false, apply:(s)=>{ s.printerCount = 3; } },
    { id:'printer4',       name:'4th Printer (Farm)',   desc:'Industrial scale â€” four printers running 24/7.',    effect:'Fourth printer slot',        cost:8000, unlockLevel:7, category:'expansion',   premium:false, apply:(s)=>{ s.printerCount = 4; } },
    { id:'resin_printer',  name:'SLA Resin Printer',    desc:'Add a stereolithography printer for ultra-detailed miniatures and jewelry.',  effect:'Unlock Resin filament',  cost:2800, unlockLevel:5, category:'expansion',   premium:false, apply:(s)=>{ s.resinUnlocked = true; } },
    { id:'uv_station',     name:'UV Curing Station',    desc:'Post-cure resin prints for max quality. âˆ’25% fail on Resin.', effect:'Resin fail âˆ’25%',       cost:400,  unlockLevel:5, category:'expansion',   premium:false, apply:(s)=>{ s.uvCuring = true; s.failBonus -= 0.05; } },
    { id:'flex_bed',       name:'Flexible Print Bed',   desc:'PEI-coated spring steel sheet. TPU prints peel off perfectly.', effect:'TPU fail âˆ’20%',         cost:120,  unlockLevel:2, category:'expansion',   premium:false, apply:(s)=>{ s.flexBed = true; } },
    // â”€â”€ PRINTER MODELS â”€â”€
    { id:'model_speed',     name:'Upgrade to CoreXY',         desc:'Vervang Printer #2 met een CoreXY Speedster. 50% sneller, maar +18% faalkans.', effect:'Printer #2: 2Ã— speed, +18% fail', cost:1500, unlockLevel:3, category:'speed',       premium:false, apply:(s)=>{ const p=s.printers.find(p=>p.id===1); if(p) p.model='SPEED'; } },
    { id:'model_tank',      name:'Industrial Workhorse',       desc:'Zet Printer #2 om naar Industrial Workhorse. Betrouwbaar en stabiel.', effect:'Printer #2: 1.5Ã— time, âˆ’15% fail', cost:2500, unlockLevel:4, category:'reliability',  premium:false, apply:(s)=>{ const p=s.printers.find(p=>p.id===1); if(p) p.model='TANK'; } },
    { id:'model_speed_p3',  name:'CoreXY voor Printer #3',     desc:'Zet Printer #3 om naar CoreXY Speedster voor maximale doorvoer.', effect:'Printer #3: 2Ã— speed, +18% fail', cost:1500, unlockLevel:5, category:'speed',       premium:false, apply:(s)=>{ const p=s.printers.find(p=>p.id===2); if(p) p.model='SPEED'; } },
    { id:'model_tank_p3',   name:'Workhorse voor Printer #3',  desc:'Zet Printer #3 om naar Industrial Workhorse voor stabiele lange runs.', effect:'Printer #3: 1.5Ã— time, âˆ’15% fail', cost:2500, unlockLevel:6, category:'reliability', premium:false, apply:(s)=>{ const p=s.printers.find(p=>p.id===2); if(p) p.model='TANK'; } },
    // â”€â”€ NICHE FILAMENTS â”€â”€
    { id:'glow_filament',   name:'Glow-in-the-Dark Filament',  desc:'Ontgrendel Glow-in-the-Dark filament. Perfect voor speelgoed en nacht-items.', effect:'Unlock GLOW filament', cost:600,  unlockLevel:3, category:'expansion',   premium:false, apply:(s)=>{ s.glowUnlocked=true; } },
    { id:'cf_nozzle',       name:'CF Nozzle + Enclosure',      desc:'Hardened nozzle en enclosure voor Carbon Fiber. Vermindert de 35% faalkans met 20% â†’ ~15% effectief.', effect:'Unlock CF filament, âˆ’20% CF fail', cost:1800, unlockLevel:5, category:'expansion', premium:false, apply:(s)=>{ s.cfUnlocked=true; s.cfNozzle=true; } },
    // â”€â”€ PRO UPGRADES â”€â”€
    { id:'smart_queue',    name:'Smart Queue',          desc:'AI auto-assigns the highest-value pending order to the next free printer.',  effect:'Auto-assign orders', cost:0, unlockLevel:1, category:'pro', premium:true, apply:(s)=>{ s.smartQueue = true; } },
    { id:'ai_quality',     name:'AI Quality Control',  desc:'Computer vision detects failures mid-print and cancels early.',              effect:'âˆ’50% failure damage',  cost:0, unlockLevel:1, category:'pro', premium:true, apply:(s)=>{ s.aiQuality = true; } },
    { id:'supplier_ai',    name:'Supplier AI',         desc:'AI monitors market and auto-buys filament when prices are low.',             effect:'Auto-buy cheap filament', cost:0, unlockLevel:3, category:'pro', premium:true, apply:(s)=>{ s.supplierAI = true; } },
  ],

  BIZ_LEVELS: [
    { name:'Garage Tinkerer', xp:0,    level:1 },
    { name:'Hobbyist',        xp:100,  level:2 },
    { name:'Side Hustler',    xp:300,  level:3 },
    { name:'Print Studio',    xp:700,  level:4 },
    { name:'Pro Workshop',    xp:1500, level:5 },
    { name:'Factory Floor',   xp:3000, level:6 },
    { name:'Print Empire',    xp:6000, level:7 },
    { name:'Industry Titan',  xp:12000,level:8 },
  ],

  ACHIEVEMENTS: [
    { id:'first_print',   name:'First Layer',      desc:'Complete your first print.',            check:(s)=>s.stats.jobsDone>=1        },
    { id:'five_jobs',     name:'Getting Warm',      desc:'Complete 5 jobs.',                      check:(s)=>s.stats.jobsDone>=5        },
    { id:'hundred',       name:'Centurion',         desc:'Earn â‚¬100 total.',                      check:(s)=>s.stats.totalEarned>=100   },
    { id:'first_fail',    name:'Spaghetti!',        desc:'Experience your first failure.',        check:(s)=>s.stats.jobsFailed>=1      },
    { id:'first_upgrade', name:'Upgrader',          desc:'Buy your first upgrade.',               check:(s)=>s.stats.upgradesBought>=1  },
    { id:'rep_50',        name:'Reliable',          desc:'Reach 50 reputation.',                  check:(s)=>s.reputation>=50           },
    { id:'rep_100',       name:'Trusted Brand',     desc:'Reach 100 reputation.',                 check:(s)=>s.reputation>=100          },
    { id:'thousand',      name:'Grand',             desc:'Earn â‚¬1,000 total.',                    check:(s)=>s.stats.totalEarned>=1000  },
    { id:'pa6_success',   name:'Engineering Grade', desc:'Successfully print PA6-GF.',            check:(s)=>s.stats.pa6Done>=1         },
    { id:'dual_printer',  name:'Scale-Up',          desc:'Own two printers.',                     check:(s)=>s.printerCount>=2          },
    { id:'ten_k',         name:'Print Baron',       desc:'Earn â‚¬10,000 total.',                   check:(s)=>s.stats.totalEarned>=10000 },
    { id:'first_contract',name:'Under Contract',    desc:'Complete your first contract.',         check:(s)=>s.stats.contractsDone>=1   },
    { id:'five_contracts', name:'Contractor',       desc:'Complete 5 contracts.',                 check:(s)=>s.stats.contractsDone>=5   },
    { id:'daily_done',    name:'Daily Grind',       desc:'Complete a daily special contract.',    check:(s)=>s.stats.dailyDone>=1       },
    // â”€â”€ NEW v2.0 â”€â”€
    { id:'streak_5',      name:'On a Roll',         desc:'Complete 5 jobs in a row without failure.', check:(s)=>s.stats.longestStreak>=5   },
    { id:'streak_10',     name:'Hot Streak',        desc:'10-job streak â€” flawless.',             check:(s)=>s.stats.longestStreak>=10  },
    { id:'night_owl',     name:'Night Owl',         desc:'Print a job after 22:00.',              check:(s)=>s.stats.nightShiftJobs>=1  },
    { id:'speed_demon',   name:'Speed Demon',       desc:'Complete a job in under 18 seconds.',   check:(s)=>s.stats.fastestJob>0&&s.stats.fastestJob<=18 },
    { id:'fifty_jobs',    name:'Assembly Line',     desc:'Complete 50 jobs.',                     check:(s)=>s.stats.jobsDone>=50       },
    { id:'hundred_jobs',  name:'Print Marathon',    desc:'Complete 100 jobs.',                    check:(s)=>s.stats.jobsDone>=100      },
    { id:'twenty_k',      name:'Print Mogul',       desc:'Earn â‚¬20,000 total.',                   check:(s)=>s.stats.totalEarned>=20000 },
    { id:'market_master', name:'Market Watcher',    desc:'Sell 10 jobs during a market surge (Ã—1.2+).', check:(s)=>s.stats.marketSurgeJobs>=10 },
    { id:'triple_printer',name:'Print Farm',        desc:'Own three printers.',                   check:(s)=>s.printerCount>=3          },
    { id:'rep_150',       name:'Industry Legend',   desc:'Reach 150 reputation.',                 check:(s)=>s.reputation>=150          },
    { id:'petg_ten',      name:'PETG Pro',          desc:'Complete 10 PETG jobs.',                check:(s)=>s.stats.petgDone>=10       },
    { id:'passive_earner',name:'Passive Income',    desc:'Earn â‚¬100 from passive sources.',       check:(s)=>s.stats.passiveEarned>=100 },
    { id:'all_upgrades',  name:'Maxed Out',         desc:'Own 8 or more upgrades.',               check:(s)=>s.ownedUpgrades.length>=8  },
    { id:'prestige_1',    name:'Fresh Start',        desc:'Prestige for the first time.',           check:(s)=>s.prestige>=1              },
    { id:'combo_10',      name:'Combo Master',       desc:'Reach a 10Ã— combo.',                    check:(s)=>s.stats.maxCombo>=10       },
    { id:'speedrun_win',  name:'Speed Printer',      desc:'Earn â‚¬200 in a single speedrun.',       check:(s)=>s.stats.bestSpeedrun>=200  },
    { id:'all_specs',     name:'Specialist Farm',    desc:'Give all 3 printers a specialization.', check:(s)=>Object.keys(s.printerSpecs).length>=3 },
    // â”€â”€ v7 NEW â”€â”€
    { id:'tpu_first',     name:'Flex Master',        desc:'Print your first TPU flexible job.',    check:(s)=>(s.stats.tpuDone||0)>=1   },
    { id:'resin_first',   name:'Precision Artisan',  desc:'Print your first Resin SLA job.',       check:(s)=>(s.stats.resinDone||0)>=1 },
    { id:'tpu_ten',       name:'Rubber King',        desc:'Complete 10 TPU jobs.',                 check:(s)=>(s.stats.tpuDone||0)>=10  },
    { id:'resin_five',    name:'SLA Expert',         desc:'Complete 5 Resin jobs.',                check:(s)=>(s.stats.resinDone||0)>=5 },
    { id:'all_filaments', name:'Material Master',    desc:'Use all 5 filament types.',             check:(s)=>(s.stats.filamentsUsed||[]).length>=5 },
    { id:'supplier_trust',name:'Trusted Partner',    desc:'Reach Trusted status with a supplier.', check:(s)=>Object.values(s.supplierRelations||{}).some(r=>r>=2) },
    { id:'crisis_survivor',name:'Crisis Survivor',   desc:'Complete 5 jobs during a market crisis.',check:(s)=>(s.stats.crisisJobsDone||0)>=5 },
    { id:'challenge_one', name:'Challenger',         desc:'Complete your first weekly challenge.', check:(s)=>(s.stats.challengesDone||0)>=1 },
    { id:'printer4_own',  name:'Print Farm',         desc:'Own four printers.',                   check:(s)=>s.printerCount>=4          },
    { id:'ultra_ten',     name:'Ultra Perfectionist',desc:'Complete 10 Ultra quality jobs.',       check:(s)=>(s.stats.ultraJobs||0)>=10 },
    // â”€â”€ v9 NEW â”€â”€
    { id:'beat_rival',    name:'Beat the Bot',        desc:'Complete 20 more jobs than PrintBot.',  check:(s)=>s.stats.jobsDone > (s.rivalScore||0)+20 },
    { id:'surge_hero',    name:'Surge Warrior',        desc:'Complete 3 demand surges successfully.', check:(s)=>(s.stats.surgesDone||0)>=3 },
    { id:'debt_free',     name:'Debt Destroyer',       desc:'Repay a loan in full.',                 check:(s)=>(s.stats.loansRepaid||0)>=1 },
    { id:'clog_champ',    name:'Clog Champion',        desc:'Win 5 nozzle clog mini-games.',         check:(s)=>(s.stats.clogWins||0)>=5 },
    { id:'no_outage',     name:'Blackout Proof',        desc:'Buy the UPS upgrade.',                  check:(s)=>s.ownedUpgrades.includes('ups_system') },
    // â”€â”€ v10 NEW â”€â”€
    { id:'tax_man',       name:'Tax Man',               desc:'Pay 5 VAT bills without penalty.',      check:(s)=>(s.stats_v10?.taxPaid||0) >= 250 },
    { id:'platinum_client',name:'Platinum Standard',   desc:'Reach Platinum tier with any client.',  check:(s)=>Object.values(s.clientTiers||{}).includes('platinum') },
    { id:'franchise_boss',name:'Franchise Boss',        desc:'Open your first franchise branch.',     check:(s)=>(s.franchiseBranches||[]).length >= 1 },
    { id:'legacy_master', name:'Legacy Master',         desc:'Earn 3 Legacy Perks.',                  check:(s)=>(s.legacyPerks||[]).length >= 3 },
    { id:'hall_of_famer', name:'Hall of Famer',         desc:'Appear in the Hall of Fame.',           check:(s)=>(s.prestige||0)>=1 },
    { id:'scrap_king',    name:'Scrap King',             desc:'Recycle 10 batches of scrap.',          check:(s)=>(s.stats_v10?.scrapsRecycled||0)>=10 },
    { id:'team_spirit',   name:'Team Spirit',           desc:'Buy 3 Team Lunches.',                   check:(s)=>(s.stats.lunchesBought||0)>=3 },
    { id:'subscriber',    name:'Subscriber',             desc:'Complete 20 subscription orders.',      check:(s)=>(s.stats_v10?.subscriptionJobsDone||0)>=20 },
    // v12 achievements
    { id:'night_grinder', name:'Nachtdienst Pro',         desc:'Print 25 jobs tijdens het nachtshift.',  check:(s)=>(s.stats.nightShiftJobs||0)>=25 },
    { id:'cf_master',     name:'CF Meester',               desc:'Voltooi 5 Carbon Fiber jobs.',           check:(s)=>(s.stats.cfDone||0)>=5 },
    { id:'researcher',    name:'Wetenschapper',            desc:'Voltooi 5 research projecten.',          check:(s)=>(s.completedResearch||[]).length>=5 },
    { id:'ai_factory',    name:'AI Fabriek',               desc:'Ontgrendel de AI Print Factory research.', check:(s)=>(s.completedResearch||[]).includes('r_ai_factory') },
    { id:'trend_surfer',  name:'Trend Surfer',             desc:'Voltooi 10 TRENDING orders.',            check:(s)=>(s.stats.trendOrdersDone||0)>=10 },
    { id:'five_printer',  name:'Print God Farm',           desc:'Heb 5 printers tegelijk.',               check:(s)=>s.printerCount>=5 },
  ],

  EVENTS: [
    { title:'ðŸ“¦ Bulk Order Bonus!',  body:'A makespace placed a bulk order! Rewards +30% for next 3 jobs.',   effect:'bulkBonus',    value:3    },
    { title:'ðŸ”¥ Clog Warning!',      body:'Nozzle temp spiked. Next print +15% fail chance.',                  effect:'nextFailBoost',value:0.15 },
    { title:'â­ 5-Star Review!',     body:'A customer left a glowing review. +10 Reputation!',                 effect:'repBoost',     value:10   },
    { title:'ðŸ’¸ Material Sale!',     body:'Supplier sale! Filament costs âˆ’50% for next 5 jobs.',              effect:'filDiscount',  value:5    },
    { title:'ðŸŒ¡ï¸ Power Surge!',      body:'Minor power fluctuation. Printer health âˆ’8.',                       effect:'hpLoss',       value:8    },
    { title:'ðŸ“° Local Press!',       body:'A local paper featured your shop! +15 Reputation.',                effect:'repBoost',     value:15   },
    { title:'ðŸŽ Warranty Parts!',    body:'Free maintenance kit arrived. Printer #1 health +20!',             effect:'hpHeal',       value:20   },
    { title:'ðŸ“± Viral TikTok!',      body:'Your shop went viral! Reputation +20 and bulk bonus for 5 jobs!',  effect:'repBoost',     value:20   },
    { title:'ðŸ§¯ Fire Drill!',        body:'Safety check slowed things down. Printer health âˆ’5, but +5 rep for compliance.', effect:'hpLoss', value:5 },
    { title:'ðŸ† Industry Award!',    body:'Your shop won a local 3D printing award! +25 Reputation!',         effect:'repBoost',     value:25   },
    { title:'ðŸŽ° Lucky Roll!',        body:'Surprise! Filament discount AND bulk bonus active together!',       effect:'filDiscount',  value:3    },
    { title:'ðŸ’§ Humidity Warning!',  body:'High humidity detected. Non-PLA filaments +10% fail next 3 jobs.', effect:'nextFailBoost',value:0.10 },
  ],

  EMPLOYEES: [
    { id:'student',   name:'Stage Student',   avatar:'ðŸ§‘â€ðŸŽ“', desc:'Start automatisch PLA-bestellingen. Langzaam maar goedkoop.', wagePM:5,  unlockLevel:2, effect:'autoPLA',   cost:200  },
    { id:'technician',name:'Technicus',        avatar:'ðŸ”§',   desc:'Repareert printers automatisch zodra health < 40%.', wagePM:12, unlockLevel:4, effect:'autoRepair', cost:800  },
    { id:'manager',   name:'Manager',          avatar:'ðŸ’¼',   desc:'Beheert wachtrij optimaal â€” pakt altijd de meest lucratieve order.', wagePM:20, unlockLevel:5, effect:'queueOpt',  cost:1500 },
    { id:'engineer',  name:'Print Engineer',   avatar:'ðŸ‘·',   desc:'Vermindert faalkansen met 10% op alle printers.', wagePM:25, unlockLevel:6, effect:'failRedux',  cost:2500 },
    { id:'salesperson',name:'Verkoper',        avatar:'ðŸ¤',   desc:'Genereert elke 2 minuten een bonus order met 30% hogere beloning.', wagePM:18, unlockLevel:5, effect:'bonusOrders',cost:1800 },
  ],

  PRODUCTION_CHAINS: [
    { id:'starter',  name:'Starter Kit',    steps:[{fil:'PLA',count:2},{fil:'PETG',count:1}],                  reward:80,  bonusTokens:3,  unlockLevel:2 },
    { id:'technical',name:'Tech Bundle',    steps:[{fil:'PETG',count:2},{fil:'PA6',count:1}],                  reward:200, bonusTokens:8,  unlockLevel:4 },
    { id:'fullspec', name:'Full Spectrum',  steps:[{fil:'PLA',count:2},{fil:'PETG',count:2},{fil:'PA6',count:2}],reward:500, bonusTokens:20, unlockLevel:6 },
    { id:'prototype',name:'Proto Sprint',   steps:[{fil:'PLA',count:1},{fil:'PETG',count:1},{fil:'PA6',count:1}],reward:300, bonusTokens:12, unlockLevel:5 },
  ],

  LOOTBOX_REWARDS: [
    { name:'â‚¬50 Cash',       icon:'ðŸ’°', rarity:'common',  apply:(s)=>{ s.money+=50; s.stats.totalEarned+=50; return '+â‚¬50 cash!'; } },
    { name:'+20 Reputatie',  icon:'â­', rarity:'common',  apply:(s)=>{ s.reputation=Math.min(200,s.reputation+20); return '+20 reputatie!'; } },
    { name:'+30 Health',     icon:'ðŸ”§', rarity:'common',  apply:(s)=>{ s.printers.forEach(p=>p.health=Math.min(100,p.health+30)); return 'Alle printers +30 health!'; } },
    { name:'â‚¬200 Cash',      icon:'ðŸ’Ž', rarity:'rare',    apply:(s)=>{ s.money+=200; s.stats.totalEarned+=200; return '+â‚¬200 cash!'; } },
    { name:'+50 Reputatie',  icon:'ðŸŒŸ', rarity:'rare',    apply:(s)=>{ s.reputation=Math.min(200,s.reputation+50); return '+50 reputatie!'; } },
    { name:'3Ã— Bulkbonus',   icon:'ðŸ“¦', rarity:'rare',    apply:(s)=>{ s.bulkBonusJobs+=3; return '3 jobs op 30% bulk bonus!'; } },
    { name:'â‚¬500 Jackpot!',  icon:'ðŸŽ°', rarity:'epic',    apply:(s)=>{ s.money+=500; s.stats.totalEarned+=500; return 'ðŸŽ° JACKPOT: +â‚¬500!'; } },
    { name:'+100 XP',        icon:'âš¡', rarity:'rare',    apply:(s)=>{ s.xp+=100; return '+100 XP!'; } },
    { name:'Gratis reparatie',icon:'ðŸ› ï¸',rarity:'common',  apply:(s)=>{ s.printers.forEach(p=>p.health=100); return 'Alle printers volledig gerepareerd!'; } },
    { name:'+5 Tokens',      icon:'ðŸŽ²', rarity:'common',  apply:(s)=>{ s.tokens+=5; return '+5 bonus tokens!'; } },
  ],

  CUSTOMER_QUOTES: {
    accept: [
      "Can't wait to see how this turns out!",
      "I've heard great things about your shop.",
      "Please get this done on time â€” it's important.",
      "Quality first! I'll pay extra if it's perfect.",
      "This is for a prototype, precision matters.",
      "My last shop messed this up. Don't disappoint.",
      "Rush order â€” I'll tip if it's done quickly!",
      "Engineering grade requested. No shortcuts.",
    ],
    loyalAccept: [
      "Great working with you again! You never disappoint.",
      "Back again â€” your quality speaks for itself.",
      "My go-to print shop. Keep it up!",
      "Returning customer here â€” you've earned my trust.",
    ],
  },
  ORDER_NAMES_TPU:  ['Flexible Gasket','Phone Bumper','Silicone Grip','Door Stop','Bike Handlebar','RC Tire','Shock Absorber','Cable Protector','Wearable Band','Soft Toy Part','Flexible Hinge','Seal Ring','Custom Insole','Grip Pad','Boot Cover'],
  ORDER_NAMES_RESIN: ['Miniature Figure','Dental Model','Jewelry Mold','Detailed Bust','Architectural Detail','Watch Housing','Gem Setting','Filigree Part','Portrait Figurine','Game Piece','Trophy Ornament','Scale Model','Fine Art Piece','Precision Gear','Medical Prototype'],
  ORDER_NAMES:  ['Figurine','Bracket','Enclosure','Gear','Phone Stand','Vase','Tool Holder','Lamp Shade','Cable Clip','Plant Pot','Drone Frame','RC Part','Jig','Sensor Housing','Architectural Model','Prosthetic','Robot Chassis','Custom Badge','Turbine Blade','Fluid Manifold'],
  // Filament-specific order names (used when rep unlocks them)
  ORDER_NAMES_PLA:  ['Figurine','Desktop Organizer','Phone Stand','Plant Pot','Cable Clip','Vase','Toy Robot','Name Tag','Coaster Set','Key Holder','Lamp Shade','Card Stand','Pencil Cup','Bookmark','Mini Trophy'],
  ORDER_NAMES_PETG: ['Bicycle Adapter','Enclosure','Drone Frame','RC Part','Electronic Housing','Waterproof Case','Mechanical Arm','Water Pump Housing','Ventilation Duct','Fan Shroud','Camera Mount','Cable Duct','Hinge Set','Bracket Set','Snap Clip'],
  ORDER_NAMES_PA6:  ['Turbine Blade','Gear Set','Fluid Manifold','Sensor Housing','Jig & Fixture','Industrial Bracket','Structural Connector','Motor Housing','Drive Shaft','Timing Pulley','Impeller','Wear Pad','Slide Rail','Bearing Housing','Coupling Flange'],
  ORDER_CUSTOMERS: ['TechHobbyist99','MakerMike','DIYQueen','PrintFan','RoboGeek','LocalMakespace','StartupXYZ','ArtStudio7','EngineerJane','HomeLab42','FabLab','DesignSprint','PrototypePete','IndustrialIvo','NanoLab'],

  CONTRACT_NAMES: ['Batch Order','Prototype Run','Bulk Delivery','Series Print','Custom Set','Volume Order','Design Sprint','Production Run','Rapid Prototype','Multi-Material Kit','Precision Batch','Engineering Set'],
  CONTRACT_CUSTOMERS: ['TechLab Inc.','DesignHub','AeroStartup','MedDevice Co.','UniversityLab','StartupXYZ','ArchStudio','FabLab Berlin','NanoTech GmbH','OpenSource Co.'],

  SUPPLIERS: [
    {
      id: 'cheapfil',
      name: 'CheapFil GmbH',
      avatar: 'ðŸ­',
      desc: 'Goedkope bulk filament. Wisselende kwaliteit.',
      basePrice: { PLA: 0.8, PETG: 2.0, PA6: 5.0, TPU: 3.5, RESIN: 7.0, CF: 12.0, GLOW: 4.0 },
      reliabilityBase: 0.75,
      discount: { preferred: 0.10, trusted: 0.20 },
    },
    {
      id: 'prusament',
      name: 'Prusament Pro',
      avatar: 'ðŸ‡¨ðŸ‡¿',
      desc: 'Hoge kwaliteit Europees filament. Betrouwbaar.',
      basePrice: { PLA: 1.4, PETG: 3.2, PA6: 8.0, TPU: 5.5, RESIN: 11.0, CF: 18.0, GLOW: 6.0 },
      reliabilityBase: 0.95,
      discount: { preferred: 0.08, trusted: 0.15 },
    },
    {
      id: 'localprint',
      name: 'LocalPrint NL',
      avatar: 'ðŸ‡³ðŸ‡±',
      desc: 'Snelle levering. Specialiseert in TPU & Resin.',
      basePrice: { PLA: 1.2, PETG: 2.8, PA6: 7.0, TPU: 3.0, RESIN: 8.5, CF: 15.0, GLOW: 3.5 },
      reliabilityBase: 0.88,
      discount: { preferred: 0.12, trusted: 0.22 },
      speciality: ['TPU','RESIN'],
    },
  ],

  MARKET_CRISES: [
    { id:'pla_shortage',  name:'PLA Tekort!',         icon:'ðŸŒ¾', desc:'Mais-oogst mislukt â€” PLA prijs +60%',          affected:'PLA',   priceMult:1.6, duration:180, stockDrain:0.3 },
    { id:'petg_spikes',   name:'PETG Prijspiek!',      icon:'âš¡', desc:'Energiekosten â€” petrochemisch duurder',        affected:'PETG',  priceMult:1.4, duration:120, stockDrain:0.2 },
    { id:'pa6_embargo',   name:'PA6 Embargo!',         icon:'ðŸš«', desc:'Import gestopt â€” PA6 schaars',                affected:'PA6',   priceMult:2.0, duration:240, stockDrain:0.5 },
    { id:'tpu_shortage',  name:'TPU Schaarste!',       icon:'ðŸ”´', desc:'Olie-derivaten duurder â€” TPU boven budget',   affected:'TPU',   priceMult:1.5, duration:150, stockDrain:0.4 },
    { id:'resin_recall',  name:'Resin Terugroep!',     icon:'â˜£ï¸', desc:'Veiligheidsincident â€” Resin leveringen stop', affected:'RESIN', priceMult:2.5, duration:300, stockDrain:0.8 },
    { id:'global_boom',   name:'3D Print Boom!',       icon:'ðŸ“ˆ', desc:'Vraag explodeert â€” alle filament duurder',    affected:'ALL',   priceMult:1.3, duration:90,  stockDrain:0.1 },
  ],

  WEEKLY_CHALLENGES: [
    { id:'speed_king',   icon:'âš¡', name:'Speed King',     desc:'Voltooi 20 jobs in Ã©Ã©n sessie.',        reward:150, bonusRep:15, target:20,  type:'jobs',      difficulty:'normal' },
    { id:'quality_run',  icon:'ðŸ’Ž', name:'Quality Run',    desc:'Print 10 Ultra-kwaliteit jobs.',         reward:200, bonusRep:20, target:10,  type:'ultra',     difficulty:'hard'   },
    { id:'filament_mix', icon:'ðŸŒˆ', name:'Filament Mix',   desc:'Gebruik alle 5 filamenttypes deze week.', reward:350, bonusRep:25, target:5,  type:'filamix',   difficulty:'hard'   },
    { id:'no_failures',  icon:'ðŸŽ¯', name:'Perfectionist',  desc:'Voltooi 15 jobs zonder storing.',        reward:250, bonusRep:30, target:15,  type:'nofail',    difficulty:'hard'   },
    { id:'millionaire',  icon:'ðŸ’°', name:'Millionaire Run',desc:'Verdien â‚¬500 in Ã©Ã©n sessie.',            reward:400, bonusRep:40, target:500, type:'earn',      difficulty:'epic'   },
    { id:'contract_king',icon:'ðŸ“‹', name:'Contract King',  desc:'Voltooi 5 contracts.',                  reward:180, bonusRep:20, target:5,   type:'contracts', difficulty:'normal' },
    { id:'chain_master', icon:'ðŸ”—', name:'Chain Master',   desc:'Voltooi 3 productieketens.',             reward:220, bonusRep:18, target:3,   type:'chains',    difficulty:'normal' },
    { id:'night_worker', icon:'ðŸŒ™', name:'Night Worker',   desc:'Print 10 jobs na 22:00.',                reward:160, bonusRep:12, target:10,  type:'night',     difficulty:'normal' },
    { id:'tpu_run',      icon:'ðŸ§²', name:'TPU Runner',     desc:'Print 5 TPU flexible jobs.',             reward:200, bonusRep:18, target:5,   type:'tpu',       difficulty:'normal' },
    { id:'resin_master', icon:'ðŸ”®', name:'Resin Master',   desc:'Print 3 Resin precision jobs.',          reward:280, bonusRep:22, target:3,   type:'resin',     difficulty:'hard'   },
    { id:'vip_service',  icon:'ðŸ‘‘', name:'VIP Service',    desc:'Voltooi 5 VIP orders.',                  reward:320, bonusRep:28, target:5,   type:'vip',       difficulty:'hard'   },
    { id:'rush_runner',  icon:'ðŸš¨', name:'Rush Runner',    desc:'Voltooi 8 Rush orders op tijd.',         reward:260, bonusRep:22, target:8,   type:'rush',      difficulty:'hard'   },
    { id:'bounty_hunter',icon:'ðŸŽ¯', name:'Bounty Hunter',  desc:'Claim 2 bounties.',                      reward:500, bonusRep:35, target:2,   type:'bounty',    difficulty:'epic'   },
  ],

  // â”€â”€ v8: RESEARCH TREE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  RESEARCH: [
    // Tier 1 â€“ Early game (unlockLevel 1-2)
    { id:'r_fast_slicing',  name:'Rapid Slicing',       icon:'âš¡', tier:1, desc:'Optimised slicer profiles cut setup time by 10%.', effect:'-10% print time', cost:300,  researchTime:30,  unlockLevel:1, apply:(s)=>{ s.speedMult *= 0.90; } },
    { id:'r_bed_adhesion',  name:'Bed Adhesion Science', icon:'ðŸ”¬', tier:1, desc:'Surface chemistry research. PLA fail rate halved.', effect:'-50% PLA fail',   cost:250,  researchTime:25,  unlockLevel:1, apply:(s)=>{ s.researchFlags.bedAdhesion=true; } },
    { id:'r_thermal_mgmt',  name:'Thermal Management',  icon:'ðŸŒ¡ï¸', tier:1, desc:'Better heat dissipation extends printer lifespan.', effect:'-30% heat wear', cost:400,  researchTime:40,  unlockLevel:2, apply:(s)=>{ s.researchFlags.thermalMgmt=true; } },
    // Tier 2 â€“ Mid game
    { id:'r_material_sci',  name:'Material Science',    icon:'ðŸ§ª', tier:2, desc:'Advanced polymer knowledge. All material costs -15%.', effect:'-15% filament cost', cost:800, researchTime:60, unlockLevel:3, requires:'r_bed_adhesion', apply:(s)=>{ s.researchFlags.materialSci=true; } },
    { id:'r_speed_opt',     name:'Speed Optimisation',  icon:'ðŸŽï¸', tier:2, desc:'Velocity profiling and pressure advance. Faster prints.', effect:'-20% time, +5% fail', cost:1000, researchTime:80, unlockLevel:3, requires:'r_fast_slicing', apply:(s)=>{ s.speedMult *= 0.80; s.failBonus += 0.05; } },
    { id:'r_quality_ctrl',  name:'Quality Control Lab', icon:'ðŸ”­', tier:2, desc:'Statistical process control. Ultra quality rewarded more.', effect:'+20% Ultra reward', cost:1200, researchTime:90, unlockLevel:4, requires:'r_thermal_mgmt', apply:(s)=>{ s.researchFlags.qualityCtrl=true; } },
    { id:'r_vip_network',   name:'VIP Network',         icon:'ðŸ¤', tier:2, desc:'High-value customer relationships. VIP orders appear more.', effect:'2Ã— VIP spawn rate', cost:1500, researchTime:100, unlockLevel:4, requires:'r_bed_adhesion', apply:(s)=>{ s.researchFlags.vipNetwork=true; } },
    // Tier 3 â€“ Late game
    { id:'r_automation',    name:'Process Automation',  icon:'ðŸ¤–', tier:3, desc:'Robotic handling system. Passive income +â‚¬25/min.',    effect:'+â‚¬25/min passive',  cost:3000, researchTime:150, unlockLevel:5, requires:'r_speed_opt', apply:(s)=>{ s.passivePerMin += 25; } },
    { id:'r_premium_mats',  name:'Premium Materials',   icon:'ðŸ’Ž', tier:3, desc:'Exclusive supplier partnerships. Unlock premium filament blends.', effect:'+35% all rewards', cost:4000, researchTime:180, unlockLevel:6, requires:'r_material_sci', apply:(s)=>{ s.rewardMult += 0.35; } },
    { id:'r_predictive',    name:'Predictive Maintenance', icon:'ðŸ”®', tier:3, desc:'ML-based failure prediction. Drastically fewer breakdowns.', effect:'-40% fail chance', cost:5000, researchTime:200, unlockLevel:6, requires:'r_quality_ctrl', apply:(s)=>{ s.failBonus -= 0.40; } },
    { id:'r_bounty_intel',  name:'Bounty Intelligence', icon:'ðŸ“¡', tier:3, desc:'Market intel platform. 3 active bounties at once.', effect:'3Ã— bounty slots', cost:3500, researchTime:160, unlockLevel:5, requires:'r_vip_network', apply:(s)=>{ s.researchFlags.bountyIntel=true; } },
    // Tier 4 â€“ End game
    { id:'r_ai_factory',    name:'AI Print Factory',    icon:'ðŸ­', tier:4, desc:'Full automation. Every 90s a free job completes automatically.', effect:'Auto-complete jobs', cost:12000, researchTime:300, unlockLevel:7, requires:'r_automation', apply:(s)=>{ s.researchFlags.aiFactory=true; } },
    { id:'r_monopoly',      name:'Market Monopoly',     icon:'ðŸ‘‘', tier:4, desc:'Industry dominance. All rewards +50%, unlock legendary orders.', effect:'+50% rewards, legendary orders', cost:15000, researchTime:360, unlockLevel:8, requires:'r_premium_mats', apply:(s)=>{ s.rewardMult += 0.50; s.researchFlags.monopoly=true; } },
  ],

  // â”€â”€ v8: SPECIAL ORDER TYPES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SPECIAL_ORDER_CHANCE: {
    rush:    0.12,  // 12% of orders are rush
    vip:     0.08,  // 8% are VIP
    bulk:    0.06,  // 6% are bulk
    mystery: 0.04,  // 4% are mystery
  },

  // â”€â”€ v8: MILESTONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  MILESTONES: [
    { id:'m_100',   name:'First â‚¬100',        icon:'ðŸ’µ', desc:'You made your first hundred euros!',              check:(s)=>s.stats.totalEarned>=100,   reward:{ money:50, xp:20  }, rewardText:'+â‚¬50 & 20 XP' },
    { id:'m_500',   name:'â‚¬500 Club',         icon:'ðŸ’°', desc:'Half a grand. You\'re a real business now.',       check:(s)=>s.stats.totalEarned>=500,   reward:{ money:100, xp:50 }, rewardText:'+â‚¬100 & 50 XP' },
    { id:'m_1k',    name:'Grand Milestone',   icon:'ðŸŽ¯', desc:'One thousand euros in revenue!',                 check:(s)=>s.stats.totalEarned>=1000,  reward:{ money:200, xp:100, rep:10 }, rewardText:'+â‚¬200, 100 XP & 10 Rep' },
    { id:'m_5k',    name:'Five-Figure Start', icon:'ðŸ“ˆ', desc:'â‚¬5,000 revenue â€” investors are calling.',        check:(s)=>s.stats.totalEarned>=5000,  reward:{ money:500, xp:200, tokens:5 }, rewardText:'+â‚¬500, 200 XP & 5 Tokens' },
    { id:'m_10k',   name:'Ten K Club',        icon:'ðŸ’Ž', desc:'â‚¬10,000! You\'re running a serious operation.',   check:(s)=>s.stats.totalEarned>=10000, reward:{ money:1000, xp:500, rep:25 }, rewardText:'+â‚¬1,000, 500 XP & 25 Rep' },
    { id:'m_25k',   name:'Quarter Century',   icon:'ðŸ†', desc:'â‚¬25,000 total revenue. Industry respect!',       check:(s)=>s.stats.totalEarned>=25000, reward:{ money:2500, xp:1000, tokens:15 }, rewardText:'+â‚¬2,500, 1000 XP & 15 Tokens' },
    { id:'m_jobs50',name:'50 Jobs',           icon:'âš™ï¸', desc:'50 completed prints. Veteran printer!',          check:(s)=>s.stats.jobsDone>=50,       reward:{ money:100, xp:75 }, rewardText:'+â‚¬100 & 75 XP' },
    { id:'m_jobs200',name:'200 Jobs',         icon:'ðŸ­', desc:'200 prints â€” true print farm territory.',        check:(s)=>s.stats.jobsDone>=200,      reward:{ money:300, xp:200 }, rewardText:'+â‚¬300 & 200 XP' },
    { id:'m_streak15',name:'15-Job Streak',   icon:'ðŸ”¥', desc:'15 perfect prints in a row. Masterclass!',       check:(s)=>s.stats.longestStreak>=15,  reward:{ money:150, xp:100, rep:5 }, rewardText:'+â‚¬150, 100 XP & 5 Rep' },
    { id:'m_rep100', name:'Rep Legend',       icon:'â­', desc:'100 reputation. Customers know your name.',      check:(s)=>s.reputation>=100,          reward:{ money:200, xp:150, tokens:3 }, rewardText:'+â‚¬200, 150 XP & 3 Tokens' },
    { id:'m_prestige1',name:'First Prestige', icon:'â™»ï¸', desc:'You reset to grow stronger. Respect.',          check:(s)=>s.prestige>=1,              reward:{ money:500, xp:300, rep:20 }, rewardText:'+â‚¬500, 300 XP & 20 Rep' },
    { id:'m_farm',   name:'Four-Printer Farm',icon:'ðŸ—ï¸', desc:'Four printers humming. Full factory mode.',       check:(s)=>s.printerCount>=4,          reward:{ money:1000, xp:400, tokens:10 }, rewardText:'+â‚¬1,000, 400 XP & 10 Tokens' },
  ],

  // â”€â”€ v8: EQUIPMENT EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  EQUIPMENT_EVENTS: [
    { id:'nozzle_clog',  name:'Nozzle Clog!',       icon:'ðŸ”´', desc:'Your nozzle is clogged. Next 3 jobs have +20% fail unless you repair.', effect:'clog',    severity:'warning', chance:0.04 },
    { id:'belt_slip',    name:'Belt Slippage!',      icon:'âš ï¸', desc:'Print quality drops. Fix for â‚¬30 or risk layer shifts.', effect:'belt',    severity:'warning', chance:0.03, fixCost:30 },
    { id:'hotend_fail',  name:'Hotend Failure!',     icon:'ðŸ”¥', desc:'Temperature inconsistency. Printer offline until repaired.', effect:'offline', severity:'critical', chance:0.02, fixCost:80 },
    { id:'bed_crack',    name:'Cracked Print Bed!',  icon:'ðŸ’¥', desc:'First layer adhesion ruined. Repair needed.', effect:'bed',     severity:'critical', chance:0.02, fixCost:60 },
    { id:'motor_whine',  name:'Motor Whining',       icon:'ðŸ”Š', desc:'Stepper noise detected. Prints 15% slower until serviced.', effect:'slow',    severity:'minor',    chance:0.05, fixCost:20 },
    { id:'spool_tangle', name:'Spool Tangle!',       icon:'ðŸŽƒ', desc:'Filament tangled mid-print. Current job cancelled.', effect:'cancel',  severity:'warning', chance:0.04 },
    { id:'power_fluctuation',name:'Power Fluctuation',icon:'âš¡',desc:'Voltage spike detected. All printers lose 15 HP.', effect:'hploss',  severity:'warning', chance:0.03 },
  ],

  // â”€â”€ v8: BOUNTIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  BOUNTIES: [
    { id:'b_pa6_rush',   name:'PA6 Rush Order',     icon:'ðŸ­', desc:'Print 3 PA6 jobs within 2 minutes each.',  reward:400,  bonusRep:15, type:'pa6_rush',   target:3, timeLimit:120 },
    { id:'b_ultra_vip',  name:'Ultra VIP Delivery', icon:'ðŸ‘‘', desc:'Complete a VIP order at Ultra quality.',    reward:300,  bonusRep:20, type:'ultra_vip',  target:1 },
    { id:'b_no_fail_5',  name:'Flawless Five',       icon:'ðŸŽ¯', desc:'Complete 5 jobs without a single failure.', reward:250,  bonusRep:12, type:'nofail',    target:5 },
    { id:'b_bulk_bonanza',name:'Bulk Bonanza',       icon:'ðŸ“¦', desc:'Print 3 Bulk orders in one session.',      reward:350,  bonusRep:10, type:'bulk',       target:3 },
    { id:'b_tpu_sprint',  name:'TPU Sprint',         icon:'ðŸ§²', desc:'Print 4 TPU jobs in rapid succession.',    reward:280,  bonusRep:12, type:'tpu',        target:4 },
    { id:'b_mystery_box', name:'Mystery Haul',       icon:'ðŸŽ²', desc:'Accept and complete 2 Mystery orders.',   reward:320,  bonusRep:14, type:'mystery',    target:2 },
    { id:'b_repair_zero', name:'Iron Machine',       icon:'ðŸ”§', desc:'Maintain 100% health for 5 minutes.',      reward:200,  bonusRep:8,  type:'health',     target:300, timeLimit:300 },
    { id:'b_resin_art',   name:'Artisan Resin',      icon:'ðŸ”®', desc:'Complete 3 Resin jobs at Fine+ quality.',  reward:450,  bonusRep:20, type:'resin_fine', target:3 },
    { id:'b_combo_god',   name:'Combo God',          icon:'ðŸ”¥', desc:'Reach a 15Ã— combo multiplier.',            reward:600,  bonusRep:25, type:'combo',      target:15 },
    { id:'b_big_earner',  name:'Big Earner',         icon:'ðŸ’°', desc:'Earn â‚¬200 in a single session minute.',   reward:500,  bonusRep:18, type:'earn_burst',  target:200 },
  ],

  // â”€â”€ v10: LEGACY PERKS (chosen at each prestige) â”€â”€â”€â”€â”€â”€â”€â”€â”€
  LEGACY_PERKS: [
    { id:'speed_legacy',    icon:'âš¡', name:'Speed Legacy',      desc:'All print times permanently âˆ’10%.',           effect: s=>{ s.speedMult *= 0.90; } },
    { id:'wealth_legacy',   icon:'ðŸ’°', name:'Wealth Legacy',     desc:'All job rewards permanently +10%.',           effect: s=>{ s.rewardMult += 0.10; } },
    { id:'durable_legacy',  icon:'ðŸ”§', name:'Durable Legacy',    desc:'All printers degrade 30% slower.',            effect: s=>{ s.durabilityBonus = (s.durabilityBonus||0) + 0.30; } },
    { id:'rep_legacy',      icon:'â­', name:'Reputation Legacy', desc:'+1 bonus rep on every completed job.',        effect: s=>{ s.repLegacyBonus = (s.repLegacyBonus||0) + 1; } },
    { id:'tax_legacy',      icon:'ðŸ§¾', name:'Tax Dodger',        desc:'VAT rate permanently reduced by 5%.',         effect: s=>{ s.taxRate = Math.max(0.03, (s.taxRate||0.15) - 0.05); } },
    { id:'rival_legacy',    icon:'ðŸ¤–', name:'Rival Blocker',     desc:'PrintBot steals 50% less often.',             effect: s=>{ s.rivalBlocker = (s.rivalBlocker||0) + 0.50; } },
    { id:'scrap_legacy',    icon:'â™»ï¸', name:'Scrap Master',      desc:'Failed prints generate 2Ã— scrap.',           effect: s=>{ s.scrapBonus = (s.scrapBonus||0) + 1; } },
    { id:'surge_legacy',    icon:'ðŸ”¥', name:'Surge Rider',       desc:'Demand surge rewards +25%.',                 effect: s=>{ s.surgeBonus = (s.surgeBonus||0) + 0.25; } },
  ],

  // â”€â”€ v10: FRANCHISE BRANCHES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  FRANCHISE_BRANCHES: [
    { id:'branch_garage',  name:'Garage Branch',    baseCost:5000,  incomePerMin:15, upgradeCost:8000,  maxLevel:3, icon:'ðŸ ' },
    { id:'branch_studio',  name:'Print Studio',     baseCost:12000, incomePerMin:40, upgradeCost:15000, maxLevel:3, icon:'ðŸ¢' },
    { id:'branch_factory', name:'MiniFactory',      baseCost:30000, incomePerMin:100,upgradeCost:40000, maxLevel:3, icon:'ðŸ­' },
  ],

  // â”€â”€ v10: COMPLAINT MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  COMPLAINT_MESSAGES: [
    '"I paid good money for this â€” it came out like spaghetti!"',
    '"This is completely unusable. I demand a refund!"',
    '"Your quality control is non-existent. Absolutely livid."',
    '"I told you I needed this for a deadline. Now my project is ruined!"',
    '"This is the worst print I\'ve ever received. Refund me NOW."',
    '"My colleague warned me about you. This confirms it."',
    '"I\'ve been 3D printing for 10 years. This is embarrassing."',
  ],
  COMPLAINT_FACES: ['ðŸ˜¤','ðŸ˜¡','ðŸ¤¬','ðŸ˜ ','ðŸ‘¿'],

  // â”€â”€ v10: CLIENT TIER THRESHOLDS (jobs with same customer) â”€
  CLIENT_TIER_THRESHOLDS: { bronze: 2, silver: 8, gold: 20, platinum: 40 },
  CLIENT_TIER_BONUS:       { bronze:1.05, silver:1.12, gold:1.20, platinum:1.35 },

  // â”€â”€ v10: SUBSCRIPTION CLIENT TEMPLATES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  SUBSCRIPTION_CLIENTS: [
    { name:'MakerSpace HQ',      filament:'PLA',   quality:'NORMAL', intervalS:90,  bonusMult:1.1 },
    { name:'PrototypeLab Berlin',filament:'PETG',  quality:'FINE',   intervalS:120, bonusMult:1.2 },
    { name:'NanoTech GmbH',      filament:'PA6',   quality:'NORMAL', intervalS:150, bonusMult:1.3 },
    { name:'ArtStudio Creative', filament:'RESIN', quality:'ULTRA',  intervalS:180, bonusMult:1.5 },
  ],

  ORDER_NAMES_LEGENDARY: ['Satellite Component','Medical Implant Mold','Aerospace Bracket','Formula E Part','Surgical Tool','Nano-lattice Structure','Quantum Sensor Housing','Deep-Sea Probe','Racing Caliper','Bionic Limb Prototype'],

  // â”€â”€ v8: EXTRA UPGRADES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  UPGRADES_V8: [
    { id:'predictive_maint',name:'Predictive Maintenance',desc:'Sensors predict failures before they happen. âˆ’20% all fail.',effect:'âˆ’20% all fail',    cost:4500, unlockLevel:6, category:'reliability', apply:(s)=>{ s.failBonus -= 0.20; } },
    { id:'carbon_rods',     name:'Carbon Fibre Rods',    desc:'Lighter motion system â€” eliminates vibration artifacts.',    effect:'âˆ’20% time, +quality',cost:6000,unlockLevel:7,category:'speed',       apply:(s)=>{ s.speedMult *= 0.80; s.failBonus -= 0.05; } },
    { id:'ai_slicer',       name:'Neural Net Slicer',    desc:'AI-generated optimal print paths. Best-in-class speed.',     effect:'âˆ’35% print time',   cost:10000,unlockLevel:8,category:'speed',       apply:(s)=>{ s.speedMult *= 0.65; } },
    { id:'franchise',       name:'Franchise Model',      desc:'License your brand. Passive income goes through the roof.',  effect:'+â‚¬100/min passive', cost:20000,unlockLevel:8,category:'profit',      apply:(s)=>{ s.passivePerMin += 100; } },
    { id:'printer5',        name:'5th Printer (Titan)',  desc:'Massive delta printer for huge jobs. Legendary orders.',     effect:'Fifth printer + legendary', cost:15000,unlockLevel:8,category:'expansion', apply:(s)=>{ s.printerCount = 5; s.legendaryUnlocked = true; } },
    { id:'rush_handler',    name:'Rush Order System',    desc:'Dedicated rush lane. Rush orders worth +30% more.',          effect:'+30% rush reward',  cost:3000, unlockLevel:5, category:'profit',      apply:(s)=>{ s.researchFlags = s.researchFlags||{}; s.researchFlags.rushBonus=true; } },
    { id:'vip_lounge',      name:'VIP Client Portal',   desc:'White-glove service. VIP order frequency doubles.',          effect:'2Ã— VIP orders',     cost:5000, unlockLevel:6, category:'profit',      apply:(s)=>{ s.researchFlags = s.researchFlags||{}; s.researchFlags.vipPortal=true; } },
  ],
};

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const State = {
  money:          CONFIG.STARTING_MONEY,
  reputation:     0,
  xp:             0,
  bizLevel:       1,
  isPro:          false,

  // Printer modifiers
  printerCount:   1,
  speedMult:      1.0,
  failBonus:      0.0,
  abrasiveBonus:  0.0,
  dryerBonus:     0.0,
  rewardMult:     1.0,
  passivePerMin:  0,
  smartQueue:     false,
  aiQuality:      false,
  packagingBonus: false,

  printers: [
    { id:0, name:'Printer #1', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 },
  ],

  orders:    [],
  contracts: [],
  dailyContractDoneAt: 0,

  nextOrderIn:     15,
  nextContractIn:  CONFIG.CONTRACT_REFRESH_S,

  pendingOrder:       null,
  selectedPrinterIdx: 0,
  viewingPrinterIdx:  0,
  selectedFilament:   'PLA',
  selectedQuality:    'NORMAL',

  ownedUpgrades: [],

  // Active event effects
  bulkBonusJobs:  0,
  nextFailBoost:  0,
  filDiscountJobs:0,

  // Market multipliers (new v2)
  market: { PLA: 1.0, PETG: 1.0, PA6: 1.0 },
  marketTimer: 120,

  // v3: Customer loyalty
  customers: {}, // name â†’ { jobs: 0, satisfaction: 0 }
  activeSkin: 'default',

  // v5: Prestige
  prestige: 0,          // number of prestiges done
  prestigeBonus: 0,     // permanent income multiplier (0.1 per prestige)

  // v5: Printer specializations (per printer id)
  printerSpecs: {},     // { 0: 'speed', 1: 'quality', 2: 'economy' }

  // v5: Combo system
  combo: 0,
  comboTimer: 0,        // seconds left before combo resets
  COMBO_WINDOW: 30,     // seconds between jobs to keep combo

  // v5: Daily goals
  dailyGoals: [],
  dailyGoalsDate: '',
  dailyGoalsEarned: 0,

  // v5: Speedrun
  speedrunActive: false,
  speedrunStart: 0,
  speedrunEarned: 0,
  speedrunJobs: 0,

  // v6: Print tokens & lootbox
  tokens: 0,

  // v6: Print wachtrij
  printQueue: [],   // array of { order, filament, quality }

  // v6: Employees
  hiredEmployees: [],  // array of employee ids

  // v6: Production chains
  activeChains: [],  // array of { id, progress: [done per step] }

  // v6: Printer temperatures
  printerTemps: {},  // printerIdx â†’ 0..100

  achievements: [],

  incomeHistory: [],

  stats: {
    jobsDone:       0,
    jobsFailed:     0,
    totalEarned:    0,
    totalPrints:    0,
    upgradesBought: 0,
    pa6Done:        0,
    petgDone:       0,
    tpuDone:        0,
    resinDone:      0,
    repEarned:      0,
    contractsDone:  0,
    dailyDone:      0,
    longestStreak:  0,
    currentStreak:  0,
    sessionStart:   Date.now(),
    sessionEarned:  0,
    nightShiftJobs: 0,
    fastestJob:     9999,
    marketSurgeJobs:0,
    passiveEarned:  0,
    maxCombo:       0,
    bestSpeedrun:   0,
    chainsDone:     0,
    ultraJobs:      0,
    failStreak:     0,   // consecutive failures
    filamentsUsed:  [],       // array of filament ids used (array, not Set â€” must serialize)
    // v9 stats
    surgesDone:     0,
    loansRepaid:    0,
    clogWins:       0,
  },

  passiveTick: 0,

  // v7: Filament stock system
  filamentStock: { PLA: 100, PETG: 80, PA6: 50, TPU: 0, RESIN: 0, CF: 0, GLOW: 0 },
  supplierRelations: { cheapfil: 0, prusament: 0, localprint: 0 }, // 0=neutral,1=preferred,2=trusted
  supplierOrderCount: { cheapfil: 0, prusament: 0, localprint: 0 }, // orders placed with each

  // v7: Market crisis
  activeCrisis: null,
  crisisTimer: 0,
  crisisCountdown: 200, // seconds until next possible crisis

  // v7: Weekly challenges
  activeChallenges: [],
  challengeSessionData: { jobs:0, ultra:0, filamix:new Set(), nofail:0, earn:0, contracts:0, chains:0, night:0, tpu:0, resin:0 },

  // v7: New upgrade flags
  tpuUnlocked: false,
  resinUnlocked: false,
  flexBed: false,
  uvCuring: false,
  bulkDealActive: false,
  supplierAI: false,

  // v11: New filament unlock flags
  cfUnlocked: false,
  glowUnlocked: false,
  cfNozzle: false,

  // v11: Inventory system
  inventory: { keychains: 0, planters: 0 },

  // v11: Trending system
  activeTrend: null,
  trendTimer: 0,
  trendCountdown: 120,

  // v8: Research system
  completedResearch: [],    // array of research ids
  activeResearch: null,     // { id, progress, total }
  researchFlags: {},        // dynamic flags set by research apply()

  // v8: Bounty board
  activeBounties: [],       // array of { ...bountyDef, progress, expiresAt, claimed }
  bountyRefreshTimer: 300,  // seconds until next bounty refresh
  claimedBounties: [],      // ids of claimed bounties this session

  // v8: Milestones
  claimedMilestones: [],    // milestone ids already claimed

  // v8: Equipment events
  activeEquipmentEvents: [],// array of { printerIdx, eventId, fixCost, resolved }

  // v8: Special order tracking
  stats_v8: {
    vipDone: 0,
    rushDone: 0,
    bulkDone: 0,
    mysteryDone: 0,
    legendaryDone: 0,
    bountiesClaimed: 0,
    milestonesHit: 0,
    researchCompleted: 0,
    equipmentEventsFixed: 0,
    sessEarnedPerMin: 0,    // highest â‚¬/min this session
  },

  // v8: Dashboard data
  lastMinuteEarnings: [],   // rolling window: last 10 per-minute earnings
  legendaryUnlocked: false,

  // v9: New systems
  rivalScore: 0,
  playerVsRival: 0,
  rivalActive: false,
  rivalSteals: 0,
  activeSurge: null,
  surgeCountdown: 120,
  activeLoans: [],
  totalDebt: 0,
  clogActive: false,

  // v10: New systems
  taxAccum: 0,          // earnings accumulated since last tax bill
  taxTimer: 180,        // seconds until next tax bill
  taxRate: 0.15,        // 15% VAT default
  hasAccountant: false,
  hasInsurance: false,
  insuranceTimer: 0,    // seconds until insurance premium due
  scrap: 0,             // scrap units from failed prints
  morale: {},           // employeeId â†’ 0..100
  legacyPerks: [],      // array of perk ids chosen at prestige
  franchiseBranches: [],// array of { id, name, level, incomePerMin, upgradeCost }
  franchiseUnlocked: false,
  hofRecords: [],       // hall of fame entries
  clientTiers: {},      // customerName â†’ 'bronze'|'silver'|'gold'|'platinum'
  subscriptionClients: [], // recurring clients
  subscriptionTimer: 0,
  pendingComplaint: null, // { client, refundAmt, repPenalty, msg }
  stats_v10: {
    taxPaid: 0,
    complaintsReceived: 0,
    complaintsRefunded: 0,
    scrapsRecycled: 0,
    franchiseEarned: 0,
    subscriptionJobsDone: 0,
    insurancePayouts: 0,
  },
};

// â”€â”€ SOUND MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Sound = {
  ctx:    null,
  muted:  false,
  _hums:  {}, // printerIdx â†’ { osc, gain }

  play(type) {
    // Named sound aliases
    if (type === 'milestone') this.success(); // reuse success sound for milestones
    else if (type === 'bounty') this.cash(100);
  },

  _ensureCtx() {
    if (!this.ctx) {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (this.ctx.state === 'suspended') this.ctx.resume();
    return this.ctx;
  },

  toggle() {
    this.muted = !this.muted;
    const btn = $el('sound-btn');
    btn.textContent = this.muted ? 'ðŸ”‡' : 'ðŸ”Š';
    btn.classList.toggle('muted', this.muted);
    if (this.muted) {
      // Stop all hums
      Object.values(this._hums).forEach(h => {
        try { h.gain.gain.setTargetAtTime(0, this.ctx.currentTime, 0.1); } catch(e){}
      });
    }
  },

  // Short synthesised click for UI interactions
  click() {
    if (this.muted) return;
    const c = this._ensureCtx();
    const osc = c.createOscillator(); const g = c.createGain();
    osc.connect(g); g.connect(c.destination);
    osc.frequency.setValueAtTime(1200, c.currentTime);
    osc.frequency.exponentialRampToValueAtTime(800, c.currentTime + 0.04);
    g.gain.setValueAtTime(0.08, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.05);
    osc.start(c.currentTime); osc.stop(c.currentTime + 0.06);
  },

  // Pleasant success chime
  success() {
    if (this.muted) return;
    const c = this._ensureCtx();
    [523.25, 659.25, 783.99].forEach((freq, i) => {
      const osc = c.createOscillator(); const g = c.createGain();
      osc.type = 'sine';
      osc.connect(g); g.connect(c.destination);
      const t = c.currentTime + i * 0.1;
      osc.frequency.setValueAtTime(freq, t);
      g.gain.setValueAtTime(0, t);
      g.gain.linearRampToValueAtTime(0.15, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.4);
      osc.start(t); osc.stop(t + 0.5);
    });
  },

  // Harsh buzz for failure
  failure() {
    if (this.muted) return;
    const c = this._ensureCtx();
    const osc = c.createOscillator(); const g = c.createGain();
    osc.type = 'sawtooth';
    osc.connect(g); g.connect(c.destination);
    osc.frequency.setValueAtTime(180, c.currentTime);
    osc.frequency.exponentialRampToValueAtTime(60, c.currentTime + 0.4);
    g.gain.setValueAtTime(0.22, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.45);
    osc.start(c.currentTime); osc.stop(c.currentTime + 0.5);
  },

  // Cash register ding
  cash(amount) {
    if (this.muted) return;
    const c = this._ensureCtx();
    const pitch = Math.min(1800, 600 + amount * 8);
    const osc = c.createOscillator(); const g = c.createGain();
    osc.type = 'triangle';
    osc.connect(g); g.connect(c.destination);
    osc.frequency.setValueAtTime(pitch, c.currentTime);
    osc.frequency.exponentialRampToValueAtTime(pitch * 1.5, c.currentTime + 0.05);
    g.gain.setValueAtTime(0.18, c.currentTime);
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + 0.5);
    osc.start(c.currentTime); osc.stop(c.currentTime + 0.55);
  },

  // Level-up fanfare
  levelUp() {
    if (this.muted) return;
    const c = this._ensureCtx();
    [392, 494, 587, 784].forEach((f, i) => {
      const osc = c.createOscillator(); const g = c.createGain();
      osc.type = 'sine'; osc.connect(g); g.connect(c.destination);
      const t = c.currentTime + i * 0.12;
      osc.frequency.setValueAtTime(f, t);
      g.gain.setValueAtTime(0, t); g.gain.linearRampToValueAtTime(0.2, t+0.03);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
      osc.start(t); osc.stop(t + 0.55);
    });
  },

  // Contract complete fanfare
  contractComplete() {
    if (this.muted) return;
    const c = this._ensureCtx();
    [523, 659, 784, 1047].forEach((f, i) => {
      const osc = c.createOscillator(); const g = c.createGain();
      osc.type = 'triangle'; osc.connect(g); g.connect(c.destination);
      const t = c.currentTime + i * 0.09;
      osc.frequency.setValueAtTime(f, t);
      g.gain.setValueAtTime(0.18, t);
      g.gain.exponentialRampToValueAtTime(0.001, t + 0.45);
      osc.start(t); osc.stop(t + 0.5);
    });
  },

  // Continuous printer hum â€” starts and stops with print job
  startHum(printerIdx) {
    if (this.muted) return;
    this.stopHum(printerIdx);
    const c = this._ensureCtx();
    const osc  = c.createOscillator();
    const osc2 = c.createOscillator();
    const gain = c.createGain();
    osc.type  = 'sawtooth'; osc.frequency.value  = 62 + printerIdx * 8;
    osc2.type = 'square';   osc2.frequency.value = 124 + printerIdx * 16;
    osc.connect(gain); osc2.connect(gain); gain.connect(c.destination);
    gain.gain.setValueAtTime(0, c.currentTime);
    gain.gain.linearRampToValueAtTime(0.025, c.currentTime + 0.5);
    osc.start(); osc2.start();
    this._hums[printerIdx] = { osc, osc2, gain };
  },

  stopHum(printerIdx) {
    const h = this._hums[printerIdx];
    if (!h) return;
    try {
      const c = this._ensureCtx();
      h.gain.gain.setTargetAtTime(0, c.currentTime, 0.3);
      setTimeout(() => { try { h.osc.stop(); h.osc2.stop(); } catch(e){} }, 600);
    } catch(e) {}
    delete this._hums[printerIdx];
  },
};

// â”€â”€ SKINS MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Skins = {
  SKINS: ['default','midnight','lava','forest'],
  set(skin) {
    State.activeSkin = skin;
    const panel = $el('active-job-panel');
    if (panel) {
      this.SKINS.forEach(s => panel.classList.remove('skin-' + s));
      if (skin !== 'default') panel.classList.add('skin-' + skin);
    }
    // Update dot active state
    this.SKINS.forEach(s => {
      const dot = document.getElementById('skin-' + s);
      if (dot) dot.classList.toggle('active-skin', s === skin);
    });
    localStorage.setItem('pnp_skin', skin);
    Sound.click();
  },
  load() {
    const saved = localStorage.getItem('pnp_skin') || 'default';
    this.set(saved);
  },
};

// â”€â”€ MINI-GAME MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MiniGame = {
  _printerIdx: null,
  _sequence: [],
  _step: 0,
  _timer: null,
  _timeLeft: 10,
  SYMBOLS: ['ðŸ”´','ðŸ”µ','ðŸŸ¢','ðŸŸ¡'],

  trigger(printerIdx) {
    this._printerIdx = printerIdx;
    const difficulty = Math.min(4, 2 + Math.floor(State.bizLevel / 2));
    this._sequence = Array.from({length: difficulty}, () => this.SYMBOLS[Math.floor(Math.random() * 4)]);
    this._step = 0;
    this._timeLeft = 8 + difficulty;
    $el('mg-sub').textContent =
      `Match the ${difficulty}-step calibration sequence! Time limit: ${this._timeLeft}s`;
    this._renderSequence();
    $el('mg-feedback').textContent = '';
    $el('mg-feedback').style.color = 'var(--text)';
    $el('minigame-overlay').classList.add('active');
    this._startTimer();
    Sound.failure();
    UI.log(`âš ï¸ Printer #${printerIdx+1} needs calibration! Mini-game triggered.`, 'warn');
  },

  _renderSequence() {
    const el = document.getElementById('mg-sequence');
    el.innerHTML = this._sequence.map((s, i) =>
      `<div class="mg-key" style="opacity:${i < this._step ? '0.3' : '1'};border-color:${i === this._step ? 'var(--accent)' : 'var(--border)'}">${i < this._step ? 'âœ“' : s}</div>`
    ).join('');
    $el('mg-progress').textContent = `Step ${this._step} / ${this._sequence.length}`;
  },

  _startTimer() {
    clearInterval(this._timer);
    const fill = $el('mg-timer-fill');
    const total = this._timeLeft;
    const interval = 100;
    let elapsed = 0;
    this._timer = setInterval(() => {
      elapsed += interval / 1000;
      const pct = Math.max(0, 100 * (1 - elapsed / total));
      if (fill) fill.style.width = pct + '%';
      if (elapsed >= total) {
        clearInterval(this._timer);
        this._fail('Time\'s up!');
      }
    }, interval);
  },

  press(symbol) {
    const btn = [...document.querySelectorAll('.mg-btn')].find(b => b.textContent === symbol);
    if (btn) { btn.classList.add('pressed'); setTimeout(() => btn.classList.remove('pressed'), 150); }

    if (symbol === this._sequence[this._step]) {
      this._step++;
      this._renderSequence();
      Sound.click();
      if (this._step === this._sequence.length) {
        clearInterval(this._timer);
        this._win();
      }
    } else {
      const fb = $el('mg-feedback');
      fb.textContent = 'âœ— Wrong! Try again from the start.';
      fb.style.color = 'var(--danger)';
      this._step = 0;
      this._renderSequence();
      Sound.failure();
    }
  },

  _win() {
    $el('mg-feedback').textContent = 'âœ“ Calibrated! Free repair!';
    $el('mg-feedback').style.color = 'var(--accent3)';
    Sound.success();
    setTimeout(() => {
      const p = State.printers[this._printerIdx];
      if (p) p.health = Math.min(100, p.health + 50);
      this._close();
      UI.renderPrinters();
      UI.log(`ðŸ”§ Mini-game won! Printer #${this._printerIdx+1} partially repaired for free.`, 'success');
    }, 1200);
  },

  _fail(reason) {
    $el('mg-feedback').textContent = `âœ— ${reason} Paying repair cost.`;
    $el('mg-feedback').style.color = 'var(--danger)';
    Sound.failure();
    setTimeout(() => { this.skip(); }, 1200);
  },

  skip() {
    clearInterval(this._timer);
    this._close();
    if (this._printerIdx !== null) Game.repairPrinter(this._printerIdx);
  },

  _close() {
    $el('minigame-overlay').classList.remove('active');
    this._printerIdx = null;
  },
};

// â”€â”€ NOTIFICATIONS MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Notifications = {
  enabled: false,

  toggle() {
    if (!('Notification' in window)) {
      UI.showPopup('Not Supported', 'Your browser does not support notifications.');
      return;
    }
    if (Notification.permission === 'granted') {
      this.enabled = !this.enabled;
      this._updateBtn();
      UI.log(this.enabled ? 'ðŸ”” Notifications enabled.' : 'ðŸ”• Notifications disabled.', 'info');
    } else if (Notification.permission !== 'denied') {
      Notification.requestPermission().then(perm => {
        if (perm === 'granted') {
          this.enabled = true;
          this._updateBtn();
          UI.log('ðŸ”” Notifications enabled!', 'info');
        }
      });
    } else {
      UI.showPopup('Blocked', 'Notifications are blocked in your browser. Enable them in site settings.');
    }
  },

  notify(title, body) {
    if (!this.enabled || document.hasFocus()) return;
    try {
      new Notification(title, { body, icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ðŸ–¨ï¸</text></svg>' });
    } catch(e) {}
  },

  _updateBtn() {
    const btn = $el('notif-btn');
    if (btn) {
      btn.textContent = this.enabled ? 'ðŸ””' : 'ðŸ”•';
      btn.innerHTML += '<div class="notif-dot"></div>';
    }
  },
};

// â”€â”€ CUSTOMER LOYALTY MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CustomerLoyalty = {
  track(customerName, filament, quality) {
    if (!State.customers[customerName]) {
      State.customers[customerName] = { jobs: 0, satisfaction: 0 };
    }
    const c = State.customers[customerName];
    c.jobs++;
    const qualBonus = { DRAFT: -0.5, NORMAL: 0.5, FINE: 1.0, ULTRA: 1.5 }[quality] || 0.5;
    c.satisfaction = Math.min(10, c.satisfaction + qualBonus);
  },

  getBonus(customerName) {
    const c = State.customers[customerName];
    if (!c || c.jobs < 2) return 1.0;
    return 1.0 + Math.min(0.3, c.satisfaction * 0.03);
  },

  getLoyaltyLevel(customerName) {
    const c = State.customers[customerName];
    if (!c || c.jobs < 2) return null;
    if (c.jobs >= 10) return 'â­â­â­';
    if (c.jobs >= 5) return 'â­â­';
    return 'â­';
  },

  showQuote(order) {
    const c = State.customers[order.customer];
    const isLoyal = c && c.jobs >= 2;
    const quotes = isLoyal ? CONFIG.CUSTOMER_QUOTES.loyalAccept : CONFIG.CUSTOMER_QUOTES.accept;
    const quote = quotes[Math.floor(Math.random() * quotes.length)];
    const toast = document.createElement('div');
    toast.className = 'quote-toast';
    toast.innerHTML = `<div class="q-name">ðŸ’¬ ${order.customer}</div><div class="q-text">"${quote}"</div>`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3500);
  },
};

// â”€â”€ LEADERBOARD MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Leaderboard = {
  MAX_ENTRIES: 10,
  KEY: 'pnp_leaderboard',

  load() {
    try { return JSON.parse(localStorage.getItem(this.KEY) || '[]'); } catch(e) { return []; }
  },

  save(entries) {
    localStorage.setItem(this.KEY, JSON.stringify(entries));
  },

  submit() {
    const score = r0(State.stats.totalEarned);
    if (score < 10) return;
    const entries = this.load();
    const name = `Run #${entries.length + 1}`;
    entries.push({
      name, score,
      level: State.bizLevel,
      jobs: State.stats.jobsDone,
      date: new Date().toLocaleDateString('nl-NL'),
      isYou: true,
    });
    entries.sort((a, b) => b.score - a.score);
    const pruned = entries.slice(0, this.MAX_ENTRIES);
    // Only mark the top "you" entry
    let marked = false;
    pruned.forEach(e => { if (e.isYou && !marked) { e.isYou = true; marked = true; } else { e.isYou = false; } });
    this.save(pruned);
  },

  render() {
    const el = document.getElementById('leaderboard-list'); if (!el) return;
    const entries = this.load();
    if (entries.length === 0) {
      el.innerHTML = `<div class="lb-empty">No runs yet.<br><span style="font-size:9px">Play and earn â‚¬10+ to appear here.</span></div>`;
      return;
    }
    const rankClass = i => i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
    el.innerHTML = entries.map((e, i) => `
      <div class="lb-row ${e.isYou ? 'lb-you' : ''}">
        <div class="lb-rank ${rankClass(i)}">${i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : i + 1}</div>
        <div class="lb-name">
          <div class="lb-name-main">${e.name} ${e.isYou ? '<span style="font-size:9px;color:var(--accent)">(you)</span>' : ''}</div>
          <div class="lb-name-sub">Lv.${e.level} Â· ${e.jobs} jobs Â· ${e.date}</div>
        </div>
        <div class="lb-score">
          <div class="lb-score-val">â‚¬${e.score.toLocaleString()}</div>
        </div>
      </div>`).join('');
  },
};

// â”€â”€ COMBO SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Combo = {
  WINDOW: 30, // seconds to maintain combo

  onJobComplete() {
    State.combo++;
    State.comboTimer = this.WINDOW;
    if (State.combo > (State.stats.maxCombo || 0)) State.stats.maxCombo = State.combo;
    this.render();
    BountyBoard.onCombo(State.combo);
    if (State.combo >= 2) {
      const mult = this.getMultiplier();
      UI.log(`ðŸ”¥ ${State.combo}Ã— Combo! +${Math.round((mult-1)*100)}% bonus`, 'money');
    }
    Achievements.check();
  },

  getMultiplier() {
    if (State.combo < 2) return 1;
    return 1 + Math.min(0.5, (State.combo - 1) * 0.05);
  },

  tick(dt) {
    if (State.combo < 2) return;
    State.comboTimer -= dt;
    // Update bar
    const bar = $el('combo-bar');
    if (bar) bar.style.width = Math.max(0, (State.comboTimer / this.WINDOW * 100)) + '%';
    if (State.comboTimer <= 0) this.reset();
  },

  reset() {
    if (State.combo >= 2) UI.log(`Combo verlopen (was ${State.combo}Ã—)`, 'warn');
    State.combo = 0;
    State.comboTimer = 0;
    const el = document.getElementById('combo-display');
    if (el) el.style.display = 'none';
  },

  render() {
    const el = document.getElementById('combo-display');
    if (!el) return;
    if (State.combo < 2) { el.style.display = 'none'; return; }
    el.style.display = 'block';
    const num = $el('combo-number');
    const mult = $el('combo-mult');
    if (num) { num.textContent = State.combo + 'Ã—'; num.style.animation = 'none'; void num.offsetWidth; num.style.animation = 'comboPop 0.3s cubic-bezier(0.34,1.8,0.64,1)'; }
    if (mult) mult.textContent = `+${Math.round((this.getMultiplier()-1)*100)}% bonus`;
    const bar = $el('combo-bar');
    if (bar) bar.style.width = '100%';
  },
};

// â”€â”€ DAILY GOALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DailyGoals = {
  GOAL_TEMPLATES: [
    { id:'jobs5',     icon:'ðŸ–¨ï¸', name:'Print 5 jobs',          desc:'Voltooi 5 afdruktaken',          reward:25,  check:(s,g)=>({cur:s.jobsDone-g.baseJobs,   max:5})  },
    { id:'earn50',    icon:'ðŸ’°', name:'Verdien â‚¬50',            desc:'Druk genoeg om â‚¬50 te verdienen', reward:15,  check:(s,g)=>({cur:s.totalEarned-g.baseEarned, max:50}) },
    { id:'petg3',     icon:'ðŸ’œ', name:'3 PETG jobs',            desc:'Druk 3 PETG-orders af',          reward:30,  check:(s,g)=>({cur:s.petgDone-(g.basePetg||0), max:3}) },
    { id:'pa61',      icon:'ðŸŸ ', name:'1 PA6 job',              desc:'Druk een engineering-order af',  reward:40,  check:(s,g)=>({cur:s.pa6Done-(g.basePa6||0),  max:1})  },
    { id:'streak5',   icon:'ðŸ”¥', name:'5 op rij',               desc:'Haal een streak van 5',          reward:35,  check:(s,g)=>({cur:s.longestStreak,          max:5})  },
    { id:'contract1', icon:'ðŸ“‹', name:'1 contract',             desc:'Voltooi een contract',           reward:50,  check:(s,g)=>({cur:s.contractsDone-g.baseContracts, max:1}) },
    { id:'repair0',   icon:'ðŸ”§', name:'Niet repareren',         desc:'Speel 10 min zonder reparatie',  reward:20,  check:(s,g)=>({cur:g.repairFree?10:0,        max:10}) },
    { id:'combo5',    icon:'âš¡', name:'5Ã— Combo',               desc:'Bereik een combo van 5Ã—',        reward:45,  check:(s,g)=>({cur:s.maxCombo,              max:5})  },
    { id:'earn100',   icon:'ðŸ’Ž', name:'Verdien â‚¬100',           desc:'Druk genoeg om â‚¬100 te verdienen',reward:30, check:(s,g)=>({cur:s.totalEarned-g.baseEarned,max:100}) },
    { id:'jobs10',    icon:'ðŸ­', name:'Print 10 jobs',          desc:'Voltooi 10 afdruktaken',         reward:40,  check:(s,g)=>({cur:s.jobsDone-g.baseJobs,   max:10}) },
  ],

  _todayKey() { return new Date().toISOString().slice(0, 10); },

  refresh() {
    const today = this._todayKey();
    if (State.dailyGoalsDate === today && State.dailyGoals.length > 0) return; // already generated today
    // Pick 3 random goals
    const shuffled = [...this.GOAL_TEMPLATES].sort(() => Math.random() - 0.5);
    State.dailyGoals = shuffled.slice(0, 3).map(t => ({
      ...t,
      done: false,
      baseJobs:      State.stats.jobsDone,
      baseEarned:    State.stats.totalEarned,
      basePetg:      State.stats.petgDone || 0,
      basePa6:       State.stats.pa6Done  || 0,
      baseContracts: State.stats.contractsDone,
      repairFree:    true,
    }));
    State.dailyGoalsDate = today;
    State.dailyGoalsEarned = 0;
    UI.log('ðŸŽ¯ Nieuwe dagelijkse doelen beschikbaar!', 'info');
  },

  check() {
    State.dailyGoals.forEach(g => {
      if (g.done) return;
      const { cur, max } = g.check(State.stats, g);
      if (cur >= max) {
        g.done = true;
        State.money = r2(State.money + g.reward);
        State.stats.totalEarned = r2(State.stats.totalEarned + g.reward);
        State.dailyGoalsEarned = (State.dailyGoalsEarned || 0) + g.reward;
        UI.log(`ðŸŽ¯ Dagelijks doel behaald: ${g.name} â†’ +â‚¬${g.reward}`, 'money');
        // Toast
        const t = document.createElement('div');
        t.className = 'contract-toast';
        t.innerHTML = `<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--warn);margin-bottom:4px">ðŸŽ¯ Dagelijks Doel!</div><div style="font-family:var(--display);font-weight:700;font-size:15px;color:var(--text-bright)">${g.icon} ${g.name}</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">+â‚¬${g.reward} beloond</div>`;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 5000);
        Achievements.check();
      }
    });
    this.render();
  },

  render() {
    const el = document.getElementById('daily-goals-list');
    const earned = $el('goals-earned');
    if (!el) return;
    if (State.dailyGoals.length === 0) { el.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px;font-size:11px">Geen doelen geladen.</div>'; return; }
    el.innerHTML = State.dailyGoals.map(g => {
      const {cur, max} = g.check(State.stats, g);
      const pct = Math.min(100, r0(cur / max * 100));
      return `<div class="goal-card${g.done?' goal-done':''}">
        <div class="goal-icon">${g.icon}</div>
        <div class="goal-info">
          <div class="goal-name">${g.name}</div>
          <div class="goal-desc">${g.desc}</div>
          <div class="goal-progress">
            <div class="goal-prog-bar"><div class="goal-prog-fill" style="width:${pct}%"></div></div>
            <div class="goal-prog-text">${Math.min(cur,max)} / ${max}</div>
          </div>
        </div>
        ${g.done ? '<div class="goal-done-check">âœ…</div>' : `<div class="goal-reward">â‚¬${g.reward}</div>`}
      </div>`;
    }).join('');
    if (earned) earned.textContent = `â‚¬${(State.dailyGoalsEarned || 0).toFixed(2)}`;
    // Reset timer
    const rt = $el('goals-reset-timer');
    if (rt) {
      const now = new Date();
      const midnight = new Date(); midnight.setHours(24,0,0,0);
      const diff = Math.round((midnight - now) / 1000);
      const h = Math.floor(diff/3600), m = Math.floor((diff%3600)/60);
      rt.textContent = `Reset over ${h}u ${m}m`;
    }
  },
};

// â”€â”€ SEASON SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Season = {
  SEASONS: [
    { months:[11,0], name:'Holiday Rush ðŸŽ„',  icon:'ðŸŽ„', desc:'+40% PLA reward Â· Meer urgente orders', mult:{PLA:1.4}, urgentBoost:0.15 },
    { months:[1],    name:'Valentijn ðŸ’',      icon:'ðŸ’', desc:'+30% decoratie reward',                  mult:{PLA:1.3}, urgentBoost:0 },
    { months:[2,3],  name:'Lente Sprint ðŸŒ±',   icon:'ðŸŒ±', desc:'+20% alle rewards Â· Lagere reparatiekosten', mult:{PLA:1.2,PETG:1.2,PA6:1.2}, repairDiscount:0.8 },
    { months:[6,7],  name:'Zomerslump â˜€ï¸',     icon:'â˜€ï¸', desc:'-15% bestellingen Â· PA6 +50% reward',  mult:{PA6:1.5}, orderDelay:1.5 },
    { months:[8,9],  name:'Terug naar school ðŸŽ’', icon:'ðŸŽ’', desc:'+25% PETG reward Â· Meer contracten', mult:{PETG:1.25}, extraContracts:1 },
    { months:[10],   name:'Hacktober ðŸŽƒ',       icon:'ðŸŽƒ', desc:'+30% alle rewards Â· Meer events',      mult:{PLA:1.3,PETG:1.3,PA6:1.3}, eventBoost:1.5 },
  ],

  current: null,

  check() {
    const month = new Date().getMonth();
    const found = this.SEASONS.find(s => s.months.includes(month)) || null;
    if (found && this.current?.name !== found.name) {
      this.current = found;
      this.showBanner();
      UI.log(`ðŸŒŸ Seizoensevent: ${found.name} â€” ${found.desc}`, 'info');
    } else if (!found) {
      this.current = null;
      const banner = $el('season-banner');
      if (banner) banner.classList.remove('active');
    }
  },

  showBanner() {
    if (!this.current) return;
    const banner = $el('season-banner');
    const icon   = $el('season-icon');
    const name   = $el('season-name');
    const effect = $el('season-effect');
    if (!banner) return;
    if (icon)   icon.textContent   = this.current.icon;
    if (name)   name.textContent   = this.current.name;
    if (effect) effect.textContent = this.current.desc;
    banner.classList.add('active');
  },

  getRewardMult(filament) {
    if (!this.current) return 1;
    return this.current.mult?.[filament] || 1;
  },
};

// â”€â”€ SPEEDRUN MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Speedrun = {
  DURATION: 600, // 10 minutes
  _timer: null,
  _remaining: 600,

  start() {
    if (State.speedrunActive) return;
    UI.showPopup('âš¡ Speedrun Modus',
      'Verdien zoveel mogelijk in 10 minuten! Jouw score wordt opgeslagen in het leaderboard. Klaar?',
      () => {
        State.speedrunActive  = true;
        State.speedrunStart   = Date.now();
        State.speedrunEarned  = 0;
        State.speedrunJobs    = 0;
        this._remaining = this.DURATION;
        $el('speedrun-bar').classList.add('active');
        this._startTimer();
        UI.log('âš¡ Speedrun gestart! 10 minuten â€” ga!', 'warn');
      },
      () => {}
    );
  },

  _startTimer() {
    clearInterval(this._timer);
    this._timer = setInterval(() => {
      if (!State.speedrunActive) { clearInterval(this._timer); return; }
      this._remaining--;
      this._updateUI();
      if (this._remaining <= 0) this.end(false);
    }, 1000);
  },

  _updateUI() {
    const m = Math.floor(this._remaining / 60);
    const s = this._remaining % 60;
    const el = document.getElementById('sr-timer');
    if (el) { el.textContent = `${m}:${s.toString().padStart(2,'0')}`; el.style.color = this._remaining < 60 ? 'var(--danger)' : 'var(--warn)'; }
    const sc = $el('sr-score');
    if (sc) sc.textContent = `â‚¬${State.speedrunEarned.toFixed(0)}`;
    const jb = $el('sr-jobs');
    if (jb) jb.textContent = State.speedrunJobs;
  },

  recordJob(profit) {
    if (!State.speedrunActive) return;
    State.speedrunEarned += profit;
    State.speedrunJobs++;
  },

  end(manual) {
    clearInterval(this._timer);
    if (!State.speedrunActive) return;
    State.speedrunActive = false;
    $el('speedrun-bar').classList.remove('active');
    const score = State.speedrunEarned;
    if (score > (State.stats.bestSpeedrun || 0)) State.stats.bestSpeedrun = score;
    // Save to leaderboard with speedrun tag
    const entries = Leaderboard.load();
    entries.push({ name:`Speedrun #${entries.length+1}`, score:r0(score), level:State.bizLevel, jobs:State.speedrunJobs, date:new Date().toLocaleDateString('nl-NL'), isYou:true, tag:'âš¡SR' });
    entries.sort((a,b)=>b.score-a.score);
    const pruned = entries.slice(0,10);
    Leaderboard.save(pruned);
    UI.showPopup('âš¡ Speedrun Klaar!', `<div style="text-align:center"><div style="font-family:var(--display);font-weight:900;font-size:36px;color:var(--warn)">â‚¬${score.toFixed(0)}</div><div style="color:var(--text-dim);margin-top:4px">${State.speedrunJobs} jobs Â· ${manual?'handmatig gestopt':'tijd op'}</div>${score>200?'<div style="color:var(--accent3);margin-top:8px">ðŸ† Achievement unlocked!</div>':''}</div>`);
    Achievements.check();
    UI.log(`âš¡ Speedrun klaar: â‚¬${score.toFixed(0)} in ${this.DURATION - this._remaining}s`, 'money');
  },
};

// â”€â”€ PRESTIGE SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Prestige = {
  REQUIRED_LEVEL: 7,
  REQUIRED_EARNED: 5000,

  canPrestige() {
    return State.bizLevel >= this.REQUIRED_LEVEL && State.stats.totalEarned >= this.REQUIRED_EARNED;
  },

  doPrestige() {
    if (!this.canPrestige()) return;
    const msg = `
      <div style="text-align:center">
        <div style="font-size:32px;margin-bottom:8px">ðŸ”¥</div>
        <div style="font-family:var(--display);font-weight:900;font-size:20px;color:#fbbf24;margin-bottom:8px">Prestige ${State.prestige + 1}</div>
        <div style="color:var(--text-dim);font-size:11px;line-height:1.7">
          Je reset je bedrijf maar behoudt:<br>
          <strong style="color:var(--text)">+10% permanente inkomensbonus</strong><br>
          <strong style="color:var(--text)">Badges & statistieken</strong><br>
          <strong style="color:var(--text)">Klantentrouw</strong><br><br>
          Je verliest: geld, upgrades, level, printers.
        </div>
      </div>`;
    UI.showPopup('ðŸ”¥ Prestige?', msg, () => this._execute(), () => {});
  },

  _execute() {
    // v10: Submit this run to Hall of Fame before reset
    HallOfFame.submit();

    State.prestige++;
    State.prestigeBonus = State.prestige * 0.10;
    // Reset everything except stats, achievements, customers, prestige itself
    State.money = CONFIG.STARTING_MONEY;
    State.reputation = 0;
    State.xp = 0;
    State.bizLevel = 1;
    State.ownedUpgrades = [];
    State.speedMult = 1.0;
    State.failBonus = 0.0;
    State.abrasiveBonus = 0.0;
    State.dryerBonus = 0.0;
    State.rewardMult = 1.0 + State.prestigeBonus;
    State.passivePerMin = 0;
    State.smartQueue = false;
    State.aiQuality = false;
    State.packagingBonus = false;
    State.printers = [{ id:0, name:'Printer #1', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 }];
    State.printerCount = 1;
    State.printerSpecs = {};
    State.orders = [];
    State.contracts = [];
    State.combo = 0;
    State.comboTimer = 0;

    // v11: Reset new feature state
    State.cfUnlocked = false;
    State.glowUnlocked = false;
    State.cfNozzle = false;
    State.activeTrend = null;
    State.trendTimer = 0;
    State.trendCountdown = 120;
    State.inventory = { keychains: 0, planters: 0 };

    // v10: Reset business-cycle state (keep legacy perks, hof, franchise, client tiers)
    State.taxAccum = 0;
    State.taxTimer = 180;
    State.taxRate  = 0.15;
    State.hasAccountant = false;
    State.hasInsurance  = false;
    State.scrap = 0;
    State.morale = {};
    State.subscriptionClients = [];
    State.pendingComplaint = null;
    // Franchise stays open (passive branches survive prestige)
    // Legacy perks also survive (that's the point)

    // Re-apply legacy perks after reset
    if ((State.legacyPerks||[]).length > 0) LegacyPerks.reapply();

    // Update prestige display
    const pill = $el('prestige-pill');
    const val  = $el('prestige-val');
    if (pill) pill.classList.add('active');
    if (val)  val.textContent = `P${State.prestige}`;
    Sound.levelUp();
    UI.log(`ðŸ”¥ Prestige ${State.prestige}! +${State.prestige*10}% permanente bonus. Nieuw begin!`, 'success');
    UI.renderAll();
    Game.saveGame();
    Achievements.check();
    HallOfFame.render();

    // v10: Show legacy perk picker after a short delay
    setTimeout(() => LegacyPerks.showPicker(), 1500);
  },

  render() {
    const el = document.getElementById('prestige-section');
    if (!el) return;
    const can = this.canPrestige();
    el.innerHTML = `
      <div style="font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#fbbf24;margin-bottom:6px;">ðŸ”¥ Prestige Systeem</div>
      <div style="font-size:10px;color:var(--text-dim);line-height:1.6;margin-bottom:8px;">
        Reset je bedrijf voor <strong style="color:#fbbf24">+10% permanente inkomensbonus</strong> per prestige.<br>
        Vereist: Level ${this.REQUIRED_LEVEL} + â‚¬${this.REQUIRED_EARNED.toLocaleString()} verdiend.
      </div>
      ${State.prestige > 0 ? `<div style="margin-bottom:8px;color:#fbbf24;font-size:11px;">Huidige bonus: +${State.prestige*10}% inkomen (P${State.prestige})</div>` : ''}
      <button class="prestige-btn" onclick="Prestige.doPrestige()" ${can?'':'disabled'}>
        ${can ? `ðŸ”¥ PRESTIGE â†’ P${State.prestige+1}` : `ðŸ”’ Level ${this.REQUIRED_LEVEL} + â‚¬${this.REQUIRED_EARNED} nodig`}
      </button>`;
  },
};

// â”€â”€ PRINTER SPECIALIZATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Specialization = {
  SPECS: {
    speed:   { name:'Snel',     icon:'âš¡', desc:'-25% printtijd', timeMult: 0.75, profitMult: 0.9 },
    quality: { name:'Kwaliteit',icon:'ðŸ’Ž', desc:'+20% winst, -10% fail', profitMult: 1.2, failBonus: -0.10 },
    economy: { name:'Zuinig',   icon:'ðŸ’°', desc:'-50% filamentkosten', filCostMult: 0.5 },
  },

  set(printerIdx, spec) {
    if (!State.printerSpecs) State.printerSpecs = {};
    if (State.printerSpecs[printerIdx] === spec) {
      delete State.printerSpecs[printerIdx]; // toggle off
      UI.log(`Printer #${printerIdx+1}: Specialisatie verwijderd`, 'info');
    } else {
      State.printerSpecs[printerIdx] = spec;
      const s = this.SPECS[spec];
      UI.log(`Printer #${printerIdx+1}: ${s.icon} ${s.name} specialisatie actief`, 'info');
    }
    Sound.click();
    UI.renderPrinters();
    Achievements.check();
  },

  get(printerIdx) {
    return State.printerSpecs?.[printerIdx] || null;
  },

  getTimeMult(printerIdx) {
    const spec = this.get(printerIdx);
    return spec ? (this.SPECS[spec].timeMult || 1) : 1;
  },
  getProfitMult(printerIdx) {
    const spec = this.get(printerIdx);
    return spec ? (this.SPECS[spec].profitMult || 1) : 1;
  },
  getFailBonus(printerIdx) {
    const spec = this.get(printerIdx);
    return spec ? (this.SPECS[spec].failBonus || 0) : 0;
  },
  getFilCostMult(printerIdx) {
    const spec = this.get(printerIdx);
    return spec ? (this.SPECS[spec].filCostMult || 1) : 1;
  },
};

// â”€â”€ SMART TIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SmartTips = {
  _shown: new Set(),
  _timer: null,
  TIPS: [
    { id:'first_fail',   trigger: s => s.stats.jobsFailed >= 1 && !s.ownedUpgrades.includes('bed_leveling'), text: 'Je eerste mislukking! Koop Auto Bed Leveling in de Shop â€” dat verlaagt de kans met 8%.' },
    { id:'low_health',   trigger: s => s.printers.some(p=>p.health<30&&!p.active), text: 'Printer health is laag! Repareer vÃ³Ã³r de volgende job om faalkansen te verlagen.' },
    { id:'unlock_petg',  trigger: s => s.reputation >= 18 && s.reputation < 22, text: 'Je bent bijna bij 20 reputatie â€” dan unlock je PETG filament met 50% meer winst!' },
    { id:'market_surge', trigger: s => Object.values(s.market).some(v=>v>=1.3), text: 'ðŸ“ˆ De markt piekt! Druk nu PA6 of PETG af voor maximale winst.' },
    { id:'combo_tip',    trigger: s => s.combo === 0 && s.stats.jobsDone >= 5, text: 'ðŸ”¥ Combo-tip: druk jobs snel achter elkaar af voor een combo-multiplier tot +50%!' },
    { id:'contract_tip', trigger: s => s.stats.jobsDone >= 3 && s.stats.contractsDone === 0, text: 'ðŸ“‹ Accepteer een contract voor grote beloningen! Klik op het Contracts-tabblad.' },
    { id:'prestige_tip', trigger: s => s.bizLevel >= 6, text: 'ðŸ”¥ Op level 6! Wist je dat Prestige je een permanente +10% inkomensbonus geeft? Check de Settings tab.' },
    { id:'spec_tip',     trigger: s => s.printerCount >= 2 && Object.keys(s.printerSpecs||{}).length === 0, text: 'ðŸ’¡ Met 2 printers: geef ze een specialisatie! EÃ©n snel, Ã©Ã©n voor kwaliteit.' },
    { id:'night_tip',    trigger: s => s.stats.jobsDone >= 10 && s.stats.nightShiftJobs === 0, text: 'ðŸŒ™ Wist je dat printen na 22:00 een nachtbonus van +20% opbrengt? Probeer het eens!' },
    { id:'research_tip', trigger: s => s.bizLevel >= 2 && (s.completedResearch||[]).length === 0, text: 'ðŸ”¬ Research is beschikbaar! Bed Adhesion Science halveert je PLA faalkans voor slechts â‚¬250.' },
    { id:'cf_tip',       trigger: s => s.reputation >= 100 && !s.ownedUpgrades.includes('cf_nozzle'), text: 'âš« Je hebt genoeg reputatie voor Carbon Fiber! Koop CF Nozzle + Enclosure voor 5Ã— winst.' },
    { id:'bulk_deal_tip',trigger: s => s.bizLevel >= 4 && !s.ownedUpgrades.includes('bulk_deals') && s.stats.jobsDone >= 30, text: 'ðŸ’¡ Bulk Deal Contracts (-20% filamentkosten) is nu beschikbaar in de Shop!' },
    { id:'trending_tip', trigger: s => (s.stats.trendOrdersDone||0) === 0 && s.stats.jobsDone >= 15, text: 'ðŸ”¥ Let op de TRENDING banner! Trending orders leveren tot 3Ã— meer op â€” druk ze snel af.' },
  ],

  check(state) {
    for (const tip of this.TIPS) {
      if (!this._shown.has(tip.id) && tip.trigger(state)) {
        this._shown.add(tip.id);
        this.show(tip.text);
        break;
      }
    }
  },

  show(text) {
    const el = document.getElementById('smart-tip');
    const t  = $el('tip-text');
    if (!el || !t) return;
    t.textContent = text;
    el.classList.add('visible');
    clearTimeout(this._timer);
    this._timer = setTimeout(() => el.classList.remove('visible'), 6000);
  },
};

// â”€â”€ PRINT WACHTRIJ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Queue = {
  MAX: 8,

  add(order, filament, quality) {
    if (State.printQueue.length >= this.MAX) { UI.log('Wachtrij is vol (max 8)!', 'warn'); return; }
    if (State.printQueue.find(q => q.order.id === order.id)) { UI.log('Al in de wachtrij!', 'warn'); return; }
    State.orders = State.orders.filter(o => o.id !== order.id);
    State.printQueue.push({ order, filament: filament || State.selectedFilament, quality: quality || State.selectedQuality });
    Sound.click();
    UI.log(`âž• ${order.name} toegevoegd aan wachtrij`, 'info');
    this.render();
    UI.renderOrders();
  },

  remove(idx) {
    const item = State.printQueue[idx];
    if (item) { State.orders.push(item.order); }
    State.printQueue.splice(idx, 1);
    this.render();
    UI.renderOrders();
    Sound.click();
  },

  tryAutoStart() {
    if (State.printQueue.length === 0) return;
    const freePrinter = State.printers.find(p => !p.active);
    if (!freePrinter) return;
    const item = State.printQueue.shift();
    const printerIdx = freePrinter.id;
    const fil = State.reputation >= CONFIG.FILAMENTS[item.order.filament]?.unlockRep ? item.filament : 'PLA';
    Printer.startJob(printerIdx, item.order, fil, item.quality);
    UI.log(`ðŸ¤– Wachtrij: automatisch gestart ${item.order.name} op ${freePrinter.name}`, 'info');
    this.render();
    UI.renderPrinters();
    UI.renderCenterPanel();
  },

  render() {
    const el = document.getElementById('queue-slots'); if (!el) return;
    if (State.printQueue.length === 0) {
      el.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:16px;font-size:10px;">Wachtrij leeg</div>';
      return;
    }
    el.innerHTML = State.printQueue.map((item, i) => {
      const fc = filClass(item.order.filament);
      return `<div class="queue-slot filled">
        <div class="queue-slot-num">${i+1}</div>
        <div class="queue-slot-name">${item.order.name}<br><span style="font-size:9px;color:var(--text-dim)">${item.quality} Â· â‚¬${item.order.reward.toFixed(0)}</span></div>
        <span class="queue-slot-fil tag tag-${fc}">${item.order.filament}</span>
        <button class="queue-slot-remove" onclick="Queue.remove(${i})">âœ•</button>
      </div>`;
    }).join('');
  },
};

// â”€â”€ EMPLOYEES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Employees = {
  hire(id) {
    const emp = CONFIG.EMPLOYEES.find(e => e.id === id);
    if (!emp) return;
    if (State.hiredEmployees.includes(id)) { UI.log('Al in dienst!', 'warn'); return; }
    if (State.money < emp.cost) { UI.showPopup('Te weinig geld', `Inhuren kost â‚¬${emp.cost}.`); return; }
    if (State.bizLevel < emp.unlockLevel) { UI.showPopup('Niveau te laag', `Vereist niveau ${emp.unlockLevel}.`); return; }
    State.money = r2(State.money - emp.cost);
    State.hiredEmployees.push(id);
    Sound.click();
    UI.log(`ðŸ‘¥ ${emp.name} in dienst genomen!`, 'success');
    if (emp.effect === 'failRedux') State.failBonus -= 0.10;
    this.render();
    UI.updateTopBar();
  },

  fire(id) {
    State.hiredEmployees = State.hiredEmployees.filter(e => e !== id);
    const emp = CONFIG.EMPLOYEES.find(e => e.id === id);
    if (emp?.effect === 'failRedux') State.failBonus += 0.10;
    Sound.click();
    UI.log(`ðŸ‘‹ ${emp?.name} ontslagen.`, 'warn');
    this.render();
  },

  tick(dt) {
    State.hiredEmployees.forEach(id => {
      const emp = CONFIG.EMPLOYEES.find(e => e.id === id);
      if (!emp) return;
      // Morale efficiency: low morale â†’ employee contributes less
      const eff = Morale.getEff(id);
      // Pay wages per second (always full â€” they show up regardless)
      const wagePerSec = emp.wagePM / 60;
      State.money = r2(State.money - wagePerSec * dt);

      // Effects scaled by morale efficiency
      if (emp.effect === 'autoRepair') {
        // Low morale technician repairs less aggressively
        const repairThreshold = eff >= 1.0 ? 40 : eff >= 0.8 ? 30 : 20;
        State.printers.forEach((p, idx) => {
          if (!p.active && p.health < repairThreshold) {
            const cost = Math.round((100 - p.health) * CONFIG.REPAIR_COST_PER_HP * 100) / 100;
            if (State.money >= cost) Game.repairPrinter(idx);
          }
        });
      }
      // failRedux engineer: morale below 30% = bonus shrinks to half
      if (emp.effect === 'failRedux' && eff < 1.0 && !emp._moraleWarnShown) {
        emp._moraleWarnShown = true;
        UI.log(`ðŸ˜´ ${emp.name} werkt op laag moreel â€” fail-reductie verminderd!`, 'warn');
      } else if (eff >= 1.0 && emp._moraleWarnShown) {
        emp._moraleWarnShown = false;
      }
      if (emp.effect === 'autoPLA' || emp.effect === 'queueOpt') {
        // Handled in tick via Queue.tryAutoStart
      }
    });
  },

  tickBonus: 0,
  tickSalesBonus(dt) {
    if (!State.hiredEmployees.includes('salesperson')) return;
    this.tickBonus = (this.tickBonus || 0) + dt;
    if (this.tickBonus >= 120) {
      this.tickBonus = 0;
      if (State.orders.length < CONFIG.MAX_ORDERS) {
        const o = Orders.generate();
        o.reward = r2(o.reward * 1.3 );
        State.orders.push(o);
        UI.log('ðŸ¤ Verkoper scoorde een bonus order!', 'info');
        UI.renderOrders();
      }
    }
  },

  render() {
    const el = document.getElementById('employee-list'); if (!el) return;
    el.innerHTML = CONFIG.EMPLOYEES.map(emp => {
      const hired = State.hiredEmployees.includes(emp.id);
      const canAfford = State.money >= emp.cost;
      const canUnlock = State.bizLevel >= emp.unlockLevel;
      return `<div class="employee-card ${hired ? 'hired' : ''}">
        <div class="employee-header">
          <div class="employee-avatar">${emp.avatar}</div>
          <div class="employee-name">${emp.name}</div>
          <div class="employee-wage">â‚¬${emp.wagePM}/min</div>
        </div>
        <div class="employee-desc">${emp.desc}</div>
        ${hired
          ? `<div style="display:flex;justify-content:space-between;align-items:center;">
              <span class="employee-status working">âœ“ In dienst</span>
              <button class="btn btn-ghost btn-sm" onclick="Employees.fire('${emp.id}')">Ontslaan</button>
             </div>`
          : `<div style="display:flex;justify-content:space-between;align-items:center;">
              <span class="employee-status idle">${canUnlock ? 'Beschikbaar' : `ðŸ”’ Level ${emp.unlockLevel}`}</span>
              <button class="btn btn-primary btn-sm" onclick="Employees.hire('${emp.id}')" ${canUnlock&&canAfford?'':'disabled'}>
                â‚¬${emp.cost} Inhuren
              </button>
             </div>`
        }
      </div>`;
    }).join('');
  },
};

// â”€â”€ PRODUCTIEKETENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Chains = {
  init() {
    if (State.activeChains.length > 0) return;
    State.activeChains = CONFIG.PRODUCTION_CHAINS.map(c => ({
      id: c.id,
      progress: c.steps.map(() => 0),
      completed: false,
    }));
  },

  trackJob(filament) {
    State.activeChains.forEach(ac => {
      if (ac.completed) return;
      const template = CONFIG.PRODUCTION_CHAINS.find(c => c.id === ac.id);
      if (!template || State.bizLevel < template.unlockLevel) return;
      // Find next unfilled step matching filament
      const stepIdx = template.steps.findIndex((s, i) => s.fil === filament && ac.progress[i] < s.count);
      if (stepIdx >= 0) {
        ac.progress[stepIdx]++;
        // Check completion
        const done = template.steps.every((s, i) => ac.progress[i] >= s.count);
        if (done) {
          ac.completed = true;
          State.money = r2(State.money + template.reward);
          State.stats.totalEarned = r2(State.stats.totalEarned + template.reward);
          State.tokens = (State.tokens || 0) + template.bonusTokens;
          Sound.contractComplete();
          UI.floatMoney(`+â‚¬${template.reward} KETEN`);
          UI.log(`ðŸ”— Productieketen voltooid: ${template.name} â†’ +â‚¬${template.reward} + ${template.bonusTokens}ðŸŽ²`, 'contract');
          this._showTokenAnim(template.bonusTokens);
          this._showCompletionToast(template);
          this.reset(ac.id);
          this.updateTokenDisplay();
          // v7: Challenge tracking
          Challenges.onChainComplete();
        }
      }
    });
    this.render();
  },

  reset(id) {
    const ac = State.activeChains.find(a => a.id === id);
    if (ac) { ac.progress = ac.progress.map(() => 0); ac.completed = false; }
  },

  updateTokenDisplay() {
    const el = document.getElementById('token-val');
    if (el) el.textContent = State.tokens || 0;
    const td = $el('token-display');
    if (td) td.textContent = `${State.tokens || 0} Tokens`;
    const pill = $el('token-pill');
    if (pill) pill.style.display = (State.tokens || 0) > 0 ? 'flex' : 'none';
  },

  _showTokenAnim(count) {
    const el = document.createElement('div');
    el.style.cssText = `position:fixed;top:80px;right:24px;font-family:var(--display);font-weight:900;font-size:24px;color:#fbbf24;z-index:500;pointer-events:none;animation:floatUp 1.5s ease forwards;`;
    el.textContent = `+${count}ðŸŽ²`;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 1600);
  },

  _showCompletionToast(template) {
    const t = document.createElement('div');
    t.className = 'contract-toast';
    t.innerHTML = `<div style="font-size:9px;letter-spacing:2px;color:#fbbf24;margin-bottom:4px">ðŸ”— KETEN VOLTOOID!</div><div style="font-family:var(--display);font-weight:700;font-size:15px;color:var(--text-bright)">${template.name}</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">+â‚¬${template.reward} Â· +${template.bonusTokens}ðŸŽ²</div>`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 5000);
  },

  render() {
    const el = document.getElementById('chain-list'); if (!el) return;
    el.innerHTML = CONFIG.PRODUCTION_CHAINS.map(template => {
      const ac = State.activeChains.find(a => a.id === template.id);
      const locked = State.bizLevel < template.unlockLevel;
      if (locked) return `<div class="chain-card" style="opacity:0.4;"><div class="chain-header"><div class="chain-name">ðŸ”’ ${template.name}</div><div style="font-size:9px;color:var(--text-dim)">Level ${template.unlockLevel}</div></div></div>`;
      const totalSteps = template.steps.reduce((s,step)=>s+step.count,0);
      const doneSoFar  = ac ? ac.progress.reduce((s,v)=>s+v,0) : 0;
      const pct = r0(doneSoFar / totalSteps * 100);
      const stepsHtml = template.steps.map((s,i) => {
        const done = ac ? ac.progress[i] : 0;
        const fc = filClass(s.fil);
        return `<div class="chain-step"><span class="tag tag-${fc}">${s.fil}</span> ${done}/${s.count}</div>${i<template.steps.length-1?'<div class="chain-arrow">â†’</div>':''}`;
      }).join('');
      return `<div class="chain-card">
        <div class="chain-header"><div class="chain-name">${template.name}</div><div class="chain-reward">â‚¬${template.reward} + ${template.bonusTokens}ðŸŽ²</div></div>
        <div class="chain-steps">${stepsHtml}</div>
        <div class="chain-progress"><div class="chain-prog-fill" style="width:${pct}%"></div></div>
        <div style="font-size:9px;color:var(--text-dim);text-align:right;">${doneSoFar}/${totalSteps} stappen (${pct}%)</div>
      </div>`;
    }).join('');
  },
};

// â”€â”€ LOOTBOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LootBox = {
  COST: 10,

  open() {
    if ((State.tokens || 0) < this.COST) {
      UI.showPopup('Niet genoeg tokens', `Je hebt ${this.COST} tokens nodig. Voltooi productieketens voor tokens!`);
      return;
    }
    State.tokens -= this.COST;
    Chains.updateTokenDisplay();
    // Weighted random: common=60%, rare=30%, epic=10%
    const roll = Math.random();
    const pool = roll < 0.1 ? CONFIG.LOOTBOX_REWARDS.filter(r=>r.rarity==='epic') :
                 roll < 0.4 ? CONFIG.LOOTBOX_REWARDS.filter(r=>r.rarity==='rare') :
                              CONFIG.LOOTBOX_REWARDS.filter(r=>r.rarity==='common');
    const reward = pool[Math.floor(Math.random() * pool.length)];
    const result = reward.apply(State);
    Confetti.burst();
    Sound.levelUp();
    UI.showPopup(`${reward.icon} Lootbox!`, `<div style="text-align:center;padding:8px 0"><div style="font-size:40px;margin-bottom:8px">${reward.icon}</div><div style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--warn);margin-bottom:4px">${reward.name}</div><div style="font-size:11px;color:var(--accent3)">${result}</div><div style="font-size:9px;color:var(--text-dim);margin-top:8px;text-transform:uppercase;letter-spacing:1px">${reward.rarity}</div></div>`);
    UI.log(`ðŸŽ² Lootbox: ${reward.name} â€” ${result}`, 'money');
    UI.updateTopBar();
    Achievements.check();
  },
};

// â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Confetti = {
  COLORS: ['#00e5ff','#ff6b35','#7fff6e','#ffcc00','#ff3d5a','#a78bfa','#4fc3f7'],

  burst(count = 60) {
    for (let i = 0; i < count; i++) {
      setTimeout(() => this._piece(), Math.random() * 600);
    }
  },

  _piece() {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    const size = 6 + Math.random() * 8;
    el.style.cssText = `
      left: ${Math.random() * 100}%;
      width: ${size}px; height: ${size}px;
      background: ${this.COLORS[Math.floor(Math.random() * this.COLORS.length)]};
      animation-duration: ${1.5 + Math.random() * 2}s;
      border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
    `;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  },

  levelUp() {
    this.burst(80);
    const overlay = document.createElement('div');
    overlay.className = 'levelup-flash';
    overlay.innerHTML = `<div class="levelup-text">LEVEL UP!<br><span style="font-size:24px;letter-spacing:2px">ðŸŽ‰</span></div>`;
    document.body.appendChild(overlay);
    setTimeout(() => overlay.remove(), 2600);
  },
};

// â”€â”€ PRINTER TEMPERATUUR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Temperature = {
  IDLE_TEMP: 25,
  PRINT_TEMP: 85,
  OVERHEAT: 95,

  tick(dt) {
    if (!State.printerTemps) State.printerTemps = {};
    State.printers.forEach((p, idx) => {
      const cur = State.printerTemps[idx] ?? 25;
      let target = p.active ? this.PRINT_TEMP : this.IDLE_TEMP;
      // Speed specialty = hotter printer
      if (Specialization.get(idx) === 'speed') target += 8;
      const delta = (target - cur) * 0.1 * dt;
      State.printerTemps[idx] = Math.max(0, Math.min(100, cur + delta));
      // Overheat: increase fail chance slightly
      if (State.printerTemps[idx] > this.OVERHEAT && p.active) {
        if (Math.random() < 0.002 * dt) {
          UI.log(`ðŸŒ¡ï¸ Printer #${idx+1} oververhit! Verhoogde faalkans.`, 'warn');
        }
      }
    });
  },

  getColor(temp) {
    if (temp > 90) return 'var(--danger)';
    if (temp > 70) return 'var(--warn)';
    if (temp > 40) return 'var(--accent3)';
    return 'var(--accent)';
  },

  getLabel(temp) {
    if (temp > 90) return 'ðŸ”´ OVERVERHIT';
    if (temp > 70) return 'ðŸŸ  Heet';
    if (temp > 40) return 'ðŸŸ¢ Warm';
    return 'ðŸ”µ Koud';
  },
};

// â”€â”€ NIEUWS TICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NewsTicker = {
  ITEMS: [
    'ðŸ“ˆ 3D-printmarkt groeit met 24% dit jaar!',
    'ðŸ§² TPU flexibel filament: perfect voor beugels en casings',
    'ðŸ”® Resin SLA printers: ongekend detailniveau voor miniaturen',
    'ðŸ­ LocalPrint NL heeft TPU en Resin op voorraad!',
    'ðŸ’¡ Tip: PA6-GF is ideaal voor industriÃ«le onderdelen',
    'âš ï¸ Marktcrises kunnen filamentprijzen tijdelijk verdubbelen!',
    'ðŸ”¥ Combo-systeem actief â€” druk snel achter elkaar!',
    'â­ VIP klanten geven tot +30% loyaliteitsbonus!',
    'ðŸ“‹ Contracts voor grote beloningen â€” check het contractbord',
    'ðŸŽ¯ Dagelijkse doelen geven gratis geld â€” niet vergeten!',
    'ðŸ”§ Regelmatig repareren verlaagt je faalkansen significant',
    'ðŸŒ¡ï¸ Printer temperatuur beÃ¯nvloedt prestaties',
    'ðŸ† Wekelijkse challenges voor exclusieve beloningen!',
    'ðŸ“¦ Koop filament bij leveranciers voor betere prijzen',
    'ðŸ§² Direct Drive upgrade maakt TPU prints mogelijk',
    'ðŸ”® SLA Resin Printer voor ultra-gedetailleerde prints',
    'ðŸ¤– Watch out! PrintBot is stealing your orders â€” be faster!',
    'ðŸ”¥ Demand Surges can pay huge bonuses â€” watch for them!',
    'ðŸ’³ Need cash fast? Take a loan â€” but pay it back before interest spirals!',
    'âš¡ Power outages will hit Level 4+ â€” buy the UPS to stay safe!',
    'ðŸ”´ PA6 and Resin can clog mid-print â€” be ready to smash!',
  ],

  init() {
    const inner = $el('ticker-inner');
    if (!inner) return;
    // Duplicate for seamless loop
    const all = [...this.ITEMS, ...this.ITEMS];
    inner.innerHTML = all.map(t => `<span class="ticker-item">${t}</span>`).join('');
  },

  addItem(text) {
    const inner = $el('ticker-inner');
    if (!inner) return;
    const span = document.createElement('span');
    span.className = 'ticker-item';
    span.textContent = text;
    inner.appendChild(span);
    inner.appendChild(span.cloneNode(true)); // duplicate for loop
  },
};

// â”€â”€ EINDSPEL CHECK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Endgame = {
  check() {
    if (State.prestige >= 3 && !State._printGodActive) {
      State._printGodActive = true;
      State.rewardMult *= 1.5;
      Confetti.burst(120);
      UI.showPopup('ðŸŒŸ PRINT GOD ONTGRENDELD!',
        `<div class="printgod-banner"><div class="printgod-title">âš¡ PRINT GOD âš¡</div><div class="printgod-desc">Na 3 prestiges heb jij de ultieme meesterprinter bewezen.<br><br>+50% permanente beloningsbonus Â· Exclusieve Print God badge Â· Je naam in de eeuwige leaderboard.<br><br>Gefeliciteerd!</div></div>`);
      UI.log('ðŸŒŸ PRINT GOD MODUS ACTIEF! +50% permanente bonus!', 'success');
      NewsTicker.addItem('ðŸŒŸ PRINT GOD ONTGRENDELD! De beste printer ter wereld is actief!');
    }
  },
};

// â”€â”€ v7: LEVERANCIERS SYSTEEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Suppliers = {
  // Current live prices (fluctuate over time)
  _prices: {},

  init() {
    CONFIG.SUPPLIERS.forEach(s => {
      this._prices[s.id] = { ...s.basePrice };
    });
    if (!State.supplierRelations) State.supplierRelations = {};
    if (!State.supplierOrderCount) State.supplierOrderCount = {};
    CONFIG.SUPPLIERS.forEach(s => {
      if (State.supplierRelations[s.id] === undefined) State.supplierRelations[s.id] = 0;
      if (State.supplierOrderCount[s.id] === undefined) State.supplierOrderCount[s.id] = 0;
    });
  },

  fluctuate() {
    CONFIG.SUPPLIERS.forEach(s => {
      Object.keys(this._prices[s.id]).forEach(fil => {
        const base = s.basePrice[fil];
        const delta = (Math.random() - 0.48) * 0.3 * base;
        this._prices[s.id][fil] = Math.max(base * 0.6, Math.min(base * 2.0, this._prices[s.id][fil] + delta));
        this._prices[s.id][fil] = r2(this._prices[s.id][fil] );
      });
    });
    this.render();
  },

  getPrice(supplierId, filament) {
    const s = CONFIG.SUPPLIERS.find(s => s.id === supplierId);
    if (!s) return 999;
    let price = this._prices[supplierId]?.[filament] ?? s.basePrice[filament] ?? 999;
    // Apply relation discount
    const rel = State.supplierRelations[supplierId] || 0;
    if (rel >= 2) price *= (1 - s.discount.trusted);
    else if (rel >= 1) price *= (1 - s.discount.preferred);
    // Bulk deal upgrade
    if (State.bulkDealActive) price *= 0.80;
    // Crisis markup
    if (State.activeCrisis) {
      const crisis = State.activeCrisis;
      if (crisis.affected === filament || crisis.affected === 'ALL') price *= crisis.priceMult;
    }
    return r2(price );
  },

  order(supplierId, filament, qty) {
    const price = this.getPrice(supplierId, filament);
    const total = price * qty;
    if (State.money < total) {
      UI.showPopup('Te weinig geld', `Bestelling kost â‚¬${total.toFixed(2)}.`);
      return;
    }
    const fil = CONFIG.FILAMENTS[filament];
    if (!fil) return;
    // Check unlock requirements
    if (filament === 'TPU' && !State.tpuUnlocked) {
      UI.showPopup('TPU Vergrendeld', 'Koop "Direct Drive" upgrade om TPU te ontgrendelen.'); return;
    }
    if (filament === 'RESIN' && !State.resinUnlocked) {
      UI.showPopup('Resin Vergrendeld', 'Koop "SLA Resin Printer" om Resin te ontgrendelen.'); return;
    }
    if (filament === 'CF' && !State.cfUnlocked) {
      UI.showPopup('Carbon Fiber Vergrendeld', 'Koop "CF Nozzle + Enclosure" upgrade om CF te ontgrendelen.'); return;
    }
    if (filament === 'GLOW' && !State.glowUnlocked) {
      UI.showPopup('Glow Vergrendeld', 'Koop "Glow-in-the-Dark Filament" upgrade om GLOW te ontgrendelen.'); return;
    }

    State.money = r2(State.money - total);
    State.filamentStock[filament] = (State.filamentStock[filament] || 0) + qty;

    // Build relation
    State.supplierOrderCount[supplierId] = (State.supplierOrderCount[supplierId] || 0) + 1;
    const orders = State.supplierOrderCount[supplierId];
    const oldRel = State.supplierRelations[supplierId] || 0;
    if (orders >= 10 && oldRel < 2) { State.supplierRelations[supplierId] = 2; UI.log(`â­ Vertrouwde relatie met ${CONFIG.SUPPLIERS.find(s=>s.id===supplierId)?.name}!`, 'success'); }
    else if (orders >= 4 && oldRel < 1) { State.supplierRelations[supplierId] = 1; UI.log(`âœ… Preferred leverancier: ${CONFIG.SUPPLIERS.find(s=>s.id===supplierId)?.name}`, 'info'); }

    Sound.click();
    UI.log(`ðŸ“¦ ${qty}Ã— ${filament} besteld bij ${supplierId} â€” â‚¬${total.toFixed(2)}`, 'info');
    this.updateStockUI();
    this.render();
    UI.updateTopBar();
  },

  useStock(filament, amount) {
    const current = State.filamentStock[filament] || 0;
    State.filamentStock[filament] = Math.max(0, current - amount);
    this.updateStockUI();
    // Warn if low
    if (State.filamentStock[filament] < 10 && State.filamentStock[filament] > 0) {
      UI.log(`âš ï¸ ${filament} voorraad laag: ${State.filamentStock[filament]} eenheden!`, 'warn');
    } else if (State.filamentStock[filament] === 0) {
      UI.log(`âŒ ${filament} voorraad LEEG! Bestel bij een leverancier.`, 'error');
    }
  },

  hasStock(filament, amount = 1) {
    return (State.filamentStock[filament] || 0) >= amount;
  },

  updateStockUI() {
    ['PLA','PETG','PA6','TPU','RESIN','CF','GLOW'].forEach(fil => {
      const val = State.filamentStock[fil] || 0;
      const el = document.getElementById(`sval-${fil.toLowerCase()}`);
      const pill = document.getElementById(`stock-${fil.toLowerCase()}`);
      if (!el || !pill) return;
      if (fil === 'TPU' && !State.tpuUnlocked) { el.textContent = 'â€”'; pill.className='stock-pill'; return; }
      if (fil === 'RESIN' && !State.resinUnlocked) { el.textContent = 'â€”'; pill.className='stock-pill'; return; }
      if (fil === 'CF' && !State.cfUnlocked) { el.textContent = 'â€”'; pill.className='stock-pill'; return; }
      if (fil === 'GLOW' && !State.glowUnlocked) { el.textContent = 'â€”'; pill.className='stock-pill'; return; }
      el.textContent = val;
      pill.className = val <= 0 ? 'stock-pill low stock-critical' : val < 20 ? 'stock-pill low' : val < 50 ? 'stock-pill mid' : 'stock-pill high';
    });
  },

  // Auto-buy for Pro Supplier AI
  autoAI() {
    if (!State.supplierAI) return;
    ['PLA','PETG','PA6'].forEach(fil => {
      if ((State.filamentStock[fil] || 0) < 15) {
        // Find cheapest supplier
        const cheapest = CONFIG.SUPPLIERS.reduce((best, s) => {
          const p = this.getPrice(s.id, fil);
          return p < this.getPrice(best.id, fil) ? s : best;
        }, CONFIG.SUPPLIERS[0]);
        const canAfford = State.money >= this.getPrice(cheapest.id, fil) * 20;
        if (canAfford) this.order(cheapest.id, fil, 20);
      }
    });
  },

  render() {
    const el = document.getElementById('supplier-list'); if (!el) return;
    el.innerHTML = '';
    CONFIG.SUPPLIERS.forEach(s => {
      const rel = State.supplierRelations[s.id] || 0;
      const relClass = rel >= 2 ? 'trusted' : rel >= 1 ? 'preferred' : '';
      const relLabel = rel >= 2 ? '<span class="supplier-rel-trusted supplier-relation">â­ Trusted</span>' : rel >= 1 ? '<span class="supplier-rel-preferred supplier-relation">âœ… Preferred</span>' : '<span class="supplier-rel-neutral supplier-relation">Nieuw</span>';
      const ordersLeft = rel < 1 ? `4 bestellingen â†’ Preferred` : rel < 2 ? `${10 - (State.supplierOrderCount[s.id]||0)} â†’ Trusted` : 'Max niveau bereikt';

      const filaments = ['PLA','PETG','PA6','TPU','RESIN','CF','GLOW'];
      const priceRows = filaments.map(fil => {
        const locked = (fil==='TPU'&&!State.tpuUnlocked) || (fil==='RESIN'&&!State.resinUnlocked) || (fil==='CF'&&!State.cfUnlocked) || (fil==='GLOW'&&!State.glowUnlocked);
        if (locked) return '';
        const price = this.getPrice(s.id, fil);
        const base = s.basePrice[fil];
        const trend = price > base * 1.1 ? '<span class="trend-up">â–²</span>' : price < base * 0.9 ? '<span class="trend-down">â–¼</span>' : 'â†’';
        const fc = fil.toLowerCase();
        const stock = State.filamentStock[fil] || 0;
        const isSpecial = s.speciality?.includes(fil) ? ' âœ¨' : '';
        return `<div class="supplier-stock-row">
          <span class="supplier-stock-name"><span class="tag tag-${fc}" style="font-size:8px">${fil}</span>${isSpecial}</span>
          <div class="stock-bar"><div class="stock-fill ${stock<10?'stock-low':stock<40?'stock-mid':'stock-high'}" style="width:${Math.min(100,stock)}%"></div></div>
          <span style="font-size:10px;min-width:28px;text-align:right;color:var(--text-dim)">${stock}</span>
          <span style="font-size:11px;font-family:var(--display);font-weight:700;min-width:48px;text-align:right">â‚¬${price}${trend}</span>
          <div style="display:flex;gap:3px;">
            <button class="btn btn-sm btn-ghost" style="padding:3px 6px;font-size:9px" onclick="Suppliers.order('${s.id}','${fil}',10)">Ã—10</button>
            <button class="btn btn-sm btn-ghost" style="padding:3px 6px;font-size:9px" onclick="Suppliers.order('${s.id}','${fil}',50)">Ã—50</button>
          </div>
        </div>`;
      }).join('');

      el.innerHTML += `<div class="supplier-card ${relClass}">
        <div class="supplier-header">
          <div class="supplier-avatar">${s.avatar}</div>
          <div>
            <div class="supplier-name">${s.name}</div>
            <div style="font-size:9px;color:var(--text-dim)">${s.desc}</div>
          </div>
          ${relLabel}
        </div>
        <div style="font-size:9px;color:var(--text-dim);margin-bottom:8px;">ðŸ“ˆ ${ordersLeft}</div>
        ${priceRows}
      </div>`;
    });
  },
};

// â”€â”€ v7: MARKTCRISIS SYSTEEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MarketCrisis = {
  _timer: null,

  tick(dt) {
    // Count down to next crisis
    if (!State.activeCrisis) {
      // Higher levels see more frequent crises
      const _crisisDt = dt * (1 + Math.max(0, State.bizLevel - 4) * 0.2);
      State.crisisCountdown = (State.crisisCountdown || 200) - _crisisDt;
      if (State.crisisCountdown <= 0 && Math.random() < 0.3) {
        this.trigger();
        State.crisisCountdown = 150 + Math.random() * 200;
      }
      return;
    }
    // Active crisis countdown
    State.crisisTimer = (State.crisisTimer || 0) - dt;
    if (State.crisisTimer <= 0) this.end();
    else this.updateUI();
  },

  trigger() {
    const crisis = CONFIG.MARKET_CRISES[Math.floor(Math.random() * CONFIG.MARKET_CRISES.length)];
    State.activeCrisis = { ...crisis };
    State.crisisTimer = crisis.duration;
    this.showBanner();
    Sound.failure();
    UI.log(`âš ï¸ Marktcrisis: ${crisis.name} â€” ${crisis.desc}`, 'warn');
    // Show toast
    const t = document.createElement('div');
    t.className = 'crisis-toast';
    t.innerHTML = `<div style="font-size:9px;letter-spacing:2px;color:var(--danger)">âš ï¸ MARKTCRISIS</div><div style="font-family:var(--display);font-weight:900;font-size:16px;color:var(--danger);margin:4px 0">${crisis.icon} ${crisis.name}</div><div style="font-size:10px;color:var(--text-dim)">${crisis.desc}</div>`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 6000);
    NewsTicker.addItem(`${crisis.icon} CRISIS: ${crisis.name} â€” ${crisis.desc}`);
  },

  end() {
    UI.log(`âœ… Marktcrisis voorbij: ${State.activeCrisis?.name}`, 'info');
    State.activeCrisis = null;
    State.crisisTimer = 0;
    $el('crisis-banner').classList.remove('active');
    Market.renderTicker(null);
  },

  showBanner() {
    if (!State.activeCrisis) return;
    const b = $el('crisis-banner');
    $el('crisis-icon').textContent = State.activeCrisis.icon;
    $el('crisis-name').textContent = State.activeCrisis.name;
    $el('crisis-desc').textContent = State.activeCrisis.desc;
    b.classList.add('active');
  },

  updateUI() {
    if (!State.activeCrisis) return;
    const t = State.crisisTimer || 0;
    const m = Math.floor(t/60), s = r0(t%60);
    const el = document.getElementById('crisis-timer');
    if (el) el.textContent = `${m}:${s.toString().padStart(2,'0')}`;
  },

  getRewardBoost(filament) {
    if (!State.activeCrisis) return 1;
    // Crisis = shortage = customers pay more!
    if (State.activeCrisis.affected === filament || State.activeCrisis.affected === 'ALL') {
      return State.activeCrisis.priceMult * 0.7; // partial boost to reward
    }
    return 1;
  },
};

// â”€â”€ v7: WEEKLY CHALLENGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Challenges = {
  init() {
    if (!State.activeChallenges || State.activeChallenges.length === 0) {
      this.generateWeekly();
    }
    if (!State.challengeSessionData) this._resetSessionData();
  },

  generateWeekly() {
    const shuffled = [...CONFIG.WEEKLY_CHALLENGES].sort(() => Math.random() - 0.5);
    State.activeChallenges = shuffled.slice(0, 4).map(c => ({
      ...c,
      progress: 0,
      completed: false,
      weekStart: new Date().toISOString().slice(0,10),
    }));
    this._resetSessionData();
    UI.log('ðŸ† Nieuwe wekelijkse uitdagingen actief!', 'info');
  },

  _resetSessionData() {
    State.challengeSessionData = {
      jobs:0, ultra:0, filamix:[], nofail:0, earn:0,
      contracts:0, chains:0, night:0, tpu:0, resin:0,
      failedThisSession:false,
    };
  },

  onJobComplete(job, filament, quality, profit) {
    const orderType = job?.orderType || 'normal';
    const sd = State.challengeSessionData;
    sd.jobs++;
    sd.earn += (profit||0);
    if (quality === 'ULTRA') sd.ultra++;
    if (filament === 'TPU') sd.tpu++;
    if (filament === 'RESIN') sd.resin++;
    if (!sd.filamix.includes(filament)) sd.filamix.push(filament);
    if (!sd.failedThisSession) sd.nofail++;
    const hr = new Date().getHours();
    if (hr >= 22 || hr < 4) sd.night++;
    // v8: track new special types
    if (!sd.vip) sd.vip = 0;
    if (!sd.rush) sd.rush = 0;
    if (!sd.bulk) sd.bulk = 0;
    if (!sd.mystery) sd.mystery = 0;
    if (orderType === 'vip')     sd.vip++;
    if (orderType === 'rush')    sd.rush++;
    if (orderType === 'bulk')    sd.bulk++;
    if (orderType === 'mystery') sd.mystery++;
    this.checkProgress();
  },

  onJobFail() {
    if (State.challengeSessionData) {
      State.challengeSessionData.failedThisSession = true;
      State.challengeSessionData.nofail = 0;
    }
  },

  onContractComplete() {
    if (State.challengeSessionData) State.challengeSessionData.contracts++;
    this.checkProgress();
  },

  onChainComplete() {
    if (State.challengeSessionData) State.challengeSessionData.chains++;
    this.checkProgress();
  },

  _getProgress(c) {
    const sd = State.challengeSessionData || {};
    switch(c.type) {
      case 'jobs':      return sd.jobs || 0;
      case 'ultra':     return sd.ultra || 0;
      case 'filamix':   return (sd.filamix || []).length;
      case 'nofail':    return sd.nofail || 0;
      case 'earn':      return r0(sd.earn || 0);
      case 'contracts': return sd.contracts || 0;
      case 'chains':    return sd.chains || 0;
      case 'night':     return sd.night || 0;
      case 'tpu':       return sd.tpu || 0;
      case 'resin':     return sd.resin || 0;
      case 'vip':       return sd.vip || 0;
      case 'rush':      return sd.rush || 0;
      case 'bulk':      return sd.bulk || 0;
      case 'bounty':    return State.stats_v8?.bountiesClaimed || 0;
      default: return 0;
    }
  },

  checkProgress() {
    State.activeChallenges.forEach(c => {
      if (c.completed) return;
      const progress = this._getProgress(c);
      c.progress = progress;
      if (progress >= c.target) {
        c.completed = true;
        State.money = r2(State.money + c.reward);
        State.stats.totalEarned = r2(State.stats.totalEarned + c.reward);
        State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + c.bonusRep);
        State.xp += 50;
        State.stats.challengesDone = (State.stats.challengesDone||0) + 1;
        Sound.contractComplete();
        Confetti.burst(80);
        UI.floatMoney(`+â‚¬${c.reward} CHALLENGE`);
        UI.log(`ðŸ† Challenge voltooid: ${c.name} â†’ +â‚¬${c.reward} +${c.bonusRep} rep`, 'money');
        const t = document.createElement('div');
        t.className = 'achievement-toast';
        t.innerHTML = `<div class="ach-label">ðŸ† Challenge Voltooid!</div><div class="ach-name">${c.icon} ${c.name}</div><div class="ach-desc">+â‚¬${c.reward} Â· +${c.bonusRep} Rep</div>`;
        document.body.appendChild(t); setTimeout(() => t.remove(), 5000);
      }
    });
    this.render();
  },

  render() {
    const el = document.getElementById('challenge-list'); if (!el) return;
    if (!State.activeChallenges || State.activeChallenges.length === 0) {
      el.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px">Geen uitdagingen.</div>';
      return;
    }
    const diffColor = { normal:'var(--accent)', hard:'var(--warn)', epic:'var(--danger)' };
    el.innerHTML = State.activeChallenges.map(c => {
      const prog = Math.min(c.target, this._getProgress(c));
      const pct = r0(prog / c.target * 100);
      const col = diffColor[c.difficulty] || 'var(--accent)';
      return `<div class="challenge-card ${c.completed ? '' : 'active-challenge'}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div class="challenge-name">${c.icon} ${c.name}</div>
          <div class="challenge-reward">â‚¬${c.reward}</div>
        </div>
        <div class="challenge-desc">${c.desc}</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
          <span style="font-size:9px;color:${col};letter-spacing:1px;text-transform:uppercase">${c.difficulty}</span>
          <span style="font-size:9px;color:var(--text-dim)">+${c.bonusRep} rep</span>
        </div>
        ${c.completed
          ? '<div style="color:var(--accent3);font-size:10px;margin-top:6px;letter-spacing:1px">âœ… VOLTOOID</div>'
          : `<div class="challenge-prog-bar"><div class="challenge-prog-fill" style="width:${pct}%"></div></div>
             <div class="challenge-timer">${prog} / ${c.target} (${pct}%)</div>`}
      </div>`;
    }).join('') +
    `<button class="btn btn-ghost btn-sm btn-full" style="margin-top:8px" onclick="Challenges.generateWeekly()">ðŸ”„ Nieuwe uitdagingen</button>`;
  },
};


// â”€â”€ CRM: Platinum Client Special Deals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CRM = {
  _platinumDeals: [], // { customerName, expiresAt }

  spawnPlatinumDeal(customerName) {
    // Spawn a mega-order from this Platinum client
    const order = Orders.generate();
    order.reward = r2(order.reward * 4.0);
    order.name = `ðŸ’Ž [PLATINUM DEAL] ${order.name}`;
    order.customer = customerName;
    order.timeLeft = 120; // 2 minutes to accept
    order.expiresIn = 120;
    order.orderType = 'vip';
    order.isPlatinumDeal = true;
    State.orders.unshift(order);
    Sound.levelUp();
    UI.log(`ðŸ’Ž PLATINUM DEAL from ${customerName}: ${order.name} â€” ${fmtEur(order.reward)}! (2 min)`, 'money');
    UI.showPopup('ðŸ’Ž Platinum Deal!',
      `<div style="text-align:center"><div style="font-size:32px">ðŸ’Ž</div><strong style="font-family:var(--display);color:var(--accent);font-size:15px">${customerName} has a Platinum Deal for you!</strong><br><br>${order.name}<br><br><span style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--accent3)">${fmtEur(order.reward)}</span><br><span style="font-size:10px;color:var(--text-dim)">Accept within 2 minutes</span></div>`);
    UI.renderOrders();
  },

  // Call this from VIPCustomers render to show CRM panel
  renderPanel() {
    const el = document.getElementById('crm-panel'); if (!el) return;
    const platinum = Object.entries(State.clientTiers || {})
      .filter(([,tier]) => tier === 'platinum')
      .map(([name]) => name);
    if (platinum.length === 0) {
      el.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:12px">Geen Platinum klanten nog. Bereik 40 jobs met dezelfde klant.</div>';
      return;
    }
    el.innerHTML = '<div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">ðŸ’Ž Platinum Klanten</div>' +
      platinum.map(name => {
        const c = (State.customers||{})[name] || { jobs:0 };
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(0,229,255,0.06);border:1px solid rgba(0,229,255,0.2);border-radius:6px;margin-bottom:6px">
          <div>
            <div style="font-family:var(--display);font-weight:700;font-size:12px">${name} <span class="tier-platinum" style="font-size:8px;padding:1px 5px;border-radius:3px">ðŸ’Ž PLATINUM</span></div>
            <div style="font-size:9px;color:var(--text-dim);margin-top:2px">${c.jobs} jobs voltoooid Â· +35% beloning</div>
          </div>
          <button class="btn btn-sm btn-primary" onclick="CRM.spawnPlatinumDeal('${name}')">ðŸ’Ž Deal</button>
        </div>`;
      }).join('');
  },
};

// â”€â”€ v7: VIP KLANTENPANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VIPCustomers = {
  render() {
    const el = document.getElementById('customer-panel'); if (!el) return;
    const customers = Object.entries(State.customers || {})
      .filter(([,c]) => c.jobs >= 1)
      .sort((a,b) => b[1].jobs - a[1].jobs)
      .slice(0, 15);

    if (customers.length === 0) {
      el.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:20px;font-size:11px">Nog geen klanthistorie.<br>Voltooi jobs om klantrelaties op te bouwen.</div>';
      return;
    }

    const rows = customers.map(([name, c]) => {
      const loyaltyBonus = CustomerLoyalty.getBonus(name);
      const level = CustomerLoyalty.getLoyaltyLevel(name);
      const satFilled = r0(Math.min(5, c.satisfaction / 2));
      const stars = Array.from({length:5}, (_,i) => `<span class="sat-star ${i<satFilled?'':'empty'}">â˜…</span>`).join('');
      const isVIP = c.jobs >= 5;
      return `<div class="customer-row">
        <div>
          <div class="customer-name-main">${name} ${isVIP ? '<span class="vip-badge">VIP</span>' : ''}</div>
          <div style="font-size:9px;color:var(--text-dim);margin-top:2px">${c.jobs} jobs</div>
        </div>
        <div class="customer-satisfaction">${stars}</div>
        ${loyaltyBonus > 1.01 ? `<div class="vip-bonus-label">+${Math.round((loyaltyBonus-1)*100)}%</div>` : ''}
        <div class="customer-jobs-count">${level || ''}</div>
      </div>`;
    }).join('');

    const vipCount = customers.filter(([,c]) => c.jobs >= 5).length;
    el.innerHTML = `<div class="customer-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase">Klantenstatus</div>
        <div style="font-size:11px;color:var(--warn)">${vipCount} VIP klanten</div>
      </div>
      ${rows}
    </div>
    <div style="padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);font-size:10px;color:var(--text-dim);line-height:1.6;margin-top:8px">
      ðŸ’¡ VIP klanten (5+ jobs) geven loyaliteitsbonus tot <strong style="color:var(--warn)">+30%</strong>.<br>
      Ultra-kwaliteit prints verhogen tevredenheid sneller.
    </div>`;
  },
};

// â”€â”€ MARKET MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Market = {
  update() {
    const prev = { ...State.market };
    ['PLA','PETG','PA6'].forEach(f => {
      const delta = (Math.random() - 0.48) * 0.3;
      State.market[f] = Math.max(0.6, Math.min(1.7, State.market[f] + delta));
      // Drift back toward 1.0
      State.market[f] = State.market[f] * 0.85 + 1.0 * 0.15;
      State.market[f] = r2(State.market[f] );
    });
    this.renderTicker(prev);
    UI.log(`ðŸ“ˆ Market shift â€” PLA Ã—${State.market.PLA} Â· PETG Ã—${State.market.PETG} Â· PA6 Ã—${State.market.PA6}`, 'info');
    // Push significant market moves to news ticker
    ['PLA','PETG','PA6'].forEach(f => {
      const delta = State.market[f] - (prev[f] || 1);
      if (delta >= 0.15) NewsTicker.addItem(`ðŸ“ˆ Marktpiek: ${f} prijzen omhoog naar Ã—${State.market[f].toFixed(2)} â€” goede tijd om te printen!`);
      else if (delta <= -0.15) NewsTicker.addItem(`ðŸ“‰ Marktdip: ${f} prijzen gezakt naar Ã—${State.market[f].toFixed(2)}.`);
    });
  },

  renderTicker(prev) {
    ['PLA','PETG','PA6'].forEach(f => {
      const key = f === 'PA6' ? 'pa6' : f.toLowerCase();
      const val = State.market[f];
      const old = prev ? prev[f] : 1;
      const el = document.getElementById('mval-' + key);
      const arr = document.getElementById('marr-' + key);
      if (!el) return;
      el.textContent = 'Ã—' + val.toFixed(2);
      if (val > old + 0.02) {
        el.className = 'market-up';
        arr.textContent = 'â†‘';
      } else if (val < old - 0.02) {
        el.className = 'market-down';
        arr.textContent = 'â†“';
      } else {
        el.className = 'market-flat';
        arr.textContent = 'â†’';
      }
    });
  },

  getMultiplier(filament) {
    return State.market[filament] || 1.0;
  },
};

// â”€â”€ TUTORIAL MODULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Tutorial = {
  step: 0,
  active: false,
  steps: [
    {
      targetId: 'ptab-body-orders',
      title: 'Welcome to Print & Profit!',
      body: 'You run a 3D printing business. Orders arrive here on the left â€” each one wants a specific print job done. Click an order to select it.',
      kbd: null,
    },
    {
      targetId: 'active-job-panel',
      title: 'Configure Your Print',
      body: 'After selecting an order, the center panel lets you choose Filament type and Quality. Higher quality = more profit but slower & riskier.',
      kbd: 'Q / W / E',
    },
    {
      targetId: 'start-job-btn',
      title: 'Start the Print!',
      body: 'Hit START PRINT (or press Space) to begin. Watch the progress bar and animation. Printers can fail â€” upgrades reduce that chance.',
      kbd: 'Space',
    },
    {
      targetId: 'tab-shop',
      title: 'Upgrade Your Workshop',
      body: 'Spend earnings in the Shop tab to unlock faster printers, better nozzles, and more. Level up your business to unlock new upgrades.',
      kbd: null,
    },
    {
      targetId: 'ptab-contracts',
      title: 'Contracts = Big Money',
      body: 'The Contracts tab has multi-job orders with large rewards. Accept them and they auto-track as you print. Daily contracts refresh each day!',
      kbd: null,
    },
  ],

  start() {
    if (localStorage.getItem('pnp_tutorial_done') && !arguments[0]) return;
    this.step = 0;
    this.active = true;
    this.render();
  },

  render() {
    const overlay = $el('tutorial-overlay');
    overlay.style.display = 'block';
    overlay.innerHTML = '';
    if (this.step >= this.steps.length) {
      this.finish();
      return;
    }
    const s = this.steps[this.step];
    const target = document.getElementById(s.targetId);
    if (target) {
      const rect = target.getBoundingClientRect();
      const spotlight = document.createElement('div');
      spotlight.className = 'tut-spotlight';
      spotlight.style.cssText = `top:${rect.top - 6}px;left:${rect.left - 6}px;width:${rect.width + 12}px;height:${rect.height + 12}px;`;
      overlay.appendChild(spotlight);
    }
    const tooltip = document.createElement('div');
    tooltip.className = 'tut-tooltip';
    const targetRect = target ? target.getBoundingClientRect() : { bottom: 200, left: window.innerWidth / 2 - 130 };
    tooltip.style.cssText = `top:${Math.min(targetRect.bottom + 14, window.innerHeight - 200)}px;left:${Math.min(targetRect.left, window.innerWidth - 290)}px;`;
    tooltip.innerHTML = `
      <div class="tut-step">Step ${this.step + 1} of ${this.steps.length}</div>
      <div class="tut-title">${s.title}</div>
      <div class="tut-body">${s.body}${s.kbd ? `<br><br>Shortcut: <kbd class="kbd">${s.kbd}</kbd>` : ''}</div>
      <div class="tut-actions">
        <button class="tut-skip" onclick="Tutorial.finish()">Skip tutorial</button>
        <button class="btn btn-primary btn-sm" onclick="Tutorial.next()">${this.step < this.steps.length - 1 ? 'Next â†’' : 'Done! ðŸŽ‰'}</button>
      </div>
    `;
    overlay.appendChild(tooltip);
  },

  next() {
    this.step++;
    this.render();
  },

  finish() {
    this.active = false;
    const overlay = $el('tutorial-overlay');
    overlay.style.display = 'none';
    overlay.innerHTML = '';
    localStorage.setItem('pnp_tutorial_done', '1');
    UI.log('Tutorial complete! Press ? to see keyboard shortcuts.', 'info');
  },

  toggleKbd() {
    const el = document.getElementById('kbd-hint');
    el.classList.toggle('visible');
  },

  _kbdTimer: null,
  showKbdHint() {
    const el = document.getElementById('kbd-hint');
    el.classList.add('visible');
    clearTimeout(this._kbdTimer);
    this._kbdTimer = setTimeout(() => el.classList.remove('visible'), 4000);
  },
};

// â”€â”€ v11: NEGOTIATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Negotiation = {
  counterOffer(orderId) {
    const orderIndex = State.orders.findIndex(o => o.id === orderId);
    if (orderIndex === -1) return;
    const order = State.orders[orderIndex];
    const successChance = 0.40 + (State.reputation / 1000);
    if (Math.random() < successChance) {
      order.reward = r2(order.reward * 1.25);
      order.negotiated = true;
      UI.log(`ðŸ¤ Klant ging akkoord! Prijs verhoogd naar â‚¬${order.reward}`, 'success');
      Sound.success();
      UI.renderOrders();
    } else {
      UI.log(`ðŸ˜  Klant vond je te duur en liep weg!`, 'error');
      Sound.failure();
      State.orders.splice(orderIndex, 1);
      UI.renderOrders();
    }
  },
};

// â”€â”€ v11: TRENDING PRODUCTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Trending = {
  tick(dt) {
    if (State.activeTrend) {
      State.trendTimer -= dt;
      this.updateBanner();
      if (State.trendTimer <= 0) this.end();
      return;
    }
    State.trendCountdown = (State.trendCountdown || 120) - dt;
    if (State.trendCountdown <= 0 && Math.random() < 0.05) {
      this.trigger();
      State.trendCountdown = 180 + Math.random() * 180;
    }
  },
  trigger() {
    const trend = CONFIG.TRENDING_PRODUCTS[Math.floor(Math.random() * CONFIG.TRENDING_PRODUCTS.length)];
    State.activeTrend = { ...trend };
    State.trendTimer = 180;
    this.showBanner();
    NewsTicker.addItem(`ðŸ”¥ TRENDING: ${trend.item} Ã—${trend.mult} marge voor ${Math.round(State.trendTimer/60)} min!`);
    UI.log(`ðŸ“ˆ Hype Alert! ${trend.item} is trending â€” Ã—${trend.mult} marges voor ${Math.round(State.trendTimer/60)} minuten!`, 'success');
    Sound.success();
    const t = document.createElement('div');
    t.className = 'crisis-toast';
    t.style.cssText = 'border-color:rgba(255,204,0,0.5);background:rgba(20,30,20,0.95)';
    t.innerHTML = `<div style="font-size:9px;letter-spacing:2px;color:var(--accent)">ðŸ“ˆ TRENDING</div><div style="font-family:var(--display);font-weight:900;font-size:16px;color:var(--accent);margin:4px 0">ðŸ”¥ ${trend.item}</div><div style="font-size:10px;color:var(--text-dim)">${trend.desc}</div>`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 6000);
  },
  end() {
    State.activeTrend = null;
    State.trendTimer = 0;
    const b = document.getElementById('trend-banner');
    if (b) b.style.display = 'none';
    UI.log('ðŸ“‰ Trend voorbij â€” marktprijzen normaliseren.', 'info');
  },
  showBanner() {
    const b = document.getElementById('trend-banner');
    if (!b) return;
    b.style.display = 'flex';
    this.updateBanner();
  },
  updateBanner() {
    const b = document.getElementById('trend-banner');
    if (!b || !State.activeTrend) return;
    const n = document.getElementById('trend-name');
    const t = document.getElementById('trend-timer');
    if (n) n.textContent = `ðŸ”¥ ${State.activeTrend.item} TRENDING Ã—${State.activeTrend.mult}`;
    if (t) t.textContent = `â³ ${Math.ceil(State.trendTimer)}s remaining`;
  },
};

// â”€â”€ v11: INVENTORY SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Inventory = {
  ITEMS: {
    keychains: { name:'Sleutelhanger', filament:'PLA',  printTime:8,  sellPrice:2.5,  icon:'ðŸ”‘' },
    planters:  { name:'Plantenbakje',  filament:'PETG', printTime:20, sellPrice:8.0,  icon:'ðŸŒ±' },
  },

  startPrint(itemKey, printerIdx) {
    const item = this.ITEMS[itemKey];
    const printer = State.printers[printerIdx];
    if (!printer || printer.active) { UI.toast('Printer bezet!', 'warn'); return; }
    if (printer.health < 10) { UI.toast('Printer kapot!', 'warn'); return; }
    // Check stock
    if ((State.filamentStock[item.filament] || 0) < 3) {
      UI.toast(`Niet genoeg ${item.filament} op voorraad!`, 'warn'); return;
    }
    // Create a pseudo-order
    const pseudoOrder = {
      id: 'inv_' + Date.now(),
      name: item.name,
      customer: 'Voorraad',
      filament: item.filament,
      reward: 0,
      printTime: item.printTime,
      urgent: false,
      expiresIn: 9999,
      timeLeft: 9999,
      xpReward: 2,
      orderType: 'normal',
      isInventory: true,
      inventoryKey: itemKey,
    };
    Printer.startJob(printerIdx, pseudoOrder, item.filament, 'NORMAL');
    UI.log(`ðŸ“¦ Voorraad-print gestart: ${item.name} op ${printer.name}`, 'info');
    UI.renderPrinters();
    this.render();
  },

  onComplete(job) {
    if (!job.isInventory) return;
    const key = job.inventoryKey;
    if (!State.inventory) State.inventory = { keychains:0, planters:0 };
    State.inventory[key] = (State.inventory[key] || 0) + 1;
    UI.log(`ðŸ“¦ ${this.ITEMS[key]?.icon || 'ðŸ“¦'} ${this.ITEMS[key]?.name} toegevoegd aan voorraad!`, 'info');
    this.render();
  },

  sellAll() {
    if (!State.inventory) State.inventory = { keychains:0, planters:0 };
    let value = 0;
    let summary = [];
    Object.entries(this.ITEMS).forEach(([key, item]) => {
      const qty = State.inventory[key] || 0;
      if (qty > 0) {
        const v = qty * item.sellPrice;
        value += v;
        summary.push(`${qty}Ã— ${item.icon} ${item.name} = â‚¬${v.toFixed(2)}`);
        State.inventory[key] = 0;
      }
    });
    if (value === 0) { UI.toast('Geen voorraad om te verkopen!', 'warn'); return; }
    State.money = r2(State.money + value);
    State.stats.totalEarned = r2(State.stats.totalEarned + value);
    State.incomeHistory.push({ t: Date.now(), v: value, type: 'inventory' });
    Sound.cash(value);
    UI.log(`ðŸ“¦ Voorraad verkocht aan retail voor â‚¬${value.toFixed(2)}: ${summary.join(', ')}`, 'money');
    UI.floatMoney(`+â‚¬${value.toFixed(2)}`);
    UI.updateTopBar();
    this.render();
  },

  render() {
    const el = document.getElementById('inventory-panel');
    if (!el) return;
    if (!State.inventory) State.inventory = { keychains:0, planters:0 };
    const freePrinters = State.printers.filter(p => !p.active);
    let html = `<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px;line-height:1.6;">
      ðŸ“¦ Print items op voorraad â€” geen klant nodig. Verkoop daarna in bulk aan lokale winkels.
    </div>`;
    Object.entries(this.ITEMS).forEach(([key, item]) => {
      const qty = State.inventory[key] || 0;
      const filStock = State.filamentStock[item.filament] || 0;
      const canPrint = freePrinters.length > 0 && filStock >= 3;
      html += `<div style="background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:10px;margin-bottom:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <div>
            <div style="font-family:var(--display);font-weight:700;font-size:13px;">${item.icon} ${item.name}</div>
            <div style="font-size:9px;color:var(--text-dim);">${item.filament} Â· ${item.printTime}s Â· â‚¬${item.sellPrice}/stuk bulk</div>
          </div>
          <div style="font-family:var(--display);font-weight:900;font-size:22px;color:var(--accent)">${qty}</div>
        </div>
        <div style="display:flex;gap:4px;">
          ${freePrinters.map((p,i) => `<button class="btn btn-sm btn-ghost" style="font-size:9px;flex:1" onclick="Inventory.startPrint('${key}',${p.id})" ${canPrint?'':'disabled'}>â–¶ ${p.name}</button>`).join('')}
          ${freePrinters.length === 0 ? '<div style="font-size:9px;color:var(--text-dim);flex:1;text-align:center;">Alle printers bezet</div>' : ''}
        </div>
      </div>`;
    });
    const totalValue = Object.entries(this.ITEMS).reduce((sum, [key, item]) => sum + (State.inventory[key] || 0) * item.sellPrice, 0);
    html += `<button class="btn btn-primary btn-full" style="margin-top:4px" onclick="Inventory.sellAll()" ${totalValue > 0 ? '' : 'disabled'}>
      ðŸ’° Verkoop aan lokale winkels${totalValue > 0 ? ` â€” â‚¬${totalValue.toFixed(2)}` : ' (leeg)'}
    </button>`;
    el.innerHTML = html;
  },
};

// â”€â”€ ORDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Orders = {
  generate() {
    const rep    = State.reputation;
    const bizLvl = State.bizLevel;
    let filPool  = ['PLA'];
    if (rep >= CONFIG.FILAMENTS.PETG.unlockRep) filPool.push('PETG');
    if (rep >= CONFIG.FILAMENTS.PA6.unlockRep)  filPool.push('PA6');
    if (rep >= CONFIG.FILAMENTS.TPU.unlockRep && State.tpuUnlocked)   filPool.push('TPU');
    if (rep >= CONFIG.FILAMENTS.RESIN.unlockRep && State.resinUnlocked) filPool.push('RESIN');
    if (rep >= CONFIG.FILAMENTS.GLOW.unlockRep && State.glowUnlocked) filPool.push('GLOW');
    if (rep >= CONFIG.FILAMENTS.CF.unlockRep && State.cfUnlocked) filPool.push('CF');
    const weights = filPool.map(f => f==='PLA'?3:f==='PETG'?2:f==='TPU'?1.5:f==='RESIN'?1:f==='CF'?0.8:f==='GLOW'?1.2:1);
    const fil     = this._weighted(filPool, weights);
    const baseTime   = 20 + Math.random()*20 + bizLvl*5;
    const filConf    = CONFIG.FILAMENTS[fil];
    // Apply market multiplier + crisis boost to base reward
    const marketMult = Market.getMultiplier(fil);
    const crisisMult = MarketCrisis.getRewardBoost(fil);
    let baseReward = (8 + Math.random()*12 + bizLvl*2) * filConf.profitMult * marketMult * crisisMult;
    const _urgentBase = 0.1 + rep * 0.003 + (Season.current?.urgentBoost || 0);
    const urgent      = Math.random() < _urgentBase;
    // Use filament-specific name pool
    const namePool = fil === 'PETG' ? CONFIG.ORDER_NAMES_PETG :
                     fil === 'PA6'  ? CONFIG.ORDER_NAMES_PA6  :
                     fil === 'TPU'  ? CONFIG.ORDER_NAMES_TPU  :
                     fil === 'RESIN'? CONFIG.ORDER_NAMES_RESIN :
                     fil === 'CF'   ? CONFIG.ORDER_NAMES_PA6  :
                     fil === 'GLOW' ? CONFIG.ORDER_NAMES_PLA  : CONFIG.ORDER_NAMES_PLA;
    const orderType = SpecialOrders.getType();
    let orderName = namePool[Math.floor(Math.random()*namePool.length)];
    // Apply trending multiplier
    if (State.activeTrend && orderName.includes(State.activeTrend.item)) {
      baseReward *= State.activeTrend.mult;
      orderName = `ðŸ”¥ [TRENDING] ${orderName}`;
    }
    const reward = Math.round(baseReward * (0.9 + Math.random()*0.2) * 100)/100;
    let order = {
      id:        Date.now() + "_" + Math.floor(Math.random() * 1e9),
      name:      orderName,
      customer:  CONFIG.ORDER_CUSTOMERS[Math.floor(Math.random()*CONFIG.ORDER_CUSTOMERS.length)],
      filament:  fil,
      reward,
      printTime: r0(baseTime),
      urgent,
      expiresIn: urgent ? 45 : CONFIG.ORDER_EXPIRE_S,
      timeLeft:  urgent ? 45 : CONFIG.ORDER_EXPIRE_S,
      xpReward:  r0(5 + bizLvl*2 + (fil==='PA6'?10:fil==='PETG'?4:fil==='TPU'?6:fil==='RESIN'?12:fil==='CF'?15:fil==='GLOW'?5:0)),
      orderType,
    };
    order = SpecialOrders.applyModifiers(order);
    return order;
  },
  _weighted(arr, w) {
    let r = Math.random() * w.reduce((a,b)=>a+b,0);
    for (let i=0;i<arr.length;i++){ r-=w[i]; if(r<=0) return arr[i]; }
    return arr[arr.length-1];
  },
};

// â”€â”€ CONTRACTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Contracts = {
  TEMPLATES: [
    { base:'Batch Print',   filaments:['PLA'],             counts:[3,5],  rewardMult:1.8 },
    { base:'PETG Series',   filaments:['PETG'],            counts:[2,4],  rewardMult:2.5, minRep:20 },
    { base:'Mixed Lot',     filaments:['PLA','PETG'],      counts:[2,2],  rewardMult:3.2, minRep:25 },
    { base:'PA6 Run',       filaments:['PA6'],             counts:[2,3],  rewardMult:4.5, minRep:60 },
    { base:'Prototype',     filaments:['PLA','PETG','PA6'],counts:[1,1,1],rewardMult:5.0, minRep:70 },
    { base:'Flex Series',   filaments:['TPU'],             counts:[2,3],  rewardMult:3.5, minRep:40, requireTPU:true },
    { base:'Precision Lot', filaments:['RESIN'],           counts:[2,3],  rewardMult:6.0, minRep:80, requireResin:true },
    { base:'Full Spectrum+',filaments:['PLA','PETG','TPU','RESIN'],counts:[1,1,1,1],rewardMult:8.0, minRep:90, requireTPU:true, requireResin:true },
  ],

  generate(isDaily=false) {
    const rep    = State.reputation;
    const bizLvl = State.bizLevel;
    // Pick eligible template
    const eligible = this.TEMPLATES.filter(t =>
      (!t.minRep || rep >= t.minRep) &&
      (!t.requireTPU || State.tpuUnlocked) &&
      (!t.requireResin || State.resinUnlocked)
    );
    // Fallback to basic templates if none eligible
    const pool = eligible.length > 0 ? eligible : this.TEMPLATES.slice(0, 2);
    const tpl  = pool[Math.floor(Math.random() * pool.length)];
    // Build requirements
    const reqs = tpl.filaments.map((f,i) => {
      const cnt = tpl.counts[Math.min(i, tpl.counts.length-1)];
      return { filament:f, required: cnt, done:0 };
    });
    const totalJobs = reqs.reduce((a,r)=>a+r.required,0);
    const baseReward = totalJobs * (12 + bizLvl*3) * tpl.rewardMult * (isDaily ? 2.5 : 1);
    return {
      id:        'c_'+Date.now()+Math.random(),
      name:      (isDaily ? 'ðŸŒŸ Daily: ' : '') + CONFIG.CONTRACT_NAMES[Math.floor(Math.random()*CONFIG.CONTRACT_NAMES.length)],
      customer:  CONFIG.CONTRACT_CUSTOMERS[Math.floor(Math.random()*CONFIG.CONTRACT_CUSTOMERS.length)],
      reqs,
      reward:    r0(baseReward),
      bonusRep:  isDaily ? 20 : 8 + bizLvl*2,
      bonusXP:   isDaily ? 50 : 15 + bizLvl*5,
      isDaily,
      accepted:  false,
      completed: false,
      expiresIn: isDaily ? CONFIG.DAILY_REFRESH_S : CONFIG.CONTRACT_REFRESH_S,
      timeLeft:  isDaily ? CONFIG.DAILY_REFRESH_S : CONFIG.CONTRACT_REFRESH_S,
    };
  },

  // Called when a job succeeds â€” checks all accepted contracts
  trackJob(filament) {
    let anyComplete = false;
    State.contracts.forEach(c => {
      if (!c.accepted || c.completed) return;
      c.reqs.forEach(r => {
        if (r.filament === filament && r.done < r.required) {
          r.done++;
        }
      });
      // Check completion
      if (c.reqs.every(r => r.done >= r.required)) {
        c.completed = true;
        anyComplete = true;
        this.complete(c);
      }
    });
    if (anyComplete) UI.renderContracts();
  },

  complete(contract) {
    State.money = r2(State.money + contract.reward);
    State.stats.totalEarned = r2(State.stats.totalEarned + contract.reward);
    State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + contract.bonusRep);
    State.xp += contract.bonusXP;
    State.stats.contractsDone++;
    if (contract.isDaily) State.stats.dailyDone++;
    // v7: Challenge tracking
    Challenges.onContractComplete();
    State.incomeHistory.push({ t: Date.now(), v: contract.reward, type:'contract' });
    if (State.incomeHistory.length > CONFIG.INCOME_HISTORY_MAX) State.incomeHistory.shift();

    Sound.contractComplete();
    UI.floatMoney(`+â‚¬${contract.reward} CONTRACT`);
    UI.log(`ðŸŽ¯ Contract complete: ${contract.name} â†’ +â‚¬${contract.reward}`, 'contract');
    UI.showContractToast(contract);
    Game.checkBizLevel();
    Achievements.check();
    UI.renderStats();
    UI.updateTopBar();
    UI.renderShop();
  },

  accept(contractId) {
    const c = State.contracts.find(x => x.id === contractId);
    if (!c) return;
    c.accepted = true;
    Sound.click();
    UI.log(`Contract accepted: ${c.name}`, 'info');
    UI.renderContracts();
  },

  refresh() {
    // Remove expired / completed contracts, add new ones
    State.contracts = State.contracts.filter(c => !c.completed && c.timeLeft > 0);
    // Ensure 3 regular contracts
    const regular = State.contracts.filter(c => !c.isDaily).length;
    for (let i = regular; i < 3; i++) {
      State.contracts.push(this.generate(false));
    }
    // Daily: one per day (real time)
    const now = Date.now();
    const hasDaily = State.contracts.some(c => c.isDaily && !c.completed);
    const lastDone = State.dailyContractDoneAt || 0;
    if (!hasDaily && (now - lastDone) > CONFIG.DAILY_REFRESH_S * 1000) {
      State.contracts.push(this.generate(true));
    }
  },
};

// â”€â”€ PRINTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Printer = {
  calcTime(order, quality, printerIdx) {
    const q = CONFIG.QUALITY[quality];
    const specMult = Specialization.getTimeMult(printerIdx ?? State.selectedPrinterIdx);
    const printer = State.printers[printerIdx ?? State.selectedPrinterIdx];
    const modelStats = CONFIG.PRINTER_MODELS[printer?.model || 'BASIC'];
    return r0(order.printTime * q.timeMult * State.speedMult * specMult * modelStats.speedMult);
  },
  calcFailChance(filament, quality, printerIdx) {
    const f = CONFIG.FILAMENTS[filament];
    const q = CONFIG.QUALITY[quality];
    let chance = f.failBase + q.failAdd + State.failBonus + State.nextFailBoost;
    if (filament !== 'PLA') { chance += State.abrasiveBonus; chance += State.dryerBonus; }
    // TPU: flex bed reduces failure
    if (filament === 'TPU' && State.flexBed) chance -= 0.20;
    // Resin: UV curing station reduces failure
    if (filament === 'RESIN' && State.uvCuring) chance -= 0.25;
    // CF: hardened nozzle+enclosure reduces failure
    if (filament === 'CF' && State.cfNozzle) chance -= 0.20;
    // Research: Bed Adhesion Science halves PLA fail rate
    if (filament === 'PLA' && State.researchFlags?.bedAdhesion) chance -= f.failBase * 0.50;
    // Research: Thermal Management reduces all heat-related wear effects
    if (State.researchFlags?.thermalMgmt) chance -= 0.03;
    // Low stock = higher failure (stress on printer)
    const stock = State.filamentStock[filament] || 0;
    if (stock < 10 && stock > 0) chance += 0.08; // running low
    chance += Specialization.getFailBonus(printerIdx ?? State.selectedPrinterIdx);
    // Printer model fail modifier
    const printer = State.printers[printerIdx ?? State.selectedPrinterIdx];
    const modelStats = CONFIG.PRINTER_MODELS[printer?.model || 'BASIC'];
    chance += modelStats.failAdd;
    // Printer health penalty: low health = higher fail chance
    if (printer && printer.health < 50) chance += (50 - printer.health) * 0.003;
    return Math.max(0.01, Math.min(0.95, chance));
  },
  calcProfit(order, filament, quality, printerIdx) {
    const f = CONFIG.FILAMENTS[filament];
    const q = CONFIG.QUALITY[quality];
    const seasonMult = Season.getRewardMult(filament);
    const specMult   = Specialization.getProfitMult(printerIdx ?? State.selectedPrinterIdx);
    const filCostMult= Specialization.getFilCostMult(printerIdx ?? State.selectedPrinterIdx);
    const prestigeM  = 1 + (State.prestigeBonus || 0);
    const comboMult  = Combo.getMultiplier();
    const surgeMult  = DemandSurge.getSurgeMultiplier(filament);
    let reward = order.reward * q.profitMult * State.rewardMult * seasonMult * specMult * prestigeM * comboMult * surgeMult;
    if (State.bulkBonusJobs > 0) reward *= 1.3;
    // Research: Quality Control Lab +20% reward for Ultra jobs
    if (quality === 'ULTRA' && State.researchFlags?.qualityCtrl) reward *= 1.20;
    // Night bonus: +20% reward between 22:00 and 04:00
    const hr = new Date().getHours();
    if (hr >= 22 || hr < 4) reward *= 1.20;
    let filCost = f.costPerJob * filCostMult;
    if (State.filDiscountJobs > 0) filCost *= 0.5;
    // Research: Material Science -15% filament cost
    if (State.researchFlags?.materialSci) filCost *= 0.85;
    return r2(reward - filCost);
  },
  startJob(printerIdx, order, filament, quality) {
    const printer = State.printers[printerIdx];
    printer.active    = true;
    printer.job       = { ...order, filament, quality, profit:this.calcProfit(order,filament,quality,printerIdx), fail:this.calcFailChance(filament,quality,printerIdx) };
    printer.progress  = 0;
    printer.timeLeft  = this.calcTime(order, quality, printerIdx);
    printer.totalTime = printer.timeLeft;
    Sound.startHum(printerIdx);
  },
  tick(printer, dt) {
    if (!printer.active || !printer.job) return;
    printer.timeLeft -= dt;
    printer.progress  = 1 - (printer.timeLeft / printer.totalTime);

    // v9: Clog trigger for PA6/RESIN at ~50% progress
    if (!printer._clogTriggered && !State.clogActive &&
        (printer.job.filament === 'PA6' || printer.job.filament === 'RESIN') &&
        printer.progress >= 0.45 && printer.progress <= 0.55) {
      const clogChance = printer.job.filament === 'RESIN' ? 0.08 : 0.05;
      if (Math.random() < clogChance && !State.ownedUpgrades.includes('hardened_nozzle')) {
        printer._clogTriggered = true;
        // Pause printer while clog minigame runs
        printer._clogPause = true;
        const pIdx = State.printers.indexOf(printer);
        setTimeout(() => ClogMinigame.trigger(pIdx), 200);
        return;
      }
      printer._clogTriggered = true; // prevent re-triggering even if no clog
    }

    // Resume from clog
    if (printer._clogPause && !State.clogActive) {
      printer._clogPause = false; // game either won or failed
    }
    if (printer._clogPause) return; // paused during clog minigame

    if (printer.progress >= 1 || printer.timeLeft <= 0) {
      printer.progress = 1;
      printer._clogTriggered = false;
      this.finishJob(printer);
    }
  },
  finishJob(printer) {
    const job     = printer.job;
    const success = Math.random() > job.fail;

    // AI Quality Control: intercept failure early (50% chance)
    if (!success && State.aiQuality && Math.random() < 0.5) {
      printer.health    = Math.max(0, printer.health - 2);
      State.nextFailBoost = 0;
      Sound.failure();
      UI.log(`ðŸ¤– AI QC caught a failure early on ${job.name} â€” damage minimised`, 'warn');
      UI.showFailureAnimation(printer.id, 'AI QC intervention', job.name);
      this._resetPrinter(printer, false);
      return;
    }

    Sound.stopHum(printer.id);
    if (success) this._onSuccess(printer, job);
    else          this._onFailure(printer, job);

    this._resetPrinter(printer, true);
    Game.checkBizLevel();
    Achievements.check();
    UI.renderCenterPanel();
    UI.renderPrinters();
    UI.updateTopBar();
    UI.renderStats();
    UI.renderGraphCanvas();
  },

  _onSuccess(printer, job) {
    // v11: Inventory jobs â€” short-circuit to inventory handler
    if (job.isInventory) {
      Inventory.onComplete(job);
      Sound.success();
      Suppliers.useStock(job.filament, CONFIG.FILAMENTS[job.filament]?.stockUse || 3);
      this._resetPrinter(printer, true);
      UI.renderPrinters();
      return;
    }

    const loyaltyMult  = CustomerLoyalty.getBonus(job.customer || '');
    const tierMult     = ClientTiers.getBonus(job.customer || '');
    const finalProfit  = r2(job.profit * loyaltyMult * tierMult);

    // â”€â”€ Money & core stats â”€â”€
    State.money             = r2(State.money + finalProfit);
    State.stats.totalEarned = r2(State.stats.totalEarned + finalProfit);
    State.stats.sessionEarned = r2((State.stats.sessionEarned||0) + finalProfit);
    State.stats.jobsDone++;
    State.stats.totalPrints++;
    State.stats.currentStreak++;
    State.stats.failStreak = 0;
    if (State.stats.currentStreak > State.stats.longestStreak)
      State.stats.longestStreak = State.stats.currentStreak;

    // â”€â”€ Reputation & XP â”€â”€
    const repGain = r0(CONFIG.REP_PER_SUCCESS * CONFIG.FILAMENTS[job.filament].repBonus
                   * CONFIG.QUALITY[job.quality].repMult) + (State.packagingBonus ? 1 : 0);
    State.reputation      = clamp(State.reputation + repGain, 0, CONFIG.MAX_REP);
    State.stats.repEarned += repGain;
    Subscriptions.checkUnlockMore();
    State.xp              += job.xpReward || 8;

    // â”€â”€ Per-filament counters â”€â”€
    const filCounters = { PA6:'pa6Done', PETG:'petgDone', TPU:'tpuDone', RESIN:'resinDone', CF:'cfDone', GLOW:'glowDone' };
    if (filCounters[job.filament]) State.stats[filCounters[job.filament]] = (State.stats[filCounters[job.filament]]||0) + 1;
    if (job.quality === 'ULTRA') State.stats.ultraJobs = (State.stats.ultraJobs||0) + 1;
    if (!State.stats.filamentsUsed.includes(job.filament)) State.stats.filamentsUsed.push(job.filament);
    if (job.name && job.name.includes('[TRENDING]')) State.stats.trendOrdersDone = (State.stats.trendOrdersDone||0) + 1;

    // â”€â”€ Misc tracking â”€â”€
    const hr = new Date().getHours();
    if (hr >= 22 || hr < 4)                               State.stats.nightShiftJobs++;
    if ((printer.totalTime||999) < State.stats.fastestJob) State.stats.fastestJob = printer.totalTime;
    if (Market.getMultiplier(job.filament) >= 1.2)         State.stats.marketSurgeJobs++;
    if (State.activeCrisis)                                State.stats.crisisJobsDone = (State.stats.crisisJobsDone||0) + 1;
    CustomerLoyalty.track(job.customer || '', job.filament, job.quality);

    // â”€â”€ Consume bonuses â”€â”€
    if (State.bulkBonusJobs   > 0) State.bulkBonusJobs--;
    if (State.filDiscountJobs > 0) State.filDiscountJobs--;
    State.nextFailBoost  = 0;
    // Health degradation â€” reduced by Durable Legacy perk and Thermal Management research
    let healthDrain = 1 + Math.random() * 2;
    if (State.durabilityBonus) healthDrain *= Math.max(0.1, 1 - State.durabilityBonus);
    if (State.researchFlags?.thermalMgmt) healthDrain *= 0.70;
    printer.health = Math.max(0, printer.health - healthDrain);

    // â”€â”€ Income history â”€â”€
    State.incomeHistory.push({ t: Date.now(), v: finalProfit, type: 'job' });
    // Track total filament cost for net profit stat
    const _filCost = r2(CONFIG.FILAMENTS[job.filament]?.costPerJob || 0);
    State.stats.totalFilamentCost = r2((State.stats.totalFilamentCost||0) + _filCost);
    if (State.incomeHistory.length > CONFIG.INCOME_HISTORY_MAX) State.incomeHistory.shift();

    // â”€â”€ Feedback â”€â”€
    Sound.success();
    Sound.cash(finalProfit);
    const loyaltyNote = loyaltyMult > 1.01 ? ` (â­Ã—${loyaltyMult.toFixed(2)})` : '';
    const tierNote    = tierMult > 1.01    ? ` (ðŸ…Ã—${tierMult.toFixed(2)})`     : '';
    const _hr = new Date().getHours();
    const nightNote   = (_hr >= 22 || _hr < 4) ? ' ðŸŒ™+20%' : '';
    UI.log(`âœ“ ${job.name} done â†’ ${fmtEur(finalProfit)}${loyaltyNote}${tierNote}${nightNote}`, 'money');
    UI.floatMoney(fmtEur(finalProfit));
    UI.showSuccessAnimation();
    Notifications.notify('Print Complete! ðŸ–¨ï¸', `${job.name} finished â†’ ${fmtEur(finalProfit)}`);

    // â”€â”€ Downstream systems â”€â”€
    Combo.onJobComplete();
    Speedrun.recordJob(finalProfit);
    DailyGoals.check();
    Challenges.onJobComplete(job, job.filament, job.quality, finalProfit);
    Suppliers.useStock(job.filament, CONFIG.FILAMENTS[job.filament]?.stockUse || 3);
    Chains.trackJob(job.filament);
    Contracts.trackJob(job.filament);
    SmartTips.check(State);
    if (State.stats.jobsDone % 5 === 0) Leaderboard.submit();
    setTimeout(() => Queue.tryAutoStart(), 300);

    // v8: special order tracking + bounty + milestone
    if (!State.stats_v8) State.stats_v8 = { vipDone:0, rushDone:0, bulkDone:0, mysteryDone:0, legendaryDone:0, bountiesClaimed:0, milestonesHit:0, researchCompleted:0, equipmentEventsFixed:0 };
    if (job.orderType === 'vip')       State.stats_v8.vipDone++;
    if (job.orderType === 'rush')      State.stats_v8.rushDone++;
    if (job.orderType === 'bulk')      State.stats_v8.bulkDone++;
    if (job.orderType === 'mystery')   State.stats_v8.mysteryDone++;
    if (job.orderType === 'legendary') State.stats_v8.legendaryDone++;
    if (job.orderType === 'subscription') State.stats_v10.subscriptionJobsDone = (State.stats_v10.subscriptionJobsDone||0) + 1;
    if (!State.stats.bestSingleJob || finalProfit > State.stats.bestSingleJob) State.stats.bestSingleJob = finalProfit;
    BountyBoard.onJobComplete(job, job.filament, job.quality);
    BountyBoard.onEarn(finalProfit);
    Milestones.check();

    // v9: New system hooks
    DemandSurge.onJobComplete(job.filament);
    Rival.onJobComplete();

    // v10: New system hooks
    TaxSystem.accrue(finalProfit);
    if (job.customer) {
      // Track jobs per customer for tier system
      if (!State.customers) State.customers = {};
      if (!State.customers[job.customer]) State.customers[job.customer] = { jobs: 0 };
      State.customers[job.customer].jobs = (State.customers[job.customer].jobs || 0) + 1;
      ClientTiers.update(job.customer);
    }
    // Legacy rep bonus
    if (State.repLegacyBonus) {
      State.reputation = clamp(State.reputation + State.repLegacyBonus, 0, CONFIG.MAX_REP);
    }

    if (State.smartQueue && State.orders.length > 0) {
      setTimeout(() => {
        const best    = [...State.orders].sort((a, b) => b.reward - a.reward)[0];
        const freeIdx = State.printers.findIndex(p => !p.active && p.id === printer.id);
        if (best && freeIdx >= 0) Game._autoStartJob(freeIdx, best);
      }, 500);
    }
  },

  _onFailure(printer, job) {
    State.stats.jobsFailed++;
    State.stats.totalPrints++;
    State.stats.currentStreak = 0;
    State.stats.failStreak    = (State.stats.failStreak||0) + 1;
    State.reputation = Math.max(0, State.reputation - Math.abs(CONFIG.REP_PER_FAILURE));

    if (State.bulkBonusJobs   > 0) State.bulkBonusJobs--;
    if (State.filDiscountJobs > 0) State.filDiscountJobs--;
    State.nextFailBoost = 0;
    printer.health = Math.max(0, printer.health - (4 + Math.random() * 5));

    Challenges.onJobFail();
    BountyBoard.onFail();
    const reason = Math.random() < 0.5 ? 'Clog detected' : 'Warping failure';
    Sound.failure();
    UI.log(`âœ— ${job.name} FAILED â€” ${reason}`, 'error');
    UI.showFailureAnimation(printer.id, reason, job.name);

    // v10: Recycling scrap + complaint chance
    Recycling.onFailure(job.filament);
    if (!Insurance.cover(`${job.name} failure`)) {
      Complaints.maybeComplain(job);
    }

    if (printer.health < 20 && printer.health > 0 && Math.random() < 0.5) {
      setTimeout(() => MiniGame.trigger(printer.id), 800);
    }
  },
  _resetPrinter(printer, clearJobState) {
    const idx = printer.id;
    printer.active   = false;
    printer.job      = null;
    printer.progress = 0;
    printer.timeLeft = 0;
    if (State.selectedPrinterIdx === idx) State.pendingOrder = null;
    if (State.viewingPrinterIdx === idx && !State.pendingOrder) {
      const other = State.printers.find(p => p.id !== idx && p.active);
      State.viewingPrinterIdx = other ? other.id : 0;
    }
  },
};

// â”€â”€ SHOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Shop = {
  buy(id) {
    // Check both CONFIG.UPGRADES and CONFIG.UPGRADES_V8
    const upg = CONFIG.UPGRADES.find(u => u.id===id) || CONFIG.UPGRADES_V8.find(u => u.id===id);
    if (!upg) return;
    if (upg.premium) {
      if (!State.isPro) { Game.showProModal(); return; }
      if (State.ownedUpgrades.includes(id)) return;
      State.ownedUpgrades.push(id);
      upg.apply(State);
      State.stats.upgradesBought++;
      Sound.success();
      UI.log(`Pro upgrade activated: ${upg.name}`, 'info');
      UI.renderShop(); return;
    }
    if (State.ownedUpgrades.includes(id)) return;
    if (State.money < upg.cost) { UI.showPopup('Insufficient Funds', `You need â‚¬${upg.cost} to buy ${upg.name}.`); return; }
    if (State.bizLevel < upg.unlockLevel) { UI.showPopup('Locked', `${upg.name} requires Business Level ${upg.unlockLevel}.`); return; }
    State.money = r2(State.money - upg.cost);
    State.ownedUpgrades.push(id);
    if (!State.researchFlags) State.researchFlags = {};
    upg.apply(State);
    State.stats.upgradesBought++;
    if (id==='printer2') State.printers.push({ id:1, name:'Printer #2', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 });
    if (id==='printer3') State.printers.push({ id:2, name:'Printer #3', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 });
    if (id==='printer4') State.printers.push({ id:3, name:'Printer #4', model:'BASIC', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 });
    if (id==='printer5') State.printers.push({ id:4, name:'Titan #5',   model:'DELTA', health:100, active:false, job:null, progress:0, timeLeft:0, totalTime:0 });
    if (id==='passive_income' || id==='etsy_store' || id==='franchise') $el('passive-pill').style.display='flex';
    if (id==='direct_drive') { State.tpuUnlocked = true; Suppliers.updateStockUI(); UI.renderFilamentRow(State.selectedFilament); }
    if (id==='resin_printer') { State.resinUnlocked = true; Suppliers.updateStockUI(); UI.renderFilamentRow(State.selectedFilament); }
    if (id==='glow_filament') { State.glowUnlocked = true; Suppliers.updateStockUI(); UI.renderFilamentRow(State.selectedFilament); }
    if (id==='cf_nozzle') { State.cfUnlocked = true; State.cfNozzle = true; Suppliers.updateStockUI(); UI.renderFilamentRow(State.selectedFilament); }
    Sound.click();
    UI.log(`Purchased: ${upg.name}`, 'info');
    UI.renderShop(); UI.renderPrinters(); UI.updateTopBar();
    Achievements.check();
    Milestones.check();
  },
};

// â”€â”€ ACHIEVEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Achievements = {
  check() {
    CONFIG.ACHIEVEMENTS.forEach(a => {
      if (!State.achievements.includes(a.id) && a.check(State)) {
        State.achievements.push(a.id);
        this._show(a);
      }
    });
    UI.renderAchievements();
  },
  _show(ach) {
    const el = document.createElement('div');
    el.className = 'achievement-toast';
    el.innerHTML = `<div class="ach-label">ðŸ† Achievement Unlocked</div><div class="ach-name">${ach.name}</div><div class="ach-desc">${ach.desc}</div>`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(), 4500);
  },
};

// â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UI = {
  toast(msg, type='info') {
    const colors = { info:'var(--accent)', success:'var(--accent3)', warn:'var(--warn)', error:'var(--danger)' };
    const t = document.createElement('div');
    t.style.cssText = `position:fixed;bottom:${70 + document.querySelectorAll('.ui-toast').length*44}px;right:16px;z-index:9999;background:var(--panel);border:1px solid ${colors[type]||colors.info};border-radius:8px;padding:8px 14px;font-size:11px;color:var(--text-bright);box-shadow:0 4px 16px rgba(0,0,0,0.4);transition:opacity 0.3s;max-width:280px;`;
    t.className = 'ui-toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => { t.style.opacity='0'; setTimeout(()=>t.remove(), 300); }, 2800);
  },
  log(msg, type='info') {
    const p = $el('log-panel');
    const now = new Date();
    const t = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
    const el = document.createElement('div'); el.className='log-entry';
    el.innerHTML=`<span class="log-time">${t}</span><span class="log-msg ${type}">${msg}</span>`;
    p.insertBefore(el, p.firstChild);
    while (p.children.length>50) p.removeChild(p.lastChild);
  },
  floatMoney(text) {
    const el = document.createElement('div'); el.className='idle-ticker'; el.textContent=text;
    el.style.cssText=`position:fixed;top:${60+Math.random()*40}px;left:${Math.random()*200+100}px;`;
    document.body.appendChild(el); setTimeout(()=>el.remove(),1200);
    const mv=$el('money-val'); mv.classList.remove('money-gained'); void mv.offsetWidth; mv.classList.add('money-gained');
  },
  updateTopBar() {
    $el('money-val').textContent=`â‚¬${State.money.toFixed(2)}`;
    $el('rep-val').textContent=`â˜… ${r0(State.reputation)}`;
    $el('level-val').textContent=State.bizLevel;
    if (State.passivePerMin>0) $el('passive-val').textContent=`â‚¬${(State.passivePerMin*60).toFixed(0)}/h`;
    const pb = $el('pro-btn');
    if (State.isPro) { pb.textContent='âš¡ Pro Active'; pb.classList.add('owned'); }
    // Show streak pill when streak â‰¥ 3
    const streakPill = $el('streak-pill');
    const streakVal = $el('streak-val');
    if (streakPill && streakVal) {
      if (State.stats.currentStreak >= 3) {
        streakPill.style.display = 'flex';
        streakVal.textContent = State.stats.currentStreak;
      } else {
        streakPill.style.display = 'none';
      }
    }
  },
  renderPrinters() {
    const panel = $el('printers-panel'); panel.innerHTML='';
    State.printers.forEach((p,idx)=>{
      const div=document.createElement('div');
      div.className=`printer-card ${p.active?'active':p.health<20?'error':'idle'}`;
      const hc = p.health>60?'var(--accent3)':p.health>30?'var(--warn)':'var(--danger)';
      const sc = p.active?'status-printing':(p.health<10?'status-error':'status-idle');
      const st = p.active?'â— Printing':(p.health<10?'! Error':'â—‹ Idle');
      const spec = Specialization.get(idx);
      const specTag = spec ? `<span class="spec-tag spec-tag-${spec}">${Specialization.SPECS[spec].icon} ${Specialization.SPECS[spec].name}</span>` : '';
      const model = p.model || 'BASIC';
      const modelConf = CONFIG.PRINTER_MODELS[model];
      const modelTagIcon = model === 'SPEED' ? 'âš¡' : model === 'DELTA' ? 'ðŸ”·' : 'ðŸ­';
      const modelTagColor = model === 'SPEED' ? 'rgba(255,61,90,0.15);border-color:rgba(255,61,90,0.3);color:#ff6b8a' : model === 'DELTA' ? 'rgba(0,229,255,0.15);border-color:rgba(0,229,255,0.3);color:var(--accent)' : 'rgba(127,255,110,0.15);border-color:rgba(127,255,110,0.3);color:#7fff6e';
      const modelTag = model !== 'BASIC' ? `<span class="spec-tag" style="background:${modelTagColor};">${modelTagIcon} ${modelConf.name}</span>` : '';
      let prog='';
      if (p.active&&p.job) prog=`<div class="progress-wrap"><div class="progress-label"><span>${p.job.name}</span><span>${Math.round(p.progress*100)}%</span></div><div class="progress-bar"><div class="progress-fill" style="width:${p.progress*100}%"></div></div></div>`;
      const specBtns = !p.active ? `<div style="display:flex;gap:4px;margin-top:6px;">
        <div class="spec-btn${spec==='speed'?' active-spec spec-speed':''}" onclick="Specialization.set(${idx},'speed')" title="Snel: -25% tijd">âš¡ Snel</div>
        <div class="spec-btn${spec==='quality'?' active-spec spec-quality':''}" onclick="Specialization.set(${idx},'quality')" title="Kwaliteit: +20% winst">ðŸ’Ž Kwal.</div>
        <div class="spec-btn${spec==='economy'?' active-spec spec-economy':''}" onclick="Specialization.set(${idx},'economy')" title="Zuinig: -50% filamentkosten">ðŸ’° Zuinig</div>
      </div>` : '';
      const temp = r0(State.printerTemps?.[idx] ?? 25);
      const tempColor = Temperature.getColor(temp);
      const tempLabel = Temperature.getLabel(temp);
      const tempHtml = `<div class="temp-bar-wrap"><div class="temp-bar-label"><span>ðŸŒ¡ï¸ ${temp}Â°C</span><span style="color:${tempColor}">${tempLabel}</span></div><div class="temp-bar"><div class="temp-fill" style="width:${temp}%;background:${tempColor}"></div></div></div>`;
      div.innerHTML=`<div class="printer-name" style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
        <span class="printer-name-editable" onclick="UI.renamePrinter(${idx})" title="Klik om te hernoemen">${p.name}</span>${specTag}${modelTag}
        <span class="printer-status ${sc}">${st}</span>
      </div>${prog}<div class="printer-stats"><div class="pstat"><div class="pstat-label">Health</div><div class="pstat-value">${r0(p.health)}%</div></div><div class="pstat"><div class="pstat-label">Filament</div><div class="pstat-value" style="color:var(--accent);font-size:12px">${p.active&&p.job?p.job.filament:'idle'}</div></div></div><div class="health-bar"><div class="health-fill" style="width:${p.health}%;background:${hc}"></div></div>${tempHtml}${!p.active&&p.health<100?`<button class="btn btn-sm btn-warn btn-full" style="margin-top:8px" onclick="Game.repairPrinter(${idx})">ðŸ”§ Repareer (â‚¬${((100-p.health)*CONFIG.REPAIR_COST_PER_HP).toFixed(0)})</button>`:''}${specBtns}`;
      panel.appendChild(div);
    });
  },
  renderOrders() {
    const body   = $el('ptab-body-orders');
    const noMsg  = $el('no-orders-msg');
    Array.from(body.children).forEach(c=>{ if(c.id!=='no-orders-msg') c.remove(); });
    const badge  = $el('order-badge');
    if (State.orders.length===0) { noMsg.style.display='block'; badge.style.display='none'; return; }
    noMsg.style.display='none'; badge.style.display='inline-block'; badge.textContent=State.orders.length;
    State.orders.forEach(o=>{
      const card=document.createElement('div');
      const fc = o.filament === 'RESIN' ? 'resin' : o.filament === 'TPU' ? 'tpu' : filClass(o.filament);
      card.className=`order-card order-${fc}${o.urgent ? ' urgent-card' : ''}${o.isFlash ? ' order-flash' : ''}`;
      const sel = State.pendingOrder&&State.pendingOrder.id===o.id;
      if (sel) card.style.borderColor='var(--accent)';
      const tpct=(o.timeLeft/(o.urgent?45:CONFIG.ORDER_EXPIRE_S))*100;
      const mMult = Market.getMultiplier(o.filament);
      const mBadge = mMult >= 1.15 ? `<span class="market-bonus">â–² Ã—${mMult.toFixed(2)}</span>` :
                     mMult <= 0.85 ? `<span class="market-bonus market-malus">â–¼ Ã—${mMult.toFixed(2)}</span>` : '';
      const loyaltyLevel = CustomerLoyalty.getLoyaltyLevel(o.customer);
      const loyBadge = loyaltyLevel ? `<span class="loyalty-badge">${loyaltyLevel}</span>` : '';
      const tierBadge = ClientTiers.getBadge(o.customer);
      const ot = o.orderType || 'normal';
      const specialBadge = ot !== 'normal' ? `<span class="tag ${SpecialOrders.getTagClass(ot)}">${SpecialOrders.getLabel(ot)}</span>` : '';
      if (ot !== 'normal') card.classList.add(`order-${ot}`);
      const hr = new Date().getHours();
      const isNight = hr >= 22 || hr < 4;
      const nightBadge = isNight ? '<span class="tag" style="background:rgba(100,80,200,0.3);color:#b39ddb">ðŸŒ™ +20%</span>' : '';
      const countdownStr = o.isFlash
        ? `<span class="flash-countdown" style="margin-left:4px">âš¡${r0(o.timeLeft)}s</span>`
        : o.urgent ? `<span style="color:var(--danger);font-weight:900;font-size:10px;margin-left:4px">â±${r0(o.timeLeft)}s</span>` : '';
      card.innerHTML=`<div class="order-header"><div><div class="order-name">${o.name}${mBadge}</div><div style="color:var(--text-dim);font-size:9px;margin-top:2px">${o.customer}${loyBadge}${tierBadge}</div></div><div class="order-reward">â‚¬${o.reward.toFixed(2)}</div></div><div class="order-meta"><span class="tag tag-${fc}">${o.filament}</span><span class="tag tag-time">â± ${r0(o.printTime)}s</span>${specialBadge}${o.urgent?`<span class="tag tag-diff">âš¡ URGENT${countdownStr}</span>`:''}${nightBadge}</div><div class="order-timer"><div class="order-timer-fill" style="width:${tpct}%"></div></div><div style="display:flex;gap:4px;margin-top:4px;"><button class="btn btn-sm btn-ghost" style="flex:1;font-size:9px" id="q-${o.id}">âž• Wachtrij</button>${!o.negotiated?`<button class="btn btn-sm btn-ghost" style="font-size:9px;color:var(--accent)" id="neg-${o.id}">ðŸ¤ +25%</button>`:''}</div>`;
      card.querySelector(`#q-${o.id}`)?.addEventListener('click', ev => { ev.stopPropagation(); Queue.add(o, null, null); });
      card.querySelector(`#neg-${o.id}`)?.addEventListener('click', ev => { ev.stopPropagation(); Negotiation.counterOffer(o.id); });
      card.onclick=()=>Game.selectOrder(o);
      body.appendChild(card);
    });
  },
  renderContracts() {
    const body   = $el('ptab-body-contracts');
    const noMsg  = $el('no-contracts-msg');
    Array.from(body.children).forEach(c=>{ if(c.id!=='no-contracts-msg') c.remove(); });
    const badge  = $el('contract-badge');
    const active = State.contracts.filter(c=>!c.completed&&c.timeLeft>0);
    if (active.length===0) { noMsg.style.display='block'; badge.style.display='none'; return; }
    noMsg.style.display='none'; badge.style.display='inline-block'; badge.textContent=active.length;
    active.forEach(c=>{
      const card=document.createElement('div');
      card.className=`contract-card ${c.isDaily?'daily':'regular'} ${c.accepted?'active-c':''} ${c.completed?'completed-c':''}`;
      const timeStr=c.timeLeft>3600?`${Math.floor(c.timeLeft/3600)}h`:c.timeLeft>60?`${Math.floor(c.timeLeft/60)}m`:r0(c.timeLeft)+'s';
      const reqsHtml=c.reqs.map(r=>{
        const pct=Math.round((r.done/r.required)*100);
        const fc=filClass(r.filament);
        return `<div class="contract-req-item"><span class="tag tag-${fc}" style="font-size:8px">${r.filament}</span><div class="contract-req-bar"><div class="contract-req-fill" style="width:${pct}%"></div></div><span class="contract-req-label">${r.done}/${r.required}</span></div>`;
      }).join('');
      card.innerHTML=`<div class="contract-header"><div><div class="contract-name">${c.name}</div><div style="color:var(--text-dim);font-size:9px;margin-top:2px">${c.customer}</div></div><div style="text-align:right"><div class="contract-reward">â‚¬${c.reward}</div><div style="color:var(--text-dim);font-size:9px">+${c.bonusRep} rep</div></div></div><div class="contract-req">${reqsHtml}</div><div class="contract-timer">â³ Expires in ${timeStr}</div>${!c.accepted?`<div class="contract-actions"><button class="btn btn-warn btn-sm btn-full" onclick="Contracts.accept('${c.id}')">Accept Contract</button></div>`:'<div style="color:var(--accent);font-size:9px;margin-top:6px;letter-spacing:1px">âœ“ TRACKING PROGRESS</div>'}`;
      body.appendChild(card);
    });
  },

  // â”€â”€ CENTER PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderCenterPanel() {
    const empty   = $el('job-empty');
    const content = $el('job-content');
    const anyActive = State.printers.some(p=>p.active);

    if (State.pendingOrder) {
      empty.style.display='none'; content.style.display='flex';
      this._renderConfigureMode(State.pendingOrder); return;
    }
    // Keep content visible if a spaghetti failure overlay is still showing
    const hasSpaghettiOverlay = document.querySelector('#job-content .spaghetti-overlay');
    if (anyActive || hasSpaghettiOverlay) {
      empty.style.display='none'; content.style.display='flex';
      const viewed = State.printers[State.viewingPrinterIdx];
      if (!viewed||!viewed.active) {
        const first=State.printers.find(p=>p.active);
        if (first) State.viewingPrinterIdx=first.id;
      }
      if (anyActive) this._renderMonitorMode(); return;
    }
    empty.style.display='flex'; empty.style.flexDirection='column'; content.style.display='none';
    const tabs=$el('center-printer-tabs'); if(tabs) tabs.innerHTML='';
  },
  renderActiveJob() { this.renderCenterPanel(); }, // alias

  _renderConfigureMode(order) {
    const fil=State.selectedFilament; const qual=State.selectedQuality;
    $el('job-title').textContent=order.name;
    $el('job-subtitle').innerHTML=`<span class="mode-label mode-configure">Configure</span> ${order.customer}`;
    $el('jstat-filament').textContent=fil;
    $el('jstat-filament').style.color=CONFIG.FILAMENTS[fil].color;
    $el('jstat-quality').textContent=qual;
    $el('jstat-time').textContent=`${Printer.calcTime(order,qual)}s`;
    const profit=Printer.calcProfit(order,fil,qual);
    const _hr2 = new Date().getHours();
    const _isNight = _hr2 >= 22 || _hr2 < 4;
    $el('jstat-profit').textContent=`â‚¬${profit.toFixed(2)}${_isNight ? ' ðŸŒ™' : ''}`;
    const failPct=Math.round(Printer.calcFailChance(fil,qual)*100);
    $el('big-prog-fill').style.width='0%';
    $el('big-prog-fill').style.background='linear-gradient(90deg,var(--accent2),var(--warn))';
    $el('big-prog-text').textContent=`Fail risk: ${failPct}% Â· ${State.printers[State.selectedPrinterIdx]?.name||'Printer #1'}`;
    $el('printer-visual').classList.remove('printing');
    $el('print-layer').style.height='0px';
    $el('print-head').style.left='10%';
    $el('nozzle-dot').style.display='none';
    $el('start-job-btn').style.display='block';
    $el('cancel-job-btn').style.display='none';
    this._renderCenterTabs(false);
    this.renderFilamentRow(fil); this.renderQualityRow(qual);
    this._renderEffectBanner();
  },
  _renderMonitorMode() {
    const printer=State.printers[State.viewingPrinterIdx]; if(!printer||!printer.job) return;
    const job=printer.job;
    $el('job-title').textContent=job.name;
    $el('job-subtitle').innerHTML=`<span class="mode-label mode-monitor">Printing</span> ${job.customer} Â· ${printer.name}`;
    $el('jstat-filament').textContent=job.filament;
    $el('jstat-filament').style.color=CONFIG.FILAMENTS[job.filament]?.color||'var(--text)';
    $el('jstat-quality').textContent=job.quality;
    $el('jstat-time').textContent=`${Math.max(0,r0(printer.timeLeft))}s`;
    $el('jstat-profit').textContent=`â‚¬${job.profit.toFixed(2)}`;
    const pct=Math.round(printer.progress*100);
    $el('big-prog-fill').style.width=pct+'%';
    $el('big-prog-fill').style.background='linear-gradient(90deg,#00b4d8,var(--accent),#00e5ff)';
    $el('big-prog-text').textContent=`${pct}% â€” ${Math.max(0,r0(printer.timeLeft))}s remaining`;
    $el('printer-visual').classList.add('printing');
    $el('print-layer').style.height=(printer.progress*100)+'px';
    $el('nozzle-dot').style.display='block';
    $el('start-job-btn').style.display='none';
    $el('cancel-job-btn').style.display='block';
    this._renderCenterTabs(true);
    const fr=$el('filament-row'); if(fr) fr.parentElement.style.display='none';
    const qr=$el('quality-row'); if(qr) qr.parentElement.style.display='none';
    this._renderEffectBanner();
  },
  _renderCenterTabs(monitorMode) {
    const el = document.getElementById('center-printer-tabs'); if(!el) return; el.innerHTML='';
    if (State.printers.length<2) return;
    State.printers.forEach((p,idx)=>{
      const isViewing = State.viewingPrinterIdx===idx&&monitorMode;
      const isSelected= State.selectedPrinterIdx===idx&&!monitorMode;
      const btn=document.createElement('div');
      const dc=p.active?'printing':(p.health<10?'error':'idle');
      btn.className=`printer-tab ${(isViewing||isSelected)?(p.active?'active-printing':'active'):''}`;
      btn.innerHTML=`<span class="tab-dot ${dc}"></span>${p.name}`;
      if (monitorMode) { btn.onclick=()=>{ State.viewingPrinterIdx=idx; this.renderCenterPanel(); }; }
      else {
        if (p.active) { btn.style.opacity='0.4'; btn.style.cursor='not-allowed'; btn.title='Busy'; }
        else btn.onclick=()=>{ State.selectedPrinterIdx=idx; this.renderCenterPanel(); };
      }
      el.appendChild(btn);
    });
  },
  _renderEffectBanner() {
    const b=$el('effect-banner'); if(!b) return; b.innerHTML='';
    if (State.bulkBonusJobs>0)     b.innerHTML+=`<span class="effect-tag effect-bulk">ðŸ“¦ Bulk Ã—${State.bulkBonusJobs}</span>`;
    if (State.filDiscountJobs>0)   b.innerHTML+=`<span class="effect-tag effect-disc">ðŸ’¸ âˆ’50% filament Ã—${State.filDiscountJobs}</span>`;
    if (State.nextFailBoost>0)     b.innerHTML+=`<span class="effect-tag effect-warn">âš  Fail +${Math.round(State.nextFailBoost*100)}%</span>`;
  },

  renderFilamentRow(sel) {
    const row=$el('filament-row'); if(!row) return;
    row.parentElement.style.display='';
    row.innerHTML='';
    ['PLA','PETG','PA6','TPU','RESIN','CF','GLOW'].forEach(id=>{
      const f=CONFIG.FILAMENTS[id];
      const locked=State.reputation<f.unlockRep;
      const upgradeRequired = (id==='TPU' && !State.tpuUnlocked) || (id==='RESIN' && !State.resinUnlocked) || (id==='CF' && !State.cfUnlocked) || (id==='GLOW' && !State.glowUnlocked);
      const stock = State.filamentStock[id] || 0;
      const noStock = stock <= 0 && !locked && !upgradeRequired;
      const fc=id.toLowerCase();
      const btn=document.createElement('div');
      btn.className=`filament-btn ${(locked||upgradeRequired||noStock)?'locked-fil':''} ${sel===id?`selected-${fc}`:''}`;
      const statText = locked ? `â˜…${f.unlockRep} rep` : upgradeRequired ? 'ðŸ”’ upgrade nodig' : noStock ? 'ðŸ“¦ geen voorraad' : `${stock} stuks`;
      btn.innerHTML=`<div class="fil-name fil-${fc}">${f.name}</div><div class="fil-stat">${statText}</div>`;
      if (!locked && !upgradeRequired && !noStock) btn.onclick=()=>{ State.selectedFilament=id; UI.renderCenterPanel(); };
      row.appendChild(btn);
    });
  },
  renderQualityRow(sel) {
    const row=$el('quality-row'); if(!row) return;
    row.parentElement.style.display='';
    row.innerHTML='';
    Object.entries(CONFIG.QUALITY).forEach(([id,q])=>{
      const btn=document.createElement('div'); btn.className=`quality-btn ${sel===id?'selected':''}`;
      btn.innerHTML=`<div class="quality-label">${q.name}</div>`;
      btn.onclick=()=>{ State.selectedQuality=id; UI.renderCenterPanel(); };
      row.appendChild(btn);
    });
  },
  renderShop() {
    const container=$el('shop-upgrades'); container.innerHTML='';
    // Pro banner if not owned
    if (!State.isPro) {
      const banner=document.createElement('div');
      banner.style.cssText='background:linear-gradient(135deg,rgba(124,58,237,0.15),rgba(167,139,250,0.08));border:1px solid rgba(167,139,250,0.4);border-radius:var(--radius);padding:12px;margin-bottom:2px;cursor:pointer;';
      banner.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;"><span style="font-family:var(--display);font-weight:900;font-size:15px;color:var(--pro)">âš¡ GO PRO</span><span style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--pro)">â‚¬4.99</span></div><div style="color:var(--text-dim);font-size:10px;">Unlock Smart Queue, AI QC, Supplier AI. One-time purchase.</div>`;
      banner.onclick=()=>Game.showProModal();
      container.appendChild(banner);
    }
    // Group by category
    const categories = [
      { id:'reliability', label:'ðŸ”§ Betrouwbaarheid' },
      { id:'speed',       label:'âš¡ Snelheid' },
      { id:'profit',      label:'ðŸ’° Winst & Passief' },
      { id:'expansion',   label:'ðŸ­ Uitbreiding' },
      { id:'pro',         label:'âš¡ Pro Upgrades', proOnly:true },
    ];
    categories.forEach(cat => {
      const upgrades = CONFIG.UPGRADES.filter(u => u.category === cat.id);
      if (upgrades.length === 0) return;
      const header = document.createElement('div');
      header.className = 'upgrade-category';
      header.textContent = cat.label;
      container.appendChild(header);
      upgrades.forEach(upg=>{
        const owned=State.ownedUpgrades.includes(upg.id);
        const affordable=State.money>=upg.cost;
        const unlocked=State.bizLevel>=upg.unlockLevel;
        const proLocked=upg.premium&&!State.isPro;
        const card=document.createElement('div');
        card.className=`upgrade-card ${owned?'owned':proLocked?'pro-locked':(affordable&&unlocked?'affordable':'')} ${!unlocked&&!upg.premium?'locked-upg':''}`;
        card.innerHTML=`<div class="upgrade-header"><div class="upgrade-name">${upg.name} ${owned?'âœ“':''} ${upg.premium?`<span class="pro-badge">PRO</span>`:''}</div><div class="upgrade-cost">${owned?'Owned':upg.premium?'Pro':'â‚¬'+upg.cost}</div></div><div class="upgrade-desc">${upg.desc}</div><div class="upgrade-effect">${upg.effect}</div>${!unlocked&&!upg.premium?`<div style="color:var(--danger);font-size:9px;margin-top:4px">ðŸ”’ Level ${upg.unlockLevel}</div>`:''}${!owned&&(unlocked||upg.premium)?`<button class="btn btn-${proLocked?'pro':'primary'} btn-sm btn-full" style="margin-top:6px" onclick="Shop.buy('${upg.id}')" ${!affordable&&!upg.premium?'disabled':''}>${proLocked?'âš¡ Unlock with Pro':'BUY'}</button>`:''}`;
        container.appendChild(card);
      });
    });
    // v8: Late-game upgrades section
    const v8Upgs = (CONFIG.UPGRADES_V8||[]).filter(u => !u.premium);
    if (v8Upgs.length > 0) {
      const header = document.createElement('div');
      header.className = 'upgrade-category';
      header.innerHTML = 'ðŸš€ Advanced Upgrades <span style="font-size:9px;color:var(--accent2)">(v8)</span>';
      container.appendChild(header);
      v8Upgs.forEach(upg=>{
        const owned=State.ownedUpgrades.includes(upg.id);
        const affordable=State.money>=upg.cost;
        const unlocked=State.bizLevel>=upg.unlockLevel;
        const tier = upg.cost >= 10000 ? 'tier4' : upg.cost >= 5000 ? 'tier3' : '';
        const card=document.createElement('div');
        card.className=`upgrade-card ${tier} ${owned?'owned':(affordable&&unlocked?'affordable':'')} ${!unlocked?'locked-upg':''}`;
        card.innerHTML=`<div class="upgrade-header"><div class="upgrade-name">${upg.name} ${owned?'âœ“':''}</div><div class="upgrade-cost">${owned?'Owned':'â‚¬'+upg.cost.toLocaleString()}</div></div><div class="upgrade-desc">${upg.desc}</div><div class="upgrade-effect">${upg.effect}</div>${!unlocked?`<div style="color:var(--danger);font-size:9px;margin-top:4px">ðŸ”’ Level ${upg.unlockLevel}</div>`:''}${!owned&&unlocked?`<button class="btn btn-primary btn-sm btn-full" style="margin-top:6px" onclick="Shop.buy('${upg.id}')" ${!affordable?'disabled':''}>BUY</button>`:''}`;
        container.appendChild(card);
      });
    }
  },
  renderBizLevel() {
    const lvls=CONFIG.BIZ_LEVELS;
    const cur=lvls[State.bizLevel-1]||lvls[lvls.length-1];
    const nxt=lvls[State.bizLevel]||null;
    const xpN=nxt?nxt.xp-cur.xp:1; const xpH=nxt?State.xp-cur.xp:xpN;
    const pct=Math.min(100,Math.round((xpH/xpN)*100));
    $el('biz-level-name').textContent=cur.name.toUpperCase();
    $el('biz-level-sub').textContent=`Level ${State.bizLevel} Â· ${r0(xpH)} / ${r0(xpN)} XP`;
    $el('biz-xp-fill').style.width=pct+'%';
  },
  renderAchievements() {
    const el = document.getElementById('achiev-list'); el.innerHTML='';
    CONFIG.ACHIEVEMENTS.forEach(a=>{
      const u=State.achievements.includes(a.id);
      const div=document.createElement('div');
      div.style.cssText=`padding:10px;background:var(--bg3);border:1px solid ${u?'var(--accent3)':'var(--border)'};border-radius:var(--radius);margin-bottom:8px;opacity:${u?1:0.45}`;
      div.innerHTML=`<div style="font-family:var(--display);font-weight:700;font-size:14px;color:${u?'var(--accent3)':'var(--text-dim)'}">${u?'ðŸ†':'ðŸ”’'} ${a.name}</div><div style="font-size:10px;color:var(--text-dim);margin-top:3px">${a.desc}</div>`;
      el.appendChild(div);
    });
  },
  renderStats() {
    const s=State.stats; const el = document.getElementById('stats-panel'); if(!el) return;
    const sessionMin=Math.round((Date.now()-s.sessionStart)/60000);
    const earningsPerMin=sessionMin>0?(s.totalEarned/sessionMin).toFixed(2):0;
    const successRate=s.totalPrints>0?Math.round((s.jobsDone/s.totalPrints)*100):0;
    el.innerHTML=[
      ['Jobs Done',    s.jobsDone,    `${s.jobsFailed} failed`],
      ['Total Earned', `â‚¬${s.totalEarned.toFixed(2)}`, `â‚¬${earningsPerMin}/min avg`],
      ['Success Rate', `${successRate}%`, `${s.totalPrints} total`],
      ['Best Streak',  s.longestStreak, `Current: ${s.currentStreak||0}`],
      ['Reputation',   r0(State.reputation), `${s.repEarned} earned`],
      ['Contracts',    s.contractsDone, `${s.dailyDone} dailies`],
      ['Upgrades',     s.upgradesBought, State.isPro?'PRO':'Free tier'],
      ['Session',      `${sessionMin}m`, 'since load'],
      ['PA6 Jobs',     s.pa6Done||0, 'engineering grade'],
      ['PETG Jobs',    s.petgDone||0, 'flexible jobs'],
      ['TPU Jobs',     s.tpuDone||0, 'flexible material'],
      ['Resin Jobs',   s.resinDone||0, 'SLA precision'],
      ['Night Shifts', s.nightShiftJobs||0, 'after 22:00'],
      ['Passive â‚¬',    `â‚¬${(s.passiveEarned||0).toFixed(0)}`, 'from store'],
      ['Chains Done',  s.chainsDone||0, 'production chains'],
    ].map(([k,v,sub])=>`<div class="stat-box"><div class="stat-box-label">${k}</div><div class="stat-box-value">${v}</div><div class="stat-box-sub">${sub||''}</div></div>`).join('');
  },

  // â”€â”€ CANVAS GRAPH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderGraphCanvas() {
    const canvas=$el('income-canvas'); if(!canvas) return;
    const data=State.incomeHistory;
    const W=canvas.offsetWidth||240; const H=120;
    canvas.width=W; canvas.height=H;
    const ctx=canvas.getContext('2d');
    ctx.clearRect(0,0,W,H);
    if (data.length<2) {
      ctx.fillStyle='rgba(90,100,128,0.4)'; ctx.font='11px monospace'; ctx.textAlign='center';
      ctx.fillText('Complete jobs to see income history',W/2,H/2); return;
    }
    const vals=data.map(d=>d.v);
    const max=Math.max(...vals)*1.2||1;
    const min=0;
    const pad={l:36,r:10,t:12,b:20};
    const cW=W-pad.l-pad.r; const cH=H-pad.t-pad.b;
    // Grid
    ctx.strokeStyle='rgba(42,48,69,0.6)'; ctx.lineWidth=1;
    [0,0.25,0.5,0.75,1].forEach(f=>{
      const y=pad.t+cH*(1-f);
      ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
      ctx.fillStyle='rgba(90,100,128,0.6)'; ctx.font='9px monospace'; ctx.textAlign='right';
      ctx.fillText('â‚¬'+r0(max*f),pad.l-4,y+3);
    });
    // Area fill
    const pts=data.map((d,i)=>({ x:pad.l+i*(cW/(data.length-1)), y:pad.t+cH*(1-(d.v-min)/(max-min)) }));
    const grad=ctx.createLinearGradient(0,pad.t,0,pad.t+cH);
    grad.addColorStop(0,'rgba(0,229,255,0.3)'); grad.addColorStop(1,'rgba(0,229,255,0)');
    ctx.beginPath(); ctx.moveTo(pts[0].x,pad.t+cH);
    pts.forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.lineTo(pts[pts.length-1].x,pad.t+cH); ctx.closePath();
    ctx.fillStyle=grad; ctx.fill();
    // Line
    ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
    pts.forEach(p=>ctx.lineTo(p.x,p.y));
    ctx.strokeStyle='var(--accent)'; ctx.lineWidth=2; ctx.stroke();
    // Dots â€” color by type
    const typeColor={job:'var(--accent)',passive:'var(--accent3)',contract:'var(--warn)'};
    data.forEach((d,i)=>{
      ctx.beginPath(); ctx.arc(pts[i].x,pts[i].y,3,0,Math.PI*2);
      ctx.fillStyle=typeColor[d.type]||'var(--accent)'; ctx.fill();
    });
    // Latest value
    const last=data[data.length-1];
    ctx.fillStyle='var(--text-bright)'; ctx.font='bold 10px monospace'; ctx.textAlign='left';
    ctx.fillText(fmtEur(last.v),pts[pts.length-1].x-20,pts[pts.length-1].y-8);
  },

  renderPieChart() {
    const canvas = $el('pie-canvas'); if (!canvas) return;
    const s = State.stats;
    const petg = s.petgDone || 0;
    const pa6  = s.pa6Done  || 0;
    const tpu  = s.tpuDone  || 0;
    const resin= s.resinDone|| 0;
    const cf   = s.cfDone   || 0;
    const glow = s.glowDone || 0;
    const pla  = Math.max(0, (s.jobsDone || 0) - petg - pa6 - tpu - resin - cf - glow);
    const total = pla + petg + pa6 + tpu + resin + cf + glow;
    const legend = $el('pie-legend');
    if (total === 0) {
      const ctx = canvas.getContext('2d');
      canvas.width = 120; canvas.height = 120;
      ctx.clearRect(0,0,120,120);
      ctx.fillStyle = 'rgba(90,100,128,0.3)'; ctx.beginPath(); ctx.arc(60,60,54,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = 'rgba(90,100,128,0.6)'; ctx.font = '10px monospace'; ctx.textAlign = 'center'; ctx.fillText('No data yet', 60, 64);
      if (legend) legend.innerHTML = '';
      return;
    }
    const slices = [
      { label: 'PLA',   value: pla,   color: '#4fc3f7' },
      { label: 'PETG',  value: petg,  color: '#ce93d8' },
      { label: 'PA6',   value: pa6,   color: '#ffab40' },
      { label: 'TPU',   value: tpu,   color: '#ff9f43' },
      { label: 'Resin', value: resin, color: '#ee5a24' },
      { label: 'CF',    value: cf,    color: '#8888aa' },
      { label: 'Glow',  value: glow,  color: '#ccff00' },
    ].filter(s => s.value > 0);
    const ctx = canvas.getContext('2d');
    canvas.width = 120; canvas.height = 120;
    ctx.clearRect(0,0,120,120);
    let angle = -Math.PI / 2;
    slices.forEach(slice => {
      const sweep = (slice.value / total) * Math.PI * 2;
      ctx.beginPath(); ctx.moveTo(60,60);
      ctx.arc(60,60,54,angle,angle+sweep);
      ctx.closePath(); ctx.fillStyle = slice.color; ctx.fill();
      ctx.strokeStyle = '#0d0f14'; ctx.lineWidth = 2; ctx.stroke();
      angle += sweep;
    });
    ctx.beginPath(); ctx.arc(60,60,28,0,Math.PI*2);
    ctx.fillStyle = '#161b26'; ctx.fill();
    ctx.fillStyle = '#d4dae8'; ctx.font = 'bold 11px monospace'; ctx.textAlign = 'center';
    ctx.fillText(total, 60, 64);
    if (legend) {
      legend.innerHTML = slices.map(s =>
        `<div class="pie-legend-item"><div class="pie-dot" style="background:${s.color}"></div>${s.label} ${Math.round(s.value/total*100)}%</div>`
      ).join('');
    }
  },

  // â”€â”€ FAILURE + SUCCESS ANIMATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  showFailureAnimation(printerIdx, reason, jobName) {
    const flash=$el('fail-flash');
    flash.classList.remove('flashing'); void flash.offsetWidth; flash.classList.add('flashing');
    setTimeout(()=>flash.classList.remove('flashing'),800);
    const cards=document.querySelectorAll('.printer-card');
    if (cards[printerIdx]) { cards[printerIdx].classList.remove('shaking'); void cards[printerIdx].offsetWidth; cards[printerIdx].classList.add('shaking'); setTimeout(()=>cards[printerIdx].classList.remove('shaking'),600); }
    if (State.viewingPrinterIdx===printerIdx) this._spaghettiOverlay(reason,jobName);
  },
  _spaghettiOverlay(reason, jobName) {
    const visual=$el('printer-visual'); if(!visual) return;
    const old=visual.querySelector('.spaghetti-overlay'); if(old) old.remove();
    const ov=document.createElement('div'); ov.className='spaghetti-overlay';
    const canvas=document.createElement('canvas'); canvas.style.cssText='position:absolute;inset:0;width:100%;height:100%;opacity:0.5;';
    ov.appendChild(canvas);
    ov.innerHTML+=`<div style="font-size:32px;z-index:1;position:relative;">ðŸ</div><div class="spaghetti-text">PRINT FAILED</div><div class="spaghetti-sub">${reason.toUpperCase()}</div><button class="btn btn-ghost btn-sm" style="margin-top:10px;z-index:1;position:relative;" onclick="this.closest('.spaghetti-overlay').remove()">Dismiss</button>`;
    visual.appendChild(ov);
    requestAnimationFrame(()=>{
      const rect=visual.getBoundingClientRect(); const W=rect.width||300; const H=rect.height||160;
      canvas.width=W; canvas.height=H;
      const c=canvas.getContext('2d');
      ['#ff3d5a','#ff6b35','#ffcc00','#ce93d8','#ff3d5a'].forEach(color=>{
        for (let s=0;s<4;s++) {
          c.beginPath(); c.strokeStyle=color; c.lineWidth=1.5+Math.random()*2; c.globalAlpha=0.4+Math.random()*0.4;
          let x=Math.random()*W; let y=Math.random()*H; c.moveTo(x,y);
          for(let j=0;j<10;j++){x+=(Math.random()-0.5)*60;y+=(Math.random()-0.5)*30;c.bezierCurveTo(x+(Math.random()-.5)*40,y+(Math.random()-.5)*20,x+(Math.random()-.5)*40,y+(Math.random()-.5)*20,x,y);}
          c.stroke();
        }
      });
    });
    setTimeout(()=>ov.remove(),7000);
  },
  showSuccessAnimation() {
    const v=$el('printer-visual'); if(!v) return;
    v.classList.remove('success-pulse'); void v.offsetWidth; v.classList.add('success-pulse');
    setTimeout(()=>v.classList.remove('success-pulse'),900);
  },

  showPopup(title, body, okCb, cancelCb) {
    $el('popup-title').textContent=title;
    $el('popup-body').innerHTML=body;
    $el('popup-box').className='popup';
    const ok=$el('popup-ok'); const can=$el('popup-cancel');
    can.style.display=cancelCb?'block':'none';
    ok.onclick=()=>{ closePopup(); if(okCb) okCb(); };
    can.onclick=()=>{ closePopup(); if(cancelCb) cancelCb(); };
    $el('popup-overlay').classList.add('visible');
  },

  showContractToast(c) {
    const el=document.createElement('div'); el.className='contract-toast';
    el.innerHTML=`<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--warn);margin-bottom:4px">ðŸŽ¯ Contract Complete!</div><div style="font-family:var(--display);font-weight:700;font-size:15px;color:var(--text-bright)">${c.name}</div><div style="font-size:10px;color:var(--text-dim);margin-top:2px">+â‚¬${c.reward} Â· +${c.bonusRep} Rep</div>`;
    document.body.appendChild(el); setTimeout(()=>el.remove(),5000);
  },

  renderAll() {
    this.updateTopBar(); this.renderPrinters(); this.renderOrders(); this.renderContracts();
    this.renderCenterPanel(); this.renderShop(); this.renderBizLevel();
    this.renderAchievements(); this.renderStats(); this.renderGraphCanvas();
    this.updateBgLevel();
  },

  renamePrinter(idx) {
    const p = State.printers[idx];
    if (!p) return;
    const newName = prompt(`Nieuwe naam voor ${p.name}:`, p.name);
    if (newName && newName.trim()) {
      p.name = newName.trim().slice(0, 20);
      this.renderPrinters();
      UI.log(`Printer hernoemd naar "${p.name}"`, 'info');
    }
  },

  updateBgLevel() {
    const body = document.body;
    body.classList.remove('level-5','level-6','level-7','level-8');
    if (State.bizLevel >= 8) body.classList.add('level-8');
    else if (State.bizLevel >= 7) body.classList.add('level-7');
    else if (State.bizLevel >= 6) body.classList.add('level-6');
    else if (State.bizLevel >= 5) body.classList.add('level-5');
  },

  renderAchievements() {
    const el = document.getElementById('achiev-list'); el.innerHTML='';
    CONFIG.ACHIEVEMENTS.forEach(a=>{
      const u=State.achievements.includes(a.id);
      // Calculate progress for numeric achievements
      let progress = null;
      const checkSrc = a.check.toString();
      const numMatch = checkSrc.match(/>=(\d+)/);
      if (numMatch && !u) {
        const target = parseInt(numMatch[1]);
        let cur = 0;
        try { cur = a.check({...State, stats:{...State.stats}, reputation:State.reputation, printerCount:State.printerCount, ownedUpgrades:State.ownedUpgrades, prestige:State.prestige}, null) ? target : (
          // Try to extract current value from state for common patterns
          checkSrc.includes('jobsDone')        ? State.stats.jobsDone        :
          checkSrc.includes('totalEarned')     ? State.stats.totalEarned     :
          checkSrc.includes('reputation')      ? State.reputation            :
          checkSrc.includes('contractsDone')   ? State.stats.contractsDone   :
          checkSrc.includes('longestStreak')   ? State.stats.longestStreak   :
          checkSrc.includes('pa6Done')         ? State.stats.pa6Done         :
          checkSrc.includes('petgDone')        ? State.stats.petgDone        :
          checkSrc.includes('printerCount')    ? State.printerCount          :
          checkSrc.includes('upgradesBought')  ? State.stats.upgradesBought  :
          checkSrc.includes('maxCombo')        ? State.stats.maxCombo        :
          checkSrc.includes('prestige')        ? State.prestige              :
          checkSrc.includes('passiveEarned')   ? State.stats.passiveEarned   : 0
        ); } catch(e) { cur = 0; }
        if (typeof cur === 'boolean') cur = cur ? target : 0;
        progress = { cur: Math.min(cur, target), max: target };
      }

      const card = document.createElement('div');
      card.className = `achiev-card ${u ? 'unlocked' : 'locked'}`;
      const pctBar = progress ? `<div class="achiev-prog-bar"><div class="achiev-prog-fill" style="width:${Math.round(progress.cur/progress.max*100)}%"></div></div><div class="achiev-prog-text">${r0(progress.cur).toLocaleString()} / ${progress.max.toLocaleString()}</div>` : '';
      card.innerHTML = `<div class="achiev-header"><div class="achiev-icon">${u?'ðŸ†':'ðŸ”’'}</div><div class="achiev-title-text" style="color:${u?'var(--accent3)':'var(--text-dim)'}">${a.name}</div></div><div class="achiev-desc">${a.desc}</div>${!u && progress ? pctBar : ''}`;
      el.appendChild(card);
    });
  },
};

// â”€â”€ GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Game = {
  tickCount: 0,
  lastTick:  Date.now(),
  _eventCountdown: 60,
  _tickTimer: null,
  _eventTimer: null,

  init() {
    this.loadGame();
    Contracts.refresh();
    if (State.orders.length===0) this._spawnOrder();
    Market.renderTicker(null);
    UI.renderAll();
    UI.log(`Welkom bij Print & Profit v${APP_VERSION}.0! Accepteer een bestelling of contract om te beginnen.`,'info');
    clearInterval(this._tickTimer);
    clearInterval(this._eventTimer);
    this._tickTimer  = setInterval(()=>this.tick(), CONFIG.TICK_MS);
    this._eventTimer = setInterval(()=>this._maybeEvent(), 1000);
    this._eventCountdown=45+Math.random()*45;

    // Night badge
    const hr = new Date().getHours();
    if (hr >= 22 || hr < 4) $el('night-badge').classList.add('active');

    // Load skin preference
    Skins.load();

    // v5: Init all new systems
    Season.check();
    DailyGoals.refresh();
    DailyGoals.render();

    // v6: Init new systems
    Chains.init();
    NewsTicker.init();
    Queue.render();
    Employees.render();
    Chains.render();
    Chains.updateTokenDisplay();
    Prestige.render();

    // v7: Init new systems
    Suppliers.init();
    Suppliers.updateStockUI();
    Challenges.init();
    Challenges.render();

    // v8: Init new systems
    if (!State.activeBounties || State.activeBounties.length === 0) BountyBoard.init();
    else BountyBoard.render();
    if (!State.researchFlags) State.researchFlags = {};
    if (!State.stats_v8) State.stats_v8 = { vipDone:0, rushDone:0, bulkDone:0, mysteryDone:0, legendaryDone:0, bountiesClaimed:0, milestonesHit:0, researchCompleted:0, equipmentEventsFixed:0, sessEarnedPerMin:0 };
    Research.render();
    EquipmentEvents.render();
    Dashboard.render();
    Milestones.check();

    // Prestige badge
    if (State.prestige > 0) {
      const pill = $el('prestige-pill');
      const val  = $el('prestige-val');
      if (pill) pill.classList.add('active');
      if (val)  val.textContent = `P${State.prestige}`;
    }

    // Update dynamic background
    UI.updateBgLevel();

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT') return;
      switch(e.key) {
        case ' ':
          e.preventDefault();
          if (State.pendingOrder) Game.startJob();
          Tutorial.showKbdHint();
          break;
        case '1': case '2': case '3':
          const idx = parseInt(e.key) - 1;
          if (State.printers[idx] && !State.printers[idx].active) {
            State.selectedPrinterIdx = idx;
            UI.renderCenterPanel();
            Tutorial.showKbdHint();
          }
          break;
        case 'q': case 'Q':
          State.selectedFilament = 'PLA';
          UI.renderCenterPanel();
          Tutorial.showKbdHint();
          break;
        case 'w': case 'W':
          if (State.reputation >= CONFIG.FILAMENTS.PETG.unlockRep) {
            State.selectedFilament = 'PETG';
            UI.renderCenterPanel();
            Tutorial.showKbdHint();
          }
          break;
        case 'e': case 'E':
          if (State.reputation >= CONFIG.FILAMENTS.PA6.unlockRep) {
            State.selectedFilament = 'PA6';
            UI.renderCenterPanel();
            Tutorial.showKbdHint();
          }
          break;
        case 'r': case 'R':
          const activePrinter = State.printers[State.viewingPrinterIdx];
          if (activePrinter && activePrinter.health < 100) {
            Game.repairPrinter(State.viewingPrinterIdx);
            Tutorial.showKbdHint();
          }
          break;
        case '?':
          Tutorial.toggleKbd();
          break;
      }
    });

    // v9: Init new systems
    if (!State.activeLoans) State.activeLoans = [];
    if (!State.totalDebt) State.totalDebt = 0;
    if (!State.activeSurge) State.activeSurge = null;
    if (!State.rivalScore) State.rivalScore = 0;
    setTimeout(() => {
      if (State.bizLevel >= 3) Rival.init();
    }, 8000); // Rival appears after 8s so player can settle in
    Loans.render();

    // v10: Init new systems
    if (!State.stats_v10) State.stats_v10 = { taxPaid:0, complaintsReceived:0, complaintsRefunded:0, scrapsRecycled:0, franchiseEarned:0, subscriptionJobsDone:0, insurancePayouts:0 };
    if (!State.legacyPerks) State.legacyPerks = [];
    if (!State.franchiseBranches) State.franchiseBranches = [];
    if (!State.clientTiers) State.clientTiers = {};
    if (!State.subscriptionClients) State.subscriptionClients = [];
    if (State.scrap === undefined) State.scrap = 0;
    if (State.taxAccum === undefined) State.taxAccum = 0;
    if (State.taxRate === undefined) State.taxRate = 0.15;
    if (State.taxTimer === undefined) State.taxTimer = 180;
    if (State.morale === undefined) State.morale = {};
    if (State.pendingComplaint === undefined) State.pendingComplaint = null;
    // Re-apply legacy perks if loaded from save
    if (State.legacyPerks.length > 0) LegacyPerks.reapply();
    Recycling._updatePill();
    LegacyPerks.render();
    HallOfFame.render();
    Franchise.render();
    Subscriptions.render();

    // v11: Init new systems
    if (!State.inventory) State.inventory = { keychains: 0, planters: 0 };
    if (!State.activeTrend) State.activeTrend = null;
    if (!State.trendTimer) State.trendTimer = 0;
    if (!State.trendCountdown) State.trendCountdown = 120;
    if (!State.cfUnlocked) State.cfUnlocked = false;
    if (!State.glowUnlocked) State.glowUnlocked = false;
    if (!State.cfNozzle) State.cfNozzle = false;
    // Ensure all printers have model field
    State.printers.forEach(p => { if (!p.model) p.model = 'BASIC'; });
    Inventory.render();
    Suppliers.updateStockUI();

    UI.log(`Welkom bij Print & Profit v${APP_VERSION}.0! New: Night Bonus, Research Effects, AI Factory, Delta Printer, More Trending & Events!`, 'info');

    // Tutorial: show on first visit
    setTimeout(() => Tutorial.start(), 800);
  },

  tick() {
    const now = Date.now();
    const dt  = (now - this.lastTick) / 1000;
    this.lastTick = now;
    this.tickCount++;

    const anyActive = this._tickPrinters(dt);
    this._tickOrders(dt);
    this._tickPassiveIncome(dt);
    this._tickLiveProgress(anyActive);
    this._tickPeriodicSystems(dt);
  },

  _tickPrinters(dt) {
    let anyActive = false;
    State.printers.forEach(p => {
      if (p.active) { anyActive = true; Printer.tick(p, dt); }
    });
    return anyActive;
  },

  _tickOrders(dt) {
    // Spawn new orders
    State.nextOrderIn -= dt;
    if (State.nextOrderIn <= 0 && State.orders.length < CONFIG.MAX_ORDERS) {
      this._spawnOrder();
      const _seasonDelay = Season.current?.orderDelay || 1;
    State.nextOrderIn = (CONFIG.ORDER_MIN_SEC + Math.random() * (CONFIG.ORDER_MAX_SEC - CONFIG.ORDER_MIN_SEC)) * _seasonDelay;
    }
    // Refresh contracts
    State.nextContractIn -= dt;
    if (State.nextContractIn <= 0) {
      Contracts.refresh();
      State.nextContractIn = CONFIG.CONTRACT_REFRESH_S;
      UI.renderContracts();
    }
    // Expire orders
    State.orders.forEach(o => { o.timeLeft -= dt; });
    const prevLen = State.orders.length;
    State.orders = State.orders.filter(o => {
      if (o.timeLeft <= 0) {
        State.reputation = Math.max(0, State.reputation + CONFIG.REP_PER_EXPIRED);
        UI.log(`Order expired: ${o.name}`, 'warn');
        return false;
      }
      return true;
    });
    if (State.orders.length !== prevLen) UI.renderOrders();
    // Contract timers
    State.contracts.forEach(c => { if (!c.completed) c.timeLeft -= dt; });
  },

  _tickPassiveIncome(dt) {
    if (State.passivePerMin <= 0) return;
    State.passiveTick += dt;
    if (State.passiveTick < 60) return;
    const earned = State.passivePerMin;
    State.money             = r2(State.money + earned);
    State.stats.totalEarned = r2(State.stats.totalEarned + earned);
    State.stats.passiveEarned = (State.stats.passiveEarned||0) + earned;
    State.passiveTick -= 60;
    State.incomeHistory.push({ t: Date.now(), v: earned, type: 'passive' });
    if (State.incomeHistory.length > CONFIG.INCOME_HISTORY_MAX) State.incomeHistory.shift();
    UI.floatMoney(`+â‚¬${earned} (passive)`);
    UI.log(`Passive income: +â‚¬${earned}`, 'money');
    UI.renderGraphCanvas();
  },

  _tickLiveProgress(anyActive) {
    if (!anyActive || State.pendingOrder) return;
    const viewed = State.printers[State.viewingPrinterIdx];
    if (viewed?.active && viewed.job) {
      const pct  = r0(viewed.progress * 100);
      const fill = $el('big-prog-fill'); if (fill) fill.style.width = pct + '%';
      const text = $el('big-prog-text'); if (text) text.textContent = `${pct}% â€” ${Math.max(0, r0(viewed.timeLeft))}s remaining`;
      const head = $el('print-head');
      if (head) {
        const s = Math.sin(Date.now() / 300);
        head.style.left = (20 + s * 35) + '%';
        const nd = $el('nozzle-dot');
        if (nd) { nd.style.left = (20 + s * 35 + 16) + '%'; nd.style.display = 'block'; }
      }
      const ts = $el('jstat-time'); if (ts) ts.textContent = `${Math.max(0, r0(viewed.timeLeft))}s`;
    }
    UI.renderPrinters();
  },

  _tickPeriodicSystems(dt) {
    const tc = this.tickCount;
    if (tc % 2   === 0) { UI.renderOrders(); UI.updateTopBar(); }
    if (tc % 10  === 0)   UI.renderContracts();
    if (tc % 40  === 0)   SmartTips.check(State);
    if (tc % 60  === 0) { DailyGoals.refresh(); DailyGoals.render(); Suppliers.autoAI(); }
    if (tc % 120 === 0)   this.saveGame();
    if (tc % 360 === 0)   Suppliers.fluctuate();

    // Market
    State.marketTimer -= dt;
    if (State.marketTimer <= 0) { Market.update(); State.marketTimer = 120; }

    // Sub-systems
    Combo.tick(dt);
    Temperature.tick(dt);
    Employees.tick(dt);
    Employees.tickSalesBonus(dt);
    MarketCrisis.tick(dt);
    Endgame.check();

    // v8 sub-systems
    Research.tick(dt);
    EquipmentEvents.tick(dt);
    BountyBoard.tick(dt);
    Milestones.check();
    if (this.tickCount % 20 === 0) { BountyBoard.render(); Research.render(); EquipmentEvents.render(); Dashboard.render(); }

    // v9 sub-systems
    Rival.tick(dt);
    DemandSurge.tick(dt);
    Loans.tick(dt);
    PowerOutage.tick(dt);

    // v10 sub-systems
    TaxSystem.tick(dt);
    Morale.tick(dt);
    Franchise.tick(dt);
    Subscriptions.tick(dt);
    Insurance.tick(dt);

    // v11 sub-systems
    Trending.tick(dt);
    FlashOrders.tick(dt);
    // Refresh franchise payout bars every few seconds
    if (!this._franchiseRenderTimer) this._franchiseRenderTimer = 0;
    this._franchiseRenderTimer += dt;
    if (this._franchiseRenderTimer >= 3) { this._franchiseRenderTimer = 0; Franchise.render(); }

    // Research: AI Print Factory â€” auto-completes the best pending order every 90s for free
    if (State.researchFlags?.aiFactory && State.orders.length > 0) {
      if (!State.aiFactoryTimer) State.aiFactoryTimer = 90;
      State.aiFactoryTimer -= dt;
      if (State.aiFactoryTimer <= 0) {
        State.aiFactoryTimer = 90;
        const bestOrder = [...State.orders].sort((a, b) => b.reward - a.reward)[0];
        if (bestOrder) {
          State.orders = State.orders.filter(o => o.id !== bestOrder.id);
          const profit = r2(bestOrder.reward * 0.8);
          State.money = r2(State.money + profit);
          State.stats.totalEarned = r2(State.stats.totalEarned + profit);
          State.stats.jobsDone++;
          State.xp += 5;
          UI.log(`ðŸ­ AI Factory auto-printed ${bestOrder.name} â€” +â‚¬${profit}`, 'success');
          UI.updateTopBar();
        }
      }
    }

    // Refresh night badge every minute
    if (tc % 60 === 0) {
      const hr = new Date().getHours();
      const nb = document.getElementById('night-badge');
      if (nb) nb.classList.toggle('active', hr >= 22 || hr < 4);
    }

    if (State.hiredEmployees.includes('student') || State.hiredEmployees.includes('manager')) {
      Queue.tryAutoStart();
    }
  },

  _spawnOrder() {
    const o=Orders.generate(); State.orders.push(o);
    UI.log(`New order: ${o.name} (${o.filament}) â€” â‚¬${o.reward.toFixed(2)}`,'info');
    UI.renderOrders();
  },

  selectOrder(order) {
    const freeIdx=State.printers.findIndex(p=>!p.active);
    if (freeIdx<0) { UI.showPopup('No Free Printer','All printers busy. Wait for a job to finish.'); return; }
    State.pendingOrder=order; State.selectedPrinterIdx=freeIdx;
    if (State.reputation>=CONFIG.FILAMENTS[order.filament].unlockRep) State.selectedFilament=order.filament;
    else State.selectedFilament='PLA';
    Sound.click();
    // Switch to orders tab
    switchPTab('orders');
    // Show customer quote
    CustomerLoyalty.showQuote(order);
    UI.renderCenterPanel(); UI.renderOrders();
  },

  startJob() {
    const order=State.pendingOrder; const printer=State.printers[State.selectedPrinterIdx];
    if (!order||!printer||printer.active) return;
    if (printer.health<10) { UI.showPopup('Printer Broken',`${printer.name} health is critical! Repair first.`); return; }
    State.orders=State.orders.filter(o=>o.id!==order.id);
    Printer.startJob(State.selectedPrinterIdx, order, State.selectedFilament, State.selectedQuality);
    State.pendingOrder=null; State.viewingPrinterIdx=State.selectedPrinterIdx;
    Sound.click();
    UI.log(`Started: ${order.name} on ${printer.name} [${State.selectedFilament}/${State.selectedQuality}]`,'info');
    UI.renderCenterPanel(); UI.renderPrinters(); UI.renderOrders(); Achievements.check();
  },

  // Auto-start for Smart Queue
  _autoStartJob(printerIdx, order) {
    const printer=State.printers[printerIdx]; if(!printer||printer.active) return;
    State.orders=State.orders.filter(o=>o.id!==order.id);
    const filament=State.reputation>=CONFIG.FILAMENTS[order.filament].unlockRep?order.filament:'PLA';
    Printer.startJob(printerIdx, order, filament, 'NORMAL');
    UI.log(`ðŸ¤– Smart Queue: Auto-started ${order.name} on ${printer.name}`,'info');
    UI.renderCenterPanel(); UI.renderPrinters(); UI.renderOrders();
  },

  cancelJob() {
    const printer=State.printers[State.viewingPrinterIdx]; if(!printer||!printer.active) return;
    const jn=printer.job?printer.job.name:'Job';
    Sound.stopHum(printer.id);
    printer.active=false; printer.job=null; printer.progress=0; printer.timeLeft=0;
    printer.health=Math.max(0,printer.health-5);
    const other=State.printers.find(p=>p.id!==State.viewingPrinterIdx&&p.active);
    State.viewingPrinterIdx=other?other.id:0;
    UI.log(`Cancelled: ${jn} (âˆ’5 health)`,'warn');
    UI.renderCenterPanel(); UI.renderPrinters();
  },

  repairPrinter(idx) {
    const p=State.printers[idx];
    const seasonDiscount = Season.current?.repairDiscount || 1;
    const cost=r2(Math.round((100-p.health)*CONFIG.REPAIR_COST_PER_HP*100)/100 * seasonDiscount);
    if (State.money<cost) { UI.showPopup('Not Enough Money',`Repair costs â‚¬${cost.toFixed(2)}.`); return; }
    State.money=r2(State.money-cost); p.health=100;
    Sound.click();
    const discountNote = seasonDiscount < 1 ? ` ðŸŒ± (${Math.round((1-seasonDiscount)*100)}% seizoenskorting)` : '';
    UI.log(`${p.name} repaired for â‚¬${cost.toFixed(2)}${discountNote}`,'info');
    UI.renderPrinters(); UI.updateTopBar();
  },

  checkBizLevel() {
    const lvls=CONFIG.BIZ_LEVELS;
    for (let i=lvls.length-1;i>=0;i--) {
      if (State.xp>=lvls[i].xp) {
        if (State.bizLevel<lvls[i].level) {
          State.bizLevel=lvls[i].level;
          Sound.levelUp();
          Confetti.levelUp();
          UI.log(`ðŸŽ‰ Level up! ${lvls[i].name}`,'success');
          NewsTicker.addItem(`ðŸŽ‰ LEVEL UP! Je bedrijf is nu: ${lvls[i].name} (Level ${lvls[i].level})`);
          Rival.resetForNextLevel();
          UI.showPopup(`Level Up! ðŸŽ‰`,`<strong style="font-size:18px;font-family:var(--display);color:var(--accent)">${lvls[i].name}</strong><br><br>Je bedrijf is nu Level ${lvls[i].level}. Nieuwe upgrades beschikbaar!`);
          UI.renderShop();
          Employees.render();
          UI.updateBgLevel();
        }
        break;
      }
    }
    UI.renderBizLevel();
  },

  showProModal() {
    if (State.isPro) { UI.showPopup('âš¡ Pro Active','You already have Pro! Enjoy Smart Queue and AI Quality Control.'); return; }
    const box=$el('popup-box'); box.className='popup pro-modal';
    $el('popup-title').innerHTML='âš¡ Print & Profit Pro';
    $el('popup-body').innerHTML=`
      <div style="color:var(--text-dim);font-size:11px;margin-bottom:8px">Unlock professional tools for your print farm:</div>
      <ul class="pro-features">
        <li>Smart Queue â€” auto-assign orders to free printers</li>
        <li>AI Quality Control â€” catch failures mid-print</li>
        <li>All future Pro upgrades included</li>
        <li>Support indie development â¤ï¸</li>
      </ul>
      <div class="pro-price">â‚¬4.99</div>
      <div class="pro-price-sub">One-time Â· No subscription Â· Instant unlock</div>
    `;
    $el('popup-cancel').style.display='block';
    $el('popup-ok').textContent='âš¡ Unlock Pro';
    $el('popup-ok').className='btn-pro';
    $el('popup-ok').style.padding='10px 20px';
    $el('popup-ok').onclick=()=>{ this.unlockPro(); closePopup(); };
    $el('popup-cancel').onclick=()=>{ $el('popup-ok').textContent='OK'; $el('popup-ok').className='btn btn-primary'; $el('popup-ok').onclick=()=>closePopup(); closePopup(); };
    $el('popup-overlay').classList.add('visible');
  },

  unlockPro() {
    // â”€â”€ PAYMENT HOOK â”€â”€
    // Replace this block with your real payment integration:
    // e.g. Stripe, Lemon Squeezy, Paddle, or itch.io IAP
    // On success, call: State.isPro = true; this._onProUnlocked();
    //
    // For demo / itch.io free version: uncomment the line below:
    State.isPro = true;
    this._onProUnlocked();
  },

  _onProUnlocked() {
    // Auto-apply Pro upgrades
    CONFIG.UPGRADES.filter(u=>u.premium).forEach(u=>{
      if (!State.ownedUpgrades.includes(u.id)) {
        State.ownedUpgrades.push(u.id);
        u.apply(State);
      }
    });
    Sound.levelUp();
    UI.log('âš¡ Pro unlocked! Smart Queue and AI QC activated.','success');
    UI.updateTopBar(); UI.renderShop();
    this.saveGame();
  },

  _maybeEvent() {
    this._eventCountdown-=1;
    if (this._eventCountdown<=0) {
      if (Math.random()<0.6) {
        const evt=CONFIG.EVENTS[Math.floor(Math.random()*CONFIG.EVENTS.length)];
        this._applyEvent(evt);
      }
      this._eventCountdown=45+Math.random()*45;
    }
  },
  _applyEvent(evt) {
    switch(evt.effect) {
      case 'bulkBonus':    State.bulkBonusJobs=evt.value; break;
      case 'nextFailBoost':State.nextFailBoost=evt.value; break;
      case 'repBoost':     State.reputation=Math.min(CONFIG.MAX_REP,State.reputation+evt.value); break;
      case 'filDiscount':  State.filDiscountJobs=evt.value; break;
      case 'hpLoss':       State.printers.forEach(p=>{p.health=Math.max(0,p.health-evt.value);}); break;
      case 'hpHeal':       if(State.printers[0]) State.printers[0].health=Math.min(100,State.printers[0].health+evt.value); break;
    }
    UI.showPopup(evt.title, evt.body);
    UI.log(`Event: ${evt.title}`,'warn');
    UI.updateTopBar(); UI.renderPrinters();
  },

  saveGame(manual=false) {
    const d={
      money:State.money, reputation:State.reputation, xp:State.xp, bizLevel:State.bizLevel,
      isPro:State.isPro, printerCount:State.printerCount, speedMult:State.speedMult,
      failBonus:State.failBonus, abrasiveBonus:State.abrasiveBonus, dryerBonus:State.dryerBonus,
      rewardMult:State.rewardMult, passivePerMin:State.passivePerMin,
      smartQueue:State.smartQueue, aiQuality:State.aiQuality, packagingBonus:State.packagingBonus,
      market:State.market, customers:State.customers, activeSkin:State.activeSkin,
      tokens:State.tokens||0, hiredEmployees:State.hiredEmployees||[],
      activeChains:State.activeChains||[], printerTemps:State.printerTemps||{},
      printerSpecs:State.printerSpecs||{}, prestige:State.prestige||0,
      prestigeBonus:State.prestigeBonus||0, _printGodActive:State._printGodActive||false,
      ownedUpgrades:State.ownedUpgrades, achievements:State.achievements, stats:State.stats,
      incomeHistory:State.incomeHistory.slice(-CONFIG.INCOME_HISTORY_MAX),
      printers:State.printers.map(p=>({...p,active:false,job:null,progress:0,timeLeft:0})),
      dailyContractDoneAt:State.dailyContractDoneAt,
      // v7 new fields
      filamentStock: State.filamentStock || {},
      supplierRelations: State.supplierRelations || {},
      supplierOrderCount: State.supplierOrderCount || {},
      activeCrisis: null, // don't persist crisis state
      activeChallenges: State.activeChallenges || [],
      challengeSessionData: State.challengeSessionData || {},
      tpuUnlocked: State.tpuUnlocked || false,
      resinUnlocked: State.resinUnlocked || false,
      flexBed: State.flexBed || false,
      uvCuring: State.uvCuring || false,
      bulkDealActive: State.bulkDealActive || false,
      supplierAI: State.supplierAI || false,
      // v12 fix: persist research state so upgrades survive reload
      completedResearch: State.completedResearch || [],
      researchFlags: State.researchFlags || {},
      activeResearch: State.activeResearch || null,
      cfNozzle: State.cfNozzle || false,
      cfUnlocked: State.cfUnlocked || false,
      glowUnlocked: State.glowUnlocked || false,
      repLegacyBonus: State.repLegacyBonus || 0,
      aiFactoryTimer: State.aiFactoryTimer || 90,
      version:APP_VERSION,
    };
    localStorage.setItem('pnp_save',JSON.stringify(d));
    // Show save indicator
    const ind = $el('save-indicator');
    if (ind) {
      ind.classList.add('visible','saving');
      setTimeout(() => { ind.classList.remove('saving'); setTimeout(() => ind.classList.remove('visible'), 600); }, 1200);
    }
    if (manual) UI.log('Game saved.','info');
  },

  exportSave() {
    const raw = localStorage.getItem('pnp_save');
    if (!raw) { UI.showPopup('Nothing to Export','Save your game first!'); return; }
    const blob = new Blob([raw], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'print-profit-save.json';
    a.click(); URL.revokeObjectURL(url);
    UI.log('Save exported as JSON.','info');
  },

  importSave(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const d = JSON.parse(e.target.result);

        // Minimal validation to prevent broken saves
        if (!d || typeof d !== 'object') throw new Error('not an object');
        if (typeof d.money !== 'number') throw new Error('missing money');
        if (!Array.isArray(d.printers)) throw new Error('missing printers');

        localStorage.setItem('pnp_save', JSON.stringify(d));
        UI.showPopup('Import Successful','Save loaded! Reloading gameâ€¦');
        setTimeout(() => location.reload(), 1500);
      } catch(err) {
        UI.showPopup('Import Failed', 'Invalid or incompatible save file.');
      }
    };
    reader.readAsText(file);
  },
  loadGame() {
    const raw=localStorage.getItem('pnp_save'); if(!raw) return;
    try {
      const d=JSON.parse(raw);
      // Load top-level fields (skip stats â€” handled separately below)
      Object.keys(d).forEach(k=>{
        if (k!=='version' && k!=='stats' && k in State) State[k]=d[k]??State[k];
      });
      // Merge stats: start from defaults so new fields always exist
      if (d.stats) {
        State.stats = { ...State.stats, ...d.stats };
      }
      // filamentsUsed must always be a plain array (Sets don't serialize)
      if (!Array.isArray(State.stats.filamentsUsed)) {
        State.stats.filamentsUsed = [];
      }
      // Guard all v7 fields that may be missing from old saves
      if (!State.filamentStock)     State.filamentStock     = { PLA:100, PETG:80, PA6:50, TPU:0, RESIN:0 };
      if (!State.supplierRelations)  State.supplierRelations  = {};
      if (!State.supplierOrderCount) State.supplierOrderCount = {};
      if (!State.activeChallenges)   State.activeChallenges   = [];
      if (!State.challengeSessionData) State.challengeSessionData = {};
      // Guard printers array
      State.printers = d.printers ?? State.printers;
      State.market   = d.market   || State.market;
      State.customers= d.customers|| State.customers;
      if (State.passivePerMin>0) $el('passive-pill').style.display='flex';
      if (State.isPro) { $el('pro-btn').textContent='âš¡ Pro Active'; $el('pro-btn').classList.add('owned'); }
      // Guard research state (v12 fix)
      if (!State.researchFlags)    State.researchFlags    = {};
      if (!State.completedResearch) State.completedResearch = [];
      // If save pre-dates v12, re-apply research flags from completedResearch list
      if (d.completedResearch) {
        State.completedResearch = d.completedResearch;
        // Restore research flags if not already saved (backwards compat)
        if (!d.researchFlags || Object.keys(d.researchFlags).length === 0) {
          State.completedResearch.forEach(id => {
            const r = (CONFIG.RESEARCH||[]).find(u => u.id === id);
            if (r && typeof r.apply === 'function') { try { r.apply(State); } catch(e) {} }
          });
        }
      }
      UI.log('Save loaded.','info');
    } catch(e){ UI.log('Could not load save.','error'); }
  },
  resetGame() {
    if (!confirm('Reset all progress? Cannot be undone.')) return;
    localStorage.removeItem('pnp_save'); location.reload();
  },
};

// â”€â”€ TAB SWITCHERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id) {
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  const order=['shop','stats','achiev','doelen','personeel','ketens','suppliers','klanten','challenges','research','bounties','dashboard','equipment','leaderboard','loans','franchise','legacy','hof','voorraad','settings'];
  const tabs=document.querySelectorAll('.tab');
  const idx=order.indexOf(id); if(tabs[idx]) tabs[idx].classList.add('active');
  const tc=document.getElementById('tab-'+id); if(tc) tc.classList.add('active');
  if (id==='stats') { UI.renderStats(); UI.renderGraphCanvas(); UI.renderPieChart(); }
  if (id==='leaderboard') { Leaderboard.submit(); Leaderboard.render(); }
  if (id==='doelen') DailyGoals.render();
  if (id==='personeel') Employees.render();
  if (id==='ketens') { Chains.render(); Chains.updateTokenDisplay(); }
  if (id==='settings') Prestige.render();
  if (id==='suppliers') Suppliers.render();
  if (id==='klanten') { VIPCustomers.render(); CRM.renderPanel(); }
  if (id==='challenges') Challenges.render();
  if (id==='research') Research.render();
  if (id==='bounties') BountyBoard.render();
  if (id==='dashboard') Dashboard.render();
  if (id==='equipment') { EquipmentEvents.render(); renderMilestoneProgress(); }
  if (id==='loans') { Loans.render(); Recycling.renderPanel(); Subscriptions.render(); Morale.renderPanel(); }
  if (id==='franchise') Franchise.render();
  if (id==='legacy') LegacyPerks.render();
  if (id==='hof') HallOfFame.render();
  if (id==='voorraad') Inventory.render();
  Sound.click();
}
function switchPTab(id) {
  ['orders','contracts','queue'].forEach(t=>{
    document.getElementById('ptab-'+t)?.classList.toggle('active',t===id);
    document.getElementById('ptab-body-'+t)?.classList.toggle('active',t===id);
  });
  if (id==='queue') Queue.render();
}
function closePopup() {
  $el('popup-overlay').classList.remove('visible');
  $el('popup-ok').textContent='OK';
  $el('popup-ok').className='btn btn-primary';
  $el('popup-ok').onclick=()=>closePopup();
  $el('popup-cancel').style.display='none';
  $el('popup-box').className='popup';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  v8 MODULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ v8: RESEARCH SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Research = {
  start(id) {
    const res = CONFIG.RESEARCH.find(r=>r.id===id);
    if (!res) return;
    if (State.completedResearch.includes(id)) return;
    if (State.activeResearch) { UI.toast('âš—ï¸ Research already in progress!','warn'); return; }
    if (res.requires && !State.completedResearch.includes(res.requires)) {
      UI.toast('ðŸ”’ Requires: '+CONFIG.RESEARCH.find(r=>r.id===res.requires)?.name,'warn'); return;
    }
    if (State.bizLevel < (res.unlockLevel||1)) { UI.toast('ðŸ”’ Requires level '+res.unlockLevel,'warn'); return; }
    if (State.money < res.cost) { UI.toast('ðŸ’¸ Insufficient funds for research!','warn'); return; }
    State.money -= res.cost;
    State.activeResearch = { id, progress:0, total: res.researchTime };
    UI.toast(`âš—ï¸ Researching: ${res.name}â€¦`,'info');
    this.render();
    UI.updateTopBar();
  },
  tick(dt) {
    if (!State.activeResearch) return;
    State.activeResearch.progress += dt;
    if (State.activeResearch.progress >= State.activeResearch.total) {
      this.complete();
    }
  },
  complete() {
    const id = State.activeResearch.id;
    const res = CONFIG.RESEARCH.find(r=>r.id===id);
    if (!res) { State.activeResearch=null; return; }
    State.completedResearch.push(id);
    State.activeResearch = null;
    State.stats_v8.researchCompleted++;
    if (!State.researchFlags) State.researchFlags = {};
    res.apply(State);
    State.xp += 80;
    Confetti.burst();
    UI.toast(`âœ… Research complete: ${res.name}! ${res.effect}`,'success');
    NewsTicker.addItem(`ðŸ”¬ Research voltooid: ${res.name} â€” ${res.effect}`);
    Milestones.check();
    this.render();
  },
  render() {
    const panel = $el('research-panel');
    if (!panel) return;
    if (!State.researchFlags) State.researchFlags = {};
    const tiers = [1,2,3,4];
    let html = '';
    if (State.activeResearch) {
      const r = CONFIG.RESEARCH.find(x=>x.id===State.activeResearch.id);
      const pct = Math.min(100, (State.activeResearch.progress / State.activeResearch.total)*100);
      html += `<div class="active-research-banner">
        <div class="arb-icon">${r?.icon||'âš—ï¸'}</div>
        <div style="flex:1">
          <div class="arb-name">${r?.name||'Research'}</div>
          <div class="arb-sub">${r?.effect||''}</div>
          <div class="arb-bar"><div class="arb-fill" style="width:${pct.toFixed(1)}%"></div></div>
        </div>
        <div style="font-family:var(--display);font-weight:900;font-size:14px;color:var(--accent)">${(State.activeResearch.total - State.activeResearch.progress).toFixed(0)}s</div>
      </div>`;
    }
    html += '<div class="research-tree">';
    for (const tier of tiers) {
      const nodes = CONFIG.RESEARCH.filter(r=>r.tier===tier);
      if (!nodes.length) continue;
      html += `<div class="research-tier"><div class="research-tier-label">Tier ${tier} Research</div><div class="research-row">`;
      for (const r of nodes) {
        const done = State.completedResearch.includes(r.id);
        const active = State.activeResearch?.id === r.id;
        const reqMet = !r.requires || State.completedResearch.includes(r.requires);
        const levelMet = State.bizLevel >= (r.unlockLevel||1);
        const locked = !reqMet || !levelMet;
        const pct = active ? Math.min(100, (State.activeResearch.progress / State.activeResearch.total)*100) : 0;
        const cls = done ? 'researched' : active ? 'researching' : locked ? 'locked-node' : 'available';
        html += `<div class="research-node ${cls}" onclick="Research.start('${r.id}')">
          <div class="research-icon">${r.icon}</div>
          <div class="research-name">${r.name}</div>
          <div class="research-desc">${r.desc}</div>
          ${done ? '<div style="font-size:9px;color:var(--accent3);margin-top:4px">âœ“ Complete</div>' :
            active ? `<div class="research-progress"><div class="research-prog-fill" style="width:${pct.toFixed(1)}%"></div></div>` :
            locked ? `<div class="research-cost">ðŸ”’ ${r.requires ? 'Requires: '+CONFIG.RESEARCH.find(x=>x.id===r.requires)?.name : 'Lvl '+r.unlockLevel}</div>` :
            `<div class="research-cost">â‚¬${r.cost}</div><div class="research-time">â± ${r.researchTime}s</div>`}
        </div>`;
      }
      html += '</div></div>';
    }
    html += '</div>';
    panel.innerHTML = html;
  },
};

// â”€â”€ v8: MILESTONE SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Milestones = {
  check() {
    for (const m of CONFIG.MILESTONES) {
      if (State.claimedMilestones.includes(m.id)) continue;
      if (m.check(State)) {
        this.claim(m);
      }
    }
  },
  claim(m) {
    State.claimedMilestones.push(m.id);
    State.stats_v8.milestonesHit++;
    // Apply reward
    if (m.reward.money)  { State.money += m.reward.money; State.stats.totalEarned += m.reward.money; }
    if (m.reward.xp)     State.xp += m.reward.xp;
    if (m.reward.rep)    State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + m.reward.rep);
    if (m.reward.tokens) State.tokens += m.reward.tokens;
    this.show(m);
  },
  show(m) {
    const overlay = $el('milestone-overlay');
    const banner = $el('milestone-banner');
    if (!overlay || !banner) return;
    banner.innerHTML = `
      <div class="milestone-icon">${m.icon}</div>
      <div class="milestone-title">${m.name}</div>
      <div class="milestone-desc">${m.desc}</div>
      <div class="milestone-reward">${m.rewardText}</div>
      <div class="milestone-reward-sub">Milestone Reward</div>
      <button class="btn" style="margin-top:16px;min-width:120px" onclick="Milestones.close()">Collect!</button>
    `;
    overlay.style.display = 'block';
    banner.style.display = 'block';
    Confetti.burst();
    Sound.play?.('milestone');
  },
  close() {
    const overlay = $el('milestone-overlay');
    if (overlay) overlay.style.display = 'none';
    UI.updateTopBar();
  },
};

// â”€â”€ v8: EQUIPMENT EVENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EquipmentEvents = {
  _cooldown: 0,
  tick(dt) {
    if (this._cooldown > 0) { this._cooldown -= dt; return; }
    for (const [idx, printer] of State.printers.entries()) {
      if (!printer.active) continue;
      for (const evt of CONFIG.EQUIPMENT_EVENTS) {
        if (Math.random() < evt.chance * dt * 0.01) {
          if (State.activeEquipmentEvents.some(e=>e.printerIdx===idx && e.eventId===evt.id)) continue;
          this.trigger(idx, evt);
          this._cooldown = 30; // 30s between events
          return;
        }
      }
    }
  },
  trigger(printerIdx, evt) {
    State.activeEquipmentEvents.push({ printerIdx, eventId: evt.id, fixCost: evt.fixCost||0, resolved: false });
    if (evt.effect === 'offline') {
      State.printers[printerIdx]._offline = true;
    } else if (evt.effect === 'hploss') {
      State.printers.forEach(p=>{ p.health = Math.max(10, p.health-15); });
    } else if (evt.effect === 'cancel' && State.printers[printerIdx].active) {
      State.printers[printerIdx].active = false;
      State.printers[printerIdx].job = null;
      State.printers[printerIdx].progress = 0;
    }
    UI.toast(`${evt.icon} ${evt.name} â€” Printer #${printerIdx+1}!`, 'warn');
    this.render();
  },
  fix(printerIdx, eventId) {
    const eIdx = State.activeEquipmentEvents.findIndex(e=>e.printerIdx===printerIdx && e.eventId===eventId);
    if (eIdx < 0) return;
    const e = State.activeEquipmentEvents[eIdx];
    if (e.fixCost > 0 && State.money < e.fixCost) { UI.toast('ðŸ’¸ Not enough money to fix!','warn'); return; }
    State.money -= e.fixCost;
    if (State.printers[printerIdx]._offline) delete State.printers[printerIdx]._offline;
    State.activeEquipmentEvents.splice(eIdx, 1);
    State.stats_v8.equipmentEventsFixed++;
    UI.toast(`ðŸ”§ Fixed! Printer #${printerIdx+1} back online.`,'success');
    this.render();
    UI.updateTopBar();
  },
  render() {
    const panel = $el('equip-events-panel');
    if (!panel) return;
    const active = State.activeEquipmentEvents.filter(e=>!e.resolved);
    if (!active.length) { panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:12px">âœ… All systems operational</div>'; return; }
    panel.innerHTML = active.map(e=>{
      const cfg = CONFIG.EQUIPMENT_EVENTS.find(x=>x.id===e.eventId);
      if (!cfg) return '';
      return `<div class="equip-event-card">
        <div class="equip-event-title">${cfg.icon} ${cfg.name} â€” Printer #${e.printerIdx+1}</div>
        <div class="equip-event-desc">${cfg.desc}</div>
        <button class="btn btn-sm ${e.fixCost?'btn-danger':'btn-ghost'}" onclick="EquipmentEvents.fix(${e.printerIdx},'${e.eventId}')">
          ${e.fixCost ? `ðŸ”§ Fix (â‚¬${e.fixCost})` : 'ðŸ”§ Resolve'}
        </button>
      </div>`;
    }).join('');
  },
};

// â”€â”€ v8: BOUNTY BOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BountyBoard = {
  _refreshTimer: 0,
  init() {
    State.activeBounties = [];
    this._refreshBounties();
  },
  _refreshBounties() {
    const maxSlots = State.researchFlags?.bountyIntel ? 3 : 2;
    const pool = [...CONFIG.BOUNTIES].sort(()=>Math.random()-0.5);
    State.activeBounties = pool.slice(0, maxSlots).map(b=>({
      ...b,
      progress: 0,
      expiresAt: Date.now() + 600000, // 10 min
      claimed: false,
    }));
    State.bountyRefreshTimer = 600;
    this.render();
  },
  tick(dt) {
    State.bountyRefreshTimer -= dt;
    if (State.bountyRefreshTimer <= 0) this._refreshBounties();
    // Progress tracking for health-type bounty
    for (const b of State.activeBounties) {
      if (b.claimed) continue;
      if (b.type === 'health') {
        const allHealthy = State.printers.every(p=>p.health >= 90);
        if (allHealthy) b.progress += dt;
        else b.progress = 0;
        if (b.progress >= b.target) this.claim(b.id);
      }
    }
  },
  onJobComplete(order, filament, quality) {
    for (const b of State.activeBounties) {
      if (b.claimed) continue;
      if (b.type === 'nofail') b.progress++;
      if (b.type === 'bulk' && order.orderType === 'bulk') b.progress++;
      if (b.type === 'vip' || b.type === 'ultra_vip') {
        if (order.orderType === 'vip') {
          if (b.type === 'ultra_vip' && quality === 'ULTRA') b.progress++;
          else if (b.type !== 'ultra_vip') b.progress++;
        }
      }
      if (b.type === 'tpu' && filament === 'TPU') b.progress++;
      if (b.type === 'mystery' && order.orderType === 'mystery') b.progress++;
      if (b.type === 'resin_fine' && filament === 'RESIN' && (quality==='FINE'||quality==='ULTRA')) b.progress++;
      if (b.type === 'pa6_rush' && filament === 'PA6') b.progress++;
      if (b.progress >= b.target) this.claim(b.id);
    }
  },
  onFail() {
    for (const b of State.activeBounties) {
      if (b.type === 'nofail') b.progress = 0;
    }
  },
  onCombo(combo) {
    for (const b of State.activeBounties) {
      if (b.type === 'combo' && combo >= b.target) this.claim(b.id);
    }
  },
  onEarn(amount) {
    for (const b of State.activeBounties) {
      if (b.type === 'earn_burst') {
        b.progress += amount;
        if (b.progress >= b.target) this.claim(b.id);
      }
    }
  },
  claim(id) {
    const b = State.activeBounties.find(x=>x.id===id);
    if (!b || b.claimed) return;
    b.claimed = true;
    State.claimedBounties.push(id);
    State.money += b.reward;
    State.stats.totalEarned += b.reward;
    State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + b.bonusRep);
    State.stats_v8.bountiesClaimed++;
    State.xp += 60;
    Confetti.burst();
    UI.toast(`ðŸŽ¯ BOUNTY CLAIMED: ${b.name}! +â‚¬${b.reward} +${b.bonusRep} Rep`,'success');
    this.render();
    UI.updateTopBar();
    Milestones.check();
  },
  render() {
    const panel = $el('bounty-panel');
    if (!panel) return;
    const now = Date.now();
    const html = State.activeBounties.map(b=>{
      const pct = Math.min(100, (b.progress / b.target) * 100);
      const msLeft = b.expiresAt - now;
      const secLeft = Math.max(0, Math.floor(msLeft/1000));
      const cls = b.claimed ? 'bounty-claimed' : '';
      return `<div class="bounty-card ${cls}">
        <div class="bounty-name">${b.icon} ${b.name}</div>
        <div class="bounty-req">${b.desc}</div>
        <div style="margin:6px 0">
          <div style="height:5px;background:var(--bg);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${pct.toFixed(1)}%;background:linear-gradient(90deg,#ffd700,#ff9f43);border-radius:3px;transition:width 0.3s"></div>
          </div>
          <div style="font-size:9px;color:var(--text-dim);margin-top:2px">${b.progress}/${b.target} â€” ${pct.toFixed(0)}%</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="bounty-reward">â‚¬${b.reward} <span style="font-size:11px;color:var(--text-dim)">+${b.bonusRep} rep</span></div>
          ${b.claimed ? '<span style="color:var(--accent3);font-size:11px">âœ“ Claimed</span>' : `<div class="bounty-expires">â± ${fmtTime(secLeft)}</div>`}
        </div>
      </div>`;
    }).join('') || '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:16px">No active bounties</div>';
    panel.innerHTML = `<div style="font-size:9px;color:var(--text-dim);margin-bottom:8px;display:flex;justify-content:space-between"><span>ðŸŽ¯ Active Bounties</span><span>Refreshes in ${fmtTime(Math.max(0,State.bountyRefreshTimer))}</span></div>${html}`;
  },
};

// â”€â”€ v8: SPECIAL ORDER HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SpecialOrders = {
  getType() {
    const r = Math.random();
    const c = CONFIG.SPECIAL_ORDER_CHANCE;
    // Apply VIP boost from research
    const vipChance = c.vip * (State.researchFlags?.vipNetwork ? 2 : 1) * (State.researchFlags?.vipPortal ? 2 : 1);
    if (r < c.rush)                      return 'rush';
    if (r < c.rush + vipChance)          return 'vip';
    if (r < c.rush + vipChance + c.bulk) return 'bulk';
    if (r < c.rush + vipChance + c.bulk + c.mystery) return 'mystery';
    // Legendary check
    if (State.legendaryUnlocked && State.researchFlags?.monopoly && Math.random() < 0.03) return 'legendary';
    return 'normal';
  },
  applyModifiers(order) {
    const t = order.orderType;
    if (t === 'rush') {
      order.reward *= 1.6;
      order.expireTime *= 0.5; // half the time
      order.rushBonus = State.researchFlags?.rushBonus ? 1.3 : 1;
      order.reward *= order.rushBonus;
    } else if (t === 'vip') {
      order.reward *= 2.0;
      order.expireTime *= 1.5;
      order.printTime *= 1.2; // more careful
    } else if (t === 'bulk') {
      order.reward *= 2.5;
      order.printTime *= 1.8; // bigger job
      order.expireTime *= 2;
    } else if (t === 'mystery') {
      order.reward *= (1.5 + Math.random() * 2.0); // 1.5Ã— to 3.5Ã— random!
      order.mystery = true;
      order.name = '??? ' + order.name;
    } else if (t === 'legendary') {
      order.reward *= 5;
      order.printTime *= 3;
      order.expireTime *= 3;
      order.name = CONFIG.ORDER_NAMES_LEGENDARY[Math.floor(Math.random()*CONFIG.ORDER_NAMES_LEGENDARY.length)];
    }
    return order;
  },
  getLabel(type) {
    return { rush:'ðŸš¨ RUSH', vip:'ðŸ‘‘ VIP', bulk:'ðŸ“¦ BULK', mystery:'ðŸŽ² MYSTERY', legendary:'â­ LEGENDARY', flash:'âš¡ FLASH', normal:'' }[type] || '';
  },
  getTagClass(type) {
    return { rush:'tag-rush', vip:'tag-vip', bulk:'tag-bulk', mystery:'tag-mystery', legendary:'tag-vip', flash:'tag-diff', normal:'' }[type] || '';
  },
};

// â”€â”€ v8: DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Dashboard = {
  render() {
    const panel = $el('dashboard-panel');
    if (!panel) return;
    const s = State.stats;
    const successRate = s.jobsDone+s.jobsFailed > 0 ? ((s.jobsDone/(s.jobsDone+s.jobsFailed))*100).toFixed(1) : 'â€”';
    const avgEarning = s.jobsDone > 0 ? (s.totalEarned/s.jobsDone).toFixed(2) : '0.00';
    const sessionMin = Math.max(1, (Date.now() - s.sessionStart) / 60000);
    const eph = (s.sessionEarned / sessionMin * 60).toFixed(0);
    const activePrinters = State.printers.filter(p=>p.active).length;
    const efficiency = State.printers.length > 0 ? Math.round(activePrinters/State.printers.length*100) : 0;
    const repTier = State.reputation >= 150 ? 4 : State.reputation >= 100 ? 3 : State.reputation >= 50 ? 2 : State.reputation >= 20 ? 1 : 0;
    const repTierNames = ['Newcomer','Known','Reliable','Trusted','Legend'];
    const research = State.completedResearch.length;
    const totalRes = CONFIG.RESEARCH.length;
    const milestonesDone = State.claimedMilestones.length;
    const totalMilestones = CONFIG.MILESTONES.length;

    panel.innerHTML = `
      <div class="kpi-row">
        <div class="kpi-pill"><div class="kpi-val">${fmtEur(s.sessionEarned)}</div><div class="kpi-lbl">Session</div></div>
        <div class="kpi-pill"><div class="kpi-val">â‚¬${eph}/h</div><div class="kpi-lbl">Rate</div></div>
        <div class="kpi-pill"><div class="kpi-val">${successRate}%</div><div class="kpi-lbl">Success</div></div>
        <div class="kpi-pill"><div class="kpi-val">${s.currentStreak}</div><div class="kpi-lbl">Streak</div></div>
      </div>
      <div class="kpi-row" style="margin-top:6px">
        <div class="kpi-pill" style="background:rgba(127,255,110,0.08)"><div class="kpi-val" style="color:var(--accent3)">${fmtEur(s.totalEarned - (s.totalFilamentCost||0))}</div><div class="kpi-lbl">Net Profit</div></div>
        <div class="kpi-pill" style="background:rgba(255,204,0,0.06)"><div class="kpi-val" style="color:var(--warn)">${fmtEur((State.franchiseBranches||[]).reduce((a,b)=>a+(b.incomePerMin||0),0))}/min</div><div class="kpi-lbl">Franchise</div></div>
        <div class="kpi-pill"><div class="kpi-val">${Object.values(State.clientTiers||{}).filter(t=>t==='platinum').length}</div><div class="kpi-lbl">Platinum</div></div>
        <div class="kpi-pill"><div class="kpi-val">${State.xp}</div><div class="kpi-lbl">XP</div></div>
      </div>
      <div class="dashboard-grid">
        <div class="dash-card">
          <div class="dash-card-label">Total Revenue</div>
          <div class="dash-card-value">${fmtEur(s.totalEarned)}</div>
          <div class="dash-card-trend dash-trend-up">â†‘ Best job: ${fmtEur(s.bestSingleJob||0)}</div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Jobs Completed</div>
          <div class="dash-card-value">${s.jobsDone}</div>
          <div class="dash-card-trend dash-trend-up">â†‘ Avg ${fmtEur(avgEarning)}/job</div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Printer Efficiency</div>
          <div class="dash-card-value">${efficiency}%</div>
          <div class="dash-efficiency-bar"><div class="dash-eff-fill" style="width:${efficiency}%"></div></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Reputation</div>
          <div class="dash-card-value">${State.reputation}</div>
          <div class="dash-card-trend"><span class="rep-tier-badge rep-tier-${repTier}">${repTierNames[repTier]}</span></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Research</div>
          <div class="dash-card-value">${research}/${totalRes}</div>
          <div style="height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-top:6px"><div style="height:100%;width:${(research/totalRes*100).toFixed(0)}%;background:var(--accent);border-radius:2px"></div></div>
        </div>
        <div class="dash-card">
          <div class="dash-card-label">Milestones</div>
          <div class="dash-card-value">${milestonesDone}/${totalMilestones}</div>
          <div style="height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-top:6px"><div style="height:100%;width:${(milestonesDone/totalMilestones*100).toFixed(0)}%;background:var(--warn);border-radius:2px"></div></div>
        </div>
      </div>
      <div style="margin-top:6px">
        <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Special Orders Completed</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <span class="tag tag-rush">ðŸš¨ Rush: ${State.stats_v8.rushDone}</span>
          <span class="tag tag-vip">ðŸ‘‘ VIP: ${State.stats_v8.vipDone}</span>
          <span class="tag tag-bulk">ðŸ“¦ Bulk: ${State.stats_v8.bulkDone}</span>
          <span class="tag tag-mystery">ðŸŽ² Mystery: ${State.stats_v8.mysteryDone}</span>
        </div>
      </div>
      <div style="margin-top:8px">
        <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">All-Time Records</div>
        <div class="kpi-row">
          <div class="kpi-pill"><div class="kpi-val">${s.longestStreak}</div><div class="kpi-lbl">Best Streak</div></div>
          <div class="kpi-pill"><div class="kpi-val">${State.stats_v8.bountiesClaimed}</div><div class="kpi-lbl">Bounties</div></div>
          <div class="kpi-pill"><div class="kpi-val">${State.prestige}</div><div class="kpi-lbl">Prestiges</div></div>
        </div>
      </div>
      ${State.bizLevel >= 6 ? `<div style="margin-top:10px;padding:10px;background:linear-gradient(135deg,rgba(0,229,255,0.08),rgba(127,255,110,0.05));border:1px solid rgba(0,229,255,0.2);border-radius:var(--radius)">
        <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">ðŸ† Endgame Score</div>
        <div style="font-family:var(--display);font-weight:900;font-size:28px;color:var(--accent)">
          ${(()=>{
            const score = Math.floor(
              (s.totalEarned / 100) +
              (s.jobsDone * 2) +
              (State.reputation * 5) +
              (State.prestige * 500) +
              ((s.longestStreak||0) * 10) +
              ((State.stats_v8?.bountiesClaimed||0) * 20) +
              ((State.completedResearch?.length||0) * 50) +
              ((State.franchiseBranches?.length||0) * 200)
            );
            return score.toLocaleString();
          })()}
        </div>
        <div style="font-size:9px;color:var(--text-dim);margin-top:3px">Score = earnings + jobs + rep + prestiges + streaks + bounties + research + franchises</div>
      </div>` : ''}
    `;
  },
};

function renderMilestoneProgress() {
  const el = document.getElementById('milestone-progress-list');
  if (!el) return;
  el.innerHTML = CONFIG.MILESTONES.map(m => {
    const done = State.claimedMilestones.includes(m.id);
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border)">
      <div>
        <span style="font-size:14px">${m.icon}</span>
        <span style="font-size:10px;color:${done?'var(--accent3)':'var(--text)'};margin-left:4px">${m.name}</span>
      </div>
      <span style="font-size:9px;color:${done?'var(--accent3)':'var(--text-dim)'}">${done ? 'âœ“ Claimed' : m.rewardText}</span>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  v9 MODULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ RIVAL COMPETITOR (PrintBot) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Rival = {
  NAMES: ['PrintBot 3000','FilamentFoe','SpeedPrinter AI','RivalRobot','NozzleNemesis'],
  _name: 'PrintBot',
  _stealTimer: 0,
  _stealInterval: 35, // seconds between steals, decreases with level

  init() {
    this._name = this.NAMES[Math.floor(Math.random() * this.NAMES.length)];
    State.rivalActive = true;
    UI.log(`ðŸ¤– ${this._name} has entered the market! Accept orders quickly!`, 'warn');
  },

  tick(dt) {
    if (!State.rivalActive) return;
    // Only active from level 3+
    if (State.bizLevel < 3) return;

    this._stealTimer -= dt;
    const interval = Math.max(15, this._stealInterval - State.bizLevel * 2);
    if (this._stealTimer <= 0) {
      this._stealTimer = interval + Math.random() * 15;
      this._maybeSteal();
    }
  },

  _maybeSteal() {
    // Steal the oldest/least valuable order
    if (State.orders.length < 2) return; // leave at least 1
    // Sort by time left ascending â€” steal the one about to expire
    const sorted = [...State.orders].sort((a, b) => a.timeLeft - b.timeLeft);
    const victim = sorted[0];
    if (!victim) return;

    State.orders = State.orders.filter(o => o.id !== victim.id);
    State.rivalScore = (State.rivalScore || 0) + 1;
    State.reputation = Math.max(0, State.reputation - 1);

    // Show banner
    const banner = $el('rival-banner');
    const msg = $el('rival-msg');
    const score = $el('rival-score');
    const pscore = $el('rival-player-score');
    if (banner) {
      banner.classList.add('active', 'rival-steal');
      setTimeout(() => banner.classList.remove('rival-steal'), 500);
      setTimeout(() => banner.classList.remove('active'), 4000);
    }
    if (msg) msg.textContent = `${this._name} snatched: "${victim.name}" (â‚¬${victim.reward.toFixed(2)}) â€” Be faster!`;
    if (score) score.textContent = State.rivalScore;
    if (pscore) pscore.textContent = State.stats.jobsDone;

    UI.log(`ðŸ¤– ${this._name} stole order: "${victim.name}"! -1 Rep`, 'warn');
    UI.renderOrders();
    UI.updateTopBar();

    // Show sabotage toast
    const t = document.createElement('div');
    t.className = 'sabotage-toast';
    t.innerHTML = `<div style="font-size:9px;letter-spacing:1px;color:var(--danger)">ðŸ¤– RIVAL STOLE YOUR ORDER</div><div style="font-family:var(--display);font-weight:700;font-size:14px;margin-top:3px">${victim.name}</div><div style="font-size:9px;color:var(--text-dim)">â‚¬${victim.reward.toFixed(2)} lost Â· âˆ’1 Rep</div>`;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 4000);
  },

  onJobComplete() {
    State.playerVsRival = (State.playerVsRival || 0) + 1;
    const pscore = $el('rival-player-score');
    if (pscore) pscore.textContent = State.stats.jobsDone;

    // Check if player has beaten rival by 20+ jobs â€” they win this round!
    const lead = State.stats.jobsDone - State.rivalScore;
    if (lead >= 20 && !State._rivalDefeated) {
      State._rivalDefeated = true;
      State._stealInterval = 50; // slow down after defeat
      const prize = 200 + State.bizLevel * 50;
      State.money = r2(State.money + prize);
      State.reputation = Math.min(200, State.reputation + 15);
      State.xp += 100;
      Sound.levelUp();
      Confetti.burst(80);
      UI.log(`ðŸ† You BEAT ${this._name}! +â‚¬${prize} bounty Â· +15 Rep Â· +100 XP`, 'success');
      UI.showPopup(`ðŸ† Rival Defeated!`,
        `<div style="text-align:center"><div style="font-size:32px">ðŸ¤–ðŸ’¥</div><strong style="font-family:var(--display);color:var(--accent);font-size:16px">${this._name} DESTROYED!</strong><br><br>You outpaced the rival by 20 jobs!<br><br>ðŸ’° +â‚¬${prize} &nbsp; â­ +15 Rep &nbsp; âš¡ +100 XP<br><br><span style="font-size:10px;color:var(--text-dim)">The rival will return stronger at the next levelâ€¦</span></div>`);
      NewsTicker.addItem(`ðŸ† RIVAL VERSLAGEN! ${this._name} is van de markt geveegd na ${State.stats.jobsDone} jobs!`);
    }
  },

  resetForNextLevel() {
    // Called when player levels up â€” rival gets a second wind
    if (!State.rivalActive || !State._rivalDefeated) return;
    State._rivalDefeated = false;
    this._stealInterval = Math.max(12, 35 - State.bizLevel * 3); // faster at higher levels
    this._name = this.NAMES[Math.floor(Math.random() * this.NAMES.length)] + ' MkII';
    UI.log(`ðŸ¤– ${this._name} is back â€” and faster! Keep up!`, 'warn');
    NewsTicker.addItem(`âš ï¸ Rival terug: ${this._name} â€” nu sneller dan ooit!`);
  },
};


// â”€â”€ FLASH ORDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// High-value orders that expire in 15 seconds â€” act fast!
const FlashOrders = {
  _timer: 0,
  _interval: 90, // seconds between flash order chances

  tick(dt) {
    if (State.bizLevel < 2) return;
    this._timer += dt;
    if (this._timer >= this._interval) {
      this._timer = 0;
      const lvlScale = 1 + (State.bizLevel - 1) * 0.15;
      this._interval = (70 + Math.random() * 60) * lvlScale;
      if (Math.random() < 0.4 && State.orders.length < CONFIG.MAX_ORDERS) {
        this._spawn();
      }
    }
  },

  _spawn() {
    const base = Orders.generate();
    base.reward = r2(base.reward * (2.5 + Math.random() * 1.5)); // 2.5â€“4Ã— normal reward
    base.timeLeft = 15;
    base.expiresIn = 15;
    base.urgent = true;
    base.isFlash = true;
    base.orderType = 'flash';
    base.name = `âš¡ FLASH: ${base.name}`;
    State.orders.unshift(base); // put at top of list
    Sound.levelUp();
    UI.log(`âš¡ FLASH ORDER! ${base.name} â€” â‚¬${base.reward.toFixed(2)} â€” only 15 seconds!`, 'warn');
    NewsTicker.addItem(`âš¡ FLASH ORDER: ${base.name} â€” â‚¬${base.reward.toFixed(2)} â€” 15 seconden!`);
    UI.renderOrders();
  },
};

// â”€â”€ DEMAND SURGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DemandSurge = {
  SURGES: [
    { name:'ðŸ”¥ PLA Frenzy',     filament:'PLA',   target:6,  duration:120, reward:180, bonusRep:8,  bonusMult:1.5 },
    { name:'ðŸ’œ PETG Rush',      filament:'PETG',  target:4,  duration:100, reward:250, bonusRep:12, bonusMult:1.6 },
    { name:'ðŸŸ  PA6 Demand',     filament:'PA6',   target:3,  duration:90,  reward:400, bonusRep:18, bonusMult:1.8 },
    { name:'ðŸ§² TPU Sprint',     filament:'TPU',   target:4,  duration:110, reward:300, bonusRep:14, bonusMult:1.7 },
    { name:'ðŸ”® Resin Bonanza',  filament:'RESIN', target:2,  duration:80,  reward:500, bonusRep:22, bonusMult:2.0 },
    { name:'âš¡ Any Material',   filament:null,    target:8,  duration:150, reward:350, bonusRep:15, bonusMult:1.4 },
  ],

  tick(dt) {
    if (State.activeSurge) {
      State.activeSurge.timer -= dt;
      this.updateUI();
      if (State.activeSurge.timer <= 0) this._end(false);
      return;
    }
    // Check if can start
    State.surgeCountdown -= dt;
    if (State.surgeCountdown <= 0) {
      State.surgeCountdown = 90 + Math.random() * 120;
      if (Math.random() < 0.4 && State.bizLevel >= 2) this._start();
    }
  },

  _start() {
    // Filter out locked filaments
    const available = this.SURGES.filter(s => {
      if (!s.filament) return true;
      if (s.filament === 'TPU' && !State.tpuUnlocked) return false;
      if (s.filament === 'RESIN' && !State.resinUnlocked) return false;
      if (s.filament === 'PETG' && State.reputation < 20) return false;
      if (s.filament === 'PA6' && State.reputation < 60) return false;
      return true;
    });
    const surge = available[Math.floor(Math.random() * available.length)];
    State.activeSurge = { ...surge, done: 0, startTime: Date.now() };

    const banner = $el('surge-banner');
    if (banner) banner.classList.add('active');
    const nm = $el('surge-name');
    if (nm) nm.textContent = surge.name;
    const rw = $el('surge-reward');
    if (rw) rw.textContent = `â‚¬${surge.reward} Bonus`;

    UI.log(`ðŸ”¥ DEMAND SURGE: ${surge.name}! Complete ${surge.target} ${surge.filament||'any'} jobs in ${Math.round(surge.duration)}s for a bonus!`, 'warn');
    Sound.success && Sound.success();

    // Ticker
    NewsTicker.addItem(`ðŸ”¥ DEMAND SURGE: ${surge.name} â€” Quick, complete orders for a huge bonus!`);
  },

  onJobComplete(filament) {
    if (!State.activeSurge) return;
    const s = State.activeSurge;
    if (s.filament && s.filament !== filament) return;
    s.done++;
    this.updateUI();
    if (s.done >= s.target) this._end(true);
  },

  updateUI() {
    const s = State.activeSurge;
    if (!s) return;
    const fill = $el('surge-fill');
    const text = $el('surge-progress-text');
    const timer = $el('surge-timer');
    if (fill) fill.style.width = Math.min(100, (s.done / s.target) * 100) + '%';
    if (text) text.textContent = `${s.done}/${s.target}`;
    if (timer) {
      const m = Math.floor(s.timer / 60), sec = r0(s.timer % 60);
      timer.textContent = `â³ ${m}:${sec.toString().padStart(2,'0')} remaining`;
      timer.style.color = s.timer < 20 ? 'var(--danger)' : 'var(--accent3)';
    }
  },

  _end(success) {
    const s = State.activeSurge;
    if (!s) return;
    State.activeSurge = null;
    const banner = $el('surge-banner');
    if (banner) banner.classList.remove('active');

    if (success) {
      State.money = r2(State.money + s.reward);
      State.stats.totalEarned = r2(State.stats.totalEarned + s.reward);
      State.reputation = Math.min(CONFIG.MAX_REP, State.reputation + s.bonusRep);
      State.stats.surgesDone = (State.stats.surgesDone || 0) + 1;
      Confetti.burst(60);
      UI.floatMoney(`+â‚¬${s.reward} SURGE BONUS!`);
      UI.log(`ðŸŽ‰ DEMAND SURGE COMPLETE: ${s.name}! +â‚¬${s.reward} +${s.bonusRep} rep!`, 'money');
      const t = document.createElement('div');
      t.className = 'contract-toast';
      t.innerHTML = `<div style="font-size:9px;letter-spacing:2px;color:var(--accent3)">ðŸ”¥ DEMAND SURGE COMPLETE!</div><div style="font-family:var(--display);font-weight:700;font-size:15px">${s.name}</div><div style="font-size:10px;color:var(--text-dim)">+â‚¬${s.reward} Â· +${s.bonusRep} Rep</div>`;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 5000);
      Sound.success && Sound.success();
    } else {
      UI.log(`âŒ Demand Surge failed: ${s.name}. Only completed ${s.done}/${s.target}.`, 'warn');
    }
    State.surgeCountdown = 80 + Math.random() * 100;
  },

  getSurgeMultiplier(filament) {
    if (!State.activeSurge) return 1;
    const s = State.activeSurge;
    if (!s.filament || s.filament === filament) return s.bonusMult;
    return 1;
  },
};

// â”€â”€ CLOG MINI-GAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ClogMinigame = {
  _printerIdx: null,
  _clicks: 0,
  _target: 20,
  _timer: null,
  _timeLeft: 8,
  _total: 8,

  trigger(printerIdx) {
    if (State.clogActive) return;
    State.clogActive = true;
    this._printerIdx = printerIdx;
    this._clicks = 0;
    // Scale difficulty with level
    this._target = 15 + State.bizLevel * 2;
    this._timeLeft = 8;
    this._total = 8;

    const overlay = $el('clog-overlay');
    if (overlay) overlay.classList.add('active');
    const pname = $el('clog-printer-name');
    if (pname) pname.textContent = State.printers[printerIdx]?.name || 'Printer #1';
    this._renderProgress();

    clearInterval(this._timer);
    this._timer = setInterval(() => {
      this._timeLeft -= 0.1;
      const fill = $el('clog-timer-fill');
      if (fill) fill.style.width = Math.max(0, (this._timeLeft / this._total) * 100) + '%';
      if (this._timeLeft <= 0) {
        clearInterval(this._timer);
        this._fail();
      }
    }, 100);

    Sound.failure && Sound.failure();
    UI.log(`ðŸ”´ NOZZLE CLOG on ${State.printers[printerIdx]?.name}! Quick, clear it!`, 'error');
  },

  press() {
    if (!State.clogActive) return;
    this._clicks++;
    this._timeLeft = Math.min(this._total, this._timeLeft + 0.3); // small time bonus per press
    this._renderProgress();
    Sound.click && Sound.click();

    const btn = $el('clog-btn');
    if (btn) {
      btn.style.transform = 'scale(0.85)';
      setTimeout(() => btn.style.transform = '', 80);
    }

    if (this._clicks >= this._target) {
      clearInterval(this._timer);
      this._win();
    }
  },

  _renderProgress() {
    const clicks = $el('clog-clicks');
    const target = $el('clog-target');
    const fb = $el('clog-feedback');
    if (clicks) clicks.textContent = this._clicks;
    if (target) target.textContent = this._target;
    if (fb) {
      const pct = this._clicks / this._target;
      if (pct < 0.3) fb.textContent = 'Mash the button to clear the clog!';
      else if (pct < 0.6) { fb.textContent = 'Keep going! Almost there...'; fb.style.color = 'var(--warn)'; }
      else if (pct < 0.9) { fb.textContent = 'ðŸ’ª Nearly clear! Final push!'; fb.style.color = 'var(--accent3)'; }
      else { fb.textContent = 'ðŸ”¥ So close!'; fb.style.color = 'var(--accent)'; }
    }
  },

  _win() {
    const fb = $el('clog-feedback');
    if (fb) { fb.textContent = 'âœ… Clog cleared! Print continuing...'; fb.style.color = 'var(--accent3)'; }
    Sound.success && Sound.success();
    State.stats.clogWins = (State.stats.clogWins || 0) + 1;
    Achievements.check();
    setTimeout(() => {
      this._close();
      UI.log(`ðŸ”§ Nozzle clog cleared! Print on ${State.printers[this._printerIdx]?.name} continues.`, 'success');
    }, 1000);
  },

  _fail() {
    const fb = $el('clog-feedback');
    if (fb) { fb.textContent = 'âŒ Too slow! The print failed.'; fb.style.color = 'var(--danger)'; }
    Sound.failure && Sound.failure();
    setTimeout(() => {
      const p = State.printers[this._printerIdx];
      if (p && p.active) {
        // Force fail the print
        p.active = false;
        State.reputation = Math.max(0, State.reputation + CONFIG.REP_PER_FAILURE);
        State.stats.jobsFailed++;
        State.stats.currentStreak = 0;
        UI.log(`âŒ Clog destroyed the print on ${p.name}!`, 'error');
        p.health = Math.max(0, p.health - 15);
        p.job = null; p.progress = 0; p.timeLeft = 0;
        UI.renderPrinters();
        UI.renderCenterPanel();
        UI.updateTopBar();
      }
      this._close();
    }, 1200);
  },

  skip() {
    clearInterval(this._timer);
    this._fail();
  },

  _close() {
    const overlay = $el('clog-overlay');
    if (overlay) overlay.classList.remove('active');
    State.clogActive = false;
    this._printerIdx = null;
    this._clicks = 0;
  },
};

// â”€â”€ LOAN SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Loans = {
  OFFERS: [
    { id:'loan_sm',  label:'Small Loan',    amount:200,  interestRate:0.02, desc:'â‚¬200 instant. 2% interest per minute.' },
    { id:'loan_md',  label:'Business Loan', amount:750,  interestRate:0.025,desc:'â‚¬750 capital. 2.5% interest per minute.' },
    { id:'loan_lg',  label:'Growth Loan',   amount:2000, interestRate:0.03, desc:'â‚¬2,000 expansion. 3% interest per minute.' },
    { id:'loan_xl',  label:'Venture Loan',  amount:6000, interestRate:0.035,desc:'â‚¬6,000 injection. 3.5% interest per minute. High risk!' },
  ],

  take(id) {
    const offer = this.OFFERS.find(o => o.id === id);
    if (!offer) return;
    // Check not already taken
    if (State.activeLoans.find(l => l.id === id)) {
      UI.showPopup('Loan Active', 'You already have this loan. Repay it first!'); return;
    }
    const loan = { id, label: offer.label, amount: offer.amount, remaining: offer.amount, interestRate: offer.interestRate };
    State.activeLoans.push(loan);
    State.money = r2(State.money + offer.amount);
    State.totalDebt = r2(State.totalDebt + offer.amount);
    UI.log(`ðŸ’³ Loan taken: ${offer.label} â€” +â‚¬${offer.amount} (${(offer.interestRate*100).toFixed(1)}% interest/min)`, 'money');
    UI.updateTopBar();
    this.render();
    // Show debt panel
    this._updateDebtUI();
  },

  tick(dt) {
    if (State.activeLoans.length === 0) return;
    State.activeLoans.forEach(loan => {
      // Accrue interest every 60s in real time â€” tick by dt
      loan._interestAccum = (loan._interestAccum || 0) + dt;
      if (loan._interestAccum >= 60) {
        const interest = r2(loan.remaining * loan.interestRate);
        loan.remaining = r2(loan.remaining + interest);
        loan._interestAccum -= 60;
        if (loan.remaining > loan.amount * 2 && !loan._warnShown) {
          loan._warnShown = true;
          UI.log(`ðŸš¨ Loan "${loan.label}" doubled to â‚¬${loan.remaining.toFixed(2)}! Pay now!`, 'error');
          NewsTicker.addItem(`ðŸš¨ SCHULD: ${loan.label} verdubbeld naar â‚¬${loan.remaining.toFixed(2)}!`);
        }
        if (loan.remaining > loan.amount * 3 && !loan._critWarnShown) {
          loan._critWarnShown = true;
          UI.log(`ðŸ’€ CRITICAL: "${loan.label}" is 3Ã— original â€” bank penalty! -5 Rep`, 'error');
          State.reputation = Math.max(0, State.reputation - 5);
          UI.updateTopBar();
        }
      }
    });
    State.totalDebt = r2(State.activeLoans.reduce((sum, l) => sum + l.remaining, 0));
    this._updateDebtUI();
  },

  repayAll() {
    if (State.totalDebt <= 0) { UI.showPopup('No Debt', 'You have no outstanding loans!'); return; }
    if (State.money < State.totalDebt) {
      UI.showPopup('Insufficient Funds', `You need â‚¬${State.totalDebt.toFixed(2)} to repay all loans. You have â‚¬${State.money.toFixed(2)}.`); return;
    }
    State.money = r2(State.money - State.totalDebt);
    UI.log(`âœ… All loans repaid! Total paid: â‚¬${State.totalDebt.toFixed(2)}`, 'success');
    State.activeLoans = [];
    State.totalDebt = 0;
    UI.updateTopBar();
    this._updateDebtUI();
    this.render();
  },

  repayOne(id) {
    const loan = State.activeLoans.find(l => l.id === id);
    if (!loan) return;
    if (State.money < loan.remaining) {
      UI.showPopup('Insufficient Funds', `Need â‚¬${loan.remaining.toFixed(2)} to repay this loan.`); return;
    }
    State.money = r2(State.money - loan.remaining);
    State.totalDebt = r2(State.totalDebt - loan.remaining);
    State.activeLoans = State.activeLoans.filter(l => l.id !== id);
    State.stats.loansRepaid = (State.stats.loansRepaid || 0) + 1;
    UI.log(`âœ… Loan "${loan.label}" repaid!`, 'success');
    UI.updateTopBar();
    this._updateDebtUI();
    this.render();
  },

  _updateDebtUI() {
    const panel = $el('loan-debt-panel');
    const display = $el('loan-debt-display');
    if (panel) panel.style.display = State.totalDebt > 0 ? 'block' : 'none';
    if (display) {
      display.textContent = fmtEur(State.totalDebt);
      display.style.color = State.totalDebt > 1000 ? 'var(--danger)' : 'var(--warn)';
    }
    // Also show a warning pill in topbar if debt is high
    const pill = $el('debt-pill');
    if (pill) {
      if (State.totalDebt > 0) {
        pill.style.display = 'flex';
        pill.querySelector('#debt-val').textContent = fmtEur(State.totalDebt);
        pill.style.borderColor = State.totalDebt > 500 ? 'rgba(255,61,90,0.6)' : 'rgba(255,204,0,0.4)';
      } else {
        pill.style.display = 'none';
      }
    }
  },

  render() {
    const panel = $el('loan-panel'); if (!panel) return;
    panel.innerHTML = '';
    this.OFFERS.forEach(offer => {
      const active = State.activeLoans.find(l => l.id === offer.id);
      const card = document.createElement('div');
      card.className = 'loan-card';
      if (active) {
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-family:var(--display);font-weight:700;font-size:14px;color:var(--danger)">${offer.label}</div>
          <div class="loan-due">${fmtEur(active.remaining)}</div>
        </div>
        <div class="loan-interest">ðŸ“ˆ ${(offer.interestRate*100).toFixed(1)}% interest/min â€” Balance growing!</div>
        <button class="btn btn-danger btn-sm btn-full" style="margin-top:8px" onclick="Loans.repayOne('${offer.id}')">ðŸ’³ Repay ${fmtEur(active.remaining)}</button>`;
      } else {
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div style="font-family:var(--display);font-weight:700;font-size:14px">${offer.label}</div>
          <div style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--accent3)">â‚¬${offer.amount.toLocaleString()}</div>
        </div>
        <div style="font-size:10px;color:var(--text-dim);margin-bottom:8px">${offer.desc}</div>
        <button class="btn btn-warn btn-sm btn-full" onclick="Loans.take('${offer.id}')">ðŸ’³ Take Loan</button>`;
      }
      panel.appendChild(card);
    });
  },
};

// â”€â”€ POWER OUTAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PowerOutage = {
  _countdown: 300,
  _active: false,
  _duration: 0,

  tick(dt) {
    if (this._active) {
      this._duration -= dt;
      if (this._duration <= 0) this._end();
      return;
    }
    // Only from level 4+
    if (State.bizLevel < 4) return;
    this._countdown -= dt;
    if (this._countdown <= 0) {
      this._countdown = 200 + Math.random() * 300;
      if (Math.random() < 0.25) this._trigger();
    }
  },

  _trigger() {
    // UPS upgrade prevents outages
    if (State.ownedUpgrades.includes('ups_system')) {
      UI.log('âš¡ Power surge detected â€” UPS protected your printers!', 'success');
      return;
    }
    this._active = true;
    this._duration = 5 + Math.random() * 8;

    // Pause all active printers
    State.printers.forEach(p => {
      if (p.active) {
        p._pausedByOutage = true;
        p.active = false; // temporarily deactivate
      }
    });

    // Flash effect
    const flash = document.createElement('div');
    flash.className = 'outage-flash';
    document.body.appendChild(flash);
    setTimeout(() => flash.remove(), 1500);

    UI.log('âš¡ POWER OUTAGE! All printers paused! Invest in a UPS to prevent this!', 'error');
    UI.showPopup('âš¡ Power Outage!', `A power outage hit your workshop! Printers are paused for ${r0(this._duration)} seconds.<br><br><span style="color:var(--danger)">Buy the <strong>UPS System</strong> upgrade to prevent future outages!</span>`);

    UI.renderPrinters();
    UI.renderCenterPanel();
    UI.updateTopBar();
    NewsTicker.addItem('âš¡ POWER OUTAGE: Workshop offline! UPS upgrade recommended!');
  },

  _end() {
    this._active = false;
    // Resume printers
    State.printers.forEach(p => {
      if (p._pausedByOutage) {
        p.active = true;
        p._pausedByOutage = false;
      }
    });
    UI.log('âœ… Power restored! Printers resuming...', 'success');
    UI.renderPrinters();
    UI.renderCenterPanel();
  },
};


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  v10 MODULES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ VAT / TAX SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TaxSystem = {
  _pending: 0,

  tick(dt) {
    if (State.bizLevel < 2) return;
    State.taxTimer = (State.taxTimer ?? 180) - dt;
    if (State.taxTimer <= 0) {
      State.taxTimer = 180;
      this._bill();
    }
  },

  accrue(amount) {
    State.taxAccum = r2((State.taxAccum || 0) + amount);
  },

  _bill() {
    if ((State.taxAccum || 0) <= 5) { State.taxAccum = 0; return; }
    const rate = State.taxRate || 0.15;
    const base = State.taxAccum;
    const taxDue = r2(base * rate);
    this._pending = taxDue;
    const overlay = document.getElementById('tax-overlay');
    const amtEl   = document.getElementById('tax-amount');
    const breakEl = document.getElementById('tax-breakdown');
    const warnEl  = document.getElementById('tax-warning');
    if (amtEl)   amtEl.textContent = fmtEur(taxDue);
    if (breakEl) breakEl.innerHTML = `
      <div class="tax-row"><span>Taxable revenue</span><span>${fmtEur(base)}</span></div>
      <div class="tax-row"><span>VAT rate</span><span>${(rate*100).toFixed(0)}%</span></div>
      <div class="tax-row"><span>Tax due</span><span>${fmtEur(taxDue)}</span></div>`;
    if (warnEl) warnEl.textContent = State.money < taxDue ? 'âš  Insufficient funds! Rep penalty if unpaid.' : '';
    if (overlay) overlay.classList.add('active');
    State.taxAccum = 0;
    UI.log(`ðŸ§¾ VAT bill: ${fmtEur(taxDue)} (${(rate*100).toFixed(0)}% of ${fmtEur(base)})`, 'warn');
  },

  pay() {
    const overlay = document.getElementById('tax-overlay');
    if (this._pending > 0) {
      if (State.money >= this._pending) {
        State.money = r2(State.money - this._pending);
        State.stats_v10.taxPaid = r2((State.stats_v10.taxPaid || 0) + this._pending);
        UI.log(`âœ… Tax paid: ${fmtEur(this._pending)}`, 'info');
      } else {
        const pen = 10;
        State.reputation = Math.max(0, State.reputation - pen);
        UI.log(`âš  Couldn't pay tax bill! âˆ’${pen} rep`, 'error');
      }
    }
    if (overlay) overlay.classList.remove('active');
    UI.updateTopBar();
    this._pending = 0;
  },
};

// â”€â”€ CLIENT COMPLAINTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Complaints = {
  maybeComplain(order) {
    if (!order || order.reward < 15) return;
    if (Math.random() > 0.40) return;
    const msgs  = CONFIG.COMPLAINT_MESSAGES;
    const faces = CONFIG.COMPLAINT_FACES;
    const refundAmt  = r2(order.reward * 0.6);
    const repPenalty = 8 + Math.floor(Math.random() * 8);
    State.pendingComplaint = {
      client: order.customer || 'Client',
      refundAmt, repPenalty,
      msg:  msgs[Math.floor(Math.random() * msgs.length)],
      face: faces[Math.floor(Math.random() * faces.length)],
    };
    const ov      = document.getElementById('complaint-overlay');
    const faceEl  = document.getElementById('complaint-face');
    const clEl    = document.getElementById('complaint-client');
    const msgEl   = document.getElementById('complaint-msg');
    const refEl   = document.getElementById('complaint-refund');
    const repEl   = document.getElementById('complaint-rep');
    if (faceEl) faceEl.textContent = State.pendingComplaint.face;
    if (clEl)   clEl.textContent   = State.pendingComplaint.client;
    if (msgEl)  msgEl.textContent  = State.pendingComplaint.msg;
    if (refEl)  refEl.textContent  = refundAmt.toFixed(2);
    if (repEl)  repEl.textContent  = repPenalty;
    if (ov)     ov.classList.add('active');
    State.stats_v10.complaintsReceived = (State.stats_v10.complaintsReceived || 0) + 1;
  },

  refund() {
    const c = State.pendingComplaint; if (!c) return;
    State.money = r2(State.money - c.refundAmt);
    State.stats_v10.complaintsRefunded = (State.stats_v10.complaintsRefunded || 0) + 1;
    UI.log(`ðŸ’¸ Refunded ${c.client}: ${fmtEur(c.refundAmt)}`, 'warn');
    this._close(); UI.updateTopBar();
  },

  ignore() {
    const c = State.pendingComplaint; if (!c) return;
    State.reputation = Math.max(0, State.reputation - c.repPenalty);
    UI.log(`ðŸ˜¤ Ignored complaint from ${c.client}. âˆ’${c.repPenalty} rep.`, 'error');
    this._close(); UI.updateTopBar();
  },

  _close() {
    State.pendingComplaint = null;
    const ov = document.getElementById('complaint-overlay');
    if (ov) ov.classList.remove('active');
  },
};

// â”€â”€ CLIENT TIER SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ClientTiers = {
  update(customerName) {
    if (!State.customers || !State.customers[customerName]) return;
    const jobs = State.customers[customerName].jobs || 0;
    const T = CONFIG.CLIENT_TIER_THRESHOLDS;
    let tier = null;
    if      (jobs >= T.platinum) tier = 'platinum';
    else if (jobs >= T.gold)     tier = 'gold';
    else if (jobs >= T.silver)   tier = 'silver';
    else if (jobs >= T.bronze)   tier = 'bronze';
    const old = (State.clientTiers || {})[customerName];
    if (tier && tier !== old) {
      State.clientTiers[customerName] = tier;
      const labels = { bronze:'ðŸ¥‰ Bronze', silver:'ðŸ¥ˆ Silver', gold:'ðŸ¥‡ Gold', platinum:'ðŸ’Ž Platinum' };
      UI.log(`â­ ${customerName} is now a ${labels[tier]} client! +${Math.round((CONFIG.CLIENT_TIER_BONUS[tier]-1)*100)}% reward bonus.`, 'success');
      const t = document.createElement('div');
      t.className = 'contract-toast';
      t.innerHTML = `<div style="font-size:9px;letter-spacing:2px;color:var(--warn)">CLIENT UPGRADE!</div>
        <div style="font-family:var(--display);font-weight:700;font-size:15px">${labels[tier]} Â· ${customerName}</div>
        <div style="font-size:10px;color:var(--text-dim)">+${Math.round((CONFIG.CLIENT_TIER_BONUS[tier]-1)*100)}% rewards from this client</div>`;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 5000);
      // ðŸ’Ž Platinum: spawn a special mega-order from this client
      if (tier === 'platinum') {
        setTimeout(() => CRM.spawnPlatinumDeal(customerName), 2000);
      }
      Achievements.check();
      NewsTicker.addItem(`ðŸ’Ž ${customerName} is nu een ${labels[tier]} klant! Speciale deals beschikbaar.`);
    }
  },

  getBonus(customerName) {
    const tier = (State.clientTiers || {})[customerName];
    return tier ? (CONFIG.CLIENT_TIER_BONUS[tier] || 1.0) : 1.0;
  },

  getBadge(customerName) {
    const tier = (State.clientTiers || {})[customerName];
    if (!tier) return '';
    const icons = { bronze:'ðŸ¥‰', silver:'ðŸ¥ˆ', gold:'ðŸ¥‡', platinum:'ðŸ’Ž' };
    return `<span class="client-tier-badge tier-${tier}">${icons[tier]} ${tier.toUpperCase()}</span>`;
  },
};

// â”€â”€ RECYCLING SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Recycling = {
  onFailure(filament) {
    if (!State.ownedUpgrades.includes('recycler')) return;
    const base  = (CONFIG.FILAMENTS[filament] && CONFIG.FILAMENTS[filament].stockUse) || 3;
    const bonus = State.scrapBonus || 0;
    const scrap = Math.ceil(base * (0.5 + bonus));
    State.scrap = (State.scrap || 0) + scrap;
    this._updatePill();
    UI.log(`â™»ï¸ Salvaged ${scrap} scrap from failed ${filament} print.`, 'info');
  },

  convert(filament) {
    const cost = 15;
    if ((State.scrap || 0) < cost) { UI.showPopup('Not Enough Scrap', `Need ${cost} scrap. You have ${State.scrap||0}.`); return; }
    State.scrap -= cost;
    State.filamentStock[filament] = (State.filamentStock[filament] || 0) + 10;
    State.stats_v10.scrapsRecycled = (State.stats_v10.scrapsRecycled || 0) + 1;
    UI.log(`â™»ï¸ Converted ${cost} scrap â†’ 10 ${filament}`, 'money');
    this._updatePill();
    this.renderPanel();
    Suppliers.updateStockUI && Suppliers.updateStockUI();
    Achievements.check && Achievements.check();
    UI.updateTopBar();
  },

  sell() {
    const scrap = State.scrap || 0;
    if (scrap < 5) { UI.showPopup('Not Enough Scrap', 'Need at least 5 scrap to sell.'); return; }
    const val = r2(scrap * 0.8);
    State.money = r2(State.money + val);
    State.stats.totalEarned = r2(State.stats.totalEarned + val);
    TaxSystem.accrue(val);
    UI.log(`â™»ï¸ Sold ${scrap} scrap for ${fmtEur(val)}`, 'money');
    State.scrap = 0;
    this._updatePill();
    this.renderPanel();
    UI.updateTopBar();
  },

  _updatePill() {
    const pill = document.getElementById('scrap-pill');
    const val  = document.getElementById('scrap-val');
    if (pill) pill.style.display = State.ownedUpgrades.includes('recycler') ? 'inline-flex' : 'none';
    if (val)  val.textContent    = State.scrap || 0;
  },

  renderPanel() {
    const panel = document.getElementById('recycle-panel'); if (!panel) return;
    if (!State.ownedUpgrades.includes('recycler')) {
      panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:20px">Buy the <strong>Filament Recycler</strong> upgrade to unlock this.</div>';
      return;
    }
    const scrap = State.scrap || 0;
    const filaments = ['PLA','PETG','PA6','TPU','RESIN'].filter(f => {
      if (f==='TPU'   && !State.tpuUnlocked)   return false;
      if (f==='RESIN' && !State.resinUnlocked) return false;
      return true;
    });
    panel.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px">
        <div style="font-size:32px">â™»ï¸</div>
        <div>
          <div style="font-family:var(--display);font-weight:900;font-size:28px;color:var(--accent3)">${scrap} scrap</div>
          <div style="font-size:9px;color:var(--text-dim)">15 scrap = 10 filament Â· or sell at â‚¬0.80/unit</div>
        </div>
      </div>
      <div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Convert to Filament</div>
      ${filaments.map(f => `
        <button class="btn btn-ghost btn-sm btn-full" style="margin-bottom:4px;display:flex;justify-content:space-between" onclick="Recycling.convert('${f}')" ${scrap<15?'disabled':''}>
          <span class="tag tag-${f.toLowerCase()}">${f}</span>
          <span>15 scrap â†’ 10 units</span>
          <span style="color:var(--accent)">Stock: ${State.filamentStock[f]||0}</span>
        </button>`).join('')}
      <button class="btn btn-warn btn-sm btn-full" style="margin-top:8px" onclick="Recycling.sell()" ${scrap<5?'disabled':''}>ðŸ’° Sell all scrap (${fmtEur(r2(scrap*0.8))})</button>`;
  },
};

// â”€â”€ EMPLOYEE MORALE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Morale = {
  _t: 0,

  tick(dt) {
    if (!State.hiredEmployees || State.hiredEmployees.length === 0) return;
    this._t += dt;
    if (this._t < 30) return;
    this._t = 0;
    State.hiredEmployees.forEach(id => {
      State.morale = State.morale || {};
      if (State.morale[id] === undefined) State.morale[id] = 100;
      State.morale[id] = Math.max(0, State.morale[id] - 2);
      if (State.morale[id] === 30) {
        const emp = CONFIG.EMPLOYEES && CONFIG.EMPLOYEES.find(e => e.id === id);
        if (emp) UI.log(`ðŸ˜´ ${emp.name} morale low (30%)! Buy a Team Lunch to prevent slowdown.`, 'warn');
      }
    });
  },

  getEff(id) {
    const m = (State.morale || {})[id] ?? 100;
    return m >= 60 ? 1.0 : m >= 30 ? 0.80 : 0.55;
  },

  renderPanel() {
    const panel = document.getElementById('morale-panel'); if (!panel) return;
    if (!State.hiredEmployees || State.hiredEmployees.length === 0) {
      panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px">No employees hired yet.</div>';
      return;
    }
    panel.innerHTML = State.hiredEmployees.map(id => {
      const emp = CONFIG.EMPLOYEES && CONFIG.EMPLOYEES.find(e => e.id === id);
      const m = (State.morale || {})[id] ?? 100;
      const color = m >= 60 ? 'var(--accent3)' : m >= 30 ? 'var(--warn)' : 'var(--danger)';
      const eff = this.getEff(id);
      return `<div style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px">
          <span>${emp ? emp.name : id}</span>
          <span style="color:${color}">${m}% morale Â· ${Math.round(eff*100)}% eff</span>
        </div>
        <div class="morale-bar"><div class="morale-fill" style="width:${m}%;background:${color}"></div></div>
      </div>`;
    }).join('');
  },

  buyLunch() {
    const cost = 80;
    if (State.money < cost) { UI.showPopup('Insufficient Funds', `Team Lunch costs â‚¬${cost}.`); return; }
    if (!State.hiredEmployees || State.hiredEmployees.length === 0) { UI.showPopup('No Staff', 'Hire employees first!'); return; }
    State.money = r2(State.money - cost);
    State.morale = State.morale || {};
    State.hiredEmployees.forEach(id => { State.morale[id] = 100; });
    State.stats.lunchesBought = (State.stats.lunchesBought || 0) + 1;
    UI.log(`ðŸ• Team Lunch! All staff morale restored to 100%.`, 'success');
    UI.updateTopBar();
    Achievements.check();
  },
};

// â”€â”€ FRANCHISE SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Franchise = {
  canUnlock() { return (State.prestige || 0) >= 2; },

  open(branchId) {
    const def = CONFIG.FRANCHISE_BRANCHES.find(b => b.id === branchId);
    if (!def) return;
    if (!this.canUnlock()) { UI.showPopup('Locked', 'Franchise unlocks after 2 Prestiges.'); return; }
    if (State.money < def.baseCost) { UI.showPopup('Insufficient Funds', `Costs ${fmtEur(def.baseCost)}.`); return; }
    if ((State.franchiseBranches || []).find(b => b.id === branchId)) { UI.showPopup('Already Open', 'This branch is already open.'); return; }
    State.money = r2(State.money - def.baseCost);
    State.franchiseBranches.push({ id: branchId, name: def.name, level: 1, incomePerMin: def.incomePerMin, upgradeCost: def.upgradeCost, _accum: 0 });
    Confetti.burst(40);
    UI.log(`ðŸ­ ${def.name} opened! +â‚¬${def.incomePerMin}/min passive income.`, 'money');
    UI.updateTopBar(); this.render();
  },

  upgrade(branchId) {
    const branch = (State.franchiseBranches || []).find(b => b.id === branchId);
    const def    = CONFIG.FRANCHISE_BRANCHES.find(b => b.id === branchId);
    if (!branch || !def) return;
    if (branch.level >= def.maxLevel) { UI.showPopup('Max Level', 'Fully upgraded!'); return; }
    if (State.money < branch.upgradeCost) { UI.showPopup('Insufficient Funds', fmtEur(branch.upgradeCost)); return; }
    State.money = r2(State.money - branch.upgradeCost);
    branch.level++;
    branch.incomePerMin = Math.round(branch.incomePerMin * 1.6);
    branch.upgradeCost  = Math.round(branch.upgradeCost  * 2.2);
    UI.log(`ðŸ­ ${branch.name} upgraded to Lv.${branch.level}! Now â‚¬${branch.incomePerMin}/min.`, 'money');
    UI.updateTopBar(); this.render();
  },

  tick(dt) {
    (State.franchiseBranches || []).forEach(b => {
      b._accum = (b._accum || 0) + dt;
      if (b._accum >= 60) {
        b._accum -= 60;
        State.money = r2(State.money + b.incomePerMin);
        State.stats.totalEarned = r2(State.stats.totalEarned + b.incomePerMin);
        State.stats_v10.franchiseEarned = r2((State.stats_v10.franchiseEarned||0) + b.incomePerMin);
        TaxSystem.accrue(b.incomePerMin);
      }
    });
  },

  render() {
    const panel = document.getElementById('franchise-panel'); if (!panel) return;
    if (!this.canUnlock()) {
      panel.innerHTML = `<div style="text-align:center;padding:28px;color:var(--text-dim)">
        <div style="font-size:40px;margin-bottom:8px">ðŸ­</div>
        <div style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--accent2);margin-bottom:8px">Franchise Mode Locked</div>
        <div style="font-size:11px">Complete <strong style="color:var(--warn)">2 Prestiges</strong> to unlock.</div>
        <div style="margin-top:8px;color:var(--pro);font-family:var(--display);font-size:16px">Prestiges: ${State.prestige||0} / 2</div>
      </div>`; return;
    }
    let html = '';
    CONFIG.FRANCHISE_BRANCHES.forEach(def => {
      const branch = (State.franchiseBranches||[]).find(b=>b.id===def.id);
      if (branch) {
        const pct = Math.min(100, ((branch._accum||0)/60)*100);
        html += `<div class="franchise-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <span>${def.icon} <span class="franchise-name">${branch.name}</span> <span style="font-size:9px;color:var(--text-dim)">Lv.${branch.level}</span></span>
            <span class="franchise-income">â‚¬${branch.incomePerMin}/min</span>
          </div>
          <div class="franchise-bar"><div class="franchise-fill" style="width:${pct}%"></div></div>
          ${branch.level < def.maxLevel
            ? `<button class="btn btn-primary btn-sm btn-full" style="margin-top:6px" onclick="Franchise.upgrade('${def.id}')">â¬† Upgrade Lv.${branch.level+1} â€” ${fmtEur(branch.upgradeCost)}</button>`
            : `<div style="color:var(--accent3);font-size:9px;text-align:center;margin-top:4px">âœ“ MAX LEVEL</div>`}
        </div>`;
      } else {
        html += `<div class="franchise-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <span>${def.icon} <span class="franchise-name">${def.name}</span></span>
            <span style="font-family:var(--display);font-weight:900;font-size:18px;color:var(--warn)">${fmtEur(def.baseCost)}</span>
          </div>
          <div style="font-size:9px;color:var(--text-dim);margin-bottom:6px">â‚¬${def.incomePerMin}/min passive Â· up to Lv.${def.maxLevel}</div>
          <button class="btn btn-warn btn-sm btn-full" onclick="Franchise.open('${def.id}')" ${State.money<def.baseCost?'disabled':''}>ðŸ­ Open Branch</button>
        </div>`;
      }
    });
    const total = (State.franchiseBranches||[]).reduce((s,b)=>s+b.incomePerMin,0);
    if (total > 0) html += `<div style="margin-top:8px;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);text-align:center">
      <div style="font-size:9px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px">Total Franchise Income</div>
      <div style="font-family:var(--display);font-weight:900;font-size:26px;color:var(--accent3)">â‚¬${total}/min</div></div>`;
    panel.innerHTML = html;
  },
};

// â”€â”€ LEGACY PERKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LegacyPerks = {
  showPicker() {
    const overlay = document.getElementById('perk-select-overlay');
    const grid    = document.getElementById('perk-select-grid');
    if (!overlay || !grid) return;
    const available = CONFIG.LEGACY_PERKS.filter(p => !(State.legacyPerks||[]).includes(p.id));
    if (available.length === 0) { UI.showPopup('All Perks Owned', 'You have every legacy perk!'); return; }
    const choices = available.sort(()=>Math.random()-0.5).slice(0, Math.min(4, available.length));
    grid.innerHTML = choices.map(p => `
      <div class="perk-choice" onclick="LegacyPerks.choose('${p.id}')">
        <div class="perk-choice-icon">${p.icon}</div>
        <div class="perk-choice-name">${p.name}</div>
        <div class="perk-choice-desc">${p.desc}</div>
      </div>`).join('');
    overlay.classList.add('active');
  },

  choose(id) {
    const perk = CONFIG.LEGACY_PERKS.find(p => p.id === id); if (!perk) return;
    State.legacyPerks = State.legacyPerks || [];
    State.legacyPerks.push(id);
    perk.effect(State);
    const ov = document.getElementById('perk-select-overlay');
    if (ov) ov.classList.remove('active');
    Confetti.burst(80);
    UI.log(`â­ Legacy Perk: ${perk.icon} ${perk.name} â€” ${perk.desc}`, 'success');
    const t = document.createElement('div');
    t.className = 'contract-toast';
    t.innerHTML = `<div style="font-size:9px;letter-spacing:2px;color:var(--pro)">â­ LEGACY PERK</div>
      <div style="font-family:var(--display);font-weight:700;font-size:16px">${perk.icon} ${perk.name}</div>
      <div style="font-size:10px;color:var(--text-dim);margin-top:2px">${perk.desc}</div>`;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 6000);
    this.render();
  },

  reapply() {
    (State.legacyPerks||[]).forEach(id => {
      const p = CONFIG.LEGACY_PERKS.find(p=>p.id===id);
      if (p) p.effect(State);
    });
  },

  render() {
    const panel = document.getElementById('legacy-panel'); if (!panel) return;
    const owned = State.legacyPerks || [];
    if (owned.length === 0 && (State.prestige||0) === 0) {
      panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:20px">Prestige once to earn your first Legacy Perk â€” a permanent bonus that survives all resets forever.</div>';
      return;
    }
    let html = '';
    if (owned.length > 0) {
      html += `<div style="font-size:9px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px">Active Legacy Perks (${owned.length})</div>`;
      owned.forEach(id => {
        const p = CONFIG.LEGACY_PERKS.find(p=>p.id===id); if (!p) return;
        html += `<div class="perk-card perk-owned"><div class="perk-icon">${p.icon}</div><div class="perk-name">${p.name}</div><div class="perk-desc">${p.desc}</div></div>`;
      });
    }
    html += `<div style="margin-top:10px;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);font-size:10px;color:var(--text-dim);line-height:1.6">
      Each prestige, pick 1 perk from 4 random choices. They stack forever.<br><br>
      <strong style="color:var(--warn)">Earned: ${owned.length} / ${CONFIG.LEGACY_PERKS.length}</strong></div>`;
    panel.innerHTML = html;
  },
};

// â”€â”€ HALL OF FAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const HallOfFame = {
  KEY: 'pnp_hof_v2',

  load() { try { return JSON.parse(localStorage.getItem(this.KEY)||'[]'); } catch(e) { return []; } },
  save(e) { try { localStorage.setItem(this.KEY, JSON.stringify(e)); } catch(e){} },

  submit() {
    const score = Math.round(State.stats.totalEarned || 0);
    if (score < 50) return;
    const entries = this.load();
    entries.push({
      score, prestige: State.prestige||0,
      level: State.bizLevel, jobs: State.stats.jobsDone,
      perks: [...(State.legacyPerks||[])],
      date: new Date().toLocaleDateString(),
    });
    entries.sort((a,b)=>b.score-a.score);
    this.save(entries.slice(0,15));
  },

  render() {
    const panel = document.getElementById('hof-panel'); if (!panel) return;
    const entries = this.load();
    if (entries.length === 0) {
      panel.innerHTML = '<div style="color:var(--text-dim);text-align:center;padding:30px;font-size:11px">No records yet. Complete a prestige or reach â‚¬50 earned to appear here.</div>';
      return;
    }
    panel.innerHTML = entries.map((e,i) => {
      const rc   = i===0?'gold':i===1?'silver':i===2?'bronze':'';
      const icon = i===0?'ðŸ¥‡':i===1?'ðŸ¥ˆ':i===2?'ðŸ¥‰':`#${i+1}`;
      const perksHtml = (e.perks||[]).map(id => {
        const p = CONFIG.LEGACY_PERKS.find(p=>p.id===id);
        return p ? `<span class="hof-perk-tag">${p.icon} ${p.name}</span>` : '';
      }).join('');
      return `<div class="hof-entry">
        <div class="hof-rank ${rc}">${icon}</div>
        <div class="hof-info">
          <div class="hof-run-name">Prestige ${e.prestige} Run</div>
          <div class="hof-run-sub">Lv.${e.level} Â· ${e.jobs} jobs Â· ${e.date}</div>
          <div class="hof-perks">${perksHtml}</div>
        </div>
        <div class="hof-score">${fmtEur(e.score)}</div>
      </div>`;
    }).join('');
  },
};

// â”€â”€ SUBSCRIPTION CLIENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Subscriptions = {
  unlock() {
    if (State.subscriptionClients.length === 0) {
      CONFIG.SUBSCRIPTION_CLIENTS.slice(0,2).forEach(t =>
        State.subscriptionClients.push({ ...t, nextIn: t.intervalS, active: true })
      );
    }
    UI.log('ðŸ“‹ Subscription System active! Regular clients will auto-send repeat orders.', 'success');
    this.render();
  },

  tick(dt) {
    if (!State.ownedUpgrades.includes('subscription_sys')) return;
    if (State.subscriptionClients.length === 0) this.unlock();
    State.subscriptionClients.forEach(c => {
      if (!c.active) return;
      c.nextIn -= dt;
      if (c.nextIn <= 0) {
        c.nextIn = c.intervalS;
        this._spawn(c);
      }
    });
  },

  checkUnlockMore() {
    if (!State.ownedUpgrades.includes('subscription_sys')) return;
    const thresholds = [
      { rep: 60,  idx: 2 },
      { rep: 100, idx: 3 },
    ];
    thresholds.forEach(({ rep, idx }) => {
      const t = CONFIG.SUBSCRIPTION_CLIENTS[idx];
      if (!t) return;
      if (State.reputation >= rep && !State.subscriptionClients.find(c => c.name === t.name)) {
        State.subscriptionClients.push({ ...t, nextIn: t.intervalS, active: true });
        UI.log(`ðŸ“‹ New subscriber unlocked: ${t.name}!`, 'success');
        NewsTicker.addItem(`ðŸ“‹ Nieuwe abonnee: ${t.name} â€” ${t.filament} orders komen binnen!`);
        this.render();
      }
    });
  },

  _spawn(client) {
    if (State.orders.length >= CONFIG.MAX_ORDERS) return;
    const fil = CONFIG.FILAMENTS[client.filament];
    if (!fil) return;
    const reward = r2(fil.costPerJob * fil.profitMult * 3.5 * client.bonusMult * (1 + (State.prestige||0)*0.1));
    State.orders.push({
      id: Date.now()+Math.random(), name: `${client.name} (subscription)`,
      customer: client.name, filament: client.filament,
      quality: client.quality, reward,
      printTime: 20 + Math.floor(Math.random()*15),
      timeLeft: CONFIG.ORDER_EXPIRE_S * 1.6, expireTime: CONFIG.ORDER_EXPIRE_S * 1.6,
      xpReward: 12, urgent: false, orderType: 'subscription',
    });
    UI.log(`ðŸ“‹ ${client.name} sent a subscription order (${client.filament}) â€” ${fmtEur(reward)}`, 'info');
    UI.renderOrders();
  },

  render() {
    const panel = document.getElementById('subscription-panel'); if (!panel) return;
    if (!State.ownedUpgrades.includes('subscription_sys')) {
      panel.innerHTML = '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:16px">Buy <strong>Subscription System</strong> in upgrades to get recurring client orders.</div>';
      return;
    }
    panel.innerHTML = (State.subscriptionClients||[]).map(c => `
      <div style="background:var(--bg3);border:1px solid rgba(0,229,255,0.2);border-radius:var(--radius);padding:10px 12px;margin-bottom:6px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-family:var(--display);font-weight:700">${c.name}</span>
          <span class="tag tag-subscription">ðŸ“‹ SUB</span>
        </div>
        <div style="font-size:9px;color:var(--text-dim);margin-top:3px">${c.filament} Â· ${c.quality} Â· Ã—${c.bonusMult} reward</div>
        <div style="font-size:9px;color:var(--accent);margin-top:2px">Next: ${Math.max(0,Math.round(c.nextIn))}s</div>
      </div>`).join('') || '<div style="color:var(--text-dim);font-size:10px;text-align:center;padding:16px">No subscription clients yet.</div>';
  },
};

// â”€â”€ INSURANCE SYSTEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const Insurance = {
  PREMIUM: 50, INTERVAL: 180,

  tick(dt) {
    if (!State.hasInsurance) return;
    State.insuranceTimer = (State.insuranceTimer||0) + dt;
    if (State.insuranceTimer >= this.INTERVAL) {
      State.insuranceTimer -= this.INTERVAL;
      if (State.money >= this.PREMIUM) {
        State.money = r2(State.money - this.PREMIUM);
        UI.log(`ðŸ›¡ Insurance premium: âˆ’â‚¬${this.PREMIUM}`, 'info');
      } else {
        State.hasInsurance = false;
        State.ownedUpgrades = (State.ownedUpgrades||[]).filter(id=>id!=='insurance');
        UI.log(`âš  Insurance lapsed â€” couldn't pay premium!`, 'error');
      }
      UI.updateTopBar();
    }
  },

  cover(desc) {
    if (!State.hasInsurance) return false;
    State.stats_v10.insurancePayouts = (State.stats_v10.insurancePayouts||0)+1;
    UI.log(`ðŸ›¡ Insurance covered: ${desc}!`, 'success');
    return true;
  },
};

window.addEventListener('DOMContentLoaded', ()=>{ Game.init(); });

// Resize graph on window resize
window.addEventListener('resize', ()=>{ UI.renderGraphCanvas(); });

/* ============================================================
   PAYMENT INTEGRATION GUIDE (for itch.io / webapp release)
   ============================================================

   Option A â€” itch.io paid download (â‚¬4.99):
     Gate the entire game behind itch.io's paywall.
     Ship `print-profit.html` as the download.

   Option B â€” Free-to-play + IAP (webapp):
     In Game.unlockPro(), replace the demo unlock with:
     â”€â”€ Stripe:
       const { error } = await stripe.redirectToCheckout({ lineItems:[{price:'price_xxx',quantity:1}], mode:'payment', ... });
     â”€â”€ Lemon Squeezy / Paddle: similar checkout redirect
     â”€â”€ On success URL: pass ?pro=1 query param, call Game._onProUnlocked()

   Option C â€” localStorage licence key:
     Sell a key on Gumroad. Player enters key:
       if (licenceKey === validKey) Game._onProUnlocked();

   ============================================================ */
</script>
</body>
</html>
